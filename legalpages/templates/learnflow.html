{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class on the html tag
            theme: {
                extend: {
                    fontFamily: {
                        // Using Inter as the default font
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        // Adding custom blue-black gradient colors
                        'blue-start': '#1e3a8a', // A dark blue
                        'black-end': '#0f172a',  // A very dark blue-black (slate-900)
                    },
                    // Add the 'prose' plugin configuration if it were being loaded dynamically,
                    // but since we're using the CDN, we rely on its defaults + responsive variants.
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}

{% block content %}
<div id="video-analysis-app" class="p-4 md:p-8">

    <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-extrabold text-primary-blue dark:text-white" id="mainTitle">LearnFlow AI</h1>
        <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-150 ease-in-out" title="Toggle dark mode">
            <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="moonIcon" class="w-6 h-6 text-gray-800 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </header>

    <div class="flex flex-col md:flex-row gap-4 mb-6">
        <input type="text" id="videoLink" placeholder="Paste YouTube Video URL here (e.g., https://www.youtube.com/watch?v=...)"
               class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-700 dark:border-gray-600 dark:text-white"
               aria-label="YouTube Video Link Input">
        <button id="analyzeButton" onclick="initiateAnalysis()"
                class="bg-primary-blue text-white font-semibold py-3 px-6 rounded-lg shadow hover:bg-hover-blue transition duration-150 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
            Analyze Video
        </button>
    </div>

    <div id="statusMessage" class="hidden p-3 mb-4 rounded-lg text-sm font-medium" role="alert"></div>

    <div id="loadingIndicator" class="hidden text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-blue mx-auto mb-3"></div>
        <p class="text-gray-600 dark:text-gray-300 font-semibold" id="loadingText">Processing video and generating content... Please wait.</p>
    </div>

    <div id="resultsContent" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6">
        
        <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button data-tab="summary" class="tab-button inline-flex items-center px-1 py-3 border-b-2 text-sm font-medium focus:outline-none" aria-controls="summary-panel" id="summaryTab">Summary</button>
                <button data-tab="quiz" class="tab-button inline-flex items-center px-1 py-3 border-b-2 text-sm font-medium focus:outline-none" aria-controls="quiz-panel" id="quizTab">Quiz</button>
                <button data-tab="transcript" class="tab-button inline-flex items-center px-1 py-3 border-b-2 text-sm font-medium focus:outline-none" aria-controls="transcript-panel" id="transcriptTab">Transcript</button>
            </nav>
        </div>

        <div id="summary-panel" class="tab-content" role="tabpanel">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white" id="summaryTitle">AI Summary</h2>
            <div id="summaryContent" class="prose dark:prose-invert max-w-none min-h-[150px] p-4 bg-gray-50 dark:bg-gray-900 rounded-lg" id="placeholderSummary"></div>
        </div>

        <div id="quiz-panel" class="tab-content hidden" role="tabpanel">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white" id="quizTitle">Interactive Quiz</h2>
            <div id="quizPlaceholder" class="text-gray-500 dark:text-gray-400 mb-4"></div>
            <div id="quizContainer">
                </div>
            <div id="quizResults" class="mt-6 p-4 border border-green-200 bg-green-50 dark:bg-green-900 dark:border-green-700 rounded-lg hidden">
                <h3 class="text-xl font-bold text-green-800 dark:text-green-300 mb-2" id="quizResultsTitle">Quiz Results</h3>
                <p id="scoreDisplay" class="text-green-700 dark:text-green-400 font-semibold text-lg"></p>
            </div>
            <button id="scoreButton" onclick="scoreQuiz()" disabled
                    class="mt-6 w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow hover:bg-green-700 transition duration-150 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                <span id="scoreButtonText">Submit Quiz</span>
            </button>
        </div>

        <div id="transcript-panel" class="tab-content hidden" role="tabpanel">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white" id="transcriptTitle">Video Transcript</h2>
            <div id="transcriptContent" class="prose dark:prose-invert max-w-none min-h-[150px] p-4 bg-gray-50 dark:bg-gray-900 rounded-lg overflow-y-scroll max-h-[60vh]" id="transcriptPlaceholder"></div>
        </div>

        <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <button id="exportButton" onclick="exportContent()"
                    class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-700 transition duration-150 ease-in-out">
                <span id="exportButtonText">Export as PDF</span>
            </button>
            <p class="text-sm text-gray-500 dark:text-gray-400">
                <span id="feedbackPromptText">Found an issue?</span>
                <a href="{% url 'legalpages:contact' %}" target="_blank" class="text-primary-blue hover:underline" id="feedbackLink">Send Feedback</a>
            </p>
        </div>

    </div>
</div>

<script>
    const i18n = {
        mainTitle: 'LearnFlow AI',
        analyzeButton: 'Analyze Video',
        loadingText: 'Processing video and generating content... Please wait.',
        summaryTitle: 'AI Summary',
        quizTitle: 'Interactive Quiz',
        transcriptTitle: 'Video Transcript',
        scoreButtonText: 'Submit Quiz',
        exportButtonText: 'Export as PDF',
        quizResultsTitle: 'Quiz Results',
        feedbackPrompt: 'Found an issue?',
        feedbackLink: 'Send Feedback',
        darkModeToggle: 'Toggle dark mode',
        placeholderSummary: 'Paste a YouTube link above and click "Analyze Video" to generate a summary and quiz.',
        placeholderQuiz: 'Quiz questions will appear here after analysis.',
        placeholderTranscript: 'The video transcript will appear here.',
        errorVideoLink: 'Please enter a valid YouTube video URL.',
        errorNetwork: 'Network error or server connection failed. Check console for details.',
        errorAnalysisFailed: 'Analysis Failed: ',
    };
    
    // DOM Elements
    const videoLinkInput = document.getElementById('videoLink');
    const analyzeButton = document.getElementById('analyzeButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContent = document.getElementById('resultsContent');
    const statusMessage = document.getElementById('statusMessage');
    const summaryContentDiv = document.getElementById('summaryContent');
    const transcriptContentDiv = document.getElementById('transcriptContent');
    const quizContainerDiv = document.getElementById('quizContainer');
    const scoreButton = document.getElementById('scoreButton');
    const quizResultsDiv = document.getElementById('quizResults');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const darkModeToggle = document.getElementById('darkModeToggle');

    let currentQuizData = [];

    // --- Utility Functions ---

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showStatusMessage(message, isError = true) {
        statusMessage.textContent = message;
        statusMessage.className = `p-3 mb-4 rounded-lg text-sm font-medium ${isError ? 'bg-error-red text-white' : 'bg-green-100 text-green-800'}`;
        statusMessage.style.display = 'block';
    }

    function hideStatusMessage() {
        statusMessage.style.display = 'none';
    }

    // --- Main Application Logic ---

    function initiateAnalysis() {
        const link = videoLinkInput.value.trim();
        hideStatusMessage();
        quizResultsDiv.classList.add('hidden'); // Reset results display

        if (!link || (!link.includes('youtube.com/watch?v=') && !link.includes('youtu.be/'))) {
            showStatusMessage(i18n.errorVideoLink);
            return;
        }

        fetchTranscript(link); // Use the original function name
    }

    // CRITICAL FIX: The API URL must match the path defined in urls.py
    async function fetchTranscript(link) {
        // FIX APPLIED HERE: Prepend the 'legal/' prefix to match the Django routing
        const apiUrl = '/legal/api/analyze_video/'; 

        analyzeButton.disabled = true;
        loadingIndicator.style.display = 'block';
        resultsContent.classList.add('hidden');
        currentQuizData = [];
        summaryContentDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Loading...</p>`;
        transcriptContentDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Loading...</p>`;
        quizContainerDiv.innerHTML = '';
        scoreDisplay.textContent = '';
        scoreButton.disabled = true;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ video_link: link })
            });

            const data = await response.json();

            if (data.status === 'success') {
                // Use DOMPurify and marked for safe markdown rendering
                summaryContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(data.summary || 'Summary could not be generated.'));
                transcriptContentDiv.textContent = data.transcript_text || data.summary; // Fallback to summary if no raw transcript is returned
                currentQuizData = data.quiz;
                renderQuiz(data.quiz);
                resultsContent.classList.remove('hidden');
                scoreButton.disabled = false;
                switchTab('summary'); // Switch to summary tab after load
            } else {
                const message = data.message || "An unknown error occurred during analysis.";
                showStatusMessage(i18n.errorAnalysisFailed + message);
                resultsContent.classList.add('hidden');
            }

        } catch (error) {
            console.error('Error fetching transcript and analysis:', error);
            showStatusMessage(i18n.errorNetwork);
            resultsContent.classList.add('hidden');
        } finally {
            loadingIndicator.style.display = 'none';
            analyzeButton.disabled = false;
        }
    }
    
    function renderQuiz(quizData) {
        quizContainerDiv.innerHTML = ''; // Clear previous quiz
        quizData.forEach((q, qIndex) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'quiz-question p-4 mb-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700';
            questionDiv.innerHTML = `<p class="font-bold mb-3 text-gray-800 dark:text-white">${qIndex + 1}. ${q.question}</p><div class="quiz-options" id="options-${qIndex}"></div><div class="feedback mt-2 text-sm font-medium p-2 rounded-md hidden" id="feedback-${qIndex}"></div>`;

            const optionsDiv = questionDiv.querySelector(`#options-${qIndex}`);
            q.options.forEach((option, oIndex) => {
                const label = document.createElement('label');
                label.className = 'flex items-center p-3 mb-2 cursor-pointer rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 transition duration-150 ease-in-out';
                label.innerHTML = `<input type="radio" name="question-${qIndex}" value="${oIndex}" class="w-4 h-4 text-primary-blue focus:ring-primary-blue dark:text-white dark:focus:ring-white mr-3"> ${option}`;
                optionsDiv.appendChild(label);
            });

            quizContainerDiv.appendChild(questionDiv);
        });
    }

    function scoreQuiz() {
        let correctCount = 0;
        const totalQuestions = currentQuizData.length;

        currentQuizData.forEach((q, qIndex) => {
            const selectedOption = document.querySelector(`input[name="question-${qIndex}"]:checked`);
            const feedbackDiv = document.getElementById(`feedback-${qIndex}`);
            const optionsDiv = document.getElementById(`options-${qIndex}`);
            
            // Reset feedback and option styling
            feedbackDiv.classList.add('hidden');
            optionsDiv.querySelectorAll('label').forEach(label => {
                label.style.backgroundColor = '';
                label.classList.remove('bg-red-100', 'dark:bg-red-900', 'bg-green-100', 'dark:bg-green-900', 'border-red-500', 'border-green-500');
            });
            
            // CRITICAL FIX: Use the correctAnswerIndex from the server
            const correctIndex = q.correctAnswerIndex;
            
            // Get all option labels for this question
            const allLabels = optionsDiv.querySelectorAll('label');
            
            if (selectedOption) {
                const selectedIndex = parseInt(selectedOption.value);
                const isCorrect = selectedIndex === correctIndex;
                
                if (isCorrect) {
                    correctCount++;
                    feedbackDiv.textContent = 'Correct! 🎉';
                    feedbackDiv.className = 'feedback mt-2 text-sm font-medium p-2 rounded-md bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                    allLabels[selectedIndex].classList.add('bg-green-100', 'dark:bg-green-900');
                } else {
                    feedbackDiv.textContent = 'Incorrect. The correct answer is highlighted in green.';
                    feedbackDiv.className = 'feedback mt-2 text-sm font-medium p-2 rounded-md bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                    // Highlight the incorrect selection in red
                    selectedOption.closest('label').classList.add('bg-red-100', 'dark:bg-red-900');
                    // Highlight the correct answer in green
                    if (correctIndex >= 0 && correctIndex < allLabels.length) {
                        allLabels[correctIndex].classList.add('bg-green-100', 'dark:bg-green-900');
                    }
                }
            } else {
                // Unanswered
                feedbackDiv.textContent = 'Unanswered. The correct answer is highlighted in green.';
                feedbackDiv.className = 'feedback mt-2 text-sm font-medium p-2 rounded-md bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                 // Highlight the correct answer in green
                if (correctIndex >= 0 && correctIndex < allLabels.length) {
                    allLabels[correctIndex].classList.add('bg-green-100', 'dark:bg-green-900');
                }
            }
            feedbackDiv.classList.remove('hidden');

            // Disable all radio buttons after scoring
            optionsDiv.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
        });

        scoreDisplay.textContent = `${correctCount} out of ${totalQuestions} correct (${Math.round((correctCount / totalQuestions) * 100)}%)`;
        quizResultsDiv.classList.remove('hidden');
        scoreButton.disabled = true; // Disable submit after scoring
    }
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(panel => panel.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-primary-blue', 'text-primary-blue', 'dark:border-white', 'dark:text-white');
            button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'hover:border-gray-300');
        });

        document.getElementById(`${tabName}-panel`).classList.remove('hidden');
        const selectedButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
        selectedButton.classList.add('border-primary-blue', 'text-primary-blue', 'dark:border-white', 'dark:text-white');
        selectedButton.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'hover:border-gray-300');
    }

    function exportContent() {
        // The element to be converted to PDF (e.g., the whole results container)
        const element = document.getElementById('resultsContent');
        const videoTitle = document.getElementById('mainTitle').textContent;
        const filename = `${videoTitle.replace(/[^a-z0-9]/gi, '_')}_Analysis.pdf`;

        // Configure PDF generation options
        const options = {
            margin: 10,
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: false, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Use html2pdf
        html2pdf().from(element).set(options).save();
    }

    function initializeDarkMode() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }

    function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.theme = 'light';
        } else {
            document.documentElement.classList.add('dark');
            localStorage.theme = 'dark';
        }
    }

    function applyLocalization() {
        // Apply text content
        document.getElementById('mainTitle').textContent = i18n.mainTitle;
        document.getElementById('analyzeButton').textContent = i18n.analyzeButton;
        document.getElementById('loadingText').textContent = i18n.loadingText;
        document.getElementById('summaryTitle').textContent = i18n.summaryTitle;
        document.getElementById('quizTitle').textContent = i18n.quizTitle;
        document.getElementById('transcriptTitle').textContent = i18n.transcriptTitle;
        document.getElementById('placeholderSummary').textContent = i18n.placeholderSummary;
        document.getElementById('quizPlaceholder').textContent = i18n.placeholderQuiz;
        document.getElementById('transcriptPlaceholder').textContent = i18n.placeholderTranscript;
        document.getElementById('scoreButtonText').textContent = i18n.scoreButtonText;
        document.getElementById('exportButtonText').textContent = i18n.exportButtonText;
        document.getElementById('quizResultsTitle').textContent = i18n.quizResultsTitle;
        document.getElementById('feedbackPromptText').textContent = i18n.feedbackPrompt;
        document.getElementById('feedbackLink').textContent = i18n.feedbackLink;

        // ARIA labels
        document.getElementById('darkModeToggle').setAttribute('aria-label', i18n.darkModeToggle);

        // Set up initial tab state
        switchTab('summary');
    }

    // --- Event Listeners and Initial Setup ---

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize dark mode first
        initializeDarkMode();

        // Apply text content
        applyLocalization();

        // Add event listeners for dark mode
        darkModeToggle.addEventListener('click', toggleDarkMode);

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Set initial state of the score button
        document.getElementById('scoreButton').disabled = true;

    });

</script>
{% endblock %}