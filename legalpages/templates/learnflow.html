{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}


{% block content %}
<main class="min-h-screen bg-background-dark text-text-light p-4 sm:p-6 lg:p-8 dark">
    <div class="max-w-7xl mx-auto">
        
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <header class="text-center py-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-light mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-blue to-blue-start">LearnFlow AI</span> Video Analysis
            </h1>
            <p class="text-sm sm:text-lg text-text-muted">Generate summaries, quizzes, and study guides from any YouTube video instantly.</p>
        </header>

        <div class="bg-card-dark p-6 rounded-xl shadow-2xl mb-8">
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label for="videoLink" class="block text-sm font-medium text-text-light mb-2">YouTube Video Link</label>
                    <input type="url" id="videoLink" name="videoLink" 
                        class="w-full px-4 py-2 border border-border-dark bg-input-dark rounded-lg text-text-light focus:ring-primary-blue focus:border-primary-blue" 
                        placeholder="e.g., https://www.youtube.com/watch?v=..."
                        value="{% if video_id %}https://www.youtube.com/watch?v={{ video_id }}{% endif %}">
                </div>
                <button id="analyzeButton" 
                    class="w-full sm:w-auto px-6 py-2 bg-primary-blue text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    onclick="analyzeVideo()" disabled>
                    Analyze Video
                </button>
            </div>

            <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center" style="display: none;"></div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                
                <div id="playerContainer" class="w-full bg-black rounded-xl overflow-hidden shadow-lg" style="height: 400px;">
                    <p class="text-center p-4 text-text-muted">Enter a link and click 'Analyze Video' to load the player and content.</p>
                </div>

                <div class="bg-card-dark p-4 rounded-xl shadow-lg">
                    <div class="flex border-b border-border-dark mb-4">
                        <button class="tab-button flex-1 py-3 text-lg font-medium transition-colors duration-200" data-tab="summary">
                            <i class="fas fa-list-alt mr-2"></i>Summary
                        </button>
                        <button class="tab-button flex-1 py-3 text-lg font-medium transition-colors duration-200" data-tab="quiz">
                            <i class="fas fa-question-circle mr-2"></i>Quiz
                        </button>
                    </div>

                    <div id="summary-tab" class="tab-content space-y-4">
                        <h2 class="text-xl font-bold text-primary-blue">Generated Summary</h2>
                        <div id="summary-content" class="text-text-muted leading-relaxed prose prose-invert max-w-none">
                            <p>Analysis results will appear here after the video is processed.</p>
                        </div>
                    </div>

                    <div id="quiz-tab" class="tab-content space-y-4 hidden">
                        <h2 class="text-xl font-bold text-primary-blue">Interactive Quiz</h2>
                        <form id="quiz-form" class="space-y-6">
                            <div id="quiz-content" class="space-y-6">
                                <p class="text-text-muted">Quiz questions will load here.</p>
                            </div>
                            <div class="flex justify-between items-center pt-4 border-t border-border-dark">
                                <span id="quiz-score" class="text-lg font-semibold text-text-light hidden">Score: N/A</span>
                                <button type="button" id="scoreButton" onclick="submitQuiz()" 
                                    class="px-6 py-2 bg-accent-orange text-white font-semibold rounded-lg hover:bg-orange-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                                    disabled>
                                    Score Quiz
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                
                <div class="bg-card-dark p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-primary-blue mb-4">Study Guide & Export</h2>
                    <p class="text-text-muted mb-4 text-sm">Create a printable PDF of your summary and quiz results.</p>
                    
                    <button id="exportButton" onclick="submitQuiz()" 
                        class="w-full px-6 py-3 bg-success-green text-white font-semibold rounded-lg hover:bg-green-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center"
                        disabled>
                        <i class="fas fa-file-pdf mr-2"></i> Generate & Download PDF
                    </button>
                    <p id="export-status" class="text-center mt-3 text-sm text-text-muted hidden">Generating PDF...</p>
                </div>

                <div class="bg-card-dark p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-primary-blue mb-4">Key Features</h2>
                    <ul class="space-y-3 text-text-muted text-sm">
                        <li class="flex items-start"><i class="fas fa-microchip text-accent-orange mr-3 mt-1"></i> AI-Powered Summaries (Gemini)</li>
                        <li class="flex items-start"><i class="fas fa-tasks text-accent-orange mr-3 mt-1"></i> Auto-Generated Quizzes</li>
                        <li class="flex items-start"><i class="fas fa-file-download text-accent-orange mr-3 mt-1"></i> Downloadable Study Guides (PDF)</li>
                        <li class="flex items-start"><i class="fas fa-code text-accent-orange mr-3 mt-1"></i> Open-Source & Community Driven</li>
                    </ul>
                    <p class="text-xs text-center text-text-faded mt-6 italic">Analysis quality is dependent on the clarity and language of the video's transcript.</p>
                </div>

            </div>
        </div>

    </div>
</main>
{% endblock %}

{% block extra_body %}
<script>
    // ----------------------------------------------------------------------------------
    // --- FIX APPLIED HERE: Using {% url %} to resolve 404 Not Found error            ---
    // The {% url %} tag correctly builds the full path (e.g., '/legal/api/analyze_video/').
    // ----------------------------------------------------------------------------------
    const ANALYZE_VIDEO_API_URL = "{% url 'legalpages:api_analyze_video' %}";
    const SUBMIT_QUIZ_API_URL = "{% url 'legalpages:api_submit_quiz' %}";
    // ----------------------------------------------------------------------------------

    // Helper function to get the CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- State and UI Management Functions ---
    const csrftoken = getCookie('csrftoken');
    const playerContainer = document.getElementById('playerContainer');
    const videoLinkInput = document.getElementById('videoLink');
    const analyzeButton = document.getElementById('analyzeButton');
    const scoreButton = document.getElementById('scoreButton');
    const exportButton = document.getElementById('exportButton');

    // Parses the YouTube video ID from a link
    function get_video_id(url) {
        if (url.startsWith('https://www.youtube.com/embed/')) {
            return url.split('/').pop().split('?')[0];
        }

        const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        
        if (match && match[2].length === 11) {
            return match[2];
        }
        return null;
    }

    // Manages the tab view
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-primary-blue', 'text-text-light');
            button.classList.add('border-transparent', 'text-text-muted');
        });

        document.getElementById(tabId + '-tab').classList.remove('hidden');
        document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.remove('border-transparent', 'text-text-muted');
        document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('border-primary-blue', 'text-text-light', 'border-b-2');
    }

    // Manages the analysis status messages
    function updateStatus(type, message) {
        const statusElement = document.getElementById('statusMessage');
        statusElement.style.display = 'block';
        statusElement.textContent = message;
        
        statusElement.classList.remove('bg-yellow-900', 'text-yellow-300', 'bg-green-900', 'text-green-300', 'bg-red-900', 'text-red-300');

        if (type === 'loading') {
            statusElement.classList.add('bg-yellow-900', 'text-yellow-300');
        } else if (type === 'success') {
            statusElement.classList.add('bg-green-900', 'text-green-300');
        } else if (type === 'error') {
            statusElement.classList.add('bg-red-900', 'text-red-300');
        }
    }

    // Manages button states
    function setAnalysisState(isAnalyzing, isAnalyzed) {
        analyzeButton.disabled = isAnalyzing;
        videoLinkInput.disabled = isAnalyzing;
        scoreButton.disabled = isAnalyzing || !isAnalyzed;
        exportButton.disabled = isAnalyzing || !isAnalyzed;
        
        if (isAnalyzing) {
            analyzeButton.textContent = 'Analyzing...';
            scoreButton.textContent = 'Scoring...';
            exportButton.textContent = 'Generating PDF...';
        } else {
            analyzeButton.textContent = 'Analyze Video';
            scoreButton.textContent = 'Score Quiz';
            if (isAnalyzed) {
                 exportButton.textContent = 'Download Study Guide';
            } else {
                exportButton.textContent = 'Generate & Download PDF';
            }
        }
    }


    // --- Main Functions (Using Updated URL Constants) ---

    // 1. ANALYZE VIDEO FUNCTION
    async function analyzeVideo() {
        setAnalysisState(true, false);
        document.getElementById('quiz-score').classList.add('hidden');
        document.getElementById('summary-content').innerHTML = '<p class="text-text-muted">Analysis results will appear here after the video is processed.</p>';
        document.getElementById('quiz-content').innerHTML = '<p class="text-text-muted">Quiz questions will load here.</p>';
        switchTab('summary');
        
        const videoId = get_video_id(videoLinkInput.value);
        if (!videoId) {
            updateStatus('error', 'Please enter a valid YouTube link.');
            setAnalysisState(false, false);
            return;
        }

        // Set the video player source
        playerContainer.innerHTML = `<iframe width="100%" height="400" src="https://www.youtube.com/embed/${videoId}?autoplay=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        
        try {
            updateStatus('loading', 'Analyzing video and generating summary/quiz... This may take up to 30 seconds.');

            const response = await fetch(ANALYZE_VIDEO_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ video_id: videoId })
            });

            const data = await response.json();

            if (response.ok) {
                const sanitizedSummary = DOMPurify.sanitize(data.summary_markdown);
                document.getElementById('summary-content').innerHTML = marked.parse(sanitizedSummary);
                document.getElementById('quiz-content').innerHTML = data.quiz_html;
                
                updateStatus('success', 'Analysis complete! Check the Summary and Quiz tabs.');
                setAnalysisState(false, true);
            } else {
                updateStatus('error', `Analysis failed: ${data.message || 'An unknown error occurred.'}`);
                setAnalysisState(false, false);
            }

        } catch (error) {
            console.error('Fetch error:', error);
            updateStatus('error', 'A network error occurred. Please check your connection or try again.');
            setAnalysisState(false, false);
        }
    }

    // 2. SUBMIT QUIZ FUNCTION
    async function submitQuiz() {
        setAnalysisState(true, true);
        document.getElementById('export-status').classList.remove('hidden');

        const videoId = get_video_id(videoLinkInput.value);
        if (!videoId) return;

        // Collect quiz data
        const quizForm = document.getElementById('quiz-form');
        const quizData = [];
        const questionElements = quizForm.querySelectorAll('.quiz-question');

        questionElements.forEach((qElement, index) => {
            const questionId = qElement.dataset.questionId;
            const type = qElement.dataset.questionType;
            let userAnswer = null;

            if (type === 'multiple_choice') {
                const checkedRadio = qElement.querySelector('input[type="radio"]:checked');
                userAnswer = checkedRadio ? checkedRadio.value : null;
            } else if (type === 'fill_in_the_blank') {
                userAnswer = qElement.querySelector('input[type="text"]').value;
            }

            quizData.push({
                question_id: questionId,
                user_answer: userAnswer
            });
        });

        try {
            const response = await fetch(SUBMIT_QUIZ_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ 
                    quiz_data: quizData,
                    video_id: videoId,
                    summary_html: document.getElementById('summary-content').innerHTML
                })
            });

            // Check for PDF file in response headers
            if (response.headers.get('Content-Type') === 'application/pdf') {
                const blob = await response.blob();
                const scoreHeader = response.headers.get('X-Quiz-Score');
                const scoreDisplay = document.getElementById('quiz-score');

                if (scoreHeader) {
                    scoreDisplay.textContent = `Final Score: ${scoreHeader}`;
                    scoreDisplay.classList.remove('hidden');
                } else {
                    scoreDisplay.textContent = `Final Score: Scored`;
                    scoreDisplay.classList.remove('hidden');
                }

                // Download PDF
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `LearnFlow_Study_Guide_${videoId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                updateStatus('success', 'Quiz scored and Study Guide PDF downloaded successfully!');
                setAnalysisState(false, true);
                document.getElementById('export-status').classList.add('hidden');

            } else {
                // Handle JSON response for scoring only
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('quiz-content').innerHTML = data.quiz_html_with_answers;
                    
                    const scoreDisplay = document.getElementById('quiz-score');
                    scoreDisplay.textContent = `Final Score: ${data.final_score}/${data.total_questions}`;
                    scoreDisplay.classList.remove('hidden');
                    
                    updateStatus('success', 'Quiz scored! Check the Quiz tab for results and explanations.');
                    setAnalysisState(false, true);
                    document.getElementById('export-status').classList.add('hidden');
                } else {
                    updateStatus('error', `Scoring failed: ${data.message || 'An unknown error occurred.'}`);
                    setAnalysisState(false, true);
                    document.getElementById('export-status').classList.add('hidden');
                }
            }

        } catch (error) {
            console.error('Fetch error:', error);
            updateStatus('error', 'A network error occurred during scoring or PDF generation. Please check your connection or try again.');
            setAnalysisState(false, true);
            document.getElementById('export-status').classList.add('hidden');
        }
    }


    // --- Page Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const videoLinkInput = document.getElementById('videoLink');
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        
        switchTab('summary');

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Enable analyze button if input has text
        videoLinkInput.addEventListener('input', () => {
            analyzeButton.disabled = videoLinkInput.value.trim().length === 0;
        });

        if (analyzeButton) analyzeButton.addEventListener('click', analyzeVideo);
        if (scoreButton) scoreButton.addEventListener('click', submitQuiz);
        if (exportButton) exportButton.addEventListener('click', submitQuiz); 
        
        // Auto-trigger analysis if a video ID was pre-selected (Django context)
        if (videoLinkInput && videoLinkInput.value.startsWith('https://www.youtube.com')) {
            setTimeout(analyzeVideo, 100); 
        } else {
             setAnalysisState(false, false); 
        }
    });

</script>
{% endblock %}