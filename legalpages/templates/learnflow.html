{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-9564790727166506",
            enable_page_level_ads: true
        });
    </script>
    <script async src="https://fundingchoicesmessages.google.com/i/pub-9564790727166506?fc_cmp_id=9649739487"></script>
    <script>
        window.__fundingChoicesConfig = {
            ui: {
                locale: 'en'
            }
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}


{% block content %}
<main class="min-h-screen bg-background-dark text-text-light p-4 sm:p-6 lg:p-8 dark">
    <div class="max-w-7xl mx-auto">
        
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <header class="text-center py-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-light mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-blue to-blue-start">LearnFlow AI</span> Video Analysis
            </h1>
            <p class="text-lg text-text-muted">
                Paste a YouTube URL to instantly generate a summary and educational quiz.
            </p>
        </header>

        <div class="bg-background-light shadow-xl rounded-lg p-6 lg:p-8 mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow">
                    <label for="videoLink" class="block text-sm font-medium text-text-muted mb-1">YouTube Video URL</label>
                    <input type="url" id="videoLink" 
                           class="w-full border-gray-600 bg-background-dark text-text-light rounded-md shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue"
                           placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                           value="{% if pre_selected_video_id %}https://www.youtube.com/watch?v={{ pre_selected_video_id }}{% endif %}"
                           required>
                </div>
                
                <button id="analyzeButton" 
                        class="w-full md:w-auto px-6 py-3 bg-primary-blue text-text-light font-semibold rounded-md shadow-lg hover:bg-hover-blue transition duration-200 flex justify-center items-center">
                    <span id="analyzeButtonText">Analyze Video</span>
                    <svg id="loadingIndicator" class="hidden animate-spin h-5 w-5 text-text-light ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="statusMessage" class="hidden p-3 mb-6 text-sm rounded-lg font-medium text-center" role="alert">
            Status will appear here.
        </div>

        <div id="analysisContent" class="hidden grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div class="md:col-span-1 bg-background-light shadow-xl rounded-lg overflow-hidden h-fit">
                <div id="videoPlayer" class="w-full aspect-video bg-background-dark flex items-center justify-center">
                    <p class="text-text-muted p-4">Video Player will load here...</p>
                </div>
                <div class="p-4 border-t border-gray-700">
                    <h3 class="text-xl font-semibold mb-3 text-text-light">Actions</h3>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <button id="scoreButton" 
                                class="flex-1 px-4 py-2 bg-success-green text-text-light font-semibold rounded-md shadow-md hover:bg-green-700 transition duration-200" disabled>
                            Score Quiz
                        </button>
                        <button id="exportButton" 
                                class="flex-1 px-4 py-2 bg-gray-500 text-text-light font-semibold rounded-md shadow-md hover:bg-gray-600 transition duration-200" disabled>
                            Export (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 bg-background-light shadow-xl rounded-lg p-6">
                
                <div class="border-b border-gray-700 mb-4 flex space-x-4">
                    <button class="tab-button pb-2 border-b-2 text-text-muted hover:text-primary-blue" data-tab="summary">
                        Summary
                    </button>
                    <button class="tab-button pb-2 border-b-2 text-text-muted hover:text-primary-blue" data-tab="quiz">
                        Quiz
                    </button>
                    <button class="tab-button pb-2 border-b-2 text-text-muted hover:text-primary-blue" data-tab="transcript">
                        Notes/Analysis
                    </button>
                </div>

                <div class="h-[70vh] md:h-[65vh] overflow-y-auto pr-2"> 
                    <div id="summaryTabContent" class="tab-content prose prose-invert max-w-none text-text-light">
                        </div>
                    
                    <div id="quizTabContent" class="tab-content hidden space-y-4">
                        </div>

                    <div id="transcriptTabContent" class="tab-content hidden prose prose-invert max-w-none text-text-light">
                        </div>
                </div>
            </div>

        </div>
    </div>
</main>
{% endblock %}

{% block extra_body %}
<script>
    // --- Global State ---
    let quizData = [];
    let videoId = null;

    /**
     * Retrieves the CSRF token from the hidden input field.
     */
    function getCsrfToken() {
        // CRITICAL FIX: Get token from the hidden field added in the HTML body
        const tokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return tokenElement ? tokenElement.value : '';
    }

    /**
     * Extracts the YouTube video ID from a URL.
     */
    function extractVideoId(url) {
        try {
            const urlObj = new URL(url);
            const urlParams = new URLSearchParams(urlObj.search);
            let id = urlParams.get('v');

            if (!id && urlObj.hostname.includes('youtu.be')) {
                // Handle youtu.be/VIDEO_ID format
                const pathParts = urlObj.pathname.split('/');
                if (pathParts.length > 1) {
                     id = pathParts[1].split('?')[0]; // Get the path segment and strip query
                }
            }
            return id;
        } catch (e) {
            return null; // Handle malformed URLs gracefully
        }
    }
    
    /**
     * Toggles the UI state for analysis (loading vs. ready).
     *
     * @param {boolean} isLoading - True to set loading state, False to set ready state.
     * @param {boolean} analysisAvailable - True if analysis data (quiz, summary) is available.
     */
    function setAnalysisState(isLoading, analysisAvailable = false) {
        const analyzeButton = document.getElementById('analyzeButton');
        const videoLinkInput = document.getElementById('videoLink');
        const analyzeButtonText = document.getElementById('analyzeButtonText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        const statusMessage = document.getElementById('statusMessage');

        if (analyzeButton) analyzeButton.disabled = isLoading;
        if (videoLinkInput) videoLinkInput.disabled = isLoading;
        
        // Correctly manage quiz action buttons
        const canActOnQuiz = analysisAvailable && !isLoading;

        if (scoreButton) scoreButton.disabled = !canActOnQuiz;
        if (exportButton) exportButton.disabled = !canActOnQuiz;
        

        if (isLoading) {
            if (analyzeButtonText) analyzeButtonText.textContent = 'Analyzing...';
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            if (statusMessage) statusMessage.classList.add('hidden');
            // Do not hide analysisContentDiv here, only when a *new* analysis starts in analyzeVideo
        } else {
            if (analyzeButtonText) analyzeButtonText.textContent = 'Analyze Video';
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        }
    }

    /**
     * Displays a status message (success or error).
     */
    function displayStatus(message, type = 'success') {
        const statusMessage = document.getElementById('statusMessage');
        if (!statusMessage) return;

        statusMessage.textContent = message;
        // Reset classes
        statusMessage.className = 'p-3 mb-6 text-sm rounded-lg font-medium text-center'; 
        
        // NOTE: The Tailwind classes here rely on the color palette from the original config. 
        // If the default CDN doesn't support them, the colors may look slightly off.
        if (type === 'error') {
            statusMessage.classList.add('bg-red-900', 'text-error-red', 'border', 'border-error-red');
        } else if (type === 'success') {
            statusMessage.classList.add('bg-green-900', 'text-success-green', 'border', 'border-success-green');
        } else if (type === 'warning') {
            statusMessage.classList.add('bg-yellow-900', 'text-yellow-400', 'border', 'border-yellow-400');
        }
        statusMessage.classList.remove('hidden');
    }

    /**
     * Renders the YouTube video player.
     */
    function renderVideoPlayer(id) {
        const videoPlayer = document.getElementById('videoPlayer');
        if (!videoPlayer) return;

        videoPlayer.innerHTML = `
            <iframe 
                class="w-full h-full" 
                src="https://www.youtube.com/embed/${id}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
            </iframe>
        `;
    }

    /**
     * Renders markdown content safely.
     */
    function renderMarkdown(content, element) {
        if (!element) return;
        // marked.js converts Markdown to HTML, DOMPurify sanitizes it
        const rawHtml = marked.parse(content);
        element.innerHTML = DOMPurify.sanitize(rawHtml);
    }

    /**
     * Renders the Quiz UI from the generated JSON data.
     */
    function renderQuiz(questions) {
        quizData = questions; // Store globally for scoring
        const quizTabContent = document.getElementById('quizTabContent');
        const quizHtml = questions.map((q, index) => {
            if (q.type === 'MCQ') {
                const optionsHtml = (q.options || []).map((option, optIndex) => `
                    <div class="flex items-center space-x-3">
                        <input id="q${index}opt${optIndex}" name="q${index}" type="radio" value="${optIndex}" 
                            class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-600 bg-gray-900">
                        <label for="q${index}opt${optIndex}" class="text-sm font-medium text-white">${option}</label>
                    </div>
                `).join('');
                return `
                    <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700">
                        <p class="font-semibold text-lg mb-3 text-white">${index + 1}. (MCQ) ${q.question}</p>
                        <div class="space-y-2 ml-4">${optionsHtml}</div>
                    </div>
                `;
            } else if (q.type === 'ShortAnswer') {
                return `
                    <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700">
                        <p class="font-semibold text-lg mb-3 text-white">${index + 1}. (Short Answer) ${q.question}</p>
                        <textarea id="q${index}ans" name="q${index}" rows="2" 
                            class="mt-1 block w-full rounded-md border-gray-600 shadow-sm p-2 bg-gray-700 text-white" 
                            placeholder="Type your answer here..."></textarea>
                    </div>
                `;
            }
        }).join('<div class="h-4"></div>'); // Spacer

        if (quizTabContent) quizTabContent.innerHTML = quizHtml;
        setAnalysisState(false, quizData.length > 0); // Enable score button if quiz is ready
    }

    /**
     * Switches the active content tab.
     */
    function switchTab(tabName) {
        // Hide all content divs
        document.querySelectorAll('.tab-content').forEach(div => {
            div.classList.add('hidden');
        });
        // Remove active styling from all buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-blue-500', 'text-blue-500', 'font-semibold');
            button.classList.add('border-transparent', 'text-gray-400');
        });

        // Show the selected content
        const contentDiv = document.getElementById(`${tabName}TabContent`);
        if (contentDiv) contentDiv.classList.remove('hidden');
        
        // Add active styling to the selected button
        const activeTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
        if (activeTabButton) {
            activeTabButton.classList.remove('border-transparent', 'text-gray-400');
            activeTabButton.classList.add('border-blue-500', 'text-blue-500', 'font-semibold');
        }
    }

    /**
     * CORE FUNCTION: Fetches the video analysis from the server API.
     */
    async function analyzeVideo() {
        const videoLinkInput = document.getElementById('videoLink');
        const summaryTabContent = document.getElementById('summaryTabContent');
        const quizTabContent = document.getElementById('quizTabContent');
        const transcriptTabContent = document.getElementById('transcriptTabContent');
        const analysisContentDiv = document.getElementById('analysisContent');

        if (!videoLinkInput) return; // Exit if input not found

        const videoUrl = videoLinkInput.value.trim();
        videoId = extractVideoId(videoUrl);

        if (!videoId || videoUrl.length < 5) {
            displayStatus('Please enter a valid YouTube video URL.', 'error');
            setAnalysisState(false, false); // Reset buttons
            return;
        }

        setAnalysisState(true, false);
        displayStatus(`Starting analysis for video ID: ${videoId}. This may take up to a minute for long videos...`, 'warning');
        
        // Clear previous content
        quizData = [];
        if (summaryTabContent) summaryTabContent.innerHTML = '';
        if (quizTabContent) quizTabContent.innerHTML = '';
        if (transcriptTabContent) transcriptTabContent.innerHTML = '';
        if (analysisContentDiv) analysisContentDiv.classList.add('hidden');


        try {
            const response = await fetch('/api/analyze_video/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    // CRITICAL FIX: Add CSRF token header
                    'X-CSRFToken': getCsrfToken() 
                },
                body: JSON.stringify({ video_url: videoUrl, video_id: videoId })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.message || `Server responded with status ${response.status}`);
            }

            const data = await response.json();
            const quizIsReady = Array.isArray(data.quiz_questions) && data.quiz_questions.length > 0;

            // 1. Render Video
            renderVideoPlayer(videoId);

            // 2. Render Summary
            renderMarkdown(data.summary, summaryTabContent);

            // 3. Render Quiz
            renderQuiz(data.quiz_questions); // This internally updates setAnalysisState(false, true) if quiz is ready

            // 4. Render Transcript / Analysis
            const transcriptContent = data.transcript || '';
            
            if (data.gemini_generated_analysis) {
                renderMarkdown(`## Gemini-Generated Analysis (Transcript Unavailable) \n\n ${data.gemini_generated_analysis}`, transcriptTabContent);
            } else if (transcriptContent.startsWith('NON_ENGLISH_TRANSCRIPT:')) {
                const parts = transcriptContent.split(':', 3);
                const lang = parts[1];
                const text = parts[2];
                renderMarkdown(`## Full Transcript (Non-English: ${lang}) \n\n ${text}`, transcriptTabContent);
            } else if (transcriptContent === 'NO_TRANSCRIPT_FALLBACK' || !transcriptContent) {
                renderMarkdown('## Transcript Unavailable \n\n A machine-readable transcript could not be found for this video. The summary and quiz were generated primarily from video title and description.', transcriptTabContent);
            }
            else {
                 renderMarkdown(`## Full Transcript \n\n ${transcriptContent}`, transcriptTabContent);
            }

            // Show results
            if (analysisContentDiv) analysisContentDiv.classList.remove('hidden');
            displayStatus('Analysis complete! Summary and Quiz are ready.', 'success');
            switchTab('summary'); // Start on the Summary tab
            
            // Final state update (redundant if renderQuiz worked, but safer)
            setAnalysisState(false, quizIsReady); 

        } catch (error) {
            console.error('Analysis failed:', error);
            // Client-side message for server/network errors
            displayStatus(`Analysis Failed: ${error.message || 'The server or AI service timed out.'}`, 'error');
            setAnalysisState(false, false); // Reset buttons on error
        }
    }


    /**
     * Submits the quiz answers and initiates the PDF report download.
     */
    async function submitQuiz() {
        if (quizData.length === 0) {
            displayStatus('Please analyze a video and wait for the quiz to generate.', 'warning');
            return;
        }

        // Set loading state, but remember analysis is available
        setAnalysisState(true, true); 
        displayStatus('Scoring quiz and generating PDF report...', 'warning');

        const answers = {};
        let answeredCount = 0;

        // 1. Collect user answers
        quizData.forEach((q, index) => {
            const qId = index.toString();
            if (q.type === 'MCQ') {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                answers[qId] = selected ? selected.value : null;
                if (selected) answeredCount++;
            } else if (q.type === 'ShortAnswer') {
                const input = document.getElementById(`q${index}ans`);
                answers[qId] = input ? input.value.trim() : '';
                if (answers[qId]) answeredCount++;
            }
        });

        if (answeredCount < quizData.length) {
             // Allow submission even if not all answered, but give a warning
             displayStatus(`Warning: You only answered ${answeredCount}/${quizData.length} questions. Generating report...`, 'warning');
        }

        try {
            const response = await fetch('/api/submit_quiz/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    // CRITICAL FIX: Add CSRF token header
                    'X-CSRFToken': getCsrfToken() 
                },
                body: JSON.stringify({ video_id: videoId, quiz_data: quizData, user_answers: answers })
            });

            if (!response.ok) {
                try {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(errorData.message || `Server responded with status ${response.status}`);
                } catch {
                    throw new Error(`Server responded with status ${response.status}. Could not generate PDF report.`);
                }
            }

            // 2. Handle PDF file download
            const scoreHeader = response.headers.get('X-Quiz-Score');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const contentDisposition = response.headers.get('Content-Disposition');
            
            let filename = `LearnFlow_AI_Report_${videoId}.pdf`;
            if (contentDisposition && contentDisposition.indexOf('filename=') !== -1) {
                filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
            }

            // Trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url); 

            if (scoreHeader) {
                displayStatus(`Quiz Scored! Your final score is ${scoreHeader}. PDF report downloaded.`, 'success');
            } else {
                displayStatus('PDF report downloaded successfully.', 'success');
            }
            
        } catch (error) {
            console.error('Submission failed:', error);
            displayStatus(`Submission Failed: ${error.message || 'An unknown error occurred during scoring/report generation.'}`, 'error');
        } finally {
            // Re-enable quiz buttons after submission completes/fails
            setAnalysisState(false, quizData.length > 0); 
        }
    }


    // --- Event Listeners and Initial Setup (The CSP FIX) ---

    document.addEventListener('DOMContentLoaded', () => {
        
        // Ensure event listeners are attached only once, to the correct elements.
        const videoLinkInput = document.getElementById('videoLink');
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        
        // Initial tab state
        switchTab('summary');

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add the main event listeners
        if (analyzeButton) analyzeButton.addEventListener('click', analyzeVideo);
        if (scoreButton) scoreButton.addEventListener('click', submitQuiz);
        // Both buttons perform the submit_quiz logic, which generates the PDF.
        if (exportButton) exportButton.addEventListener('click', submitQuiz); 
        
        // Auto-trigger analysis if a video ID was pre-selected (Django context)
        if (videoLinkInput && videoLinkInput.value.startsWith('https://www.youtube.com')) {
            // This setTimeout is safe because it uses a function reference (analyzeVideo), 
            // not a string argument, avoiding the eval() call.
            setTimeout(analyzeVideo, 100); 
        } else {
             // Ensure buttons are disabled initially if no video is pre-loaded
             setAnalysisState(false, false); 
        }
    });

</script>
{% endblock %}