{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class on the html tag
            theme: {
                extend: {
                    fontFamily: {
                        // Using Inter as the default font
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // PRIMARY COLORS (Brighter for better button contrast)
                        'primary-blue': '#1e40ff', // A strong, modern blue
                        'hover-blue': '#1c3ade',   // Slightly darker hover
                        
                        // BACKGROUNDS & TEXT (CRITICAL for contrast fix)
                        'background-light': '#f7f7f9', // Very light gray
                        'background-dark': '#0d0d1e', // Very dark blue-black for high contrast
                        'error-red': '#d93025',
                    },
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>

    <style>
        /* Custom styles for active tab button */
        .tab-button {
            padding: 10px 16px;
            font-weight: 500;
            border-bottom-width: 2px;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .tab-active {
            border-color: #1e40ff; /* primary-blue */
            color: #1e40ff; /* primary-blue */
            background-color: #ffffff;
        }
        .dark .tab-active {
            border-color: #3b82f6; /* Tailwind blue-500 for visibility */
            color: #3b82f6;
            background-color: transparent;
        }
        /* Ensure all text in the main container has good default contrast */
        .content-section {
            color: #1f2937; /* Dark text for light mode */
        }
        .dark .content-section {
            color: #f3f4f6; /* Light gray text for dark mode */
        }
    </style>
{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto font-sans p-4 md:p-8 min-h-screen rounded-lg shadow-xl
                bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100"> <h1 id="mainTitle" class="text-3xl font-extrabold text-primary-blue dark:text-blue-400 mb-6">
            Video Analysis & Study Kit ðŸš€
        </h1>
        
        {% csrf_token %}

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8 border border-gray-200 dark:border-gray-700">
            <h2 id="inputTitle" class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Enter YouTube Video Link</h2>
            <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
                <input
                    type="url"
                    id="youtubeLink"
                    placeholder="E.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                    class="flex-grow p-3 border border-gray-300 rounded-lg 
                           focus:ring-primary-blue focus:border-primary-blue 
                           dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                />
                <button
                    id="analyzeButton"
                    onclick="startAnalysis()"
                    class="bg-primary-blue hover:bg-hover-blue text-white font-bold py-3 px-6 rounded-lg 
                           transition duration-200 ease-in-out transform hover:scale-105 
                           disabled:opacity-40 disabled:hover:scale-100"
                >
                    <span id="analyzeButtonText">Analyze Video</span>
                </button>
            </div>
            <div id="errorMessage" class="text-error-red mt-3 hidden text-sm font-medium"></div>
        </div>

        <div id="loadingIndicator" class="hidden text-center p-6 bg-yellow-50 dark:bg-gray-900 rounded-xl shadow-md border border-yellow-200 dark:border-yellow-700 mb-8">
            <svg class="animate-spin h-5 w-5 text-primary-blue mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loadingText" class="text-gray-700 dark:text-gray-300 font-semibold">Generating Summary & Quiz...</span>
            <div id="currentTask" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></div>
        </div>

        <div id="resultContainer" class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">

            <div class="flex border-b border-gray-200 dark:border-gray-700 overflow-x-auto">
                <button id="tab_summary" data-tab="summary" class="tab-button border-transparent text-gray-500 dark:text-gray-400 dark:hover:text-blue-400 hover:text-primary-blue">Summary</button>
                <button id="tab_quiz" data-tab="quiz" class="tab-button border-transparent text-gray-500 dark:text-gray-400 dark:hover:text-blue-400 hover:text-primary-blue">Quiz</button>
                <button id="tab_transcript" data-tab="transcript" class="tab-button border-transparent text-gray-500 dark:text-gray-400 dark:hover:text-blue-400 hover:text-primary-blue">Transcript Status</button>

                <div class="ml-auto flex space-x-2 p-2">
                    <button
                        id="scoreButton"
                        onclick="scoreQuiz()"
                        class="hidden bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:hover:scale-100"
                    >
                        <span id="scoreButtonText">Score Quiz</span>
                    </button>
                    <button
                        id="exportButton"
                        onclick="exportPDF()"
                        class="bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg text-sm transition duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50"
                        disabled
                    >
                        <span id="exportButtonText">Export PDF</span>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <div id="summaryContent" data-tab-content="summary" class="content-section prose dark:prose-invert max-w-none">
                    <p id="summaryPlaceholder" class="text-gray-500 dark:text-gray-400 italic">Enter a YouTube link and click 'Analyze Video' to generate a summary.</p>
                </div>

                <div id="quizContent" data-tab-content="quiz" class="content-section">
                    <div id="quizForm">
                        <p id="quizPlaceholder" class="text-gray-500 dark:text-gray-400 italic">A quiz will be generated here after the video analysis.</p>
                    </div>
                    <div id="quizResults" class="mt-6 p-4 rounded-lg bg-green-100 dark:bg-green-900 border border-green-300 dark:border-green-700 hidden">
                        <h3 id="quizResultsTitle" class="text-lg font-bold text-green-800 dark:text-green-200 mb-2">Quiz Results</h3>
                        <p id="quizScoreText" class="text-green-700 dark:text-green-300"></p>
                    </div>
                </div>

                <div id="transcriptContent" data-tab-content="transcript" class="content-section max-h-96 overflow-y-auto">
                    <p id="transcriptPlaceholder" class="text-gray-500 dark:text-gray-400 italic">The full video transcript will appear here.</p>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
            <span id="feedbackPromptText">Found an issue or have feedback?</span>
            <a id="feedbackLink" href="https://github.com/jdepoix/youtube-transcript-api/issues" target="_blank" class="text-primary-blue hover:text-hover-blue ml-1">Report it here.</a>
        </div>


    </div>

    <script>
        // NOTE: We assume jQuery is available or loaded by the base.html template.
        let currentQuizData = []; // Global variable to store quiz questions and answers
        let currentVideoID = null; // Global variable for the video ID
        
        // Global scope for jsPDF, defined in the extra_head block
        const { jsPDF } = window.jspdf;

        function switchTab(targetTab) {
            // Tab Button Logic
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active');
                button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'dark:hover:text-blue-400', 'hover:text-primary-blue');
            });
            const activeTabButton = document.getElementById(`tab_${targetTab}`);
            if (activeTabButton) {
                activeTabButton.classList.add('tab-active');
                activeTabButton.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'dark:hover:text-blue-400', 'hover:text-primary-blue');
            }

            // Content Pane Logic
            document.querySelectorAll('[data-tab-content]').forEach(content => {
                content.classList.add('hidden');
            });
            const activeContent = document.getElementById(`${targetTab}Content`);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }

            // Show/hide score button based on 'quiz' tab
            const scoreButton = document.getElementById('scoreButton');
            if (targetTab === 'quiz' && currentQuizData.length > 0) {
                scoreButton.classList.remove('hidden');
            } else {
                scoreButton.classList.add('hidden');
            }
        }

        function displayError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('analyzeButton').disabled = false;
        }

        function renderQuiz(quizData) {
            const quizForm = document.getElementById('quizForm');
            quizForm.innerHTML = ''; // Clear any previous content

            if (quizData.length === 0) {
                quizForm.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">The AI could not generate any questions for this content.</p>';
                document.getElementById('scoreButton').disabled = true;
                return;
            }

            currentQuizData = quizData;
            let quizHTML = '';

            quizData.forEach((q, index) => {
                // Background color for question block for visual separation
                quizHTML += `
                    <div class="mb-6 p-4 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                        <p class="font-bold text-gray-800 dark:text-gray-100 mb-3">Question ${index + 1}: ${q.question}</p>
                        <div class="space-y-2">
                `;
                // Use a copy of options to shuffle them without changing the source
                const options = [...q.options].sort(() => Math.random() - 0.5);

                options.forEach((option, optionIndex) => {
                    // Using a unique name for each question's radio group
                    const radioName = `q${index}`;
                    const radioId = `${radioName}o${optionIndex}`;

                    quizHTML += `
                        <label for="${radioId}" class="flex items-center text-gray-700 dark:text-gray-300 cursor-pointer p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                            <input type="radio" id="${radioId}" name="${radioName}" value="${option}" class="mr-3 text-primary-blue focus:ring-primary-blue">
                            <span>${option}</span>
                        </label>
                    `;
                });
                quizHTML += `
                        </div>
                        <div id="feedback_${index}" class="mt-2 text-sm font-medium hidden"></div>
                    </div>
                `;
            });

            quizForm.innerHTML = quizHTML;
            document.getElementById('scoreButton').disabled = false;
        }

        function renderResults(data) {
            // 1. Render Summary
            // Use marked (for markdown) and DOMPurify (for safety)
            const summaryHtml = DOMPurify.sanitize(marked.parse(data.summary));
            document.getElementById('summaryContent').innerHTML = summaryHtml;
            
            // 2. Render Quiz
            renderQuiz(data.quiz);

            // 3. Update Transcript placeholder/content
            const transcriptPlaceholder = document.getElementById('transcriptPlaceholder');
            const statusText = document.createElement('p');
            statusText.className = 'text-lg font-semibold';

            if (data.transcript_status === "FOUND") {
                statusText.textContent = "âœ… Transcript Found: The summary and quiz were generated directly from the video's full content.";
                statusText.classList.add('text-green-600', 'dark:text-green-400');
            } else {
                statusText.textContent = "âš ï¸ Transcript Not Found: The summary and quiz were generated based on the video URL and general topic metadata. Accuracy may vary.";
                statusText.classList.add('text-yellow-600', 'dark:text-yellow-400');
            }

            document.getElementById('transcriptContent').innerHTML = ''; // Clear old content
            document.getElementById('transcriptContent').appendChild(statusText);


            // 4. Update the export button state and show results
            document.getElementById('exportButton').disabled = false;
            document.getElementById('resultContainer').classList.remove('hidden');
            switchTab('summary'); // Switch to Summary tab by default

            // Set globals for PDF export/other uses
            currentVideoID = data.video_id;
        }


        function startAnalysis() {
            const linkInput = document.getElementById('youtubeLink');
            const link = linkInput.value.trim();
            
            // Reset state
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('scoreButton').classList.add('hidden');
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('analyzeButton').disabled = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingText').textContent = i18n.loadingText;

            if (!link) {
                displayError("Please enter a YouTube link.");
                return;
            }
            
            // Check for CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            if (!csrfToken) {
                displayError("CSRF token not found. Cannot proceed.");
                return;
            }

            // --- AJAX CALL ---
            // CRITICAL FIX: The URL name is now 'api_analyze_video' 
            $.ajax({
                url: "{% url 'legalpages:api_analyze_video' %}", 
                type: 'POST',
                data: {
                    'youtube_link': link,
                    // Pass the CSRF token in the data payload
                    'csrfmiddlewaretoken': csrfToken
                },
                success: function(data) {
                    document.getElementById('loadingIndicator').classList.add('hidden');
                    document.getElementById('analyzeButton').disabled = false;
                    
                    if (data.status === 'success') {
                        renderResults(data);
                    } else {
                        // Handle success but API-returned error (e.g., 400 or 500 from backend payload)
                        displayError("Analysis failed: " + (data.message || "An unknown error occurred."));
                    }
                },
                error: function(xhr, status, error) {
                    document.getElementById('loadingIndicator').classList.add('hidden');
                    document.getElementById('analyzeButton').disabled = false;

                    let errorMessage = "A network or server error occurred. Please check the URL and try again.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 404) {
                        errorMessage = "API endpoint not found (404). Check your Django routing.";
                    } else if (xhr.status === 500) {
                        errorMessage = "Internal Server Error (500). Check server logs for details.";
                    }
                    displayError(errorMessage);
                }
            });
        }

        function scoreQuiz() {
            // Hide previous feedback/results
            document.getElementById('quizResults').classList.add('hidden');
            document.querySelectorAll('[id^="feedback_"]').forEach(div => div.classList.add('hidden'));

            let correctCount = 0;
            const totalQuestions = currentQuizData.length;
            let allAnswered = true;

            currentQuizData.forEach((q, index) => {
                const radioName = `q${index}`;
                const feedbackDiv = document.getElementById(`feedback_${index}`);
                const selectedOption = document.querySelector(`input[name="${radioName}"]:checked`);
                
                // Reset feedback classes
                feedbackDiv.classList.remove('text-green-600', 'text-error-red', 'dark:text-green-400', 'dark:text-red-400');

                if (selectedOption) {
                    const isCorrect = selectedOption.value === q.answer;
                    
                    if (isCorrect) {
                        correctCount++;
                        feedbackDiv.textContent = 'âœ… Correct!';
                        feedbackDiv.classList.add('text-green-600', 'dark:text-green-400');
                    } else {
                        feedbackDiv.textContent = `âŒ Incorrect. The correct answer was: ${q.answer}`;
                        feedbackDiv.classList.add('text-error-red', 'dark:text-red-400');
                    }
                    feedbackDiv.classList.remove('hidden');
                } else {
                    allAnswered = false;
                }
            });
            
            if (!allAnswered) {
                // If not all questions are answered, show an error instead of a score
                displayError("Please answer all questions before scoring the quiz.");
                return;
            }

            // Hide the error message if it was shown due to un-answered questions
            document.getElementById('errorMessage').classList.add('hidden');


            // Display overall score
            const scoreText = document.getElementById('quizScoreText');
            const percentage = ((correctCount / totalQuestions) * 100).toFixed(0);
            scoreText.textContent = `You scored ${correctCount} out of ${totalQuestions} (${percentage}%)!`;
            
            // Update results box appearance based on score
            const resultsBox = document.getElementById('quizResults');
            resultsBox.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'border-green-300', 'border-red-300', 'dark:bg-green-900', 'dark:bg-red-900', 'dark:border-green-700', 'dark:border-red-700');
            
            if (percentage >= 70) {
                resultsBox.classList.add('bg-green-100', 'border-green-300', 'dark:bg-green-900', 'dark:border-green-700');
                document.getElementById('quizResultsTitle').textContent = "Quiz Results: Excellent! ðŸ†";
            } else {
                resultsBox.classList.add('bg-red-100', 'border-red-300', 'dark:bg-red-900', 'dark:border-red-700');
                document.getElementById('quizResultsTitle').textContent = "Quiz Results: Review Recommended ðŸ“˜";
            }
            resultsBox.classList.remove('hidden');
        }

        function exportPDF() {
            if (!currentVideoID) return;

            const doc = new jsPDF();
            const videoLink = document.getElementById('youtubeLink').value;
            const summaryContent = document.getElementById('summaryContent').innerText;
            
            doc.setFontSize(18);
            doc.text("LearnFlow AI - Video Analysis Report", 14, 20);

            doc.setFontSize(12);
            doc.text(`Video Link: ${videoLink}`, 14, 30);
            doc.text(`Video ID: ${currentVideoID}`, 14, 36);

            let y = 46;

            // Summary Section
            doc.setFontSize(14);
            doc.setTextColor(30, 115, 232); // primary-blue
            doc.text("Summary", 14, y);
            y += 7;
            doc.setTextColor(0); // Black
            doc.setFontSize(10);
            
            // Split text into lines for PDF wrapping
            const summaryLines = doc.splitTextToSize(summaryContent, 180); 
            doc.text(summaryLines, 14, y);
            y += (summaryLines.length * 5) + 5; // Advance Y by number of lines * line height

            // Quiz Section
            doc.setFontSize(14);
            doc.setTextColor(30, 115, 232); // primary-blue
            doc.text("Quiz Questions", 14, y);
            y += 7;

            doc.setFontSize(10);
            currentQuizData.forEach((q, index) => {
                // Check for page overflow
                if (y > 280) {
                    doc.addPage();
                    y = 20; // Reset Y position for new page
                }
                
                doc.setTextColor(0); // Black for question text
                const questionText = doc.splitTextToSize(`Q${index + 1}: ${q.question}`, 180);
                doc.text(questionText, 14, y);
                y += (questionText.length * 5) + 3;

                // Add options
                q.options.forEach(option => {
                    const optionText = doc.splitTextToSize(` - ${option}`, 175);
                    doc.text(optionText, 18, y);
                    y += (optionText.length * 5);
                });
                
                // Add Correct Answer
                doc.setTextColor(34, 139, 34); // Forest green for answer
                doc.text(`Correct Answer: ${q.answer}`, 18, y);
                doc.setTextColor(0); // Reset color
                y += 7;
            });

            // Save the PDF
            doc.save(`LearnFlow_Analysis_${currentVideoID}.pdf`);
        }

        // --- Localization (Simplified for this file) ---
        const i18n = {
            analyzeButtonText: "Analyze Video",
            loadingText: "Generating Summary & Quiz...",
            placeholderSummary: "Enter a YouTube link and click 'Analyze Video' to generate a summary.",
            placeholderQuiz: "A quiz will be generated here after the video analysis.",
            placeholderTranscript: "The full video transcript will appear here.",
            scoreButtonText: "Score Quiz",
            exportButtonText: "Export PDF",
            quizResultsTitle: "Quiz Results",
            feedbackPrompt: "Found an issue or have feedback?",
            feedbackLink: "Report it here.",
            darkModeToggle: "Toggle dark mode"
        };
        
        function applyLocalization() {
            // Apply text content 
            document.getElementById('analyzeButtonText').textContent = i18n.analyzeButtonText;
            document.getElementById('loadingText').textContent = i18n.loadingText;
            document.getElementById('summaryPlaceholder').textContent = i18n.placeholderSummary;
            document.getElementById('quizPlaceholder').textContent = i18n.placeholderQuiz;
            document.getElementById('transcriptPlaceholder').textContent = i18n.placeholderTranscript;
            document.getElementById('scoreButtonText').textContent = i18n.scoreButtonText;
            document.getElementById('exportButtonText').textContent = i18n.exportButtonText;
            document.getElementById('quizResultsTitle').textContent = i18n.quizResultsTitle;
            document.getElementById('feedbackPromptText').textContent = i18n.feedbackPrompt; 
            document.getElementById('feedbackLink').textContent = i18n.feedbackLink; 

            // Set up initial tab state
            switchTab('summary');
        }

        // --- Event Listeners and Initial Setup ---

        document.addEventListener('DOMContentLoaded', () => {

            // Apply text content
            applyLocalization();

            // Add event listeners for tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });

            // Set initial state of the score button
            document.getElementById('scoreButton').disabled = true;

        });

    </script>
{% endblock %}