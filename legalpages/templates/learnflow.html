{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}


{% block content %}
<main class="min-h-screen bg-background-dark text-text-light p-4 sm:p-6 lg:p-8 dark">
    <div class="max-w-7xl mx-auto">
        
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <header class="text-center py-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-light mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-blue to-blue-start">LearnFlow AI</span> Video Analysis
            </h1>
            <p class="text-sm sm:text-lg text-text-muted">Generate summaries, quizzes, and study guides from any YouTube video instantly.</p>
        </header>

        <div class="bg-card-dark p-6 rounded-xl shadow-2xl mb-8">
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label for="videoLink" class="block text-sm font-medium text-text-light mb-2">YouTube Video Link</label>
                    <input type="url" id="videoLink" name="videoLink" 
                        class="w-full px-4 py-2 border border-border-dark bg-gray-700 rounded-lg text-text-light focus:ring-primary-blue focus:border-primary-blue" 
                        placeholder="e.g., https://www.youtube.com/watch?v=..."
                        value="{% if preloaded_video_url %}{{ preloaded_video_url }}{% endif %}">
                        </div>
                <button id="analyzeButton" 
                    class="w-full sm:w-auto px-6 py-2 bg-primary-blue text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    disabled>
                    Analyze Video
                </button>
            </div>

            <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center" style="display: none;"></div>
        </div>
        
        <div class="grid grid-cols-1 lg:col-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                
                <div id="playerContainer" class="w-full bg-black rounded-xl overflow-hidden shadow-lg" style="height: 400px;">
                    <p class="text-center p-4 text-text-muted">Enter a link and click 'Analyze Video' to load the player and content.</p>
                </div>

                <div class="bg-card-dark p-4 rounded-xl shadow-lg">
                    <div class="flex border-b border-border-dark mb-4">
                        <button class="tab-button flex-1 py-3 text-lg font-medium transition-colors duration-200 border-b-2 border-primary-blue text-text-light" data-tab="summary">
                            <i class="fas fa-list-alt mr-2"></i>Summary
                        </button>
                        <button class="tab-button flex-1 py-3 text-lg font-medium transition-colors duration-200 border-transparent text-text-muted" data-tab="quiz">
                            <i class="fas fa-question-circle mr-2"></i>Quiz
                        </button>
                    </div>

                    <div id="summary-tab" class="tab-content space-y-4">
                        <h2 class="text-xl font-bold text-primary-blue">Generated Summary</h2>
                        <div id="summary-content" class="text-text-muted leading-relaxed prose prose-invert max-w-none">
                            <p>Analysis results will appear here after the video is processed.</p>
                        </div>
                    </div>

                    <div id="quiz-tab" class="tab-content space-y-4 hidden">
                        <h2 class="text-xl font-bold text-primary-blue">Interactive Quiz: <span id="quiz-title-display"></span></h2>
                        <form id="quiz-form" class="space-y-6">
                            <div id="quiz-content" class="space-y-6">
                                <p class="text-text-muted">Quiz questions will load here.</p>
                            </div>
                            <div class="flex justify-between items-center pt-4 border-t border-border-dark">
                                <span id="quiz-score" class="text-lg font-semibold text-success-green hidden"></span>
                                <button type="button" id="scoreButton" 
                                    class="px-6 py-2 bg-accent-orange text-white font-semibold rounded-lg hover:bg-orange-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                                    disabled>
                                    Score Quiz
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                
                <div class="bg-card-dark p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-primary-blue mb-4">Study Guide & Export</h2>
                    <p class="text-text-muted mb-4 text-sm">Create a printable PDF of your summary and quiz results.</p>
                    
                    <button id="exportButton" 
                        class="w-full px-6 py-3 bg-success-green text-white font-semibold rounded-lg hover:bg-green-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center"
                        disabled>
                        <i class="fas fa-file-pdf mr-2"></i> Generate & Download PDF
                    </button>
                    <p id="export-status" class="text-center mt-3 text-sm text-text-muted hidden">Generating PDF...</p>
                </div>

                <div class="bg-card-dark p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-primary-blue mb-4">Key Features</h2>
                    <ul class="space-y-3 text-text-muted text-sm">
                        <li class="flex items-start"><i class="fas fa-microchip text-accent-orange mr-3 mt-1"></i> AI-Powered Summaries (Gemini)</li>
                        <li class="flex items-start"><i class="fas fa-tasks text-accent-orange mr-3 mt-1"></i> Auto-Generated Quizzes</li>
                        <li class="flex items-start"><i class="fas fa-file-download text-accent-orange mr-3 mt-1"></i> Downloadable Study Guides (PDF)</li>
                        <li class="flex items-start"><i class="fas fa-code text-accent-orange mr-3 mt-1"></i> Open-Source & Community Driven</li>
                    </ul>
                    <p class="text-xs text-center text-text-faded mt-6 italic">Analysis quality is dependent on the clarity and language of the video's transcript.</p>
                </div>

            </div>
        </div>

    </div>
</main>
{% endblock %}

{% block extra_body %}
<script>
    // --- API URL Constants (Confirmed Correct) ---
    const ANALYZE_VIDEO_API_URL = "{% url 'legalpages:api_analyze_video' %}";
    const SUBMIT_QUIZ_API_URL = "{% url 'legalpages:api_submit_quiz' %}";

    // --- Global State for Data Persistence ---
    let globalQuizData = null;
    let globalVideoResponseData = null; // Store summary/title data for PDF generation

    // Helper function to get the CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- State and UI Management Variables ---
    const csrftoken = getCookie('csrftoken');
    const playerContainer = document.getElementById('playerContainer');
    // NOTE: variables are retrieved inside DOMContentLoaded below for scope safety
    // const videoLinkInput = document.getElementById('videoLink');
    // const analyzeButton = document.getElementById('analyzeButton');
    // const scoreButton = document.getElementById('scoreButton');
    // const exportButton = document.getElementById('exportButton');


    // Parses the YouTube video ID from a link
    function get_video_id(url) {
        if (url.startsWith('https://www.youtube.com/embed/')) {
            return url.split('/').pop().split('?')[0];
        }

        const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        
        if (match && match[2].length === 11) {
            return match[2];
        }
        return null;
    }

    // Manages the tab view
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-primary-blue', 'text-text-light');
            button.classList.add('border-transparent', 'text-text-muted');
        });

        document.getElementById(tabId + '-tab').classList.remove('hidden');
        document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.remove('border-transparent', 'text-text-muted');
        document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('border-primary-blue', 'text-text-light', 'border-b-2');
    }

    // Manages the analysis status messages
    function updateStatus(type, message) {
        const statusElement = document.getElementById('statusMessage');
        statusElement.style.display = 'block';
        statusElement.textContent = message;
        
        statusElement.classList.remove('bg-yellow-900', 'text-yellow-300', 'bg-green-900', 'text-green-300', 'bg-red-900', 'text-red-300');

        if (type === 'loading') {
            statusElement.classList.add('bg-yellow-900', 'text-yellow-300');
        } else if (type === 'success') {
            statusElement.classList.add('bg-green-900', 'text-green-300');
        } else if (type === 'error') {
            statusElement.classList.add('bg-red-900', 'text-red-300');
        }
    }

    // Manages button states (Uses the variables passed from DOMContentLoaded)
    function setAnalysisState(isAnalyzing, isAnalyzed) {
        const analyzeButton = document.getElementById('analyzeButton');
        const videoLinkInput = document.getElementById('videoLink');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');

        analyzeButton.disabled = isAnalyzing;
        videoLinkInput.disabled = isAnalyzing;
        scoreButton.disabled = isAnalyzing || !isAnalyzed;
        exportButton.disabled = isAnalyzing || !isAnalyzed;
        
        if (isAnalyzing) {
            analyzeButton.textContent = 'Analyzing...';
            scoreButton.textContent = 'Score Quiz';
            exportButton.textContent = 'Generate & Download PDF';
        } else {
            analyzeButton.textContent = 'Analyze Video';
            scoreButton.textContent = 'Score Quiz';
            exportButton.textContent = 'Download Study Guide';
        }
    }

    // Correctly generates the Quiz HTML from the JSON structure
    function generateQuizHtml(quizData) {
        if (!quizData || !Array.isArray(quizData.questions)) {
            return '<p class="text-red-400">Error: Could not parse quiz data from AI response.</p>';
        }

        document.getElementById('quiz-title-display').textContent = quizData.quiz_title || 'Untitled Quiz';
        
        let html = '';
        quizData.questions.forEach((q, index) => {
            html += `<div class="quiz-question bg-input-dark p-4 rounded-lg" data-question-id="${q.id}">`;
            html += `<p class="font-semibold text-text-light mb-3">${index + 1}. ${DOMPurify.sanitize(q.question)}</p>`;
            
            if (Array.isArray(q.options)) {
                q.options.forEach((option, optIndex) => {
                    const uniqueId = `q${q.id}_opt${optIndex}`;
                    html += `
                        <label for="${uniqueId}" class="flex items-center space-x-3 py-2 cursor-pointer hover:bg-card-light rounded-md px-2">
                            <input type="radio" id="${uniqueId}" name="question_${q.id}" value="${DOMPurify.sanitize(option)}" class="form-radio text-primary-blue">
                            <span class="text-text-muted">${DOMPurify.sanitize(option)}</span>
                        </label>
                    `;
                });
            }
            html += `</div>`;
        });
        return html;
    }


    // --- Main Functions (Using Updated URL Constants) ---

    // 1. ANALYZE VIDEO FUNCTION
    async function analyzeVideo() {
        // Need to retrieve elements here since they aren't globally scoped
        const videoLinkInput = document.getElementById('videoLink');
        
        setAnalysisState(true, false);
        document.getElementById('quiz-score').classList.add('hidden');
        document.getElementById('summary-content').innerHTML = '<p class="text-text-muted">Analysis results will appear here after the video is processed.</p>';
        document.getElementById('quiz-content').innerHTML = '<p class="text-text-muted">Quiz questions will load here.</p>';
        globalQuizData = null; 
        globalVideoResponseData = null; 
        switchTab('summary');
        
        const videoUrl = videoLinkInput.value.trim();
        const videoId = get_video_id(videoUrl);

        if (!videoId) {
            updateStatus('error', 'Please enter a valid YouTube link.');
            setAnalysisState(false, false);
            return;
        }

        playerContainer.innerHTML = `<iframe width="100%" height="400" src="https://www.youtube.com/embed/${videoId}?autoplay=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        
        try {
            updateStatus('loading', 'Analyzing video and generating summary/quiz... This may take up to 30 seconds.');

            const response = await fetch(ANALYZE_VIDEO_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ video_url_or_id: videoUrl || videoId }) 
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                const summaryMarkdown = data.summary_result || '';
                const sanitizedSummary = DOMPurify.sanitize(summaryMarkdown);
                document.getElementById('summary-content').innerHTML = marked.parse(sanitizedSummary);
                
                globalQuizData = data.quiz_data; 
                globalVideoResponseData = { 
                    video_id: data.video_id,
                    video_title: data.video_title,
                    summary_result: summaryMarkdown 
                };

                document.getElementById('quiz-content').innerHTML = generateQuizHtml(globalQuizData);
                
                updateStatus('success', 'Analysis complete! Check the Summary and Quiz tabs.');
                setAnalysisState(false, true);
            } else {
                updateStatus('error', `Analysis failed: ${data.message || 'An unknown error occurred.'}`);
                setAnalysisState(false, false);
            }

        } catch (error) {
            console.error('Fetch error:', error);
            updateStatus('error', 'A network error occurred. Please check your connection or try again.');
            setAnalysisState(false, false);
        }
    }

    // 2. SUBMIT QUIZ FUNCTION
    async function submitQuiz() {
        if (!globalQuizData) {
            updateStatus('error', 'Please analyze a video first.');
            return;
        }

        setAnalysisState(true, true);
        document.getElementById('export-status').classList.remove('hidden');

        const userAnswers = {};
        const quizForm = document.getElementById('quiz-form');
        
        globalQuizData.questions.forEach(q => {
            const radioGroupName = `question_${q.id}`;
            const checkedElement = quizForm.querySelector(`input[name="${radioGroupName}"]:checked`);
            userAnswers[String(q.id)] = checkedElement ? checkedElement.value : null; 
        });

        try {
            const response = await fetch(SUBMIT_QUIZ_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ 
                    user_answers: userAnswers,
                    quiz_data: globalQuizData,
                    video_response_data: globalVideoResponseData
                })
            });

            setAnalysisState(false, true);
            document.getElementById('export-status').classList.add('hidden');

            if (response.headers.get('Content-Type') === 'application/pdf') {
                const blob = await response.blob();
                const scoreHeader = response.headers.get('X-Quiz-Score');
                const scoreDisplay = document.getElementById('quiz-score');

                if (scoreHeader) {
                    scoreDisplay.textContent = `Final Score: ${scoreHeader}`;
                    scoreDisplay.classList.remove('hidden');
                } else {
                    scoreDisplay.textContent = `Final Score: Scored`;
                    scoreDisplay.classList.remove('hidden');
                }

                // Download PDF
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const disposition = response.headers.get('Content-Disposition');
                const filename = (disposition && disposition.match(/filename="(.+)"/)) 
                                 ? disposition.match(/filename="(.+)"/)[1] 
                                 : `LearnFlow_Study_Guide_${globalVideoResponseData.video_id || 'Report'}.pdf`;
                                 
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                updateStatus('success', `Quiz scored (Score: ${scoreHeader}) and Study Guide PDF downloaded successfully!`);
                switchTab('quiz');

            } else {
                const data = await response.json();
                updateStatus('error', `Scoring/PDF generation failed: ${data.message || 'The server did not return a PDF and reported an unknown error.'}`);
            }

        } catch (error) {
            console.error('Fetch error:', error);
            setAnalysisState(false, true);
            document.getElementById('export-status').classList.add('hidden');
            updateStatus('error', 'A network error occurred during scoring or PDF generation. Please check your connection or try again.');
        }
    }


    // --- Page Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Retrieve elements inside DOMContentLoaded
        const videoLinkInput = document.getElementById('videoLink');
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        
        switchTab('summary');

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 1. Enable/Disable Analyze button based on input
        videoLinkInput.addEventListener('input', () => {
            analyzeButton.disabled = videoLinkInput.value.trim().length === 0;
        });

        // 2. Attach click handlers to the main action buttons
        if (analyzeButton) analyzeButton.addEventListener('click', analyzeVideo);
        if (scoreButton) scoreButton.addEventListener('click', submitQuiz); 
        if (exportButton) exportButton.addEventListener('click', submitQuiz); 
        
        // Initial state
        setAnalysisState(false, false); 
        
        // Auto-trigger analysis if a video URL was pre-selected (Django context)
        if (videoLinkInput && videoLinkInput.value.startsWith('http')) {
            analyzeButton.disabled = false; // Enable button
            setTimeout(analyzeVideo, 100); 
        }
    });

</script>
{% endblock %}