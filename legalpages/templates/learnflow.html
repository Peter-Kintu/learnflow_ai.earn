{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        'blue-start': '#1e3a8a', 
                        'black-end': '#0f172a',  
                    },
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}


{% block content %}
<main class="min-h-screen bg-background-light dark:bg-gray-900 p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        
        <header class="text-center py-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 dark:text-white mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-blue to-blue-start">LearnFlow AI</span> Video Analysis
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">
                Paste a YouTube URL to instantly generate a summary and educational quiz.
            </p>
        </header>

        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 lg:p-8 mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow">
                    <label for="videoLink" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">YouTube Video URL</label>
                    <input type="url" id="videoLink" 
                           class="w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue"
                           placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                           value="{% if pre_selected_video_id %}https://www.youtube.com/watch?v={{ pre_selected_video_id }}{% endif %}"
                           required>
                </div>
                
                <button id="analyzeButton" 
                        class="w-full md:w-auto px-6 py-3 bg-primary-blue text-white font-semibold rounded-md shadow-lg hover:bg-hover-blue transition duration-200 flex justify-center items-center">
                    <span id="analyzeButtonText">Analyze Video</span>
                    <svg id="loadingIndicator" class="hidden animate-spin h-5 w-5 text-white ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="statusMessage" class="hidden p-3 mb-6 text-sm rounded-lg font-medium text-center" role="alert">
            Status will appear here.
        </div>

        <div id="analysisContent" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 bg-white dark:bg-gray-800 shadow-xl rounded-lg overflow-hidden">
                <div id="videoPlayer" class="w-full aspect-video bg-black flex items-center justify-center">
                    <p class="text-white/50 dark:text-gray-500 p-4">Video Player will load here...</p>
                </div>
                <div class="p-4 border-t dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-3 dark:text-white">Actions</h3>
                    <div class="flex space-x-3">
                        <button id="scoreButton" 
                                class="flex-1 px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 transition duration-200" disabled>
                            Score Quiz
                        </button>
                        <button id="exportButton" 
                                class="flex-1 px-4 py-2 bg-gray-600 text-white font-semibold rounded-md shadow-md hover:bg-gray-700 transition duration-200" disabled>
                            Export Report (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6">
                
                <div class="border-b border-gray-200 dark:border-gray-700 mb-4 flex space-x-4">
                    <button class="tab-button pb-2 border-b-2" data-tab="summary">
                        Summary
                    </button>
                    <button class="tab-button pb-2 border-b-2" data-tab="quiz">
                        Quiz
                    </button>
                    <button class="tab-button pb-2 border-b-2" data-tab="transcript">
                        Notes/Analysis
                    </button>
                </div>

                <div class="h-[60vh] overflow-y-auto pr-2">
                    <div id="summaryTabContent" class="tab-content prose dark:prose-invert max-w-none">
                        </div>
                    
                    <div id="quizTabContent" class="tab-content hidden space-y-4">
                        </div>

                    <div id="transcriptTabContent" class="tab-content hidden prose dark:prose-invert max-w-none">
                        </div>
                </div>
            </div>

        </div>
    </div>
</main>
{% endblock %}

{% block extra_body %}
<script>
    // --- Global State and DOM Elements ---
    let quizData = [];
    let videoId = null;

    // Element selection to resolve TypeError: Cannot read properties of null
    const videoLinkInput = document.getElementById('videoLink');
    const analyzeButton = document.getElementById('analyzeButton');
    const analyzeButtonText = document.getElementById('analyzeButtonText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const statusMessage = document.getElementById('statusMessage');
    const analysisContentDiv = document.getElementById('analysisContent');
    const summaryTabContent = document.getElementById('summaryTabContent');
    const quizTabContent = document.getElementById('quizTabContent');
    const transcriptTabContent = document.getElementById('transcriptTabContent');
    const scoreButton = document.getElementById('scoreButton');
    const exportButton = document.getElementById('exportButton');


    // --- Helper Functions ---

    /**
     * Extracts the YouTube video ID from a URL.
     */
    function extractVideoId(url) {
        try {
            const urlObj = new URL(url);
            const urlParams = new URLSearchParams(urlObj.search);
            let id = urlParams.get('v');

            if (!id && urlObj.hostname.includes('youtu.be')) {
                id = urlObj.pathname.split('/')[1].split('?')[0];
            }
            return id;
        } catch (e) {
            return null; // Handle malformed URLs gracefully
        }
    }
    
    /**
     * Toggles the UI state for analysis (loading vs. ready).
     */
    function setAnalysisState(isLoading) {
        analyzeButton.disabled = isLoading;
        videoLinkInput.disabled = isLoading;
        scoreButton.disabled = isLoading || (quizData.length === 0 && !document.querySelector('input[name^="q"]:checked'));
        exportButton.disabled = isLoading || (quizData.length === 0);

        if (isLoading) {
            analyzeButtonText.textContent = 'Analyzing...';
            loadingIndicator.classList.remove('hidden');
            statusMessage.classList.add('hidden');
            analysisContentDiv.classList.add('hidden');
        } else {
            analyzeButtonText.textContent = 'Analyze Video';
            loadingIndicator.classList.add('hidden');
        }
    }

    /**
     * Displays a status message (success or error).
     */
    function displayStatus(message, type = 'success') {
        statusMessage.textContent = message;
        statusMessage.className = 'p-3 mb-6 text-sm rounded-lg font-medium text-center'; // Reset classes
        
        if (type === 'error') {
            statusMessage.classList.add('bg-red-100', 'text-error-red');
        } else if (type === 'success') {
            statusMessage.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'warning') {
            statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
        }
        statusMessage.classList.remove('hidden');
    }

    /**
     * Renders the YouTube video player.
     */
    function renderVideoPlayer(id) {
        const videoPlayer = document.getElementById('videoPlayer');
        videoPlayer.innerHTML = `
            <iframe 
                class="w-full h-full" 
                src="https://www.youtube.com/embed/${id}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
            </iframe>
        `;
    }

    /**
     * Renders markdown content safely.
     */
    function renderMarkdown(content, element) {
        // marked.js converts Markdown to HTML, DOMPurify sanitizes it
        const rawHtml = marked.parse(content);
        element.innerHTML = DOMPurify.sanitize(rawHtml);
    }

    /**
     * Renders the Quiz UI from the generated JSON data.
     */
    function renderQuiz(questions) {
        quizData = questions; // Store globally for scoring
        const quizHtml = questions.map((q, index) => {
            if (q.type === 'MCQ') {
                const optionsHtml = q.options.map((option, optIndex) => `
                    <div class="flex items-center space-x-3">
                        <input id="q${index}opt${optIndex}" name="q${index}" type="radio" value="${optIndex}" 
                            class="focus:ring-primary-blue h-4 w-4 text-primary-blue border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                        <label for="q${index}opt${optIndex}" class="text-sm font-medium text-gray-700 dark:text-gray-300">${option}</label>
                    </div>
                `).join('');
                return `
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-md">
                        <p class="font-semibold text-lg mb-3 dark:text-white">${index + 1}. (MCQ) ${q.question}</p>
                        <div class="space-y-2 ml-4">${optionsHtml}</div>
                    </div>
                `;
            } else if (q.type === 'ShortAnswer') {
                return `
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-md">
                        <p class="font-semibold text-lg mb-3 dark:text-white">${index + 1}. (Short Answer) ${q.question}</p>
                        <textarea id="q${index}ans" name="q${index}" rows="2" 
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-2 dark:bg-gray-800 dark:text-white" 
                            placeholder="Type your answer here..."></textarea>
                    </div>
                `;
            }
        }).join('<div class="h-4"></div>'); // Spacer

        quizTabContent.innerHTML = quizHtml;
        setAnalysisState(false); // Enable score button
    }

    /**
     * Switches the active content tab.
     */
    function switchTab(tabName) {
        // Hide all content divs
        document.querySelectorAll('.tab-content').forEach(div => {
            div.classList.add('hidden');
        });
        // Remove active styling from all buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-primary-blue', 'text-primary-blue', 'font-semibold');
            button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-primary-blue');
        });

        // Show the selected content
        document.getElementById(`${tabName}TabContent`).classList.remove('hidden');
        
        // Add active styling to the selected button
        const activeTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
        activeTabButton.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-primary-blue');
        activeTabButton.classList.add('border-primary-blue', 'text-primary-blue', 'font-semibold');
    }

    // --- Main Logic Functions ---

    /**
     * CORE FUNCTION: Fetches the video analysis from the server API.
     */
    async function analyzeVideo() {
        const videoUrl = videoLinkInput.value.trim();
        videoId = extractVideoId(videoUrl);

        if (!videoId || videoUrl.length < 5) {
            displayStatus('Please enter a valid YouTube video URL.', 'error');
            return;
        }

        setAnalysisState(true);
        displayStatus(`Starting analysis for video ID: ${videoId}. This may take up to a minute for long videos...`, 'warning');
        
        // Clear previous content
        quizData = [];
        summaryTabContent.innerHTML = '';
        quizTabContent.innerHTML = '';
        transcriptTabContent.innerHTML = '';
        analysisContentDiv.classList.add('hidden');


        try {
            const response = await fetch('/api/analyze_video/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_url: videoUrl, video_id: videoId })
            });

            // CRITICAL FIX: Ensure non-ok responses are processed for JSON error message
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Server responded with status ${response.status}`);
            }

            const data = await response.json();

            // 1. Render Video
            renderVideoPlayer(videoId);

            // 2. Render Summary
            renderMarkdown(data.summary, summaryTabContent);

            // 3. Render Quiz
            renderQuiz(data.quiz_questions);

            // 4. Render Transcript / Analysis
            const transcriptContent = data.transcript || '';
            
            if (data.gemini_generated_analysis) {
                renderMarkdown(`## Gemini-Generated Analysis (Transcript Unavailable) \n\n ${data.gemini_generated_analysis}`, transcriptTabContent);
            } else if (transcriptContent.startsWith('NON_ENGLISH_TRANSCRIPT:')) {
                const parts = transcriptContent.split(':', 3);
                const lang = parts[1];
                const text = parts[2];
                renderMarkdown(`## Full Transcript (Non-English: ${lang}) \n\n ${text}`, transcriptTabContent);
            } else if (transcriptContent === 'NO_TRANSCRIPT_FALLBACK' || !transcriptContent) {
                renderMarkdown('## Transcript Unavailable \n\n A machine-readable transcript could not be found for this video. The summary and quiz were generated solely from the video title, description, and visual context.', transcriptTabContent);
            }
            else {
                 renderMarkdown(`## Full Transcript \n\n ${transcriptContent}`, transcriptTabContent);
            }

            // Show results
            analysisContentDiv.classList.remove('hidden');
            displayStatus('Analysis complete! Summary and Quiz are ready.', 'success');
            switchTab('summary'); // Start on the Summary tab

        } catch (error) {
            console.error('Analysis failed:', error);
            // Client-side message for server/network errors
            displayStatus(`Analysis Failed: ${error.message || 'The server or AI service timed out.'}`, 'error');

        } finally {
            setAnalysisState(false);
        }
    }


    /**
     * Submits the quiz answers and initiates the PDF report download.
     */
    async function submitQuiz() {
        if (quizData.length === 0) {
            displayStatus('Please analyze a video and wait for the quiz to generate.', 'warning');
            return;
        }

        setAnalysisState(true);
        displayStatus('Scoring quiz and generating PDF report...', 'warning');

        const answers = {};
        let answeredCount = 0;

        // 1. Collect user answers
        quizData.forEach((q, index) => {
            const qId = index.toString();
            if (q.type === 'MCQ') {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                answers[qId] = selected ? selected.value : null;
                if (selected) answeredCount++;
            } else if (q.type === 'ShortAnswer') {
                const input = document.getElementById(`q${index}ans`);
                answers[qId] = input ? input.value.trim() : '';
                if (answers[qId]) answeredCount++;
            }
        });

        if (answeredCount < quizData.length) {
             // Allow submission even if not all answered, but give a warning
             displayStatus(`Warning: You only answered ${answeredCount}/${quizData.length} questions. Generating report...`, 'warning');
        }

        try {
            const response = await fetch('/api/submit_quiz/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_id: videoId, quiz_data: quizData, user_answers: answers })
            });

            if (!response.ok) {
                try {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Server responded with status ${response.status}`);
                } catch {
                    throw new Error(`Server responded with status ${response.status}. Could not generate PDF report.`);
                }
            }

            // 2. Handle PDF file download
            const scoreHeader = response.headers.get('X-Quiz-Score');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const contentDisposition = response.headers.get('Content-Disposition');
            
            let filename = `LearnFlow_AI_Report_${videoId}.pdf`;
            if (contentDisposition && contentDisposition.indexOf('filename=') !== -1) {
                filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
            }

            // Trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url); 

            if (scoreHeader) {
                displayStatus(`Quiz Scored! Your final score is ${scoreHeader}. PDF report downloaded.`, 'success');
            } else {
                displayStatus('PDF report downloaded successfully.', 'success');
            }
            
        } catch (error) {
            console.error('Submission failed:', error);
            displayStatus(`Submission Failed: ${error.message || 'An unknown error occurred during scoring/report generation.'}`, 'error');
        } finally {
            setAnalysisState(false);
        }
    }


    // --- Event Listeners and Initial Setup ---

    document.addEventListener('DOMContentLoaded', () => {
        
        // Initial tab state
        switchTab('summary');

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add the main event listeners
        if (analyzeButton) analyzeButton.addEventListener('click', analyzeVideo);
        if (scoreButton) scoreButton.addEventListener('click', submitQuiz);
        if (exportButton) exportButton.addEventListener('click', submitQuiz); 
        
        // Auto-trigger analysis if a video ID was pre-selected (Django context)
        if (videoLinkInput && videoLinkInput.value.startsWith('https://www.youtube.com')) {
            // Slight delay to ensure all JS/HTML elements are rendered before fetching
            setTimeout(analyzeVideo, 100); 
        }
    });

</script>
{% endblock %}