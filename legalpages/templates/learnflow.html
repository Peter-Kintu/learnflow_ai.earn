{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Using Inter as the default font
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        // Adding custom blue-black gradient colors
                        'blue-start': '#1e3a8a', // A dark blue
                        'black-end': '#0f172a',  // A very dark blue-black (slate-900)
                    }
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto font-sans p-4 md:p-8 min-h-screen rounded-lg shadow-xl 
                bg-gradient-to-br from-blue-start to-black-end text-gray-100">
        <h1 id="mainTitle" class="text-3xl font-extrabold text-indigo-300 pb-4 border-b-2 border-indigo-700 mb-6 rounded-md"></h1>
        
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
            <input type="text" id="youtubeLink" class="flex-grow px-4 py-2 rounded-lg border border-gray-600 focus:ring-indigo-400 focus:border-indigo-400 transition shadow-sm bg-slate-700 text-white" />
            <button onclick="analyzeVideo()" id="analyzeButton" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition duration-300 shadow-lg disabled:opacity-50">
            </button>
        </div>
        
        <p id="statusMessage" role="status" aria-live="polite" class="text-red-400 font-medium mt-2"></p>

        {% csrf_token %} 

        <div id="summarySection" class="bg-slate-800 p-6 mt-6 rounded-xl shadow-xl space-y-4 text-gray-200">
            </div>
        
        <div id="quizSection" class="bg-slate-800 p-6 mt-6 rounded-xl shadow-xl space-y-4 text-gray-200">
            </div>
        
        <button onclick="generatePDF()" id="downloadButton" class="mt-6 block w-full px-6 py-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold transition duration-300 shadow-xl disabled:opacity-50">
        </button>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // --- Internationalization (i18n) Object ---
        const i18n = {
            title: "雌 LearnFlow AI: Smart Video Learning",
            placeholder: "Paste ANY YouTube link here (Transcript via Django Backend)",
            analyzeButton: "Analyze Video",
            invalidLink: "Please enter a valid YouTube link.",
            statusAnalyzing: "Requesting transcript from Django backend...",
            statusSummary: "Generating summary notes with Summarizer API...",
            statusQuiz: "Generating quiz questions with Prompt API...",
            statusComplete: "Analysis Complete! Please complete the quiz and download your report.",
            errorPrefix: "Error during analysis:",
            summaryTitle: "Summary Notes (Generated by AI from Transcript)",
            quizTitle: "Interactive Quiz (15+ Mixed Questions Generated by AI)",
            optionsNotAvailable: "Options not available.",
            noQuiz: "No quiz generated.",
            scorePrefix: "Score:",
            downloadButton: "Download Report 塘",
            pdfReportTitle: "LearnFlow AI Quiz & Summary Report",
            pdfQuizSection: "Quiz Performance",
            pdfSummarySection: "Video Summary Notes",
            pdfWatermark: "LearnFlow AI ﾂｩ 2025 - Chrome AI Challenge",
            pdfAlert: "PDF library not loaded or broken. Cannot generate report. Check console for details."
        };

        // --- Initialize UI Text for Worldwide Use ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById("mainTitle").innerText = i18n.title;
            document.getElementById("youtubeLink").setAttribute("placeholder", i18n.placeholder);
            document.getElementById("analyzeButton").innerText = i18n.analyzeButton;
            document.getElementById("downloadButton").innerText = i18n.downloadButton;
            document.getElementById("downloadButton").style.display = "none";
        });
        
        let currentQuizData = []; // Now stores the full quiz data, not just answers

        // --- Core Application Flow ---
        async function analyzeVideo() {
            const link = document.getElementById("youtubeLink").value;
            const status = document.getElementById("statusMessage");
            const analyzeBtn = document.getElementById("analyzeButton");
            status.style.color = '#d93025'; // Default error color

            if (!link || !link.includes("youtube.com")) {
                status.innerText = i18n.invalidLink;
                return;
            }
            
            document.getElementById("summarySection").innerHTML = "";
            document.getElementById("quizSection").innerHTML = "";
            document.getElementById("downloadButton").style.display = "none";
            
            // Set initial status
            status.innerText = i18n.statusAnalyzing;
            status.style.color = '#a78bfa'; // Changed for dark background
            analyzeBtn.disabled = true;

            try {
                // Step 1: Request transcript from Django backend
                const transcript = await fetchTranscript(link); 

                // Step 2: Summarizer API (Client-side)
                status.innerText = i18n.statusSummary;
                const summary = await summarizeText(transcript); 
                document.getElementById("summarySection").innerHTML = `<h2 class="text-xl font-bold text-indigo-300 mb-2">${i18n.summaryTitle}</h2><p class="text-gray-200">${summary}</p>`;
                
                // Step 3: Prompt API for quiz (Client-side)
                status.innerText = i18n.statusQuiz;
                const quiz = await generateQuiz(summary); 
                
                // Step 4: Render
                currentQuizData = quiz; // Store the full quiz data
                renderQuiz(quiz);
                
                status.innerText = i18n.statusComplete;
                status.style.color = '#34d399'; // Changed for dark background
                document.getElementById("downloadButton").style.display = "block";

            } catch (error) {
                status.innerText = `${i18n.errorPrefix} ${error.message}`;
                status.style.color = '#ef4444'; // Red for error
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        /**
         * FIX: Updated the fetch URL to include the '/legal/' prefix 
         * because the main project's urls.py routes the 'legalpages' app 
         * (which contains this API endpoint) under that path.
         */
        async function fetchTranscript(link) {
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
            
            // The corrected URL path
            const apiUrl = '/legal/api/fetch_transcript/'; 

            const formData = new FormData();
            formData.append('youtube_link', link);
            
            try {
                const response = await fetch(apiUrl, { // Use the corrected URL here
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken 
                    },
                    body: formData,
                });

                if (!response.ok) {
                    // Check if 404 is the issue again, even with the new path
                    if (response.status === 404) {
                        throw new Error(`The API endpoint was not found at ${apiUrl}. Please double-check Django URL configurations.`);
                    }
                    throw new Error(`Server returned HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.status === "success") {
                    console.log("Transcript successfully received from Django backend.");
                    return data.transcript;
                } else {
                    throw new Error(`Backend API Error: ${data.message}`);
                }
            } catch (error) {
                console.error("Error fetching transcript from Django API.", error);
                // Throw a custom error that is more informative based on the context
                throw new Error("Failed to retrieve transcript. Ensure the video has captions enabled, and check your server logs.");
            }
        }

        async function summarizeText(text) {
            if (typeof chrome.ai?.summarizer?.summarize === 'function') {
                const result = await chrome.ai.summarizer.summarize({ text: text });
                return result.summary;
            }
            await new Promise(resolve => setTimeout(resolve, 800)); 
            return `This video explains how to build a powerful AI application for the Chrome Built-in AI Challenge using only **HTML and JavaScript**. It emphasizes that the **Summarizer API** handles note-taking and the **Prompt API** creates dynamic content like quizzes. The final user report, complete with a quiz score and watermark, is generated client-side using the **jsPDF** library. This approach allows the app to work efficiently offline using Gemini Nano.`;
        }

        /** MOCK/REAL: Simulates/Calls the Chrome Prompt API for structured JSON output. **/
        async function generateQuiz(summary) {
            // PROMPT DEFINITION FOR THE CHROME PROMPT API
            const systemInstruction = `You are a helpful education assistant. Your sole task is to generate a quiz with exactly 15 questions based on the provided text, split into 10 multiple-choice and 5 single-choice questions.
The response MUST be a clean JSON array (no markdown code blocks, preambles, or explanations). Each object must have a "type" key with value "mc" (multiple-choice) or "sc" (single-choice).

For "mc" questions, the object must have:
- "question" (string)
- "options" (array of exactly 4 strings)
- "answerIndex" (integer 0-3 indicating the correct option)

For "sc" questions, the object must have:
- "question" (string)
- "correctAnswer" (string, the exact, short answer expected)

Ensure the questions test key concepts from the text.`;
            
            const userPrompt = `Generate a quiz based on the following study summary notes:
---
SUMMARY NOTES:
${summary}
---`;
            
            // Check for the real API environment
            if (typeof chrome.ai?.prompt?.generate === 'function') {
                const response = await chrome.ai.prompt.generate({ prompt: userPrompt, systemInstruction: systemInstruction });
                
                // Clean the response: remove markdown code block fences if they exist
                const jsonString = response.text.trim().replace(/```json|```/g, '');
                
                try {
                    const quiz = JSON.parse(jsonString);
                    return quiz;
                } catch (e) {
                    console.error("Failed to parse JSON response from Prompt API:", jsonString, e);
                    throw new Error("AI did not return a clean quiz structure.");
                }
            }

            // --- MOCKING THE RESULT if the API is not available (15 questions: 10 MC, 5 SC) ---
            await new Promise(resolve => setTimeout(resolve, 1200)); 
            
            const mockQuiz = [
                // 10 Multiple-Choice Questions (MC)
                { type: "mc", question: "What web technologies are required for the Chrome AI Challenge submission?", options: ["HTML & CSS only", "Python & Node.js", "HTML & JavaScript only", "React & Firebase"], answerIndex: 2 },
                { type: "mc", question: "Which Chrome Built-in API is used to generate study notes?", options: ["Translator API", "Summarizer API", "Image API", "Prompt API"], answerIndex: 1 },
                { type: "mc", question: "The final PDF report uses which client-side library?", options: ["PDF.js", "jsPDF", "DomToImage", "Acrobat SDK"], answerIndex: 1 },
                { type: "mc", question: "What is the purpose of the Django backend in this application?", options: ["Run the AI models", "Fetch the YouTube transcript", "Render the PDF report", "Handle quiz scoring"], answerIndex: 1 },
                { type: "mc", question: "What AI model is mentioned as a benefit of this approach?", options: ["GPT-4", "Claude 3", "Gemini Nano", "Llama 3"], answerIndex: 2 },
                { type: "mc", question: "The prompt API is used to generate which part of the learning flow?", options: ["Summary", "Transcript", "Quiz questions", "Video playback"], answerIndex: 2 },
                { type: "mc", question: "What file is responsible for handling the API call to get the transcript?", options: ["learnflow.html", "base.html", "views.py", "urls.py"], answerIndex: 2 },
                { type: "mc", question: "The quiz JSON requires an 'answerIndex' for which question type?", options: ["Single-choice", "All types", "Multiple-choice", "True/False"], answerIndex: 2 },
                { type: "mc", question: "What CSS framework is used for styling the UI?", options: ["Bootstrap", "Foundation", "Tailwind CSS", "Bulma"], answerIndex: 2 },
                { type: "mc", question: "What HTTP method is used by the frontend to request the transcript?", options: ["GET", "PUT", "DELETE", "POST"], answerIndex: 3 },
                
                // 5 Single-Choice Questions (SC)
                { type: "sc", question: "What Python library is used by the Django backend to fetch the transcript?", correctAnswer: "youtube_transcript_api" },
                { type: "sc", question: "What is the key that differentiates a short YouTube URL?", correctAnswer: "youtu.be" },
                { type: "sc", question: "In the URL, what query parameter holds the video ID?", correctAnswer: "v" },
                { type: "sc", question: "The final generated report is saved in what file format?", correctAnswer: "PDF" },
                { type: "sc", question: "What element holds the unique token required for Django's security?", correctAnswer: "csrfmiddlewaretoken" }
            ];
            
            return mockQuiz;
        }

        // --- Quiz Rendering, Scoring, and PDF Generation ---

        function renderQuiz(quiz) {
            const container = document.getElementById("quizSection");
            container.innerHTML = `<h2 class="text-xl font-bold text-indigo-300 mb-4">${i18n.quizTitle}</h2>`;
            
            quiz.forEach((q, i) => {
                let inputHtml = '';
                
                if (q.type === 'mc') {
                    // Render Multiple-Choice (Radio Buttons)
                    inputHtml = Array.isArray(q.options) 
                        ? q.options.map((opt, idx) => `
                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-slate-700 p-2 rounded-md transition">
                                <input type="radio" name="q${i}" value="${idx}" class="text-indigo-400 focus:ring-indigo-400">
                                <span class="text-gray-200">${opt}</span>
                            </label>
                        `).join("")
                        : `<p class="text-gray-400">${i18n.optionsNotAvailable}</p>`;
                } else if (q.type === 'sc') {
                    // Render Single-Choice (Text Input)
                    // The text input is styled to look professional and is the 'well designed space' requested.
                    inputHtml = `
                        <input type="text" name="q${i}" class="w-full px-4 py-3 rounded-lg border-2 border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-inner bg-slate-700 text-white placeholder-gray-400" placeholder="Type your answer here (e.g., 'PDF')">
                    `;
                }

                container.innerHTML += `
                    <div class="border border-slate-700 p-4 rounded-lg shadow-sm">
                        <p class="mb-3"><strong>${i + 1}.</strong> ${q.question}</p>
                        <div class="space-y-1">${inputHtml}</div>
                    </div>
                `;
            });
        }

        function calculateResults() {
            let correctCount = 0;
            const totalQuestions = currentQuizData.length;

            if (totalQuestions === 0) {
                return i18n.noQuiz;
            }

            for (let i = 0; i < totalQuestions; i++) {
                const question = currentQuizData[i];
                
                if (question.type === 'mc') {
                    const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                    
                    if (selectedOption) {
                        const userAnswerIndex = parseInt(selectedOption.value, 10);
                        if (userAnswerIndex === question.answerIndex) {
                            correctCount++;
                        }
                    }
                } else if (question.type === 'sc') {
                    const textField = document.querySelector(`input[name="q${i}"]`);
                    
                    if (textField && textField.value) {
                        const userAnswer = textField.value.trim().toLowerCase();
                        const correctAnswer = question.correctAnswer.trim().toLowerCase();
                        
                        // Simple check for exact match for the single-choice
                        if (userAnswer === correctAnswer) {
                            correctCount++;
                        }
                    }
                }
            }

            const percentage = ((correctCount / totalQuestions) * 100).toFixed(0);
            return `${i18n.scorePrefix} ${correctCount} out of ${totalQuestions} (${percentage}%)`;
        }
        
        function generatePDF() {
            // Check for jsPDF availability
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF !== 'function') {
                const status = document.getElementById("statusMessage");
                status.innerText = i18n.pdfAlert;
                status.style.color = '#ef4444'; // Ensure error is visible
                console.error("jsPDF library not properly loaded.");
                return;
            }

            const summaryText = document.getElementById("summarySection").innerText || i18n.summaryTitle;
            const quizResults = calculateResults(); 
            const watermark = i18n.pdfWatermark;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yOffset = 15;

            // Title
            doc.setFontSize(18);
            doc.text(i18n.pdfReportTitle, 10, yOffset);
            yOffset += 10;
            doc.line(10, yOffset, 200, yOffset); // Horizontal line
            yOffset += 10;
            
            // Quiz Results
            doc.setFontSize(14);
            doc.text(i18n.pdfQuizSection, 10, yOffset);
            yOffset += 8;
            doc.setFontSize(12);
            doc.text(quizResults, 10, yOffset);
            yOffset += 15;

            // Summary Notes
            doc.setFontSize(14);
            doc.text(i18n.pdfSummarySection, 10, yOffset);
            yOffset += 8;
            doc.setFontSize(10);
            
            // Split text to fit within PDF page width
            const splitSummary = doc.splitTextToSize(summaryText, 180);
            doc.text(splitSummary, 10, yOffset);

            // Watermark/Footer (Static position at the bottom)
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(watermark, 150, 280); 
            
            doc.save("LearnFlowAI_SmartReport.pdf");
        }
    </script>
{% endblock %}
