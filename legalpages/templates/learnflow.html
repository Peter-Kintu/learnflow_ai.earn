{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class on the html tag
            theme: {
                extend: {
                    fontFamily: {
                        // Using Inter as the default font
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        // Adding custom blue-black gradient colors
                        'blue-start': '#1e3a8a', // A dark blue
                        'black-end': '#0f172a',  // A very dark blue-black (slate-900)
                    },
                    // Add the 'prose' plugin configuration if it were being loaded dynamically,
                    // but since we're using the CDN, we rely on its defaults + responsive variants.
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto font-sans p-4 md:p-8 min-h-screen rounded-lg shadow-xl 
                bg-background-light dark:bg-black-end dark:text-gray-100 transition-colors duration-300">
        
        <!-- Header and Dark Mode Toggle -->
        <header class="flex justify-between items-center mb-6">
            <h1 id="mainTitle" class="text-3xl font-extrabold text-primary-blue dark:text-gray-100 transition-colors duration-300" 
                aria-live="polite">
                LearnFlow AI
            </h1>
            <button onclick="document.documentElement.classList.toggle('dark')" 
                    id="darkModeToggle"
                    class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-blue-start transition-colors duration-300"
                    aria-label="Toggle Dark Mode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 12c0 3.033 1.077 5.816 2.872 7.973a.75.75 0 1 1-.858 1.258A10.473 10.473 0 0 1 5 12c0-2.494.673-4.832 1.802-6.837a.75.75 0 0 1 .819-.162ZM2.916 10.078a7.5 7.5 0 0 1 12.007-4.118.75.75 0 0 0 1.254-.157A9 9 0 0 0 2.308 12c0 5.068 3.045 9.344 7.394 11.232a.75.75 0 0 0 .857-.162 10.5 10.5 0 0 0-4.72-7.839 10.5 10.5 0 0 0-1.873-1.072Z" clip-rule="evenodd" />
                </svg>
            </button>
        </header>

        <!-- Input and Control Section -->
        <section id="inputSection" class="bg-white dark:bg-blue-start p-6 rounded-xl shadow-lg mb-8 transition-colors duration-300">
            <label for="youtubeLink" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-200">
                <span id="label_input">Enter YouTube Link (e.g., https://www.youtube.com/watch?v=...)</span>:
            </label>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="youtubeLink" 
                       placeholder="https://www.youtube.com/watch?v=..."
                       aria-label="YouTube Video Link"
                       class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-blue dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
                
                <button onclick="initiateAnalysis()" id="analyzeButton"
                        aria-label="Analyze Video"
                        class="px-6 py-3 bg-primary-blue hover:bg-hover-blue text-white font-semibold rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-primary-blue focus:ring-opacity-50 disabled:opacity-50">
                    <span id="button_analyze">Analyze Video</span>
                </button>
            </div>
        </section>

        <!-- Video Player Section -->
        <section id="videoPlayerSection" class="hidden mb-8 rounded-xl overflow-hidden shadow-2xl bg-gray-900 aspect-video" aria-hidden="true">
            <iframe id="videoIframe" width="100%" height="100%" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </section>

        <!-- Alert/Error Section -->
        <div id="alertContainer" class="mb-6 hidden" role="alert" aria-live="assertive">
            <div id="alertMessage" class="bg-error-red text-white p-4 rounded-lg shadow-md flex justify-between items-center">
                <!-- Error message injected here -->
                <button onclick="initiateAnalysis()" id="retryButton" class="ml-4 px-4 py-2 bg-white text-error-red font-semibold rounded-lg hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-white">
                    Retry
                </button>
            </div>
        </div>
        
        <!-- Main Results Section (Hidden until analysis is complete) -->
        <section id="resultsSection" class="hidden mt-8" tabindex="0" aria-labelledby="resultsTitle">
            <h2 id="resultsTitle" class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-primary-blue dark:text-gray-300">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75m9-3.75H20.25a2.25 2.25 0 0 1-2.25 2.25H12M9 12V6.75M9 12h3.75m9 3.75H20.25a2.25 2.25 0 0 1-2.25 2.25H12m0 0v-5.25m0 5.25h3.75" />
                </svg>
                <span id="section_results_title">Analysis Results</span>
            </h2>

            <!-- Tabs Navigation -->
            <div class="flex mb-6 border-b border-gray-300 dark:border-gray-700">
                <button class="tab-button px-4 py-2 text-sm font-medium border-b-2 transition-colors duration-300" data-tab="summary">
                    <span id="tab_summary">Summary</span>
                </button>
                <button class="tab-button px-4 py-2 text-sm font-medium border-b-2 transition-colors duration-300" data-tab="quiz">
                    <span id="tab_quiz">Quiz</span>
                </button>
                <button class="tab-button px-4 py-2 text-sm font-medium border-b-2 transition-colors duration-300" data-tab="transcript">
                    <span id="tab_transcript">Transcript</span>
                </button>
            </div>

            <!-- Content Containers -->
            <div id="tabContent">
                <!-- Summary Tab -->
                <div id="summary" class="tab-pane active p-6 rounded-xl bg-white dark:bg-blue-start shadow-md transition-colors duration-300">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800 dark:text-gray-100" id="summaryTitle">
                        <span id="section_summary_title">Summary Notes</span>
                    </h3>
                    <!-- Added prose class for improved reading experience -->
                    <div id="summarySection" class="prose prose-sm md:prose lg:prose-lg max-w-none text-gray-800 dark:text-gray-200 transition-colors duration-300" role="region" aria-live="polite">
                        <p id="summaryPlaceholder">Content will appear here after analysis...</p>
                    </div>
                </div>

                <!-- Quiz Tab -->
                <div id="quiz" class="tab-pane hidden p-6 rounded-xl bg-white dark:bg-blue-start shadow-md transition-colors duration-300" tabindex="0" aria-labelledby="quizTitle">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800 dark:text-gray-100" id="quizTitle">
                        <span id="section_quiz_title">Knowledge Check Quiz</span>
                    </h3>
                    <div id="quizSection" role="form" aria-live="polite">
                        <!-- Quiz content injected here -->
                        <p id="quizPlaceholder">Generate a quiz from the content above.</p>
                    </div>

                    <!-- Quiz Actions -->
                    <div id="quizActions" class="mt-6 flex flex-col gap-3">
                        <button onclick="scoreQuiz()" id="scoreButton" disabled
                                aria-label="Score Quiz Answers"
                                class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50">
                            <span id="button_score_quiz">Score Quiz</span>
                        </button>
                        
                        <div id="quizScoreContainer" class="hidden flex flex-col items-center justify-center p-4 bg-green-50 dark:bg-green-900 rounded-lg">
                            <p id="quizScore" class="text-lg font-bold text-green-800 dark:text-green-200"></p>
                            
                            <!-- New: Download Report Button and Feedback Prompt -->
                            <button onclick="downloadReport()" id="downloadReportButton"
                                    aria-label="Download Quiz Report"
                                    class="mt-3 px-4 py-2 bg-primary-blue hover:bg-hover-blue text-white text-sm font-semibold rounded-lg shadow transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-blue">
                                <span id="button_download_report">Download Detailed Report</span>
                            </button>
                            
                            <!-- New: User Feedback Prompt -->
                            <p class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                                <span id="feedbackPromptText">Was this quiz helpful?</span> 
                                <a href="{% url 'legalpages:contact' %}" class="underline text-primary-blue dark:text-blue-300 hover:text-hover-blue transition-colors duration-200" id="feedbackLink">
                                    Send feedback
                                </a>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Transcript Tab -->
                <div id="transcript" class="tab-pane hidden p-6 rounded-xl bg-white dark:bg-blue-start shadow-md transition-colors duration-300" tabindex="0" aria-labelledby="transcriptTitle">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800 dark:text-gray-100" id="transcriptTitle">
                        <span id="section_transcript_title">Video Transcript</span>
                    </h3>
                    <div id="transcriptSection" class="prose prose-sm md:prose lg:prose-lg max-w-none max-h-96 overflow-y-auto text-gray-800 dark:text-gray-200 transition-colors duration-300" role="region" aria-live="polite">
                        <p id="transcriptPlaceholder">The full transcript will appear here.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-12 w-12 mb-4"></div>
            <p id="loadingMessage" class="text-white text-lg font-semibold" aria-live="polite" aria-label="Loading in progress">
                Fetching transcript...
            </p>
        </div>

    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Global state to store the generated quiz and user answers for detailed reporting
    let globalQuizData = null; 
    let globalUserAnswers = {}; 
    let currentVideoId = '';
    let currentTranscript = '';
    let currentSummary = '';

    // --- Localization (i18n) Setup ---
    // In a real application, this would be loaded from a Django template context or a JSON file.
    const userLanguage = navigator.language.substring(0, 2);
    const i18n = {
        en: {
            title: "LearnFlow AI - Smart Video Learning",
            labelInput: "Enter YouTube Link (e.g., https://www.youtube.com/watch?v=...)",
            buttonAnalyze: "Analyze Video",
            buttonScoreQuiz: "Score Quiz",
            buttonDownloadReport: "Download Detailed Report",
            sectionResultsTitle: "Analysis Results",
            sectionSummaryTitle: "Summary Notes",
            sectionQuizTitle: "Knowledge Check Quiz",
            sectionTranscriptTitle: "Video Transcript",
            tabSummary: "Summary",
            tabQuiz: "Quiz",
            tabTranscript: "Transcript",
            placeholderSummary: "Content will appear here after analysis...",
            placeholderQuiz: "Generate a quiz from the content above.",
            placeholderTranscript: "The full transcript will appear here.",
            loadingTranscript: "Fetching transcript...",
            loadingSummaryQuiz: "Generating summary and quiz with AI...",
            errorNoLink: "Please enter a valid YouTube link to begin.",
            errorAPI: "An error occurred during analysis. Try again.",
            errorTranscript: "Failed to fetch transcript. Note: Not all videos have transcripts enabled.",
            buttonRetry: "Retry",
            quizScoreText: "Your Score: {score}",
            pdfReportTitle: "LearnFlow AI Quiz & Summary Report",
            pdfQuizSection: "Quiz Score Summary",
            pdfDetailedExplanation: "Detailed Answer Explanation",
            pdfSummarySection: "Summary Notes",
            pdfWatermark: "Generated by LearnFlow AI",
            pdfFilenamePrefix: "Quiz_Report",
            darkModeToggle: "Toggle Dark Mode",
            feedbackPrompt: "Was this quiz helpful?",
            feedbackLink: "Send feedback"
        },
        // Fallback or default English. In a real app, include more languages.
    }[userLanguage] || i18n.en;


    // --- Core Functions ---

    /**
     * Initializes the analysis process: fetches transcript, then triggers AI content generation.
     */
    async function initiateAnalysis() {
        const linkInput = document.getElementById('youtubeLink');
        const youtubeLink = linkInput.value.trim();
        
        if (!youtubeLink) {
            displayAlert(i18n.errorNoLink, false);
            linkInput.focus();
            return;
        }

        // Hide old results and show loading indicator
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('videoPlayerSection').classList.add('hidden');
        document.getElementById('quizScoreContainer').classList.add('hidden');
        showLoading(i18n.loadingTranscript);
        hideAlert();

        try {
            // 1. Fetch Transcript (Django backend API)
            const response = await fetchTranscript(youtubeLink);
            
            currentVideoId = response.video_id;
            currentTranscript = response.transcript;

            // 2. Embed Video
            embedVideo(currentVideoId);
            document.getElementById('transcriptSection').innerHTML = `<p>${currentTranscript.replace(/\n/g, '<br>')}</p>`;

            // 3. Generate AI Content (Summary & Quiz)
            await generateContent(currentTranscript);
            
            // Show results section after all content is ready
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('videoPlayerSection').classList.remove('hidden');
            
        } catch (error) {
            console.error('Full analysis error:', error);
            displayAlert(error.message, true);
        } finally {
            hideLoading();
        }
    }

    /**
     * Fetches the transcript from the Django backend.
     * @param {string} youtubeLink 
     * @returns {Promise<object>} Response object containing transcript and video_id.
     */
    async function fetchTranscript(youtubeLink) {
        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch("{% url 'legalpages:api_fetch_transcript' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `youtube_link=${encodeURIComponent(youtubeLink)}`
            });

            const data = await response.json();

            if (data.status === 'error') {
                throw new Error(data.message || i18n.errorAPI);
            }
            return data;
        } catch (e) {
            // Re-throw specific errors for better handling in initiateAnalysis
            if (e.message.includes('transcript')) {
                throw new Error(i18n.errorTranscript);
            }
            throw new Error(i18n.errorAPI);
        }
    }

    /**
     * Calls the Gemini API to generate the summary and quiz in a structured JSON format.
     * Uses exponential backoff for retries.
     * @param {string} transcript The full video transcript.
     */
    async function generateContent(transcript) {
        showLoading(i18n.loadingSummaryQuiz);
        
        const systemPrompt = `You are a world-class AI learning assistant. Your task is to analyze the provided video transcript and generate two items:
            1. A concise, well-formatted summary (max 3-4 paragraphs) of the key educational points.
            2. A short, structured quiz of exactly 3 multiple-choice questions. Each question must have exactly 4 options, a single correct_answer (matching one of the options), and a detailed explanation for the correct answer.

            The output MUST be a single JSON object. Do not include any text, notes, or markdown outside of the JSON block.`;

        const userQuery = `Video Transcript: "${transcript}"`;
        const apiKey = ""; // Canvas will inject this.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // JSON Schema for structured output
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "summary": { "type": "STRING", "description": "The concise, paragraph-formatted summary of the key educational points." },
                        "quiz": {
                            "type": "ARRAY",
                            "description": "An array of exactly 3 multiple-choice questions.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "question": { "type": "STRING" },
                                    "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "correct_answer": { "type": "STRING", "description": "The exact text of the correct option." },
                                    "explanation": { "type": "STRING", "description": "A detailed explanation of the correct answer and why the other options are wrong." }
                                },
                                "required": ["question", "options", "correct_answer", "explanation"]
                            }
                        }
                    },
                    required: ["summary", "quiz"]
                }
            },
        };

        const MAX_RETRIES = 5;
        let attempt = 0;

        while (attempt < MAX_RETRIES) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                const jsonText = candidate?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("AI returned an invalid or empty response structure.");
                }

                const data = JSON.parse(jsonText);
                
                currentSummary = data.summary;
                renderSummary(data.summary);
                renderQuiz(data.quiz);
                return; // Success, exit the loop
            } catch (e) {
                console.warn(`Attempt ${attempt + 1} failed: ${e.message}`);
                attempt++;
                if (attempt >= MAX_RETRIES) {
                    throw new Error(i18n.errorAPI + " (AI Content Generation Failed)");
                }
                // Exponential backoff
                const delay = Math.pow(2, attempt) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }


    // --- UI Helper Functions ---

    /**
     * Populates the video player iframe.
     * @param {string} videoId 
     */
    function embedVideo(videoId) {
        const iframe = document.getElementById('videoIframe');
        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;
        iframe.setAttribute('aria-label', `YouTube video player for ID ${videoId}`);
    }

    /**
     * Renders the generated summary.
     * @param {string} summaryText 
     */
    function renderSummary(summaryText) {
        // Replace newlines with paragraph tags to maintain formatting
        const formattedSummary = summaryText.split('\n').map(p => `<p>${p}</p>`).join('');
        document.getElementById('summarySection').innerHTML = formattedSummary;
        // Switch to the summary tab by default after successful generation
        switchTab('summary');
    }
    
    /**
     * Renders the quiz structure.
     * @param {Array<object>} quizData 
     */
    function renderQuiz(quizData) {
        globalQuizData = quizData; // Store the full data globally
        globalUserAnswers = {}; // Reset user answers
        const quizContainer = document.getElementById('quizSection');
        quizContainer.innerHTML = ''; // Clear existing content
        document.getElementById('scoreButton').disabled = true; // Disable score button until answers are selected
        document.getElementById('quizScoreContainer').classList.add('hidden'); // Hide score

        quizData.forEach((q, qIndex) => {
            const questionId = `q${qIndex}`;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'mb-6 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-black-end';
            questionDiv.setAttribute('role', 'group');
            questionDiv.setAttribute('aria-labelledby', `question-title-${qIndex}`);

            questionDiv.innerHTML = `
                <p id="question-title-${qIndex}" class="font-semibold text-gray-800 dark:text-gray-100 mb-3">
                    ${qIndex + 1}. ${q.question}
                </p>
            `;

            q.options.forEach((option, oIndex) => {
                const optionId = `option-${qIndex}-${oIndex}`;
                const optionDiv = document.createElement('div');
                optionDiv.className = 'mt-2';
                optionDiv.innerHTML = `
                    <input type="radio" id="${optionId}" name="${questionId}" value="${option}" 
                           aria-labelledby="${optionId}-label"
                           onchange="handleAnswerChange('${questionId}', this.value)">
                    <label for="${optionId}" id="${optionId}-label" class="ml-2 text-gray-700 dark:text-gray-300 cursor-pointer">
                        ${option}
                    </label>
                `;
                questionDiv.appendChild(optionDiv);
            });
            quizContainer.appendChild(questionDiv);
        });
        
        // Ensure initial state of score button
        checkIfAllAnswered(); 
    }

    /**
     * Tracks the user's selected answers and enables the score button if all questions are answered.
     * @param {string} questionId 
     * @param {string} answer 
     */
    function handleAnswerChange(questionId, answer) {
        globalUserAnswers[questionId] = answer;
        checkIfAllAnswered();
    }
    
    /**
     * Checks if all questions have been answered to enable the score button.
     */
    function checkIfAllAnswered() {
        const totalQuestions = globalQuizData ? globalQuizData.length : 0;
        const answeredCount = Object.keys(globalUserAnswers).length;
        const scoreButton = document.getElementById('scoreButton');
        
        // Check if all questions have an answer recorded
        const allAnswered = totalQuestions > 0 && answeredCount === totalQuestions;
        
        // Ensure the score button is only enabled if all questions are present and answered
        scoreButton.disabled = !allAnswered;
    }


    /**
     * Calculates the score and displays the results in the UI.
     * Also returns structured results for PDF generation.
     */
    function calculateResults() {
        let correctCount = 0;
        const totalQuestions = globalQuizData.length;
        let resultDetails = ``; // String to hold the detailed report for PDF

        const quizContainer = document.getElementById('quizSection');
        quizContainer.querySelectorAll('.quiz-feedback').forEach(el => el.remove());

        globalQuizData.forEach((q, index) => {
            const questionId = `q${index}`;
            const userAnswer = globalUserAnswers[questionId];
            const correctAnswer = q.correct_answer;
            const isCorrect = userAnswer === correctAnswer;
            
            // --- UI Feedback ---
            const questionDiv = quizContainer.children[index];
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'quiz-feedback p-3 mt-2 rounded-md shadow-inner text-sm';
            
            let resultText = '';

            // --- PDF Report Detail Generation ---
            resultDetails += `\n--- Question ${index + 1} ---\n`;
            resultDetails += `Question: ${q.question}\n`;
            resultDetails += `Your Answer: ${userAnswer || 'Not answered'}\n`;
            resultDetails += `Correct Answer: ${correctAnswer}\n`;

            if (isCorrect) {
                correctCount++;
                feedbackDiv.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
                resultText = '✅ Correct!';
                resultDetails += `Result: Correct!\n\n`;
            } else {
                feedbackDiv.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
                resultText = `❌ Incorrect. Correct answer was: ${correctAnswer}.`;
                resultDetails += `Result: Incorrect. Explanation: ${q.explanation}\n\n`;
            }
            
            feedbackDiv.innerHTML = `
                <p class="font-bold mb-1">${resultText}</p>
                <p>${q.explanation}</p>
            `;
            questionDiv.appendChild(feedbackDiv);
            
            // Highlight the correct option in the UI
            questionDiv.querySelectorAll('input[type="radio"]').forEach(input => {
                const label = questionDiv.querySelector(`label[for="${input.id}"]`);
                if (input.value === correctAnswer) {
                    label.classList.add('font-bold', 'text-green-600', 'dark:text-green-400');
                } else {
                    label.classList.remove('font-bold', 'text-green-600', 'dark:text-green-400');
                }
            });
            
            // Disable inputs after scoring
            questionDiv.querySelectorAll('input').forEach(input => input.disabled = true);
        });

        const finalScore = `${correctCount} / ${totalQuestions}`;
        const scoreText = i18n.quizScoreText.replace('{score}', finalScore);

        // Update the UI message
        document.getElementById('quizScore').textContent = scoreText;

        // Return the detailed report for the PDF
        return {
            scoreSummary: scoreText,
            detailedReport: resultDetails,
            finalScore: finalScore 
        };
    }

    /**
     * Scores the quiz and displays the results container.
     */
    function scoreQuiz() {
        if (!globalQuizData || globalQuizData.length === 0) return;
        
        // Perform the scoring and display UI feedback
        calculateResults(); 
        
        // Hide score button, show score container
        document.getElementById('scoreButton').classList.add('hidden');
        document.getElementById('quizScoreContainer').classList.remove('hidden');
    }

    /**
     * Generates and downloads a detailed PDF report using jspdf.
     */
    async function downloadReport() {
        const { scoreSummary, detailedReport, finalScore } = calculateResults(); // Recalculate/fetch structured results
        const summaryText = currentSummary || document.getElementById("summarySection").innerText || i18n.sectionSummaryTitle;
        const watermark = i18n.pdfWatermark;
        const videoID = currentVideoId || 'N_A';
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let yOffset = 15;
        const margin = 10;
        const maxWidth = 190; // PDF page width minus margins (210 - 10*2)
        let pageNumber = 1;

        // Function to handle page breaks and add page number/watermark
        const checkPageBreak = (requiredHeight) => {
            if (yOffset + requiredHeight > 280) {
                // Add Watermark to the old page
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(watermark, 105, 290, null, null, 'center');
                
                doc.addPage();
                pageNumber++;
                yOffset = 15;
            }
        };

        // --- Title and Metadata ---
        doc.setFontSize(18);
        doc.text(i18n.pdfReportTitle, margin, yOffset);
        yOffset += 10;
        doc.line(margin, yOffset, margin + maxWidth, yOffset); 
        yOffset += 10;
        
        // --- Quiz Score Summary ---
        doc.setFontSize(14);
        doc.setTextColor(50);
        doc.text(i18n.pdfQuizSection, margin, yOffset);
        yOffset += 8;
        doc.setFontSize(12);
        doc.setTextColor(0);
        doc.text(scoreSummary, margin, yOffset);
        yOffset += 15;

        // --- Detailed Answer Explanation ---
        doc.setFontSize(14);
        doc.setTextColor(50);
        doc.text(i18n.pdfDetailedExplanation, margin, yOffset);
        yOffset += 8;
        doc.setFontSize(10);
        doc.setTextColor(0);
        
        // Add the detailed report, handling page breaks
        const splitReport = doc.splitTextToSize(detailedReport, maxWidth);
        
        splitReport.forEach(line => {
            const lineHeight = 5; 
            checkPageBreak(lineHeight);
            doc.text(line, margin, yOffset);
            yOffset += lineHeight;
        });

        yOffset += 10; // Extra space after report

        // --- Summary Notes ---
        checkPageBreak(15);
        doc.setFontSize(14);
        doc.setTextColor(50);
        doc.text(i18n.pdfSummarySection, margin, yOffset);
        yOffset += 8;
        doc.setFontSize(10);
        doc.setTextColor(0);
        
        // Split summary text
        const splitSummary = doc.splitTextToSize(summaryText, maxWidth);
        
        splitSummary.forEach(line => {
            const lineHeight = 5; 
            checkPageBreak(lineHeight);
            doc.text(line, margin, yOffset);
            yOffset += lineHeight;
        });

        // Add Watermark to the final page
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(watermark, 105, 290, null, null, 'center');

        // Save the PDF
        doc.save(`${i18n.pdfFilenamePrefix}_${videoID}_${finalScore.replace(' / ', 'of')}.pdf`);
    }
    
    // --- UI State Management ---

    function showLoading(message) {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling while loading
    }

    function hideLoading() {
        document.getElementById('loadingIndicator').classList.add('hidden');
        document.body.style.overflow = '';
    }

    function displayAlert(message, isRetryable) {
        const alertContainer = document.getElementById('alertContainer');
        const alertMessage = document.getElementById('alertMessage');
        const retryButton = document.getElementById('retryButton');
        
        alertMessage.innerHTML = `<p>${message}</p>`;
        
        if (isRetryable) {
            alertMessage.innerHTML += `<button onclick="initiateAnalysis()" id="retryButton" class="ml-4 px-4 py-2 bg-white text-error-red font-semibold rounded-lg hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-white">${i18n.buttonRetry}</button>`;
        }
        
        alertContainer.classList.remove('hidden');
    }

    function hideAlert() {
        document.getElementById('alertContainer').classList.add('hidden');
    }

    function switchTab(tabId) {
        // Handle panes
        document.querySelectorAll('.tab-pane').forEach(pane => {
            if (pane.id === tabId) {
                pane.classList.remove('hidden');
                pane.setAttribute('aria-hidden', 'false');
            } else {
                pane.classList.add('hidden');
                pane.setAttribute('aria-hidden', 'true');
            }
        });

        // Handle buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            if (button.dataset.tab === tabId) {
                button.classList.add('border-primary-blue', 'text-primary-blue', 'dark:border-gray-100', 'dark:text-gray-100');
                button.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            } else {
                button.classList.remove('border-primary-blue', 'text-primary-blue', 'dark:border-gray-100', 'dark:text-gray-100');
                button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-primary-blue', 'dark:hover:text-gray-100');
            }
        });
    }

    /**
     * Applies i18n strings to the DOM elements.
     */
    function applyLocalization() {
        document.getElementById('mainTitle').textContent = i18n.title.replace(' - Smart Video Learning', '');
        document.getElementById('label_input').textContent = i18n.labelInput;
        document.getElementById('button_analyze').textContent = i18n.buttonAnalyze;
        document.getElementById('button_score_quiz').textContent = i18n.buttonScoreQuiz;
        document.getElementById('button_download_report').textContent = i18n.buttonDownloadReport;
        document.getElementById('section_results_title').textContent = i18n.sectionResultsTitle;
        document.getElementById('section_summary_title').textContent = i18n.sectionSummaryTitle;
        document.getElementById('section_quiz_title').textContent = i18n.sectionQuizTitle;
        document.getElementById('section_transcript_title').textContent = i18n.sectionTranscriptTitle;
        document.getElementById('tab_summary').textContent = i18n.tabSummary;
        document.getElementById('tab_quiz').textContent = i18n.tabQuiz;
        document.getElementById('tab_transcript').textContent = i18n.tabTranscript;
        document.getElementById('summaryPlaceholder').textContent = i18n.placeholderSummary;
        document.getElementById('quizPlaceholder').textContent = i18n.placeholderQuiz;
        document.getElementById('transcriptPlaceholder').textContent = i18n.placeholderTranscript;
        document.getElementById('feedbackPromptText').textContent = i18n.feedbackPrompt;
        document.getElementById('feedbackLink').textContent = i18n.feedbackLink;
        
        // ARIA labels
        document.getElementById('darkModeToggle').setAttribute('aria-label', i18n.darkModeToggle);

        // Set up initial tab state
        switchTab('summary');
    }

    // --- Event Listeners and Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        applyLocalization();

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Set initial state of the score button
        const scoreButton = document.getElementById('scoreButton');
        scoreButton.classList.remove('hidden');
        scoreButton.disabled = true;
    });

</script>
{% endblock %}
