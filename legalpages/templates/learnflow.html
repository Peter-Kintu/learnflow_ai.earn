{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        'blue-start': '#1e3a8a', 
                        'black-end': '#0f172a',  
                    },
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}

{% block content %}
<div id="video-analysis-app" class="p-4 md:p-8 min-h-screen bg-background-light dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-extrabold text-primary-blue dark:text-white" id="mainTitle">LearnFlow AI</h1>
        <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-150 ease-in-out mt-2 sm:mt-0" title="Toggle dark mode">
            <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="moonIcon" class="w-6 h-6 text-gray-800 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2004/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </header> 

    <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
        <input type="text" id="videoLink" placeholder="Paste YouTube Video URL here (e.g., https://www.youtube.com/watch?v=...)" 
                class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-700 dark:text-white transition duration-150 ease-in-out"
                value="{% if pre_selected_video_id %}https://www.youtube.com/watch?v={{ pre_selected_video_id }}{% endif %}">
        
        <button id="analyzeButton" 
                class="w-full md:w-auto px-6 py-3 text-white font-bold rounded-lg transition duration-150 ease-in-out bg-primary-blue hover:bg-hover-blue focus:outline-none focus:ring-4 focus:ring-primary-blue/50 disabled:opacity-50" 
                title="Start Analysis">
            <span id="analyzeButtonText">Analyze Video</span>
            <span id="loadingIndicator" class="hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></span>
        </button>
    </div>

    <div id="statusMessage" class="hidden p-4 mb-6 rounded-lg font-medium" role="alert"></div>

    <div id="analysisContent" class="hidden">
        
        <div id="videoPlayer" class="aspect-video mb-6 rounded-xl overflow-hidden shadow-2xl bg-black dark:bg-gray-900"></div>

        <div class="flex flex-col lg:flex-row gap-6">

            <div class="lg:w-2/3 space-y-6">
                
                <div class="flex border-b border-gray-200 dark:border-gray-700">
                    <button data-tab="summary" class="tab-button px-4 py-2 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none" aria-controls="tab-summary-content" aria-selected="true" id="summaryButton">Summary</button>
                    <button data-tab="questions" class="tab-button px-4 py-2 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none" aria-controls="tab-questions-content" aria-selected="false" id="questionsButton">Questions</button>
                    <button data-tab="transcript" class="tab-button px-4 py-2 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none" aria-controls="tab-transcript-content" aria-selected="false" id="transcriptButton">Transcript</button>
                </div>

                <div id="tabContent">
                    
                    <div id="tab-summary-content" class="tab-pane p-6 bg-white dark:bg-gray-800 rounded-b-xl shadow-md space-y-4 prose dark:prose-invert">
                        <h2 class="text-xl font-bold border-b pb-2 dark:border-gray-700" id="summaryTitle">Video Summary</h2>
                        <div id="summaryContent" class="text-gray-700 dark:text-gray-300">
                            <p id="summaryPlaceholder" class="italic text-gray-500 dark:text-gray-400">Analysis result will appear here...</p>
                        </div>
                    </div>

                    <div id="tab-questions-content" class="tab-pane hidden p-6 bg-white dark:bg-gray-800 rounded-b-xl shadow-md space-y-6">
                        <div class="flex justify-between items-center border-b pb-2 dark:border-gray-700">
                            <h2 class="text-xl font-bold" id="quizTitle">Knowledge Assessment (20+ Questions)</h2>
                            <button id="scoreButton" 
                                        class="px-4 py-2 text-white font-bold rounded-lg bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-600/50 disabled:opacity-50"
                                        disabled>
                                <span id="scoreButtonText">Submit & Get Report</span>
                            </button>
                        </div>
                        
                        <div id="quizContainer" class="space-y-8">
                            <p id="quizPlaceholder" class="italic text-gray-500 dark:text-gray-400">Questions will load here after analysis...</p>
                        </div>

                        <div id="quizResults" class="hidden mt-8 p-6 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-xl shadow-inner space-y-4">
                            <h3 class="text-2xl font-bold text-green-700 dark:text-green-300" id="quizResultsTitle">Your Results</h3>
                            <p id="finalScoreDisplay" class="text-lg font-semibold text-green-800 dark:text-green-200">Score: -/-</p>
                            <button id="exportButton" 
                                        class="px-4 py-2 text-white font-bold rounded-lg bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-600/50"
                                        title="Download PDF Report and Certificate">
                                <span id="exportButtonText">Download PDF Report & Certificate</span>
                            </button>
                        </div>
                    </div>

                    <div id="tab-transcript-content" class="tab-pane hidden p-6 bg-white dark:bg-gray-800 rounded-b-xl shadow-md space-y-4 prose dark:prose-invert">
                        <h2 class="text-xl font-bold border-b pb-2 dark:border-gray-700" id="transcriptTitle">Video Transcript</h2>
                        <div id="transcriptContent" class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                            <p id="transcriptPlaceholder" class="italic text-gray-500 dark:text-gray-400">Transcript will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:w-1/3 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg h-fit space-y-4">
                <h3 class="text-xl font-bold border-b pb-2 dark:border-gray-700">Additional Resources</h3>
                <p id="feedbackPromptText" class="text-sm">Found an issue or want to request a feature? Let us know.</p>
                <a href="#" id="feedbackLink" class="text-primary-blue hover:text-hover-blue font-semibold text-sm">Send Feedback</a>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global State ---
    let currentVideoId = null;
    let quizData = []; // Stores the full quiz structure with correct answers
    let quizSubmitted = false;

    // --- DOM Elements ---
    const videoLinkInput = document.getElementById('videoLink');
    const analyzeButton = document.getElementById('analyzeButton');
    const analyzeButtonText = document.getElementById('analyzeButtonText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const statusMessage = document.getElementById('statusMessage');
    const analysisContent = document.getElementById('analysisContent');
    const summaryContent = document.getElementById('summaryContent');
    const transcriptContent = document.getElementById('transcriptContent');
    const quizContainer = document.getElementById('quizContainer');
    const videoPlayer = document.getElementById('videoPlayer');
    const scoreButton = document.getElementById('scoreButton');
    const exportButton = document.getElementById('exportButton');
    const finalScoreDisplay = document.getElementById('finalScoreDisplay');
    const quizResults = document.getElementById('quizResults');


    // Internationalization (for text elements)
    const i18n = {
        analyzeButtonText: "Analyze Video",
        loadingText: "Analyzing...",
        summaryTitle: "Video Summary",
        questionsTitle: "Knowledge Assessment (20+ Questions)",
        transcriptTitle: "Video Transcript",
        placeholderSummary: "Analysis result will appear here...",
        placeholderQuiz: "Questions will load here after analysis...",
        placeholderTranscript: "Transcript will appear here...",
        errorMessageEmpty: "Please enter a valid YouTube video link.",
        errorMessageAPI: "An error occurred during analysis. Please try again.",
        scoreButtonText: "Submit & Get Report",
        scoreButtonLoading: "Scoring...",
        downloadButtonText: "Download PDF Report & Certificate"
    };

    // --- Helper Functions ---

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function setStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
        
        switch (type) {
            case 'error':
                statusMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700', 'border');
                break;
            case 'success':
                statusMessage.classList.add('bg-green-100', 'border-green-400', 'text-green-700', 'border');
                break;
            case 'warning':
                statusMessage.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700', 'border');
                break;
            case 'info':
            default:
                statusMessage.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700', 'border');
                break;
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideStatus() {
        statusMessage.classList.add('hidden');
    }

    function toggleLoading(isLoading) {
        analyzeButton.disabled = isLoading;
        loadingIndicator.classList.toggle('hidden', !isLoading);
        analyzeButtonText.textContent = isLoading ? i18n.loadingText : i18n.analyzeButtonText;
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(button => {
            const isSelected = button.dataset.tab === tabName;
            button.setAttribute('aria-selected', isSelected);
            button.classList.toggle('border-primary-blue', isSelected);
            button.classList.toggle('text-primary-blue', isSelected);
            button.classList.toggle('border-transparent', !isSelected);
            button.classList.toggle('text-gray-500', !isSelected);
        });

        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.toggle('hidden', pane.id !== `tab-${tabName}-content`);
        });

        // Ensure quiz/summary is the default focus when switching from transcript
        if (tabName !== 'transcript') {
            window.scrollTo({ top: analysisContent.offsetTop, behavior: 'smooth' });
        }
    }

    // --- Core Logic ---

    function renderQuiz(quizData) {
        quizContainer.innerHTML = '';
        if (quizData.length === 0) {
            quizContainer.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">Could not generate questions for this video. Please try another link.</p>`;
            return;
        }

        quizData.forEach((q, index) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'p-5 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700 shadow-sm';
            qDiv.setAttribute('data-question-id', index);
            
            const questionText = DOMPurify.sanitize(marked.parse(`**${index + 1}.** ${q.question}`));
            qDiv.innerHTML += `<p class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">${questionText}</p>`;

            if (q.type === 'MCQ') {
                // Render Multiple Choice Options
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-2 ml-4';
                q.options.forEach((option, optIndex) => {
                    const optionId = `q${index}-opt${optIndex}`;
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.id = optionId;
                    radio.name = `question-${index}`;
                    radio.value = optIndex;
                    radio.className = 'mr-2 text-primary-blue focus:ring-primary-blue dark:bg-gray-600 dark:ring-offset-gray-800';
                    radio.addEventListener('change', checkQuizCompletion);

                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.className = 'text-gray-700 dark:text-gray-300 cursor-pointer hover:text-primary-blue transition-colors duration-150 ease-in-out';
                    label.textContent = option;
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-start';
                    div.appendChild(radio);
                    div.appendChild(label);
                    optionsDiv.appendChild(div);
                });
                qDiv.appendChild(optionsDiv);

            } else if (q.type === 'ShortAnswer') {
                // Render Short Answer Input
                const input = document.createElement('textarea');
                input.rows = 3;
                input.placeholder = "Type your answer here...";
                input.className = 'w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-600 dark:text-white transition duration-150 ease-in-out mt-2';
                input.setAttribute('data-question-type', 'ShortAnswer');
                input.addEventListener('input', checkQuizCompletion);
                qDiv.appendChild(input);
            }

            quizContainer.appendChild(qDiv);
        });

        // Display the count and enable scoring button
        document.getElementById('quizTitle').textContent = `Knowledge Assessment (${quizData.length} Questions)`;
        scoreButton.disabled = true; // Still disabled until all questions are answered
    }

    function checkQuizCompletion() {
        if (quizSubmitted) return; 

        const totalQuestions = quizData.length;
        let answeredQuestions = 0;

        document.querySelectorAll('#quizContainer > div').forEach((qDiv, index) => {
            const qType = quizData[index].type;
            let isAnswered = false;

            if (qType === 'MCQ') {
                const checkedRadio = qDiv.querySelector(`input[name="question-${index}"]:checked`);
                if (checkedRadio) {
                    isAnswered = true;
                }
            } else if (qType === 'ShortAnswer') {
                const textarea = qDiv.querySelector('textarea');
                if (textarea && textarea.value.trim() !== '') {
                    isAnswered = true;
                }
            }

            if (isAnswered) {
                answeredQuestions++;
            }
        });

        const allAnswered = (answeredQuestions === totalQuestions);
        scoreButton.disabled = !allAnswered;

        if (allAnswered) {
            setStatus("All questions have been answered. You can now submit your quiz.", 'success');
        } else {
            hideStatus();
        }
    }


    async function analyzeVideo() {
        const videoLink = videoLinkInput.value.trim();
        const videoIdMatch = videoLink.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|v\/|embed\/|live\/))([\w-]{11})/);

        if (!videoIdMatch) {
            setStatus(i18n.errorMessageEmpty, 'error');
            return;
        }

        const videoId = videoIdMatch[1];
        currentVideoId = videoId;
        hideStatus();
        toggleLoading(true);
        analysisContent.classList.add('hidden');
        quizResults.classList.add('hidden');
        quizSubmitted = false;
        
        // Reset placeholders
        summaryContent.innerHTML = `<p id="summaryPlaceholder" class="italic text-gray-500 dark:text-gray-400">${i18n.placeholderSummary}</p>`;
        transcriptContent.innerHTML = `<p id="transcriptPlaceholder" class="italic text-gray-500 dark:text-gray-400">${i18n.placeholderTranscript}</p>`;
        quizContainer.innerHTML = `<p id="quizPlaceholder" class="italic text-gray-500 dark:text-gray-400">${i18n.placeholderQuiz}</p>`;
        scoreButton.disabled = true;

        try {
            // **FIX: Removed leading slash for relative API path to resolve 404 issue.**
            const response = await fetch('api/analyze_video/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ video_url: videoLink, video_id: videoId })
            });

            const data = await response.json();

            if (response.ok) {
                // Update UI with content
                const summaryHtml = DOMPurify.sanitize(marked.parse(data.summary));
                summaryContent.innerHTML = summaryHtml;
                
                transcriptContent.textContent = data.transcript;

                // Store and render quiz data
                quizData = data.quiz_questions;
                renderQuiz(quizData);
                
                // Set up the video player
                videoPlayer.innerHTML = `<iframe 
                                            class="w-full h-full" 
                                            src="https://www.youtube.com/embed/${videoId}" 
                                            frameborder="0" 
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                            allowfullscreen>
                                         </iframe>`;

                analysisContent.classList.remove('hidden');
                setStatus("Analysis complete. Review the summary and take the quiz.", 'success');
                switchTab('summary');
                window.scrollTo({ top: analysisContent.offsetTop, behavior: 'smooth' });

            } else {
                // Handle API error messages
                setStatus(`Error: ${data.message || i18n.errorMessageAPI} (${response.status})`, 'error');
            }

        } catch (error) {
            logger.error('Analyze Video Fetch Error:', error);
            setStatus(`A network error occurred. Please check your connection or try again.`, 'error');
        } finally {
            toggleLoading(false);
        }
    }


    async function submitQuiz() {
        if (quizSubmitted) {
             // If already submitted, just re-trigger the download with current state
             // This uses the same POST endpoint which returns the PDF
             scoreButton.disabled = true;
             scoreButton.textContent = "Re-downloading...";
        } else {
            // First submission logic
            scoreButton.disabled = true;
            scoreButton.textContent = i18n.scoreButtonLoading;
        }

        const userAnswers = {};
        const totalQuestions = quizData.length;
        
        document.querySelectorAll('#quizContainer > div').forEach((qDiv, index) => {
            const qType = quizData[index].type;
            const qId = String(index);

            if (qType === 'MCQ') {
                const checkedRadio = qDiv.querySelector(`input[name="question-${index}"]:checked`);
                if (checkedRadio) {
                    userAnswers[qId] = checkedRadio.value; // Store the option index
                }
            } else if (qType === 'ShortAnswer') {
                const textarea = qDiv.querySelector('textarea');
                if (textarea) {
                    userAnswers[qId] = textarea.value.trim(); // Store the text value
                }
            }
        });

        try {
            // **FIX: Removed leading slash for relative API path to resolve 404 issue.**
            const response = await fetch('api/submit_quiz/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ 
                    video_id: currentVideoId, 
                    quiz_data: quizData, // Send the full quiz structure (with correct answers)
                    user_answers: userAnswers 
                })
            });
            
            if (response.headers.get('Content-Type') === 'application/pdf') {
                // Success: PDF is returned
                const scoreHeader = response.headers.get('X-Quiz-Score'); // e.g., "7/10"
                const blob = await response.blob();
                
                // 1. Trigger Download
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                a.download = `LearnFlow_AI_Report_${currentVideoId}.pdf`; 
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();
                
                // 2. Update UI
                if (scoreHeader) {
                    finalScoreDisplay.textContent = `Final Score: ${scoreHeader}`;
                } else {
                    // Fallback if header is missing, though server should always provide it
                    finalScoreDisplay.textContent = 'Report Generated. Score calculation complete.';
                }
                
                quizResults.classList.remove('hidden');
                scoreButton.disabled = true;
                scoreButton.textContent = "Report Submitted";
                exportButton.textContent = i18n.downloadButtonText;
                quizSubmitted = true;
                setStatus("Quiz submitted successfully! Your PDF report is downloading.", 'success');
                switchTab('questions'); // Stay on the questions tab to show results
                
            } else {
                // Handle JSON error response (e.g., Status 400 or 500)
                const data = await response.json();
                setStatus(`Submission Error: ${data.message || 'The server could not process the quiz.'} (${response.status})`, 'error');
            }

        } catch (error) {
            logger.error('Submit Quiz Fetch Error:', error);
            setStatus(`A network error occurred during quiz submission.`, 'error');
        } finally {
            scoreButton.disabled = true;
            // Restore button text if not in download state
            if (!quizSubmitted) {
                scoreButton.textContent = i18n.scoreButtonText;
            }
        }
    }


    // --- Event Listeners and Initial Setup ---

    document.addEventListener('DOMContentLoaded', () => {
        // Dark mode toggle logic (not provided, but assume it works)
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
            });
        }
        
        // Initial tab state
        switchTab('summary');

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add the main event listeners
        document.getElementById('analyzeButton').addEventListener('click', analyzeVideo);
        document.getElementById('scoreButton').addEventListener('click', submitQuiz);
        // The export button re-triggers the submission (which re-downloads the report)
        document.getElementById('exportButton').addEventListener('click', submitQuiz); 
        
        // Initial button states
        scoreButton.disabled = true;
        
        // Auto-trigger analysis if a video ID was pre-selected (Django context)
        const videoLinkInput = document.getElementById('videoLink');
        if (videoLinkInput && videoLinkInput.value.startsWith('https://www.youtube.com')) {
            // Slight delay to ensure all JS/HTML elements are rendered before fetching
            setTimeout(analyzeVideo, 100); 
        }
    });

</script>
{% endblock %}