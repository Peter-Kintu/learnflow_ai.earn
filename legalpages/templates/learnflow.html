{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}


{% block content %}
<main class="min-h-screen bg-background-dark text-text-light p-4 sm:p-6 lg:p-8 dark">
    <div class="max-w-7xl mx-auto">
        
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <header class="text-center py-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-light mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-blue to-blue-start">LearnFlow AI</span> Video Analysis
            </h1>
            <p class="text-lg text-text-muted">
                Paste a YouTube URL to instantly generate a summary and educational quiz.
            </p>
        </header>

        <div class="bg-background-light shadow-xl rounded-lg p-6 lg:p-8 mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow">
                    <label for="videoLink" class="block text-sm font-medium text-text-muted mb-1">YouTube Video URL</label>
                    <input type="url" id="videoLink" 
                           class="w-full border-gray-600 bg-background-dark text-text-light rounded-md shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue"
                           placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                           value="{% if pre_selected_video_id %}https://www.youtube.com/watch?v={{ pre_selected_video_id }}{% endif %}"
                           required>
                </div>
                
                <button id="analyzeButton" 
                        class="w-full md:w-auto px-6 py-3 bg-primary-blue text-text-light font-semibold rounded-md shadow-lg hover:bg-hover-blue transition duration-200 flex justify-center items-center">
                    <span id="analyzeButtonText">Analyze Video</span>
                    <svg id="loadingIndicator" class="hidden animate-spin h-5 w-5 text-text-light ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="statusMessage" class="hidden p-3 mb-6 text-sm rounded-lg font-medium text-center" role="alert">
            Status will appear here.
        </div>

        <div id="analysisContent" class="hidden grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div class="md:col-span-1 bg-background-light shadow-xl rounded-lg overflow-hidden h-fit">
                <div id="videoPlayer" class="w-full aspect-video bg-background-dark flex items-center justify-center">
                    <p class="text-text-muted p-4">Video Player will load here...</p>
                </div>
                <div class="p-4 border-t border-gray-700">
                    <h3 class="text-xl font-semibold mb-3 text-text-light">Actions</h3>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <button id="scoreButton" 
                                class="flex-1 px-4 py-2 bg-success-green text-text-light font-semibold rounded-md shadow-md hover:bg-green-700 transition duration-200" disabled>
                            Score Quiz
                        </button>
                        <button id="exportButton" 
                                class="flex-1 px-4 py-2 bg-gray-500 text-text-light font-semibold rounded-md shadow-md hover:bg-gray-600 transition duration-200" disabled>
                            Export (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 bg-background-light shadow-xl rounded-lg p-6">
                
                <div class="border-b border-gray-700 mb-4 flex space-x-4">
                    <button class="tab-button pb-2 border-b-2 text-text-muted hover:text-primary-blue" data-tab="summary">
                        Summary
                    </button>
                    <button class="tab-button pb-2 border-b-2 text-text-muted hover:text-primary-blue" data-tab="quiz">
                        Quiz
                    </button>
                    <button class="tab-button pb-2 border-b-2 text-text-muted hover:text-primary-blue" data-tab="transcript">
                        Notes/Analysis
                    </button>
                </div>

                <div class="h-[70vh] md:h-[65vh] overflow-y-auto pr-2">
                    <div id="summaryTabContent" class="tab-content prose prose-invert max-w-none text-text-light">
                    </div>
                    <div id="quizTabContent" class="tab-content hidden space-y-4">
                    </div>
                    <div id="transcriptTabContent" class="tab-content hidden prose prose-invert max-w-none text-text-light">
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_body %}
<script>
    // --- Global State ---
    let quizData = [];
    let videoId = null;

    /**
     * Retrieves the CSRF token from the hidden input field.
     */
    function getCsrfToken() {
        // CRITICAL FIX: Get token from the hidden field added in the HTML body
        const tokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return tokenElement ? tokenElement.value : '';
    }

    /**
     * Extracts the YouTube video ID from a URL.
     */
    function extractVideoId(url) {
        if (!url) return null;

        // Standard YouTube URL
        const standardMatch = url.match(/(?:\?v=|&v=|youtu\.be\/)([^&]+)/);
        if (standardMatch && standardMatch[1].length === 11) {
            return standardMatch[1];
        }

        // Shortened youtu.be link
        const shortMatch = url.match(/youtu\.be\/([^?]+)/);
        if (shortMatch && shortMatch[1].length === 11) {
            return shortMatch[1];
        }
        
        return null;
    }

    /**
     * Sets the state of the analysis buttons and content area.
     * @param {boolean} analysisDone - True if analysis is complete.
     * @param {boolean} quizScored - True if the quiz has been scored.
     */
    function setAnalysisState(analysisDone, quizScored = false) {
        const analysisContent = document.getElementById('analysisContent');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');

        // Show/hide main content area
        analysisContent.classList.toggle('hidden', !analysisDone);

        // Enable/disable score button (always enabled if analysis is done)
        scoreButton.disabled = !analysisDone;
        
        // Export button logic
        if (analysisDone) {
            // Export is enabled if the quiz has been scored (optional, can be done before scoring)
            // Senior Dev Fix: Export should be enabled *after* the analysis is done, 
            // but the PDF content is generated by the submit_quiz_api, which scores it first.
            // Let's keep it simple: enable after analysis, but tell the user it scores first.
            exportButton.disabled = false;
            exportButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            exportButton.classList.add('bg-primary-blue', 'hover:bg-hover-blue');
        } else {
            exportButton.disabled = true;
            exportButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
            exportButton.classList.remove('bg-primary-blue', 'hover:bg-hover-blue');
        }

        // Update button text and color after scoring
        if (quizScored) {
            scoreButton.textContent = "View Score";
            scoreButton.classList.remove('bg-success-green', 'hover:bg-green-700');
            scoreButton.classList.add('bg-gray-500', 'hover:bg-gray-600'); 
            exportButton.textContent = "Export Report (PDF)";
        } else if (analysisDone) {
            scoreButton.textContent = "Score Quiz";
            scoreButton.classList.add('bg-success-green', 'hover:bg-green-700');
            scoreButton.classList.remove('bg-gray-500', 'hover:bg-gray-600'); 
            exportButton.textContent = "Export (PDF)";
        }
    }

    /**
     * Updates the status message box.
     */
    function updateStatus(message, type = 'info') {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-red-500', 'bg-yellow-500', 'bg-green-500', 'text-red-900', 'text-yellow-900', 'text-green-900', 'text-text-light');
        
        // Tailwind classes for status colors
        switch (type) {
            case 'error':
                statusMessage.classList.add('bg-red-500', 'text-text-light');
                break;
            case 'warning':
                statusMessage.classList.add('bg-yellow-500', 'text-text-light');
                break;
            case 'success':
                statusMessage.classList.add('bg-green-500', 'text-text-light');
                break;
            case 'info':
            default:
                statusMessage.classList.add('bg-gray-700', 'text-text-light');
                break;
        }
    }

    /**
     * Renders the video player using the YouTube Iframe API.
     */
    function renderVideoPlayer(id) {
        const videoPlayer = document.getElementById('videoPlayer');
        videoPlayer.innerHTML = `
            <iframe 
                class="w-full h-full"
                src="https://www.youtube.com/embed/${id}" 
                title="YouTube video player" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
            </iframe>
        `;
    }

    /**
     * Renders the summary content in the appropriate tab.
     */
    function renderSummary(summaryHtml) {
        // Use DOMPurify for sanitization before rendering
        const safeHtml = DOMPurify.sanitize(summaryHtml);
        document.getElementById('summaryTabContent').innerHTML = safeHtml;
    }

    /**
     * Renders the quiz from the JSON data.
     */
    function renderQuiz(quiz, scored = false) {
        const quizContent = document.getElementById('quizTabContent');
        quizContent.innerHTML = ''; // Clear previous content

        if (!quiz || quiz.length === 0) {
            quizContent.innerHTML = '<p class="text-text-muted">No quiz could be generated for this video.</p>';
            return;
        }

        quiz.forEach((q, qIndex) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'quiz-question p-4 bg-background-dark rounded-md shadow-md border-l-4 border-primary-blue';
            questionElement.dataset.index = qIndex;
            
            // Question text (sanitized)
            const questionText = DOMPurify.sanitize(q.question);
            questionElement.innerHTML = `<p class="font-semibold mb-3 text-text-light">${qIndex + 1}. ${questionText}</p>`;
            
            // Options container
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-2';

            q.options.forEach((option, oIndex) => {
                const optionId = `q${qIndex}-o${oIndex}`;
                const optionElement = document.createElement('div');
                optionElement.className = 'flex items-center space-x-2';
                
                let inputElement;
                if (q.type === 'multiple_choice') {
                    inputElement = document.createElement('input');
                    inputElement.setAttribute('type', 'radio');
                    inputElement.setAttribute('name', `question-${qIndex}`);
                    inputElement.setAttribute('value', option);
                    inputElement.id = optionId;
                    inputElement.className = 'form-radio h-4 w-4 text-primary-blue border-gray-600 bg-background-light focus:ring-primary-blue';
                    
                    // Restore checked state if available (from a previous scoring attempt)
                    if (scored && q.user_answer === option) {
                        inputElement.checked = true;
                    }

                    // Handle Scored state feedback
                    if (scored) {
                        inputElement.disabled = true; // Disable further changes
                        
                        // Apply color feedback
                        if (q.correct_answer === option) {
                            // Correct answer
                            optionElement.classList.add('text-success-green');
                        } else if (q.user_answer === option) {
                            // User's wrong answer
                            optionElement.classList.add('text-error-red', 'font-medium');
                        } else {
                            // Unselected wrong answer
                            optionElement.classList.add('text-text-muted');
                        }
                    }
                    
                } else if (q.type === 'short_answer') {
                    // Short Answer input (only one per question)
                    if (oIndex === 0) {
                        inputElement = document.createElement('input');
                        inputElement.setAttribute('type', 'text');
                        inputElement.setAttribute('name', `question-${qIndex}`);
                        inputElement.setAttribute('placeholder', 'Your answer...');
                        inputElement.id = optionId;
                        inputElement.className = 'w-full border-gray-600 bg-background-dark text-text-light rounded-md shadow-sm p-2 focus:ring-primary-blue focus:border-primary-blue';
                        
                        // Restore previous answer
                        if (scored && q.user_answer) {
                            inputElement.value = q.user_answer;
                        }
                        
                        if (scored) {
                            inputElement.disabled = true;
                        }
                    } else {
                        return; // Only one text box for short answer
                    }
                } else {
                    return; // Skip unsupported types
                }
                
                const labelElement = document.createElement('label');
                labelElement.setAttribute('for', optionId);
                // Option text (sanitized)
                labelElement.textContent = DOMPurify.sanitize(option);
                labelElement.className = 'cursor-pointer text-text-light';

                if (q.type === 'multiple_choice') {
                    optionElement.appendChild(inputElement);
                    optionElement.appendChild(labelElement);
                } else if (q.type === 'short_answer' && oIndex === 0) {
                    // For short answer, the label is usually the input placeholder
                    optionElement.appendChild(inputElement);
                }

                if (optionElement.children.length > 0) {
                    optionsContainer.appendChild(optionElement);
                }
            });

            // Feedback/Correction section for scored quizzes
            if (scored) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'mt-3 p-3 text-sm rounded-md';

                // Get the final status/feedback from the question object
                if (q.is_correct) {
                    feedbackDiv.classList.add('bg-green-800/50', 'text-success-green');
                    feedbackDiv.innerHTML = '<span class="font-bold">Correct!</span>';
                } else {
                    feedbackDiv.classList.add('bg-red-800/50', 'text-error-red');
                    
                    let correctionHtml = `<span class="font-bold">Incorrect.</span>`;
                    
                    if (q.type === 'multiple_choice') {
                        // Display the correct answer
                        const safeAnswer = DOMPurify.sanitize(q.correct_answer);
                        correctionHtml += `<br>The correct answer was: <span class="font-semibold">${safeAnswer}</span>`;
                    } else if (q.type === 'short_answer' && q.correct_answer) {
                        // Display the expected answer for short answers
                        const safeAnswer = DOMPurify.sanitize(q.correct_answer);
                        correctionHtml += `<br>Expected answer: <span class="font-semibold">${safeAnswer}</span>`;
                    } else if (q.feedback) {
                         // Fallback to general feedback
                        const safeFeedback = DOMPurify.sanitize(q.feedback);
                        correctionHtml += `<br>${safeFeedback}`;
                    }
                    feedbackDiv.innerHTML = correctionHtml;
                }
                
                questionElement.appendChild(feedbackDiv);
                
            }

            questionElement.appendChild(optionsContainer);
            quizContent.appendChild(questionElement);
        });
    }

    /**
     * Renders the transcript/notes using the marked library.
     */
    function renderTranscript(markdown) {
        // Render Markdown to HTML using marked
        const renderedHtml = marked.parse(markdown);
        // Sanitize the resulting HTML
        const safeHtml = DOMPurify.sanitize(renderedHtml);
        document.getElementById('transcriptTabContent').innerHTML = safeHtml;
    }

    /**
     * Handles the main video analysis process.
     */
    async function analyzeVideo() {
        const videoLinkInput = document.getElementById('videoLink');
        const analyzeButtonText = document.getElementById('analyzeButtonText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        const videoURL = videoLinkInput.value;
        const newVideoId = extractVideoId(videoURL);

        if (!newVideoId) {
            updateStatus("Please enter a valid YouTube URL.", 'error');
            return;
        }

        // --- Start Analysis State ---
        videoId = newVideoId;
        setAnalysisState(false);
        updateStatus("Analyzing video... This may take up to 30 seconds for longer videos.", 'info');
        analyzeButtonText.textContent = "Analyzing...";
        loadingIndicator.classList.remove('hidden');
        document.getElementById('analyzeButton').disabled = true;

        try {
            // 1. Render the video player immediately
            renderVideoPlayer(videoId);

            // 2. Fetch analysis data from the backend
            const csrfToken = getCsrfToken();
            const response = await fetch('/api/analyze_video/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ video_url: videoURL })
            });

            const data = await response.json();

            if (data.status === 'success') {
                updateStatus("Video analysis complete. Summary and Quiz are ready!", 'success');
                
                // Store quiz data globally
                quizData = data.quiz; 
                
                // Render content
                renderSummary(data.summary);
                renderQuiz(quizData);
                renderTranscript(data.transcript);

                // Update UI state
                setAnalysisState(true);
                switchTab('summary'); 

            } else {
                updateStatus(`Error: ${data.message}`, 'error');
                // Re-enable the button but keep content hidden
                setAnalysisState(false);
            }

        } catch (error) {
            console.error('Fetch error:', error);
            updateStatus("A network or server error occurred. Please try again.", 'error');
            setAnalysisState(false);

        } finally {
            // --- End Analysis State ---
            analyzeButtonText.textContent = "Analyze Video";
            loadingIndicator.classList.add('hidden');
            document.getElementById('analyzeButton').disabled = false;
        }
    }

    /**
     * Collects user answers from the quiz form.
     */
    function collectUserAnswers() {
        const answers = [];
        
        // Iterate over all questions
        quizData.forEach((q, qIndex) => {
            const answer = {
                question_index: qIndex,
                user_answer: null
            };

            if (q.type === 'multiple_choice') {
                const checkedRadio = document.querySelector(`input[name="question-${qIndex}"]:checked`);
                if (checkedRadio) {
                    answer.user_answer = checkedRadio.value;
                }
            } else if (q.type === 'short_answer') {
                const textInput = document.querySelector(`input[name="question-${qIndex}"]`);
                if (textInput && textInput.value.trim()) {
                    answer.user_answer = textInput.value.trim();
                }
            }
            
            // Only submit questions that were answered
            if (answer.user_answer !== null) {
                 answers.push(answer);
            }
        });
        
        return answers;
    }

    /**
     * Submits the user's quiz answers for scoring and PDF generation.
     */
    async function submitQuiz(event) {
        // Determine if we are scoring or exporting
        const isExport = event.target.id === 'exportButton';
        
        // 1. Collect answers
        const userAnswers = collectUserAnswers();

        if (userAnswers.length === 0 && !isExport) {
            updateStatus("Please answer at least one question before scoring.", 'warning');
            switchTab('quiz');
            return;
        }

        // --- Start Scoring State ---
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        const originalScoreText = scoreButton.textContent;
        const originalExportText = exportButton.textContent;
        
        scoreButton.textContent = isExport ? "Scoring..." : "Submitting...";
        exportButton.textContent = isExport ? "Generating PDF..." : "Export (PDF)";
        
        scoreButton.disabled = true;
        exportButton.disabled = true;

        if (isExport) {
            updateStatus("Generating personalized PDF report. This may take a few moments...", 'info');
        } else {
            updateStatus("Submitting quiz for scoring...", 'info');
            switchTab('quiz');
        }

        try {
            // 2. Prepare payload
            const payload = {
                video_id: videoId,
                quiz_data: quizData, // Send the original quiz structure
                user_answers: userAnswers,
                // Request PDF only if the export button was clicked
                generate_pdf: isExport
            };

            // 3. Send to API
            const csrfToken = getCsrfToken();
            const response = await fetch('/api/submit_quiz/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            });

            // 4. Handle response
            if (isExport) {
                // Response for PDF download
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    
                    // Extract filename from header
                    let fileName = 'LearnFlow_Report.pdf';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match && match[1]) {
                            fileName = match[1];
                        }
                    }

                    // Create link, trigger download, and clean up
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    
                    // Display score returned in custom header
                    const quizScore = response.headers.get('X-Quiz-Score') || 'N/A';
                    updateStatus(`PDF report downloaded successfully! Final Score: ${quizScore}`, 'success');
                    
                    // Since a PDF was generated, we assume scoring happened.
                    const scoreData = await response.json(); // Re-read JSON content if needed, but the score is in the header.
                    
                    // CRITICAL FIX: To render the score feedback, we need the scored quiz data from the JSON response
                    // Since we already read the blob for PDF, we need to check if the response body is still readable.
                    // A better approach is to make a scoring API call first, then an export API call if needed.
                    // For now, let's assume the JSON body is not available after reading the blob.
                    // If the server can also return the scored JSON in a custom header or via a separate endpoint, that's best.
                    
                    // Re-enable buttons
                    setAnalysisState(true, true); 

                } else {
                    const errorText = await response.text();
                    updateStatus(`Error generating PDF: ${errorText}`, 'error');
                }
            } else {
                // Response for Scoring
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Update global quizData with the scored results
                    quizData = data.scored_quiz; 
                    
                    // Render the quiz with feedback
                    renderQuiz(quizData, true); 
                    
                    // Display final score
                    updateStatus(`Quiz Scored! Your final score is ${data.final_score}/${data.total_questions}.`, 'success');
                    
                    // Update button state for next action (Export)
                    setAnalysisState(true, true); 
                } else {
                    updateStatus(`Scoring Error: ${data.message}`, 'error');
                    setAnalysisState(true, false); // Keep content visible, reset score button
                }
            }
        
        } catch (error) {
            console.error('Submission error:', error);
            updateStatus("A network or server error occurred during scoring/export. Check the console for details.", 'error');
            setAnalysisState(true, false); // Keep content visible, reset score button

        } finally {
            // Restore button text if an error occurred before setting final state
            if (scoreButton.disabled) {
                scoreButton.textContent = originalScoreText;
                scoreButton.disabled = false;
            }
            if (exportButton.disabled) {
                exportButton.textContent = originalExportText;
                exportButton.disabled = false;
            }
        }
    }


    /**
     * Toggles between the Summary, Quiz, and Transcript tabs.
     */
    function switchTab(targetTab) {
        const tabs = ['summary', 'quiz', 'transcript'];
        
        tabs.forEach(tab => {
            const content = document.getElementById(`${tab}TabContent`);
            const button = document.querySelector(`.tab-button[data-tab="${tab}"]`);
            
            if (content && button) {
                if (tab === targetTab) {
                    content.classList.remove('hidden');
                    button.classList.add('border-primary-blue', 'text-primary-blue');
                    button.classList.remove('border-transparent', 'text-text-muted', 'hover:text-primary-blue');
                } else {
                    content.classList.add('hidden');
                    button.classList.add('border-transparent', 'text-text-muted', 'hover:text-primary-blue');
                    button.classList.remove('border-primary-blue', 'text-primary-blue');
                }
            }
        });
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const videoLinkInput = document.getElementById('videoLink');
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        
        // Initial tab state
        switchTab('summary');

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add the main event listeners
        if (analyzeButton) analyzeButton.addEventListener('click', analyzeVideo);
        if (scoreButton) scoreButton.addEventListener('click', submitQuiz);
        // Both buttons perform the submit_quiz logic, which generates the PDF.
        if (exportButton) exportButton.addEventListener('click', submitQuiz); 
        
        // Auto-trigger analysis if a video ID was pre-selected (Django context)
        if (videoLinkInput && videoLinkInput.value.startsWith('https://www.youtube.com')) {
            // This setTimeout is safe because it uses a function reference (analyzeVideo), 
            // not a string argument, avoiding the eval() call.
            setTimeout(analyzeVideo, 100); 
        } else {
             // Ensure buttons are disabled initially if no video is pre-loaded
             setAnalysisState(false, false); 
        }
    });

</script>
{% endblock %}