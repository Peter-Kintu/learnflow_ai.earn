{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        'blue-start': '#1e3a8a', 
                        'black-end': '#0f172a',  
                    },
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}

{% block content %}
<div id="video-analysis-app" class="p-4 md:p-8 min-h-screen bg-background-light dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-extrabold text-primary-blue dark:text-white" id="mainTitle">LearnFlow AI</h1>
        <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-150 ease-in-out mt-2 sm:mt-0" title="Toggle dark mode">
            <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="moonIcon" class="w-6 h-6 text-gray-800 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2004/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </header> 

    <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
        <input type="text" id="videoLink" placeholder="Paste YouTube Video URL here (e.g., https://www.youtube.com/watch?v=...)" 
                class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-700 dark:text-white transition duration-150 ease-in-out"
                value="{% if pre_selected_video_id %}https://www.youtube.com/watch?v={{ pre_selected_video_id }}{% endif %}">
        
        <button id="analyzeButton" 
                class="w-full md:w-auto px-6 py-3 text-white font-bold rounded-lg transition duration-150 ease-in-out bg-primary-blue hover:bg-hover-blue focus:outline-none focus:ring-4 focus:ring-primary-blue/50 disabled:opacity-50" 
                title="Start Analysis">
            <span id="analyzeButtonText">Analyze Video</span>
            <span id="loadingIndicator" class="hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></span>
        </button>
    </div>

    <div id="analysisStatus" class="hidden p-4 mb-6 rounded-lg font-medium shadow-md" role="alert"></div>

    <div id="contentArea" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div id="videoPlayer" class="aspect-video mb-6 rounded-xl overflow-hidden shadow-2xl bg-black dark:bg-gray-900">
                    <iframe id="videoFrame" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full"></iframe>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                    <p class="text-lg font-bold text-primary-blue dark:text-white">Actions</p>
                    <button id="scoreButton" disabled class="w-full px-4 py-2 text-white font-semibold rounded-lg bg-green-600 hover:bg-green-700 disabled:opacity-50 transition duration-150">
                        Submit Quiz & View Score
                    </button>
                    <button id="exportButton" disabled class="w-full px-4 py-2 text-gray-800 font-semibold rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 disabled:opacity-50 transition duration-150">
                        Export Report (PDF)
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                        <button data-tab="summary" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg bg-primary-blue text-white mr-2 transition duration-150">
                            Summary
                        </button>
                        <button data-tab="notes" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100 mr-2 transition duration-150">
                            Detailed Notes
                        </button>
                        <button data-tab="quiz" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100 transition duration-150">
                            Quiz
                        </button>
                    </div>

                    <div id="summary-content" class="tab-content text-gray-700 dark:text-gray-300 space-y-4">
                        <p>Content will appear here after analysis...</p>
                    </div>
                    
                    <div id="notes-content" class="tab-content hidden text-gray-700 dark:text-gray-300 space-y-4">
                        <p>Detailed notes/transcript will appear here...</p>
                    </div>
                    
                    <div id="quiz-content" class="tab-content hidden text-gray-700 dark:text-gray-300 space-y-4">
                        <p>Quiz will appear here after analysis...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variable to store the fetched quiz data for submission
    let currentQuizData = [];

    // Helper function to extract the video ID from the URL
    function extractVideoId(url) {
        if (!url) return null;
        try {
            const urlObj = new URL(url);
            if (url.includes('youtu.be')) {
                return urlObj.pathname.split('/').pop();
            }
            const params = new URLSearchParams(urlObj.search);
            return params.get('v') || null;
        } catch (e) {
            // Handle invalid URLs gracefully
            return null;
        }
    }

    // Function to switch between tabs
    function switchTab(tabName) {
        // Hide all content containers
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        // Deactivate all buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('bg-primary-blue', 'text-white');
            button.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800', 'dark:bg-gray-700', 'dark:hover:bg-gray-600', 'dark:text-gray-100');
        });

        // Show the selected tab content
        const selectedContent = document.getElementById(tabName + '-content');
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }

        // Activate the selected button
        const selectedButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
        if (selectedButton) {
            selectedButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800', 'dark:bg-gray-700', 'dark:hover:bg-gray-600', 'dark:text-gray-100');
            selectedButton.classList.add('bg-primary-blue', 'text-white');
        }
    }

    // Function to display messages (error, success, loading)
    function displayMessage(type, message = '') {
        const statusDiv = document.getElementById('analysisStatus');
        statusDiv.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-yellow-100', 'text-red-700', 'text-green-700', 'text-yellow-700', 'bg-error-red', 'text-white');
        statusDiv.innerHTML = '';

        if (type === 'loading') {
            statusDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            statusDiv.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${message}`;
            statusDiv.classList.remove('hidden');
        } else if (type === 'error') {
            statusDiv.classList.add('bg-error-red', 'text-white');
            statusDiv.innerHTML = `<i class="fas fa-times-circle mr-2"></i>**Error:** ${message}`;
            statusDiv.classList.remove('hidden');
        } else {
            statusDiv.classList.add('hidden');
        }
    }

    // Function to dynamically render the quiz questions
    function renderQuiz(quizQuestions) {
        const quizContainer = document.getElementById('quiz-content');
        let html = '';
        
        quizQuestions.forEach((q, index) => {
            const qId = `q${index}`;
            html += `<div class="p-4 mb-4 bg-white dark:bg-gray-700 rounded-lg shadow-md question-item">
                        <p class="font-semibold text-lg text-primary-blue dark:text-blue-300">Question ${index + 1}:</p>
                        <p class="mb-3 dark:text-gray-200">${DOMPurify.sanitize(q.question)}</p>`;

            if (q.type === 'MCQ') {
                q.options.forEach((option, optionIndex) => {
                    // Use index for value since the server scores based on index
                    html += `<div class="flex items-center mb-2">
                                <input type="radio" id="${qId}-${optionIndex}" name="${qId}" value="${optionIndex}" class="w-4 h-4 text-primary-blue bg-gray-100 border-gray-300 focus:ring-primary-blue dark:focus:ring-blue-500 dark:ring-offset-gray-800 dark:bg-gray-600 dark:border-gray-500">
                                <label for="${qId}-${optionIndex}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">${DOMPurify.sanitize(option)}</label>
                            </div>`;
                });
            } else if (q.type === 'ShortAnswer') {
                html += `<textarea id="${qId}-answer" name="${qId}" rows="2" class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" placeholder="Type your answer here..."></textarea>`;
            }

            html += `</div>`;
        });

        quizContainer.innerHTML = html;
        document.getElementById('scoreButton').disabled = false;
        document.getElementById('exportButton').disabled = false;
    }

    // Function to render all content into tabs (THE KEY FIX)
    function renderContent(analysisData) {
        const summaryContainer = document.getElementById('summary-content');
        const notesContainer = document.getElementById('notes-content');
        const contentArea = document.getElementById('contentArea');
        
        // --- 1. Render Summary (Markdown to HTML) ---
        // Use the 'marked' library to convert the markdown summary to HTML
        const summaryHtml = marked.parse(analysisData.summary || 'Summary not provided by AI.');
        summaryContainer.innerHTML = DOMPurify.sanitize(summaryHtml);
        
        // --- 2. Render Detailed Notes/Transcript ---
        let notesContent = '';
        const TRANSCRIPT_FALLBACK_MARKER = "NO_TRANSCRIPT_FALLBACK"; // Match server constant
        
        if (analysisData.gemini_generated_analysis) {
            // Use the memory-optimized analysis if available (new fallback)
            notesContent = `<h2 class="text-xl font-bold mb-3 text-primary-blue dark:text-blue-300">Detailed Chronological Analysis (AI-Generated)</h2>
                            <p class="text-sm italic mb-4 dark:text-gray-400">Since video subtitles were unavailable, the AI analyzed the video content and generated these detailed notes. This content is not a verbatim transcript.</p>
                            <div class="p-4 bg-gray-100 dark:bg-gray-600 rounded-lg text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${DOMPurify.sanitize(analysisData.gemini_generated_analysis)}</div>`;
        
        } else if (analysisData.transcript && analysisData.transcript.startsWith("NON_ENGLISH_TRANSCRIPT:")) {
            // Handle non-English transcript
            const [,, actualTranscript] = analysisData.transcript.split(":", 2);
            notesContent = `<h2 class="text-xl font-bold mb-3 text-primary-blue dark:text-blue-300">Original Transcript (Non-English)</h2>
                            <p class="text-sm italic mb-4 dark:text-gray-400">The language detected was non-English. The summary was generated using the non-English transcript.</p>
                            <div class="p-4 bg-gray-100 dark:bg-gray-600 rounded-lg text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${DOMPurify.sanitize(actualTranscript)}</div>`;

        } else if (analysisData.transcript && analysisData.transcript !== TRANSCRIPT_FALLBACK_MARKER) {
            // Use the standard English transcript
            notesContent = `<h2 class="text-xl font-bold mb-3 text-primary-blue dark:text-blue-300">Original Video Transcript</h2>
                            <div class="p-4 bg-gray-100 dark:bg-gray-600 rounded-lg text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${DOMPurify.sanitize(analysisData.transcript)}</div>`;
        
        } else {
             // Transcript was 'NO_TRANSCRIPT_FALLBACK' AND the AI failed to provide a detailed analysis.
            notesContent = `<p class="text-lg text-red-600 dark:text-red-400">**Error/Warning:** Could not retrieve a transcript, and the AI did not provide a detailed analysis. The summary and quiz were created based on the video's title/description alone.</p>`;
        }

        notesContainer.innerHTML = notesContent;

        // --- 3. Render Quiz ---
        currentQuizData = analysisData.quiz_questions || [];
        if (currentQuizData.length > 0) {
            renderQuiz(currentQuizData);
        } else {
            document.getElementById('quiz-content').innerHTML = '<p class="text-lg text-red-600 dark:text-red-400">Quiz questions could not be generated by the AI.</p>';
            document.getElementById('scoreButton').disabled = true;
            document.getElementById('exportButton').disabled = true;
        }

        // Show the main content area and switch to the summary tab
        contentArea.classList.remove('hidden');
        switchTab('summary');
    }


    // Main function to call the API
    async function analyzeVideo() {
        const videoLinkInput = document.getElementById('videoLink');
        const videoUrl = videoLinkInput.value.trim();
        const videoId = extractVideoId(videoUrl);
        
        if (!videoId) {
            displayMessage('error', 'Please enter a valid YouTube video URL.');
            return;
        }

        // Disable button and show loading state
        const analyzeButton = document.getElementById('analyzeButton');
        analyzeButton.disabled = true;
        analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
        document.getElementById('loadingIndicator').classList.remove('hidden');
        displayMessage('loading', `Fetching analysis for ${videoId}... This may take up to 30 seconds for complex videos.`);
        
        // Hide content area during analysis
        document.getElementById('contentArea').classList.add('hidden');
        document.getElementById('scoreButton').disabled = true;
        document.getElementById('exportButton').disabled = true;

        try {
            // Fetch endpoint needs the correct URL reference
            const response = await fetch('{% url "legalpages:api_analyze_video" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ video_url: videoUrl, video_id: videoId }),
            });

            // Check for non-JSON content first (e.g., if a Django error page was returned)
            const responseText = await response.text();
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                // If it fails to parse, it's likely an unhandled server error
                throw new Error(`Server returned non-JSON content. Status: ${response.status}. Content snippet: ${responseText.substring(0, 200)}`);
            }


            if (response.ok) {
                // Success: Render the fetched data
                renderContent(data);
                displayMessage('success'); // Clears loading message
                // Update the embedded video player
                document.getElementById('videoFrame').src = `https://www.youtube.com/embed/${videoId}`;

            } else {
                // Server-side error (e.g., API key missing, AI malformed response)
                displayMessage('error', data.message || 'An unknown error occurred during video analysis.');
            }

        } catch (error) {
            console.error('Network or Parsing Error:', error);
            displayMessage('error', 'A critical network or server error occurred: ' + error.message);
        } finally {
            // Re-enable button
            analyzeButton.disabled = false;
            analyzeButton.innerHTML = 'Analyze Video';
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
    }

    // Function to collect user answers and submit the quiz
    async function submitQuiz() {
        if (currentQuizData.length === 0) {
            displayMessage('error', 'No quiz data available to submit.');
            return;
        }
        
        const videoUrl = document.getElementById('videoLink').value.trim();
        const videoId = extractVideoId(videoUrl);

        const userAnswers = {};
        let allAnswered = true;

        // Collect answers from the form
        currentQuizData.forEach((q, index) => {
            const qId = `q${index}`;
            
            if (q.type === 'MCQ') {
                const selected = document.querySelector(`input[name="${qId}"]:checked`);
                if (selected) {
                    userAnswers[index] = selected.value; // Store the index (0, 1, 2, 3)
                } else {
                    userAnswers[index] = ''; // Store empty string for unanswered
                    allAnswered = false;
                }
            } else if (q.type === 'ShortAnswer') {
                const answerText = document.getElementById(`${qId}-answer`).value.trim();
                userAnswers[index] = answerText; // Store the text answer
                if (!answerText) {
                    allAnswered = false;
                }
            }
        });
        
        if (!allAnswered) {
             // Provide a warning but allow submission
            displayMessage('loading', 'Warning: Some questions were left unanswered. Submitting quiz now...');
        } else {
             displayMessage('loading', 'Submitting quiz and generating PDF report...');
        }

        // Disable buttons during submission
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        scoreButton.disabled = true;
        exportButton.disabled = true;

        try {
            const response = await fetch('{% url "legalpages:api_submit_quiz" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CSRF token would be included here in a full Django app:
                    // 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ 
                    video_id: videoId,
                    quiz_data: currentQuizData,
                    user_answers: userAnswers
                }),
            });

            if (response.ok) {
                // Successful response, trigger file download
                const blob = await response.blob();
                // Get filename and score from headers
                const contentDisposition = response.headers.get('Content-Disposition') || 'filename="report.pdf"';
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/i);
                const filename = filenameMatch ? filenameMatch[1] : `LearnFlow_AI_Report_${videoId}.pdf`;

                const scoreHeader = response.headers.get('X-Quiz-Score') || 'N/A';
                
                // Create a temporary link to trigger the download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                displayMessage('loading', `Quiz submitted! Your score is **${scoreHeader}**. Report downloading now...`);
                setTimeout(() => displayMessage('success'), 5000); // Clear after 5 seconds

            } else {
                // API returned an error (e.g., ReportLab not installed)
                const errorData = await response.json();
                displayMessage('error', errorData.message || 'Failed to submit quiz and generate report.');
            }

        } catch (error) {
            console.error('Quiz submission error:', error);
            displayMessage('error', 'A network error occurred during quiz submission.');
        } finally {
            scoreButton.disabled = false;
            exportButton.disabled = false;
        }
    }

    // --- Event Listeners and Initial Setup ---

    document.addEventListener('DOMContentLoaded', () => {
        const scoreButton = document.getElementById('scoreButton');
        
        // Dark mode toggle logic (simple version)
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
            });
        }
        
        // Initial tab state
        switchTab('summary');

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add the main event listeners
        document.getElementById('analyzeButton').addEventListener('click', analyzeVideo);
        document.getElementById('scoreButton').addEventListener('click', submitQuiz);
        // The export button re-triggers the submission (which re-downloads the report)
        document.getElementById('exportButton').addEventListener('click', submitQuiz); 
        
        // Initial button states
        scoreButton.disabled = true;
        
        // Auto-trigger analysis if a video ID was pre-selected (Django context)
        const videoLinkInput = document.getElementById('videoLink');
        if (videoLinkInput && videoLinkInput.value.startsWith('https://www.youtube.com')) {
            // Slight delay to ensure all JS/HTML elements are rendered before fetching
            setTimeout(analyzeVideo, 100); 
        }
    });

</script>
{% endblock %}