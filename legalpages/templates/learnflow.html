{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <style>
        /* Custom styles for the dark theme */
        :root {
            --color-background-dark: #111827; /* Gray-900 */
            --color-card-dark: #1f2937; /* Gray-800 */
            --color-primary-blue: #3b82f6; /* Blue-500 */
            --color-text-light: #f3f4f6; /* Gray-100 */
        }
        .bg-background-dark { background-color: var(--color-background-dark); }
        .bg-card-dark { background-color: var(--color-card-dark); }
        .text-text-light { color: var(--color-text-light); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: var(--color-primary-blue);
            color: var(--color-text-light);
        }

        /* Aspect ratio container for responsive iframe */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .markdown-output ul { list-style-type: disc; margin-left: 1.5rem; }
        .markdown-output ol { list-style-type: decimal; margin-left: 1.5rem; }
        .markdown-output h1, .markdown-output h2 { font-size: 1.25em; font-weight: 700; margin-top: 1rem; }
    </style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-background-dark text-text-light p-4 md:p-8 font-sans">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-white mb-2">LearnFlow: AI Video Analyst</h1>
            <p class="text-gray-400">Unlock the knowledge within any YouTube video instantly.</p>
        </header>

        <!-- Main Card Container -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Video Player and Input -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Video Player Card -->
                <div class="bg-card-dark p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-3">Video Source</h2>
                    <div id="video-player-container" class="video-container bg-gray-700">
                        <div class="flex items-center justify-center h-full text-gray-400">
                            Enter a YouTube link above to load the player.
                        </div>
                    </div>
                </div>

                <!-- Input Card -->
                <div class="bg-card-dark p-4 rounded-xl shadow-lg">
                    <div class="flex flex-col space-y-3">
                        <label for="video-link" class="text-sm font-medium text-gray-300">YouTube Video Link</label>
                        <input type="text" id="video-link" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                               class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                        
                        <button id="analyze-button" disabled
                                class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 disabled:bg-gray-600 disabled:cursor-not-allowed">
                            <i class="fas fa-play mr-2"></i> Analyze Video
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results and Tabs -->
            <div class="lg:col-span-2 bg-card-dark p-6 rounded-xl shadow-lg">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-700 mb-4 flex space-x-4 overflow-x-auto">
                    <button data-tab="summary" class="tab-button active py-2 px-4 text-sm font-medium transition duration-150">
                        <i class="fas fa-file-alt mr-1"></i> Summary
                    </button>
                    <button data-tab="quiz" class="tab-button py-2 px-4 text-sm font-medium transition duration-150">
                        <i class="fas fa-question-circle mr-1"></i> Quiz
                    </button>
                    <button data-tab="action_plan" class="tab-button py-2 px-4 text-sm font-medium transition duration-150">
                        <i class="fas fa-graduation-cap mr-1"></i> Action Plan
                    </button>
                </div>

                <!-- Content Area -->
                <div class="relative min-h-[500px]">
                    <!-- Loading Indicator/Overlay -->
                    <div id="loading-overlay" class="absolute inset-0 bg-card-dark bg-opacity-90 flex items-center justify-center hidden rounded-lg z-10">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                            <p class="text-lg font-semibold">Analyzing Video Content...</p>
                            <p class="text-sm text-gray-400 mt-1">Fetching transcript and generating AI insights.</p>
                        </div>
                    </div>

                    <!-- Summary Tab -->
                    <div id="summary-content" class="tab-content active markdown-output">
                        <div id="summary-output">
                            <p class="text-gray-400">The detailed summary and key takeaways will appear here once the video is processed.</p>
                        </div>
                    </div>

                    <!-- Quiz Tab -->
                    <div id="quiz-content" class="tab-content">
                        <div id="quiz-output" class="markdown-output">
                            <p class="text-gray-400">A multiple-choice quiz will be generated here.</p>
                        </div>
                        <button id="score-button" disabled
                                class="mt-4 py-2 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 disabled:bg-gray-600 disabled:cursor-not-allowed">
                            <i class="fas fa-check-circle mr-2"></i> Submit & Score Quiz
                        </button>
                        <div id="quiz-score-output" class="mt-3 font-semibold text-lg"></div>
                    </div>

                    <!-- Action Plan Tab -->
                    <div id="action_plan-content" class="tab-content markdown-output">
                        <div id="action_plan-output">
                            <p class="text-gray-400">Personalized next steps and resources will appear here.</p>
                        </div>
                    </div>
                </div>

                <!-- Footer Action Buttons -->
                <div class="mt-6 pt-4 border-t border-gray-700 flex justify-end">
                    <button id="export-button" disabled
                            class="py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-file-pdf mr-2"></i> Export Analysis (PDF)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Define the Django-resolved API URLs. THIS IS WHERE THE TEMPLATE ERROR IS FIXED.
    // We correctly pass the URL pattern name to the 'url' tag.
    const API_URLS = {
        analyze: "{% url 'legalpages:api_analyze_video' %}",
        submitQuiz: "{% url 'legalpages:api_submit_quiz' %}",
        exportContent: "{% url 'legalpages:api_export_content' %}",
    };

    // Global object for DOM elements
    const D = {
        videoLinkInput: document.getElementById('video-link'),
        analyzeButton: document.getElementById('analyze-button'),
        loadingOverlay: document.getElementById('loading-overlay'),
        videoPlayerContainer: document.getElementById('video-player-container'),
        summaryOutput: document.getElementById('summary-output'),
        quizOutput: document.getElementById('quiz-output'),
        action_planOutput: document.getElementById('action_plan-output'),
        scoreButton: document.getElementById('score-button'),
        quizScoreOutput: document.getElementById('quiz-score-output'),
        exportButton: document.getElementById('export-button'),
        tabButtons: document.querySelectorAll('.tab-button'),
        tabContents: document.querySelectorAll('.tab-content'),
    };

    // State management
    let currentVideoId = null;
    let currentQuizData = null;
    let currentSummary = '';
    let currentActionPlan = '';
    let currentQuizResults = null;

    /**
     * Extracts a YouTube video ID from a variety of YouTube URLs.
     * @param {string} url - The YouTube URL.
     * @returns {string | null} The video ID or null if not found.
     */
    function extractVideoId(url) {
        if (!url) return null;
        let videoId = null;
        try {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\/|watch\?v=|embed\/|v\/)|youtu\.be\/)([^&?%]{11})/;
            const match = url.match(regex);
            if (match && match[1]) {
                videoId = match[1];
            }
        } catch (e) {
            console.error("URL parsing error:", e);
        }
        return videoId;
    }

    /**
     * Loads the YouTube player iframe.
     * @param {string | null} videoId - The video ID to load.
     */
    function loadVideoPlayer(videoId) {
        D.videoPlayerContainer.innerHTML = ''; // Clear existing content
        if (videoId) {
            D.videoPlayerContainer.innerHTML = `
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=0&controls=1&showinfo=0&rel=0"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    title="YouTube video player">
                </iframe>`;
            currentVideoId = videoId;
        } else {
            D.videoPlayerContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400">
                Enter a YouTube link above to load the player.
            </div>`;
            currentVideoId = null;
        }
    }

    /**
     * Clears and resets all output panels to their initial state.
     */
    function resetOutputs() {
        currentQuizData = null;
        currentSummary = '';
        currentActionPlan = '';
        currentQuizResults = null;
        D.summaryOutput.innerHTML = '<p class="text-gray-400">The detailed summary and key takeaways will appear here once the video is processed.</p>';
        D.quizOutput.innerHTML = '<p class="text-gray-400">A multiple-choice quiz will be generated here.</p>';
        D.action_planOutput.innerHTML = '<p class="text-gray-400">Personalized next steps and resources will appear here.</p>';
        D.quizScoreOutput.textContent = '';
        D.scoreButton.disabled = true;
        D.exportButton.disabled = true;
    }

    /**
     * Gets the CSRF token from the cookie.
     */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    /**
     * Fetches analysis data from the server.
     */
    async function analyzeVideo() {
        if (!currentVideoId) return;

        resetOutputs(); // Clear previous results
        D.loadingOverlay.classList.remove('hidden');
        D.analyzeButton.disabled = true;
        D.analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Analyzing...';

        try {
            const response = await fetch(API_URLS.analyze, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    video_url: D.videoLinkInput.value.trim(),
                    video_id: currentVideoId
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "An unknown error occurred during analysis.");
            }
            
            // Store raw results
            currentSummary = data.summary || 'No summary generated.';
            currentQuizData = data.quiz_data || null;
            currentActionPlan = data.action_plan || 'No action plan generated.';

            // Render results
            D.summaryOutput.innerHTML = DOMPurify.sanitize(await marked.parse(currentSummary));
            D.action_planOutput.innerHTML = DOMPurify.sanitize(await marked.parse(currentActionPlan));
            renderQuiz(currentQuizData);

            // Enable action buttons
            D.exportButton.disabled = false;

        } catch (error) {
            console.error('Analysis failed:', error);
            // Display error message
            D.summaryOutput.innerHTML = `<p class="text-red-400 font-semibold">Error: ${error.message}</p>`;
            D.quizOutput.innerHTML = `<p class="text-red-400">Could not generate quiz: ${error.message}</p>`;
        } finally {
            D.loadingOverlay.classList.add('hidden');
            D.analyzeButton.disabled = false;
            D.analyzeButton.innerHTML = '<i class="fas fa-play mr-2"></i> Analyze Video';
            // Only re-enable score button if quiz data exists
            if (currentQuizData && currentQuizData.questions && currentQuizData.questions.length > 0) {
                 D.scoreButton.disabled = false;
            }
        }
    }
    
    /**
     * Renders the quiz from the fetched data.
     * @param {Object} quizData - The quiz data object.
     */
    function renderQuiz(quizData) {
        if (!quizData || !quizData.questions || quizData.questions.length === 0) {
            D.quizOutput.innerHTML = '<p class="text-gray-400">Quiz generation failed or no questions were provided.</p>';
            D.scoreButton.disabled = true;
            return;
        }

        let html = '<h3 class="text-xl font-bold mb-4">Multiple Choice Quiz</h3>';
        
        quizData.questions.forEach((q, qIndex) => {
            html += `<div class="mb-6 p-4 rounded-lg bg-gray-700">`;
            html += `<p class="font-semibold mb-3 text-blue-300">Question ${qIndex + 1}: ${q.question}</p>`;
            
            q.options.forEach((option, oIndex) => {
                const optionId = `q${qIndex}-o${oIndex}`;
                html += `
                    <div class="flex items-center mb-2">
                        <input type="radio" id="${optionId}" name="question-${qIndex}" value="${option}" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="${optionId}" class="ml-3 text-sm font-medium text-gray-300">${option}</label>
                    </div>`;
            });
            html += `</div>`;
        });

        D.quizOutput.innerHTML = DOMPurify.sanitize(html);
        D.scoreButton.disabled = false;
    }

    /**
     * Collects user answers and submits them for scoring.
     */
    async function submitQuiz() {
        if (!currentQuizData || !currentQuizData.questions) return;

        D.scoreButton.disabled = true;
        D.quizScoreOutput.textContent = 'Scoring...';

        const userAnswers = [];
        currentQuizData.questions.forEach((q, qIndex) => {
            const selected = document.querySelector(`input[name="question-${qIndex}"]:checked`);
            userAnswers.push({
                question: q.question,
                user_answer: selected ? selected.value : null,
                correct_answer: q.correct_answer,
                explanation: q.explanation // Include explanation for grading
            });
        });

        try {
            const response = await fetch(API_URLS.submitQuiz, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    video_id: currentVideoId,
                    answers: userAnswers,
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "An unknown error occurred during quiz submission.");
            }

            currentQuizResults = data.grading_data;
            renderQuizResults(currentQuizResults);
            D.exportButton.disabled = false; // Enable export after scoring
            
        } catch (error) {
            console.error('Quiz submission failed:', error);
            D.quizScoreOutput.innerHTML = `<p class="text-red-400">Scoring failed: ${error.message}</p>`;
        } finally {
            D.scoreButton.disabled = false;
        }
    }

    /**
     * Renders the graded quiz results.
     * @param {Object} results - The grading data object.
     */
    function renderQuizResults(results) {
        if (!results || !results.graded_questions) return;
        
        let score = 0;
        const total = results.graded_questions.length;
        let resultHtml = '';

        results.graded_questions.forEach(q => {
            if (q.is_correct) {
                score++;
                resultHtml += `<p class="text-green-400"><i class="fas fa-check-circle mr-2"></i> **Question:** ${q.question}</p>`;
            } else {
                resultHtml += `<p class="text-red-400"><i class="fas fa-times-circle mr-2"></i> **Question:** ${q.question}</p>`;
            }
            // Add feedback
            resultHtml += `<p class="text-sm text-gray-400 ml-6">**Your Answer:** ${q.user_answer || 'N/A'}</p>`;
            resultHtml += `<p class="text-sm text-gray-400 ml-6">**Correct Answer:** ${q.correct_answer}</p>`;
            resultHtml += `<p class="text-sm text-gray-300 ml-6 mb-3">**Explanation:** ${q.explanation}</p>`;
        });

        D.quizOutput.innerHTML = DOMPurify.sanitize(marked.parse(resultHtml));
        D.quizScoreOutput.innerHTML = `<p class="text-2xl font-bold mt-4">Score: <span class="text-blue-500">${score}</span> / ${total} (Accuracy: <span class="text-blue-500">${((score / total) * 100).toFixed(0)}%</span>)</p>`;
    }

    /**
     * Switches between content tabs.
     * @param {string} targetTab - The name of the tab to switch to ('summary', 'quiz', 'action_plan').
     */
    function switchTab(targetTab) {
        D.tabButtons.forEach(btn => btn.classList.remove('active'));
        D.tabContents.forEach(content => content.classList.remove('active'));

        document.querySelector(`.tab-button[data-tab="${targetTab}"]`).classList.add('active');
        document.getElementById(`${targetTab}-content`).classList.add('active');
    }

    /**
     * Initiates the PDF export process.
     */
    async function exportContent() {
        if (!currentVideoId) return;

        D.exportButton.disabled = true;
        D.exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating PDF...';

        // Prepare data for export
        const exportData = {
            video_title: document.title, // Use the default page title or fetch the actual video title
            summary: currentSummary,
            quiz_data: currentQuizResults, // Send graded results if available
            action_plan: currentActionPlan,
            video_id: currentVideoId,
        };

        try {
            const response = await fetch(API_URLS.exportContent, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(exportData),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Failed to generate PDF report.");
            }

            // Get blob and create a download link
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `LearnFlow_Report_${currentVideoId}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Notification (optional, replacing alert)
            console.log("PDF download initiated successfully.");

        } catch (error) {
            console.error('PDF Export Failed:', error);
            D.summaryOutput.innerHTML += `<p class="text-red-400 mt-4">PDF Export Failed: ${error.message}</p>`;
        } finally {
            D.exportButton.disabled = false;
            D.exportButton.innerHTML = '<i class="fas fa-file-pdf mr-2"></i> Export Analysis (PDF)';
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        // 1. URL Input Listener: Enable/Disable Analyze button and load player
        D.videoLinkInput.addEventListener('input', () => {
            const videoLink = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(videoLink);
            const isValid = videoId !== null;

            D.analyzeButton.disabled = !isValid;
            
            if (isValid) {
                 loadVideoPlayer(videoId);
                 resetOutputs();
            } else {
                 loadVideoPlayer(null); // Clear player if invalid
                 resetOutputs();
            }
        });

        // 2. Tab Button Listeners
        D.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 3. Main Action Button Listeners
        D.analyzeButton.addEventListener('click', analyzeVideo);
        D.scoreButton.addEventListener('click', submitQuiz); 
        D.exportButton.addEventListener('click', exportContent);
        
        // Initial setup
        resetOutputs();
        switchTab('summary');
    });

</script>

{% endblock %}
