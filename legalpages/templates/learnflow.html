{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}


{% block content %}
<main class="min-h-screen bg-background-dark text-text-light p-4 sm:p-6 lg:p-8 dark">
    <div class="max-w-7xl mx-auto">
        
        <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

        <header class="text-center py-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-light mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-blue to-blue-start">LearnFlow AI</span> Video Analysis
            </h1>
            <p class="text-lg text-gray-400">Transform any YouTube video into an interactive learning experience.</p>
        </header>

        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <div class="flex-grow w-full">
                    <label for="videoLink" class="block text-sm font-medium text-gray-300 mb-1">YouTube Video Link</label>
                    <input type="url" id="videoLink" name="videoLink" 
                           value="{{ pre_loaded_video_link|default:'' }}"
                           placeholder="Paste a YouTube URL (e.g., https://www.youtube.com/watch?v=...)"
                           class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-primary-blue focus:border-primary-blue">
                </div>
                <button id="analyzeButton" 
                        class="w-full sm:w-auto mt-4 sm:mt-0 px-6 py-3 bg-primary-blue hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200 disabled:bg-gray-600"
                        disabled>
                    Analyze Video
                </button>
            </div>
            <div id="loadingIndicator" class="hidden mt-4 text-primary-blue text-sm">
                <div class="flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary-blue"></div>
                    <span>Analyzing video content and generating quiz...</span>
                </div>
            </div>
        </div>

        <div id="videoPlayerContainer" class="bg-black mb-8 aspect-video w-full rounded-xl overflow-hidden shadow-2xl">
            <div id="videoPlaceholder" class="w-full h-full flex items-center justify-center bg-gray-900">
                <p class="text-gray-400 text-lg">Enter a YouTube link and click "Analyze Video" to load the player.</p>
            </div>
            <iframe id="videoIframe" width="100%" height="100%" frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    allowfullscreen style="display:none;">
            </iframe>
        </div>


        <div id="resultsContainer" class="hidden bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
            <div class="flex border-b border-gray-700 mb-6">
                <button data-tab="summary" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-primary-blue transition-colors duration-150" aria-selected="true">
                    Summary
                </button>
                <button data-tab="quiz" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-primary-blue transition-colors duration-150">
                    Quiz
                </button>
                <button data-tab="report" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-primary-blue transition-colors duration-150">
                    Report
                </button>
            </div>

            <div id="summaryContent" class="tab-content space-y-4 prose prose-invert max-w-none">
                <h2 class="text-xl font-bold text-white mb-4">Video Summary</h2>
                <div id="summaryText">
                    </div>
            </div>

            <div id="quizContent" class="tab-content hidden">
                <h2 class="text-xl font-bold text-white mb-4">Interactive Quiz</h2>
                <div id="quizQuestions" class="space-y-6">
                    </div>
                <div class="mt-8 flex justify-end">
                    <button id="scoreButton" 
                            class="px-6 py-3 bg-success-green hover:bg-green-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200 disabled:bg-gray-600" 
                            disabled>
                        Score Quiz & Get Report
                    </button>
                </div>
            </div>

            <div id="reportContent" class="tab-content hidden">
                <h2 class="text-xl font-bold text-white mb-4">Final Report</h2>
                <div id="reportResults" class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-lg font-medium">Your score: <span id="finalScore" class="font-bold text-primary-blue">N/A</span></p>
                    <p class="text-sm text-gray-400 mt-2">The report summary and quiz details are also available as a downloadable PDF.</p>
                </div>
                <div class="mt-4">
                    <a id="downloadLink" href="#" download="LearnFlow_Report.pdf" 
                       class="inline-block px-6 py-3 bg-warning-orange hover:bg-orange-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200 disabled:bg-gray-600"
                       style="display: none;">
                        Download PDF Report
                    </a>
                </div>
                <div id="pdfError" class="mt-4 text-red-400 text-sm hidden">
                    </div>
            </div>
        </div>
    </div>
</main>


<script>
    // Global state for storing quiz and analysis data
    let analysisData = {
        video_title: '',
        summary: '',
        quiz: [],
        correct_answers: [], // Store correct answers securely for scoring
        video_id: '',
    };
    
    // Global variable for the CSRF Token
    const CSRF_TOKEN = document.getElementById('csrfToken').value;

    function getCsrfHeaders() {
        return {
            'X-CSRFToken': CSRF_TOKEN,
            'Content-Type': 'application/json',
        };
    }
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-primary-blue', 'text-white');
            button.classList.add('border-transparent', 'text-gray-400');
            if (button.dataset.tab === tabName) {
                button.classList.add('border-primary-blue', 'text-white');
                button.classList.remove('border-transparent', 'text-gray-400');
            }
        });

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`${tabName}Content`).classList.remove('hidden');
    }

    function setAnalysisState(isAnalyzing, isAnalyzed) {
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContainer = document.getElementById('resultsContainer');
        const downloadLink = document.getElementById('downloadLink');

        analyzeButton.disabled = isAnalyzing;
        analyzeButton.textContent = isAnalyzing ? 'Analyzing...' : 'Analyze Video';
        loadingIndicator.classList.toggle('hidden', !isAnalyzing);
        resultsContainer.classList.toggle('hidden', !isAnalyzed);
        scoreButton.disabled = !isAnalyzed;
        
        // Hide download link and score on new analysis
        downloadLink.style.display = 'none';
        document.getElementById('finalScore').textContent = 'N/A';
        document.getElementById('pdfError').classList.add('hidden');
    }

    function loadVideoPlayer(videoLink) {
        const videoId = videoLink.match(/(?:v=|\/embed\/|\.be\/)([^&?]*)/) ? videoLink.match(/(?:v=|\/embed\/|\.be\/)([^&?]*)/)[1] : null;
        const iframe = document.getElementById('videoIframe');
        const placeholder = document.getElementById('videoPlaceholder');

        if (videoId) {
            iframe.src = `https://www.youtube.com/embed/${videoId}`;
            iframe.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            iframe.style.display = 'none';
            iframe.src = '';
            placeholder.style.display = 'flex';
        }
    }

    async function analyzeVideo() {
        const videoLinkInput = document.getElementById('videoLink');
        const videoLink = videoLinkInput.value;

        if (!videoLink) {
            alert("Please enter a YouTube video link.");
            return;
        }

        setAnalysisState(true, false);
        loadVideoPlayer(videoLink);
        document.getElementById('pdfError').classList.add('hidden'); // Clear previous errors

        try {
            const response = await fetch('/api/analyze_video/', {
                method: 'POST',
                headers: getCsrfHeaders(),
                body: JSON.stringify({ videoLink: videoLink, videoTitle: videoLinkInput.placeholder }),
            });

            const data = await response.json();

            if (data.status === 'success') {
                // Store results globally
                analysisData.video_title = data.video_title;
                analysisData.summary = data.summary;
                analysisData.quiz = data.quiz;
                analysisData.correct_answers = data.quiz.map(q => ({
                    question: q.question,
                    answer: q.answer
                })); // Secure copy of correct answers
                analysisData.video_id = data.video_id;

                // 1. Render Summary
                // Senior Dev Fix: Use DOMPurify for security and marked for Markdown rendering
                const summaryHtml = marked.parse(analysisData.summary);
                document.getElementById('summaryText').innerHTML = DOMPurify.sanitize(summaryHtml);

                // 2. Render Quiz
                renderQuiz(analysisData.quiz);

                setAnalysisState(false, true);
                switchTab('summary');
            } else {
                alert(`Analysis Failed: ${data.message}`);
                setAnalysisState(false, false);
                document.getElementById('videoIframe').src = ''; // Clear player on failure
            }

        } catch (error) {
            console.error('API Error:', error);
            alert('An unexpected error occurred during analysis. Please check the video link.');
            setAnalysisState(false, false);
        }
    }
    
    function renderQuiz(quiz) {
        const quizQuestionsContainer = document.getElementById('quizQuestions');
        quizQuestionsContainer.innerHTML = ''; // Clear previous quiz

        quiz.forEach((q, index) => {
            let questionHtml = `
                <div class="p-4 bg-gray-700 rounded-lg shadow-inner question-item" data-question-index="${index}">
                    <p class="font-semibold text-white mb-3">Q${index + 1}: ${DOMPurify.sanitize(q.question)}</p>
                    <div class="space-y-2">
            `;
            
            q.options.forEach((option, optionIndex) => {
                const optionId = `q${index}-opt${optionIndex}`;
                questionHtml += `
                    <div class="flex items-center p-3 bg-gray-600 rounded-md hover:bg-gray-500 cursor-pointer">
                        <input type="radio" id="${optionId}" name="question_${index}" value="${DOMPurify.sanitize(option)}" 
                               class="text-primary-blue bg-gray-800 border-gray-600 focus:ring-primary-blue h-4 w-4">
                        <label for="${optionId}" class="ml-3 text-sm text-gray-200 flex-grow">${DOMPurify.sanitize(option)}</label>
                    </div>
                `;
            });

            questionHtml += `
                    </div>
                    <p class="feedback mt-2 text-sm font-medium hidden"></p>
                </div>
            `;
            quizQuestionsContainer.innerHTML += questionHtml;
        });
    }
    
    function collectSubmittedAnswers() {
        const submitted_answers = [];
        const questionItems = document.querySelectorAll('.question-item');
        
        questionItems.forEach((item, index) => {
            const selectedRadio = item.querySelector(`input[name="question_${index}"]:checked`);
            
            submitted_answers.push({
                question_index: index,
                user_answer: selectedRadio ? selectedRadio.value : '',
            });
        });
        
        return submitted_answers;
    }

    async function submitQuiz() {
        // Disable buttons to prevent double-submission
        const scoreButton = document.getElementById('scoreButton');
        scoreButton.disabled = true;
        scoreButton.textContent = 'Generating Report...';
        
        const submittedAnswers = collectSubmittedAnswers();

        try {
            const response = await fetch('/api/submit_quiz/', {
                method: 'POST',
                headers: getCsrfHeaders(),
                body: JSON.stringify({
                    submitted_answers: submittedAnswers,
                    correct_answers: analysisData.correct_answers, // Pass correct answers from analysis state
                    video_title: analysisData.video_title,
                    summary: analysisData.summary
                }),
            });
            
            // Check for custom score header (used when PDF generation fails but scoring succeeds)
            const quizScoreHeader = response.headers.get('X-Quiz-Score');
            
            if (response.headers.get('content-type') === 'application/pdf') {
                // PDF was successfully generated and returned
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const downloadLink = document.getElementById('downloadLink');
                
                downloadLink.href = url;
                // Update filename to match server-provided title
                const contentDisposition = response.headers.get('Content-Disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch && filenameMatch[1]) {
                        downloadLink.download = filenameMatch[1];
                    }
                }
                downloadLink.style.display = 'inline-block';
                
                // Extract score from header
                document.getElementById('finalScore').textContent = quizScoreHeader || 'Report Generated';
                document.getElementById('pdfError').classList.add('hidden');

            } else {
                // Response is JSON (meaning an error or warning occurred)
                const data = await response.json();

                if (data.status === 'warning' && data.final_score) {
                    // Quiz was scored, but PDF generation failed
                    document.getElementById('finalScore').textContent = `${data.final_score}/${data.total_questions}`;
                    document.getElementById('pdfError').textContent = data.message;
                    document.getElementById('pdfError').classList.remove('hidden');
                    document.getElementById('downloadLink').style.display = 'none';

                } else if (data.status === 'error') {
                     // General scoring or submission error
                    alert(`Submission Failed: ${data.message}`);
                    document.getElementById('downloadLink').style.display = 'none';
                    document.getElementById('finalScore').textContent = 'Error';
                    
                } else {
                    alert('Submission received a non-PDF and non-error response.');
                }
            }

            // After processing, enable button and switch tab
            scoreButton.disabled = false;
            scoreButton.textContent = 'Score Quiz & Get Report';
            switchTab('report');

        } catch (error) {
            console.error('Submission Error:', error);
            alert('A critical network error occurred during quiz submission.');
            scoreButton.disabled = false;
            scoreButton.textContent = 'Score Quiz & Get Report';
        }
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const videoLinkInput = document.getElementById('videoLink');
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        
        // Initial button state logic
        const updateAnalyzeButtonState = () => {
            analyzeButton.disabled = !videoLinkInput.value.trim();
        };

        // Add input listener for analyze button state
        videoLinkInput.addEventListener('input', updateAnalyzeButtonState);
        updateAnalyzeButtonState(); // Check on load for pre-loaded links

        // Initial tab state
        switchTab('summary');

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add the main event listeners
        if (analyzeButton) analyzeButton.addEventListener('click', analyzeVideo);
        if (scoreButton) scoreButton.addEventListener('click', submitQuiz);
        
        // Auto-trigger analysis if a video ID was pre-selected (Django context)
        if (videoLinkInput && videoLinkInput.value.startsWith('https://www.youtube.com')) {
            loadVideoPlayer(videoLinkInput.value); // Load player immediately
            setTimeout(analyzeVideo, 500); // Wait briefly before starting analysis
        } else {
             // Ensure buttons are disabled initially if no video is pre-loaded
             setAnalysisState(false, false); 
        }
    });

</script>
{% endblock %}