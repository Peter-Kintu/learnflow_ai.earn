{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LearnFlow AI - Smart Video Learning</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Using Inter as the default font
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                    }
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-background-light font-sans p-4 md:p-8 min-h-screen">
    <div class="max-w-4xl mx-auto">
        <h1 id="mainTitle" class="text-3xl font-extrabold text-primary-blue pb-4 border-b-2 border-gray-200 mb-6 rounded-md"></h1>
        
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
            <input type="text" id="youtubeLink" class="flex-grow px-4 py-2 rounded-lg border border-gray-300 focus:ring-primary-blue focus:border-primary-blue transition shadow-sm" />
            <button onclick="analyzeVideo()" id="analyzeButton" class="px-6 py-2 rounded-lg bg-primary-blue hover:bg-hover-blue text-white font-semibold transition duration-300 shadow-lg disabled:opacity-50">
            </button>
        </div>
        
        <p id="statusMessage" role="status" aria-live="polite" class="text-error-red font-medium mt-2"></p>

        {% csrf_token %} 

        <div id="summarySection" class="bg-white p-6 mt-6 rounded-xl shadow-xl space-y-4">
            <!-- Summary content will be loaded here -->
        </div>
        
        <div id="quizSection" class="bg-white p-6 mt-6 rounded-xl shadow-xl space-y-4">
            <!-- Quiz content will be loaded here -->
        </div>
        
        <button onclick="generatePDF()" id="downloadButton" class="mt-6 block w-full px-6 py-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold transition duration-300 shadow-xl disabled:opacity-50">
        </button>
    </div>

    <script>
        // --- Internationalization (i18n) Object ---
        const i18n = {
            title: "ðŸŽ“ LearnFlow AI: Smart Video Learning",
            placeholder: "Paste ANY YouTube link here (Transcript via Django Backend)",
            analyzeButton: "Analyze Video",
            invalidLink: "Please enter a valid YouTube link.",
            statusAnalyzing: "Requesting transcript from Django backend...",
            statusSummary: "Generating summary notes with Summarizer API...",
            statusQuiz: "Generating quiz questions with Prompt API...",
            statusComplete: "Analysis Complete! Please complete the quiz and download your report.",
            errorPrefix: "Error during analysis:",
            summaryTitle: "Summary Notes (Generated by AI from Transcript)",
            quizTitle: "Interactive Quiz (3 Questions Generated by AI)",
            optionsNotAvailable: "Options not available.",
            noQuiz: "No quiz generated.",
            scorePrefix: "Score:",
            downloadButton: "Download Report ðŸ“„",
            pdfReportTitle: "LearnFlow AI Quiz & Summary Report",
            pdfQuizSection: "Quiz Performance",
            pdfSummarySection: "Video Summary Notes",
            pdfWatermark: "LearnFlow AI Â© 2025 - Chrome AI Challenge",
            pdfAlert: "PDF library not loaded or broken. Cannot generate report. Check console for details."
        };

        // --- Initialize UI Text for Worldwide Use ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById("mainTitle").innerText = i18n.title;
            document.getElementById("youtubeLink").setAttribute("placeholder", i18n.placeholder);
            document.getElementById("analyzeButton").innerText = i18n.analyzeButton;
            document.getElementById("downloadButton").innerText = i18n.downloadButton;
            document.getElementById("downloadButton").style.display = "none";
        });
        
        let currentQuizAnswers = []; 

        // --- Core Application Flow ---
        async function analyzeVideo() {
            const link = document.getElementById("youtubeLink").value;
            const status = document.getElementById("statusMessage");
            const analyzeBtn = document.getElementById("analyzeButton");
            status.style.color = '#d93025'; // Default error color

            if (!link || !link.includes("youtube.com")) {
                status.innerText = i18n.invalidLink;
                return;
            }
            
            document.getElementById("summarySection").innerHTML = "";
            document.getElementById("quizSection").innerHTML = "";
            document.getElementById("downloadButton").style.display = "none";
            
            // Set initial status
            status.innerText = i18n.statusAnalyzing;
            status.style.color = '#1a73e8'; // Blue for pending status
            analyzeBtn.disabled = true;

            try {
                // Step 1: Request transcript from Django backend
                const transcript = await fetchTranscript(link); 

                // Step 2: Summarizer API (Client-side)
                status.innerText = i18n.statusSummary;
                const summary = await summarizeText(transcript); 
                document.getElementById("summarySection").innerHTML = `<h2 class="text-xl font-bold text-gray-800 mb-2">${i18n.summaryTitle}</h2><p class="text-gray-600">${summary}</p>`;
                
                // Step 3: Prompt API for quiz (Client-side)
                status.innerText = i18n.statusQuiz;
                const quiz = await generateQuiz(summary); 
                
                // Step 4: Render
                renderQuiz(quiz);
                
                status.innerText = i18n.statusComplete;
                status.style.color = '#10b981'; // Green for success
                document.getElementById("downloadButton").style.display = "block";

            } catch (error) {
                status.innerText = `${i18n.errorPrefix} ${error.message}`;
                status.style.color = '#d93025'; // Red for error
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        // --- AI API MOCK/REAL Functions ---

        /** * REAL INTEGRATION: Uses AJAX POST to call the Django backend endpoint.
          * Django handles the complex, real YouTube transcript fetching using Python.
          **/
        async function fetchTranscript(link) {
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';

            const formData = new FormData();
            formData.append('youtube_link', link);
            
            try {
                // Fetch call to the Django API endpoint
                const response = await fetch('/api/fetch_transcript/', {
                    method: 'POST',
                    headers: {
                        // Pass the CSRF token in the header
                        'X-CSRFToken': csrfToken 
                    },
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Server returned HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.status === "success") {
                    // This is the real transcript text returned from the Django backend.
                    console.log("Transcript successfully received from Django backend.");
                    return data.transcript;
                } else {
                    throw new Error(`Backend API Error: ${data.message}`);
                }
            } catch (error) {
                console.error("Error fetching transcript from Django API. Falling back to client-side mock.", error);
                
                // Fallback to the stable mock if the backend/API call fails
                await new Promise(resolve => setTimeout(resolve, 500)); 
                return `[FALLBACK MODE] Backend failed to provide a transcript. Using a stable mock: The video emphasizes the use of **HTML and JavaScript** for the Chrome Built-in AI Challenge. Key tools are the **Summarizer API** for notes, the **Prompt API** for generating quizzes, and **jsPDF** for client-side report generation, enabling efficient offline use via Gemini Nano.`;
            }
        }

        /** MOCK/REAL: Simulates/Calls the Chrome Summarizer API. **/
        async function summarizeText(text) {
            if (typeof chrome.ai?.summarizer?.summarize === 'function') {
                const result = await chrome.ai.summarizer.summarize({ text: text });
                return result.summary;
            }

            // Mocking the result if the API is not available
            await new Promise(resolve => setTimeout(resolve, 800)); 
            
            // Generate a summary from the *input* text
            const isFallback = text.includes("[FALLBACK MODE]");
            if (isFallback) {
                return `[Fallback Summary] This app uses **HTML and JavaScript** for the Chrome AI Challenge, leveraging the **Summarizer API** for notes, the **Prompt API** for quizzes, and **jsPDF** for client-side reports, enabling offline use via Gemini Nano.`;
            } else {
                return `This video explains how to build a powerful AI application for the Chrome Built-in AI Challenge using only **HTML and JavaScript**. It emphasizes that the **Summarizer API** handles note-taking and the **Prompt API** creates dynamic content like quizzes. The final user report, complete with a quiz score and watermark, is generated client-side using the **jsPDF** library. This approach allows the app to work efficiently offline using Gemini Nano.`;
            }
        }

        /** MOCK/REAL: Simulates/Calls the Chrome Prompt API for structured JSON output. **/
        async function generateQuiz(summary) {
            // PROMPT DEFINITION FOR THE CHROME PROMPT API
            const systemInstruction = `You are a helpful education assistant. Your sole task is to generate exactly 3 multiple-choice questions based on the provided text.
The response MUST be a clean JSON array (no markdown code blocks, preambles, or explanations) where each object has three keys: "question" (string), "options" (array of 4 strings), and "answerIndex" (integer 0-3 indicating the correct option).`;
            
            const userPrompt = `Generate a quiz based on the following study summary notes. Ensure the questions test key concepts from the text.
---
SUMMARY NOTES:
${summary}
---`;
            
            // Check for the real API environment
            if (typeof chrome.ai?.prompt?.generate === 'function') {
                const response = await chrome.ai.prompt.generate({ prompt: userPrompt, systemInstruction: systemInstruction });
                
                // Clean the response: remove markdown code block fences if they exist
                const jsonString = response.text.trim().replace(/```json|```/g, '');
                
                try {
                    const quiz = JSON.parse(jsonString);
                    // Store the correct answers globally
                    currentQuizAnswers = quiz.map(q => q.answerIndex);
                    return quiz;
                } catch (e) {
                    console.error("Failed to parse JSON response from Prompt API:", jsonString, e);
                    throw new Error("AI did not return a clean quiz structure.");
                }
            }

            // --- MOCKING THE RESULT if the API is not available ---
            await new Promise(resolve => setTimeout(resolve, 1200)); 
            
            const mockQuiz = [
                { question: "What web technologies are required for the Chrome AI Challenge submission?", options: ["HTML & CSS only", "Python & Node.js", "HTML & JavaScript only", "React & Firebase"], answerIndex: 2 },
                { question: "Which Chrome Built-in API is used to generate study notes?", options: ["Translator API", "Summarizer API", "Image API", "Prompt API"], answerIndex: 1 },
                { question: "The final PDF report uses which client-side library?", options: ["PDF.js", "jsPDF", "DomToImage", "Acrobat SDK"], answerIndex: 1 }
            ];
            
            currentQuizAnswers = mockQuiz.map(q => q.answerIndex);
            return mockQuiz;
        }

        // --- Quiz Rendering, Scoring, and PDF Generation ---

        function renderQuiz(quiz) {
            const container = document.getElementById("quizSection");
            container.innerHTML = `<h2 class="text-xl font-bold text-gray-800 mb-4">${i18n.quizTitle}</h2>`;
            
            quiz.forEach((q, i) => {
                const optionsHtml = Array.isArray(q.options) 
                    ? q.options.map((opt, idx) => `
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded-md transition">
                            <input type="radio" name="q${i}" value="${idx}" class="text-primary-blue focus:ring-primary-blue"> 
                            <span class="text-gray-700">${opt}</span>
                        </label>
                    `).join("")
                    : `<p class="text-gray-500">${i18n.optionsNotAvailable}</p>`;

                container.innerHTML += `
                    <div class="border border-gray-200 p-4 rounded-lg shadow-sm">
                        <p class="mb-3"><strong>${i + 1}.</strong> ${q.question}</p>
                        <div class="space-y-1">${optionsHtml}</div>
                    </div>
                `;
            });
        }

        function calculateResults() {
            let correctCount = 0;
            const totalQuestions = currentQuizAnswers.length;

            if (totalQuestions === 0) {
                return i18n.noQuiz;
            }

            for (let i = 0; i < totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                
                if (selectedOption) {
                    const userAnswerIndex = parseInt(selectedOption.value, 10);
                    const correctAnswerIndex = currentQuizAnswers[i];

                    if (userAnswerIndex === correctAnswerIndex) {
                        correctCount++;
                    }
                }
            }

            const percentage = ((correctCount / totalQuestions) * 100).toFixed(0);
            return `${i18n.scorePrefix} ${correctCount} out of ${totalQuestions} (${percentage}%)`;
        }
        
        function generatePDF() {
            // Check for jsPDF availability
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF !== 'function') {
                const status = document.getElementById("statusMessage");
                // Replaced alert() with status message update
                status.innerText = i18n.pdfAlert;
                status.style.color = '#d93025'; // Ensure error is visible
                console.error("jsPDF library not properly loaded.");
                return;
            }

            const summaryText = document.getElementById("summarySection").innerText || i18n.summaryTitle;
            const quizResults = calculateResults(); 
            const watermark = i18n.pdfWatermark;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yOffset = 15;

            // Title
            doc.setFontSize(18);
            doc.text(i18n.pdfReportTitle, 10, yOffset);
            yOffset += 10;
            doc.line(10, yOffset, 200, yOffset); // Horizontal line
            yOffset += 10;
            
            // Quiz Results
            doc.setFontSize(14);
            doc.text(i18n.pdfQuizSection, 10, yOffset);
            yOffset += 8;
            doc.setFontSize(12);
            doc.text(quizResults, 10, yOffset);
            yOffset += 15;

            // Summary Notes
            doc.setFontSize(14);
            doc.text(i18n.pdfSummarySection, 10, yOffset);
            yOffset += 8;
            doc.setFontSize(10);
            
            // Split text to fit within PDF page width
            const splitSummary = doc.splitTextToSize(summaryText, 180);
            doc.text(splitSummary, 10, yOffset);

            // Watermark/Footer (Static position at the bottom)
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(watermark, 150, 280); 
            
            doc.save("LearnFlowAI_SmartReport.pdf");
        }
    </script>
</body>
</html>
