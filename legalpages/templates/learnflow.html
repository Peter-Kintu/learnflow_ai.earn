{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class on the html tag
            theme: {
                extend: {
                    fontFamily: {
                        // Using Inter as the default font
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        // Adding custom blue-black gradient colors
                        'blue-start': '#1e3a8a', // A dark blue
                        'black-end': '#0f172a',  // A very dark blue-black (slate-900)
                    },
                    // Add the 'prose' plugin configuration if it were being loaded dynamically,
                    // but since we're using the CDN, we rely on its defaults + responsive variants.
                }
            }
        }
    </script>

    <!-- JS Libraries for PDF and Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto font-sans p-4 md:p-8 min-h-screen rounded-lg shadow-xl 
                bg-white dark:bg-black-end dark:text-gray-100 transition-colors duration-300">
        
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 dark:border-gray-700">
            <!-- Title and Description -->
            <div class="mb-4 sm:mb-0">
                <h1 id="mainTitle" class="text-3xl font-extrabold text-primary-blue dark:text-white mb-1">
                    Smart Video Learning
                </h1>
                <p id="subTitle" class="text-gray-500 dark:text-gray-400">
                    Analyze any YouTube video: Get summary, quiz, and transcript.
                </p>
            </div>

            <!-- Export and Dark Mode Toggle -->
            <div class="flex space-x-3 items-center">
                <button id="exportPdfButton" onclick="pdfExport()" disabled
                    class="flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-lg 
                            bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 
                            hover:bg-gray-300 disabled:opacity-50 transition-colors duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span id="exportPdfText">Export to PDF</span>
                </button>
                <button id="darkModeToggle" aria-label="Toggle Dark Mode" onclick="toggleDarkMode()"
                    class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
                    <!-- Icon will be dynamically set by JS -->
                    <svg id="darkModeIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </div>

        <!-- Input Section -->
        <div class="mb-8 p-6 bg-background-light dark:bg-gray-800 rounded-xl shadow-inner transition-colors duration-300">
            <label for="youtubeLink" id="inputLabel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Enter YouTube Video Link:
            </label>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <input type="url" id="youtubeLink" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                       class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-700 dark:text-white"
                       required>
                <button id="generateButton" onclick="handleTranscriptFetch(event)"
                        class="px-6 py-3 bg-primary-blue text-white font-semibold rounded-lg shadow-md 
                                hover:bg-hover-blue transition-colors duration-200 disabled:opacity-50">
                    <span id="generateButtonText">Generate Summary & Quiz</span>
                </button>
            </div>
            <p id="errorFeedback" class="text-error-red text-sm mt-2 hidden"></p>
        </div>

        <!-- Video Player (Hidden until loaded) -->
        <div id="videoPlayerContainer" class="mb-8 hidden">
            <div class="aspect-video bg-gray-300 dark:bg-gray-700 rounded-xl overflow-hidden shadow-lg">
                <iframe id="videoPlayer" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
            <button data-tab="summary" class="tab-button tab-active" id="tab_summary">Summary</button>
            <button data-tab="quiz" class="tab-button" id="tab_quiz">Quiz</button>
            <button data-tab="transcript" class="tab-button" id="tab_transcript">Transcript</button>
        </div>

        <!-- Content Area -->
        <div id="contentArea" class="space-y-6">

            <!-- Summary Tab Content -->
            <div id="summaryContent" class="tab-content">
                <div id="summarySection" class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300">
                    <p id="summaryPlaceholder" class="text-center italic text-gray-400 dark:text-gray-500">
                        Enter a YouTube link and click 'Generate' to see the summary here.
                    </p>
                    <div id="summaryLoading" class="hidden text-center p-8">
                        <svg class="animate-spin h-6 w-6 text-primary-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-2 text-primary-blue dark:text-primary-blue-light">Generating detailed summary...</p>
                    </div>
                </div>
                <div id="summaryCitations" class="mt-4 p-4 border-t border-gray-200 dark:border-gray-700 hidden text-sm text-gray-500 dark:text-gray-400">
                    <h4 class="font-semibold mb-2">Sources Used:</h4>
                    <ul id="citationList" class="list-disc ml-5 space-y-1"></ul>
                </div>
            </div>

            <!-- Quiz Tab Content -->
            <div id="quizContent" class="tab-content hidden">
                <div id="quizSection" class="space-y-6">
                    <p id="quizPlaceholder" class="text-center italic text-gray-400 dark:text-gray-500">
                        Once the summary is ready, the system will generate a quiz here.
                    </p>
                    <div id="quizLoading" class="hidden text-center p-8">
                        <svg class="animate-spin h-6 w-6 text-primary-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-2 text-primary-blue dark:text-primary-blue-light">Crafting multiple-choice questions...</p>
                    </div>
                </div>
                <!-- Score Button & Results -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                    <button id="scoreButton" onclick="displayQuizResults()" disabled
                            class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md 
                                    hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 hidden">
                        <span id="scoreButtonText">Score Quiz</span>
                    </button>
                    <p id="quizResultDisplay" class="text-lg font-bold text-gray-700 dark:text-gray-200 hidden"></p>
                </div>
            </div>

            <!-- Transcript Tab Content -->
            <div id="transcriptContent" class="tab-content hidden">
                <div id="transcriptSection" class="prose dark:prose-invert max-w-none whitespace-pre-wrap text-gray-700 dark:text-gray-300">
                    <p id="transcriptPlaceholder" class="text-center italic text-gray-400 dark:text-gray-500">
                        The full video transcript will appear here.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Feedback Link (Bottom of Page) -->
        <div class="mt-12 pt-6 border-t border-gray-200 dark:border-gray-700 text-center">
            <p id="feedbackPromptText" class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                Did this analysis help you? We value your feedback!
            </p>
            <a href="#" id="feedbackLink" class="text-sm font-medium text-primary-blue hover:text-hover-blue dark:text-primary-blue-light">
                Give Feedback
            </a>
        </div>

    </div>

{% endblock %}

{% block extra_js %}
<script>
    // --- Global State and Constants ---
    const API_URL = "{% url 'legalpages:api_fetch_transcript' %}";
    const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
    const API_KEY = ""; // Canvas will automatically provide this
    let quizData = []; // To store the generated quiz questions and correct answers
    let videoId = ''; // To store the fetched video ID

    // --- Localization/Internationalization (i18n) ---
    const i18n = {
        mainTitle: "Smart Video Learning",
        subTitle: "Analyze any YouTube video: Get summary, quiz, and transcript.",
        inputLabel: "Enter YouTube Video Link:",
        generateButtonText: "Generate Summary & Quiz",
        errorInvalidLink: "Please enter a valid YouTube link (e.g., watch?v=... or youtu.be/...).",
        tabSummary: "Summary",
        tabQuiz: "Quiz",
        tabTranscript: "Transcript",
        placeholderSummary: "Enter a YouTube link and click 'Generate' to see the summary here.",
        placeholderQuiz: "Once the summary is ready, the system will generate a quiz here.",
        placeholderTranscript: "The full video transcript will appear here.",
        feedbackPrompt: "Did this analysis help you? We value your feedback!",
        feedbackLink: "Give Feedback",
        exportPdfText: "Export to PDF",
        darkModeToggle: "Toggle Dark Mode",
        // PDF Texts
        pdfReportTitle: "LearnFlow AI - Video Analysis Report",
        pdfQuizSection: "Quiz Results",
        pdfSummarySection: "Summary Notes",
        pdfWatermark: "Generated by LearnFlow AI",
        // Loading texts
        loadingTranscript: "Fetching transcript...",
        loadingSummary: "Generating detailed summary...",
        loadingQuiz: "Crafting multiple-choice questions...",
        // Error texts
        errorFetchFailed: (error) => `Error fetching data: ${error}`,
        errorQuizParse: "Failed to parse quiz data from AI. Please try generating again."
    };

    // --- Core Functions: Dark Mode & Localization ---
    function initializeDarkMode() {
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        document.documentElement.classList.toggle('dark', isDarkMode);
        updateDarkModeIcon(isDarkMode);
    }

    function toggleDarkMode() {
        const isDarkMode = document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', isDarkMode);
        updateDarkModeIcon(isDarkMode);
    }

    function updateDarkModeIcon(isDarkMode) {
        const icon = document.getElementById('darkModeIcon');
        if (icon) {
            // Sun icon for light mode (meaning it toggles to dark)
            // Moon icon for dark mode (meaning it toggles to light)
            icon.innerHTML = isDarkMode
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
        }
    }

    function applyLocalization() {
        document.getElementById('mainTitle').textContent = i18n.mainTitle;
        document.getElementById('subTitle').textContent = i18n.subTitle;
        document.getElementById('inputLabel').textContent = i18n.inputLabel;
        document.getElementById('generateButtonText').textContent = i18n.generateButtonText;
        document.getElementById('exportPdfText').textContent = i18n.exportPdfText;
        document.getElementById('tab_summary').textContent = i18n.tabSummary;
        document.getElementById('tab_quiz').textContent = i18n.tabQuiz;
        document.getElementById('tab_transcript').textContent = i18n.tabTranscript;
        document.getElementById('summaryPlaceholder').textContent = i18n.placeholderSummary;
        document.getElementById('quizPlaceholder').textContent = i18n.placeholderQuiz;
        document.getElementById('transcriptPlaceholder').textContent = i18n.placeholderTranscript;
        document.getElementById('feedbackPromptText').textContent = i18n.feedbackPrompt;
        document.getElementById('feedbackLink').textContent = i18n.feedbackLink;
        
        // ARIA labels
        document.getElementById('darkModeToggle').setAttribute('aria-label', i18n.darkModeToggle);
    }

    // --- Utility Functions ---

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('tab-active');
            button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-primary-blue', 'dark:hover:text-white');
        });

        document.getElementById(`${tabId}Content`).classList.remove('hidden');
        const activeTab = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
        activeTab.classList.add('tab-active');
        activeTab.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-primary-blue', 'dark:hover:text-white');
    }

    function setLoadingState(elementId, isLoading, loadingText = '') {
        const element = document.getElementById(elementId);
        const placeholder = document.getElementById(`${elementId.replace('Loading', 'Placeholder')}`);
        const section = document.getElementById(`${elementId.replace('Loading', 'Section')}`);
        
        if (element) {
            element.classList.toggle('hidden', !isLoading);
        }
        if (placeholder) {
            placeholder.classList.toggle('hidden', isLoading);
        }
        if (section && !isLoading) {
            section.innerHTML = ''; // Clear previous content when generation is complete
        }
    }

    function updateVideoPlayer(id) {
        const playerContainer = document.getElementById('videoPlayerContainer');
        const player = document.getElementById('videoPlayer');
        
        if (id) {
            player.src = `https://www.youtube.com/embed/${id}?autoplay=0&rel=0`;
            playerContainer.classList.remove('hidden');
        } else {
            playerContainer.classList.add('hidden');
        }
    }

    function updateError(message) {
        const errorElement = document.getElementById('errorFeedback');
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
        document.getElementById('generateButton').disabled = false;
        document.getElementById('generateButtonText').textContent = i18n.generateButtonText;
    }

    function clearResults() {
        document.getElementById('summarySection').innerHTML = `<p id="summaryPlaceholder" class="text-center italic text-gray-400 dark:text-gray-500">${i18n.placeholderSummary}</p>`;
        document.getElementById('quizSection').innerHTML = `<p id="quizPlaceholder" class="text-center italic text-gray-400 dark:text-gray-500">${i18n.placeholderQuiz}</p>`;
        document.getElementById('transcriptSection').innerHTML = `<p id="transcriptPlaceholder" class="text-center italic text-gray-400 dark:text-gray-500">${i18n.placeholderTranscript}</p>`;
        document.getElementById('errorFeedback').classList.add('hidden');
        document.getElementById('exportPdfButton').disabled = true;
        document.getElementById('videoPlayerContainer').classList.add('hidden');
        document.getElementById('scoreButton').classList.add('hidden');
        document.getElementById('quizResultDisplay').classList.add('hidden');
        document.getElementById('summaryCitations').classList.add('hidden');
        quizData = [];
    }
    
    // --- API Calls to Gemini ---

    async function callGeminiAPI(payload, maxRetries = 5) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429) {
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    } else {
                        throw new Error("Rate limit exceeded after multiple retries.");
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     // Check for block reasons if content is empty
                     if (candidate?.finishReason === 'SAFETY') {
                        throw new Error("Content blocked due to safety settings.");
                    }
                    throw new Error("Model response was empty or malformed.");
                }

                // Extract text
                const text = candidate.content.parts[0].text;

                // Extract grounding sources (citations)
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); 
                }

                return { text, sources };

            } catch (error) {
                if (attempt === maxRetries - 1) {
                    throw new Error(`Gemini API call failed: ${error.message}`);
                }
            }
        }
    }
    
    // --- Summary Generation ---
    async function generateSummary(transcript) {
        setLoadingState('summaryLoading', true, i18n.loadingSummary);
        
        const systemPrompt = `You are an expert educational content writer. Your task is to summarize the provided video transcript. The summary must be detailed, easy to understand, and structured using clear markdown headings (##, ###) and bullet points. Focus on key concepts and main takeaways. The summary should be approximately 300 words.`;
        const userQuery = `Summarize the following video transcript. Use citations for any factual information. TRANSCRIPT:\n\n${transcript}`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            // Use Google Search grounding for factual accuracy
            tools: [{ "google_search": {} }], 
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        try {
            const { text, sources } = await callGeminiAPI(payload);
            const summarySection = document.getElementById('summarySection');
            
            // Convert markdown to HTML and sanitize
            const htmlContent = marked.parse(text);
            summarySection.innerHTML = DOMPurify.sanitize(htmlContent);
            
            // Display citations
            const citationList = document.getElementById('citationList');
            citationList.innerHTML = '';
            if (sources.length > 0) {
                sources.forEach(source => {
                    if (source.uri && source.title) {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a href="${source.uri}" target="_blank" class="text-primary-blue hover:underline">${source.title}</a>`;
                        citationList.appendChild(listItem);
                    }
                });
                document.getElementById('summaryCitations').classList.remove('hidden');
            } else {
                document.getElementById('summaryCitations').classList.add('hidden');
            }

        } catch (error) {
            document.getElementById('summarySection').innerHTML = `<p class="text-error-red">Summary Generation Failed: ${error.message}</p>`;
        } finally {
            setLoadingState('summaryLoading', false);
            // Enable PDF export after summary is done
            document.getElementById('exportPdfButton').disabled = false;
        }
    }

    // --- Quiz Generation ---
    async function generateQuiz(transcript) {
        setLoadingState('quizLoading', true, i18n.loadingQuiz);

        const quizSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "question": { "type": "STRING", "description": "The multiple-choice question derived from the video content." },
                    "options": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "An array of 4 possible answers." },
                    "correct_answer": { "type": "STRING", "description": "The correct answer text, which must match one of the options exactly." }
                },
                required: ["question", "options", "correct_answer"],
                propertyOrdering: ["question", "options", "correct_answer"]
            }
        };

        const systemPrompt = "You are an AI specialized in generating educational quizzes. Your task is to create 5 multiple-choice questions (MCQs) based on the provided transcript. Ensure each question has exactly 4 options and the correct_answer field exactly matches one of the options.";
        const userQuery = `Generate 5 multiple-choice questions from the following transcript: \n\n${transcript}`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: quizSchema
            }
        };

        try {
            const { text } = await callGeminiAPI(payload);
            // The response should be a JSON string
            quizData = JSON.parse(text);
            renderQuiz(quizData);

        } catch (error) {
            console.error(error);
            document.getElementById('quizSection').innerHTML = `<p class="text-error-red">${i18n.errorQuizParse}</p>`;
        } finally {
            setLoadingState('quizLoading', false);
        }
    }

    function renderQuiz(questions) {
        const quizSection = document.getElementById('quizSection');
        quizSection.innerHTML = '';
        quizSection.classList.add('space-y-6');

        questions.forEach((q, qIndex) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'p-4 rounded-lg bg-gray-50 dark:bg-gray-700 shadow-md';
            
            let html = `<p class="font-semibold text-gray-800 dark:text-gray-100 mb-3">Q${qIndex + 1}: ${q.question}</p><div class="space-y-2">`;
            
            q.options.forEach((option, oIndex) => {
                const optionId = `q${qIndex}o${oIndex}`;
                html += `
                    <label for="${optionId}" class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-150">
                        <input type="radio" id="${optionId}" name="question${qIndex}" value="${option}" class="text-primary-blue focus:ring-primary-blue mr-3">
                        <span class="text-gray-700 dark:text-gray-300">${option}</span>
                    </label>
                `;
            });

            html += '</div>';
            questionElement.innerHTML = html;
            quizSection.appendChild(questionElement);
        });

        // Show the score button
        document.getElementById('scoreButton').classList.remove('hidden');
        document.getElementById('scoreButton').disabled = false;
        document.getElementById('quizResultDisplay').classList.add('hidden');
    }

    function calculateResults() {
        let correctCount = 0;
        let totalCount = quizData.length;
        let resultsText = '';

        quizData.forEach((q, qIndex) => {
            const selectedOption = document.querySelector(`input[name="question${qIndex}"]:checked`);
            const isCorrect = selectedOption && selectedOption.value === q.correct_answer;
            
            if (isCorrect) {
                correctCount++;
            }

            // Create detailed results text for PDF
            resultsText += `Q${qIndex + 1}: ${q.question}\n`;
            resultsText += `Selected: ${selectedOption ? selectedOption.value : 'N/A'}\n`;
            resultsText += `Correct: ${q.correct_answer}\n\n`;

            // Apply visual feedback to the quiz UI
            const options = document.querySelectorAll(`input[name="question${qIndex}"]`);
            options.forEach(input => {
                const label = input.closest('label');
                label.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'bg-red-100', 'bg-green-100', 'dark:bg-red-900', 'dark:bg-green-900');
                
                if (input.value === q.correct_answer) {
                    label.classList.add('bg-green-100', 'dark:bg-green-900/50', 'text-green-800', 'dark:text-green-300');
                    label.querySelector('span').classList.remove('text-gray-700', 'dark:text-gray-300');
                    label.querySelector('span').classList.add('font-bold', 'text-green-800', 'dark:text-green-300');
                } else if (selectedOption && input === selectedOption && !isCorrect) {
                    label.classList.add('bg-red-100', 'dark:bg-red-900/50', 'text-red-800', 'dark:text-red-300');
                    label.querySelector('span').classList.remove('text-gray-700', 'dark:text-gray-300');
                }
            });
            
            // Disable all inputs after scoring
            options.forEach(input => input.disabled = true);
        });

        const score = `${correctCount} / ${totalCount}`;
        const resultDisplay = document.getElementById('quizResultDisplay');
        resultDisplay.textContent = `Your Score: ${score}`;
        resultDisplay.classList.remove('hidden');
        document.getElementById('scoreButton').disabled = true;

        return `Final Score: ${score}\n\nDetailed Answers:\n\n${resultsText}`;
    }

    function displayQuizResults() {
        calculateResults();
    }

    // --- Main Transcript Fetching Logic ---
    async function handleTranscriptFetch(event) {
        event.preventDefault();
        
        clearResults(); // Clear previous data
        
        const linkInput = document.getElementById('youtubeLink');
        const link = linkInput.value.trim();

        if (!link) {
            updateError(i18n.errorInvalidLink);
            return;
        }

        // Show loading state for the main process
        const generateButton = document.getElementById('generateButton');
        generateButton.disabled = true;
        document.getElementById('generateButtonText').textContent = i18n.loadingTranscript;
        document.getElementById('errorFeedback').classList.add('hidden');
        document.getElementById('transcriptPlaceholder').textContent = i18n.loadingTranscript;
        switchTab('summary');


        try {
            // 1. Fetch the transcript from the Django backend
            const fetchResponse = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    // Note: Django generally requires a CSRF token for POST, but in this
                    // isolated environment, we proceed without it.
                },
                body: `youtube_link=${encodeURIComponent(link)}`
            });

            if (!fetchResponse.ok) {
                const errorData = await fetchResponse.json().catch(() => ({ message: 'Unknown server error.' }));
                throw new Error(errorData.message);
            }

            const response = await fetchResponse.json();

            if (response.status === 'success') {
                const transcript = response.transcript;
                videoId = response.video_id; // Store globally
                
                // 2. Display the transcript
                document.getElementById('transcriptSection').innerHTML = `<p class="whitespace-pre-wrap">${transcript}</p>`;

                // 3. Update the video player
                updateVideoPlayer(videoId);

                // 4. Generate Summary and Quiz (run in parallel)
                await Promise.all([
                    generateSummary(transcript),
                    generateQuiz(transcript)
                ]);

            } else {
                throw new Error(response.message || 'Failed to process video.');
            }

        } catch (error) {
            console.error("Fetch/Generation Error:", error);
            updateError(i18n.errorFetchFailed(error.message));
        } finally {
            generateButton.disabled = false;
            document.getElementById('generateButtonText').textContent = i18n.generateButtonText;
        }
    }
    
    // --- PDF Export Logic ---
    function pdfExport() {
        // Ensure jspdf is loaded
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            updateError("PDF library not fully loaded yet. Please wait a moment and try again.");
            return;
        }

        // Gather content
        const summaryText = document.getElementById("summarySection").innerText || i18n.placeholderSummary;
        // Check if quiz has been generated/attempted
        const quizResults = quizData.length > 0 ? calculateResults() : "Quiz not yet attempted."; 
        const watermark = i18n.pdfWatermark;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let yOffset = 15;
        const pageHeight = doc.internal.pageSize.height;

        // Title
        doc.setFontSize(18);
        doc.text(i18n.pdfReportTitle, 10, yOffset);
        yOffset += 10;
        doc.line(10, yOffset, 200, yOffset); // Horizontal line
        yOffset += 10;
        
        // Quiz Results
        doc.setFontSize(14);
        doc.text(i18n.pdfQuizSection, 10, yOffset);
        yOffset += 8;
        doc.setFontSize(10);
        
        const splitQuiz = doc.splitTextToSize(quizResults, 180);
        doc.text(splitQuiz, 10, yOffset);
        yOffset += splitQuiz.length * 5 + 10; // Adjust for content height + margin

        // Summary Notes
        doc.setFontSize(14);
        doc.text(i18n.pdfSummarySection, 10, yOffset);
        yOffset += 8;
        doc.setFontSize(10);
        
        // Split text to fit within PDF page width and handle page breaks
        const splitSummary = doc.splitTextToSize(summaryText, 180);
        
        splitSummary.forEach(line => {
            if (yOffset > pageHeight - 30) { // Check if we are near the bottom
                doc.addPage();
                yOffset = 15; // Reset yOffset for new page
            }
            doc.text(line, 10, yOffset);
            yOffset += 5;
        });

        // Watermark (Optional: added to the last page only for simplicity)
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(watermark, doc.internal.pageSize.width / 2, pageHeight - 10, { align: 'center' });

        doc.save(`LearnFlow_Report_${videoId || 'analysis'}.pdf`);
    }

    // --- Event Listeners and Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize dark mode first
        initializeDarkMode();
        
        // Apply text content
        applyLocalization();

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });
        
        // Initial setup
        switchTab('summary');
        
        // Add CSS for active tab button
        const style = document.createElement('style');
        style.textContent = `
            .tab-button {
                padding: 10px 16px;
                font-weight: 500;
                border-bottom-width: 2px;
                transition: all 0.2s ease-in-out;
            }
            .tab-active {
                border-color: #1a73e8; /* primary-blue */
                color: #1a73e8; /* primary-blue */
                background-color: #ffffff; /* white */
            }
            .dark .tab-active {
                border-color: #4285f4; /* A light primary blue */
                color: #ffffff; /* white */
                background-color: transparent; 
            }
        `;
        document.head.appendChild(style);
    });

</script>
{% endblock %}
