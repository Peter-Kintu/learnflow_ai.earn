{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <style>
        /* Custom styles for the dark theme and responsive video player */
        :root {
            --color-background-dark: #1f2937; /* Gray-800 */
            --color-primary-blue: #3b82f6; /* Blue-500 */
            --color-text-light: #f3f4f6; /* Gray-100 */
        }
        .bg-background-dark { background-color: var(--color-background-dark); }
        .text-text-light { color: var(--color-text-light); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Aspect ratio container for responsive iframe */
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-text-light p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-blue-400 mb-6">LearnFlow AI: Video Analysis Tool</h1>
        
        <!-- Global Alert Box for Errors and Success Messages (IMPROVED CLARITY) -->
        <div id="global-alert" role="alert" 
             class="hidden p-4 mb-6 rounded-lg border-l-4 font-medium transition-opacity duration-300">
        </div>
        
        <!-- Input and Control Area -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <!-- Video Link Input -->
                <input type="url" id="video-link-input" placeholder="Paste YouTube Video URL here..." 
                       class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" 
                       value="{{ initial_url|default:'' }}"
                >
                
                <!-- Analyze Button -->
                <button id="analyze-button" disabled 
                        class="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-all duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    <i class="fas fa-magic mr-2"></i> Analyze Video
                </button>
            </div>
        </div>

        <!-- Main Content Layout (Video Player on Left, Analysis Tabs on Right) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Video Player and Score Button -->
            <div class="lg:col-span-1 space-y-6">
                <div class="video-container">
                    <div id="video-player">
                        <!-- YouTube iframe will be loaded here -->
                        <div class="flex items-center justify-center w-full h-full bg-gray-700 absolute top-0 left-0">
                            <p class="text-gray-400">Paste a YouTube URL to load the video.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Score and Export Button -->
                <div class="flex gap-4">
                    <button id="score-button" disabled
                            class="flex-grow px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition-all duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <i class="fas fa-check-circle mr-2"></i> Score Quiz
                    </button>
                    <button id="export-button" disabled
                            class="flex-grow px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-md transition-all duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <i class="fas fa-file-pdf mr-2"></i> Export Report
                    </button>
                </div>
            </div>

            <!-- Right Column: Analysis Tabs -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-2xl">
                <!-- Tab Navigation -->
                <div id="tab-buttons" class="flex border-b border-gray-700 mb-4">
                    <button data-tab="summary" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 transition duration-150 active-tab-class">Summary</button>
                    <button data-tab="quiz" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 transition duration-150">Quiz</button>
                    <button data-tab="action-plan" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 transition duration-150">Action Plan</button>
                </div>

                <!-- Tab Contents -->
                <div class="min-h-[400px]">
                    <!-- Summary Tab -->
                    <div id="summary-content" data-tab="summary" class="tab-content active">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-400">Comprehensive Summary</h2>
                        <div id="summary-output" class="prose max-w-none text-gray-200">
                            <p class="text-gray-400">The detailed summary will appear here once the video is processed.</p>
                        </div>
                    </div>

                    <!-- Quiz Tab -->
                    <div id="quiz-content" data-tab="quiz" class="tab-content">
                        <h2 class="2xl:text-2xl font-semibold mb-4 text-blue-400">Generated Quiz</h2>
                        <div id="quiz-output" class="space-y-6">
                            <p class="text-gray-400">A multiple-choice quiz will be generated here.</p>
                        </div>
                        <div id="quiz-score-display" class="mt-6 text-xl font-bold hidden p-4 rounded-lg bg-gray-700"></div>
                    </div>

                    <!-- Action Plan Tab -->
                    <div id="action-plan-content" data-tab="action-plan" class="tab-content">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-400">Personalized Action Plan</h2>
                        <div id="action-plan-output" class="prose max-w-none text-gray-200">
                            <p class="text-gray-400">Personalized next steps and resources will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DOM Elements (D) & State ---
        const D = {
            videoLinkInput: document.getElementById('video-link-input'),
            analyzeButton: document.getElementById('analyze-button'),
            scoreButton: document.getElementById('score-button'),
            exportButton: document.getElementById('export-button'),
            globalAlert: document.getElementById('global-alert'), // Updated element for centralized errors/success
            videoPlayer: document.getElementById('video-player'),
            tabButtons: document.querySelectorAll('.tab-button'),
            summaryOutput: document.getElementById('summary-output'),
            quizOutput: document.getElementById('quiz-output'),
            action_planOutput: document.getElementById('action-plan-output'),
            quizScoreDisplay: document.getElementById('quiz-score-display'),
        };

        let currentAnalysis = {
            video_title: '',
            summary: '',
            quiz: [], // The initial quiz data from the AI
            action_plan: '',
            graded_quiz: null, // The scored quiz data after submission
        };
        
        const API_URLS = {
            analyze: "{% url 'legalpages:api_analyze_video' %}",
            submit: "{% url 'legalpages:api_submit_quiz' %}",
            export: "{% url 'legalpages:api_export_content' %}",
        };

        // --- 2. Helper Functions (Updated for Clarity) ---
        
        /**
         * Displays a temporary alert message (success or error).
         * @param {string} message - The message content.
         * @param {string} type - 'error' (default) or 'success'.
         */
        function displayAlert(message, type = 'error') {
            D.globalAlert.textContent = message;
            // Reset classes
            D.globalAlert.classList.remove('hidden', 'bg-red-800', 'text-red-200', 'border-red-600', 
                                              'bg-green-800', 'text-green-200', 'border-green-600');
            
            if (type === 'error') {
                D.globalAlert.classList.add('bg-red-800', 'text-red-200', 'border-red-600', 'border-opacity-80');
                D.globalAlert.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${message}`;
            } else {
                D.globalAlert.classList.add('bg-green-800', 'text-green-200', 'border-green-600', 'border-opacity-80');
                D.globalAlert.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ${message}`;
            }
            D.globalAlert.classList.remove('hidden');

            // Auto-hide after 8 seconds
            setTimeout(() => D.globalAlert.classList.add('hidden'), 8000);
        }

        /**
         * Safely extracts the YouTube video ID from various URL formats.
         * @param {string} url - The YouTube URL.
         * @returns {string | null} The video ID or null if invalid.
         */
        function extractVideoId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        /**
         * Updates the video player iframe.
         * @param {string | null} videoId - The YouTube video ID.
         */
        function loadVideoPlayer(videoId) {
            if (videoId) {
                const iframe = `<iframe width="100%" height="100%" 
                                        src="https://www.youtube.com/embed/${videoId}" 
                                        frameborder="0" allow="accelerometer; autoplay; clipboard-write; 
                                        encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen></iframe>`;
                D.videoPlayer.innerHTML = iframe;
            } else {
                 D.videoPlayer.innerHTML = `
                    <div class="flex items-center justify-center w-full h-full bg-gray-700 absolute top-0 left-0">
                        <p class="text-gray-400">Paste a YouTube URL to load the video.</p>
                    </div>`;
            }
        }
        
        /**
         * Toggles the active tab display.
         * @param {string} targetTab - The data-tab value of the tab to activate.
         */
        function switchTab(targetTab) {
            D.tabButtons.forEach(button => {
                const tabContent = document.getElementById(`${button.dataset.tab}-content`);
                if (button.dataset.tab === targetTab) {
                    button.classList.add('border-blue-500', 'text-blue-400');
                    button.classList.remove('border-transparent', 'text-gray-300');
                    tabContent.classList.add('active');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-400');
                    button.classList.add('border-transparent', 'text-gray-300');
                    tabContent.classList.remove('active');
                }
            });
        }
        
        /**
         * Clears all analysis output areas and resets state.
         */
        function resetAnalysis() {
            currentAnalysis = { video_title: '', summary: '', quiz: [], action_plan: '', graded_quiz: null };
            D.summaryOutput.innerHTML = '<p class="text-gray-400">The detailed summary will appear here once the video is processed.</p>';
            D.quizOutput.innerHTML = '<p class="text-gray-400">A multiple-choice quiz will be generated here.</p>';
            D.action_planOutput.innerHTML = '<p class="text-gray-400">Personalized next steps and resources will appear here.</p>';
            D.quizScoreDisplay.classList.add('hidden');
            D.scoreButton.disabled = true;
            D.exportButton.disabled = true;
        }

        /**
         * Renders the quiz based on the quiz data.
         * (Rendering logic remains the same for correctness)
         */
        function renderQuiz(quizData, isGraded = false) {
            if (!quizData || quizData.length === 0) {
                D.quizOutput.innerHTML = '<p class="text-red-400">Quiz generation failed or no content was available.</p>';
                return;
            }

            let html = '';
            quizData.forEach((q, qIndex) => {
                html += `<div class="p-4 rounded-lg bg-gray-700 shadow-inner">`;
                html += `<p class="font-bold text-lg mb-3 text-blue-300">Question ${qIndex + 1}: ${DOMPurify.sanitize(q.question)}</p>`;
                
                const selectedAnswer = currentAnalysis.graded_quiz ? q.user_answer : q.options.find(opt => q.user_answer === opt);

                q.options.forEach((option, oIndex) => {
                    const optionId = `q${qIndex}-o${oIndex}`;
                    
                    let inputClass = 'form-radio h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 focus:ring-blue-500';
                    let labelClass = 'ml-3 text-gray-200 cursor-pointer';
                    let answerStatus = '';

                    if (isGraded) {
                        const isUserAnswer = (option === q.user_answer);
                        const isCorrect = (option === q.correct_answer);
                        
                        if (isCorrect) {
                            labelClass += ' text-green-400 font-semibold';
                            answerStatus = ' <i class="fas fa-check-circle ml-1"></i> (Correct Answer)';
                        } else if (isUserAnswer) {
                            labelClass += ' text-red-400 line-through';
                            answerStatus = ' <i class="fas fa-times-circle ml-1"></i> (Your Incorrect Answer)';
                        }
                    }

                    html += `<div class="flex items-center my-2">
                                <input id="${optionId}" 
                                       type="radio" 
                                       name="question-${qIndex}" 
                                       value="${DOMPurify.sanitize(option)}" 
                                       data-q-index="${qIndex}"
                                       ${option === selectedAnswer ? 'checked' : ''}
                                       ${isGraded ? 'disabled' : ''}
                                       class="${inputClass}">
                                <label for="${optionId}" class="${labelClass}">
                                    ${DOMPurify.sanitize(option)} ${answerStatus}
                                </label>
                            </div>`;
                });
                html += `</div>`;
            });

            D.quizOutput.innerHTML = html;
        }

        /**
         * Shows the loading state.
         */
        function startLoading(button) {
            button.disabled = true;
            button.originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
        }

        /**
         * Stops the loading state.
         */
        function stopLoading(button) {
            if (button.originalText) {
                button.innerHTML = button.originalText;
                button.originalText = null;
            }
            // Button state (disabled/enabled) is managed by caller functions
        }
        
        // --- 3. Main Logic Functions (Updated for Error Handling) ---

        /**
         * CORE FUNCTION: Fetches analysis data from the Django API.
         */
        async function analyzeVideo() {
            resetAnalysis(); 
            const videoUrl = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(videoUrl);
            const videoTitle = 'YouTube Video Analysis'; 

            if (!videoId) {
                displayAlert("Please enter a valid YouTube video URL.", 'error');
                return;
            }
            
            startLoading(D.analyzeButton);
            D.scoreButton.disabled = true;
            D.exportButton.disabled = true;
            
            try {
                const response = await fetch(API_URLS.analyze, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ 
                        video_url: videoUrl,
                        video_title: videoTitle
                    })
                });

                if (!response.ok) {
                    let errorText = `HTTP Error ${response.status}: ${response.statusText}.`;
                    
                    // Attempt to extract specific error message from backend JSON
                    try {
                        const data = await response.json();
                        if (data.error) {
                            errorText = data.error;
                        }
                    } catch (e) {
                        // If JSON parsing fails, use the default errorText
                    }
                    
                    displayAlert(`Analysis failed: ${errorText}`, 'error');
                    D.analyzeButton.disabled = false;
                    return; // Exit function on failure
                }

                // SUCCESS PATH
                const data = await response.json();
                
                currentAnalysis.summary = data.summary;
                currentAnalysis.quiz = data.quiz;
                currentAnalysis.action_plan = data.action_plan;
                currentAnalysis.video_title = data.video_title || videoTitle;

                // Render results
                D.summaryOutput.innerHTML = DOMPurify.sanitize(marked.parse(data.summary));
                D.action_planOutput.innerHTML = DOMPurify.sanitize(marked.parse(data.action_plan));
                renderQuiz(data.quiz, false); 

                // Enable score button and switch to quiz tab
                D.scoreButton.disabled = false;
                switchTab('quiz');
                displayAlert("Video analyzed successfully! Quiz and Summary are ready.", 'success');

            } catch (e) {
                console.error("Fetch error during analysis:", e);
                displayAlert("A network error occurred. Check your connection and console for details.", 'error');
            } finally {
                stopLoading(D.analyzeButton);
            }
        }
        
        /**
         * Submits the user's quiz answers for grading.
         */
        async function submitQuiz() {
            if (currentAnalysis.quiz.length === 0) {
                displayAlert("Cannot score: No quiz questions available.", 'error');
                return;
            }
            
            startLoading(D.scoreButton);
            D.exportButton.disabled = true;

            // 1. Collect user answers (as before)
            const userAnswers = [];
            currentAnalysis.quiz.forEach((q, qIndex) => {
                const checkedRadio = document.querySelector(`input[name="question-${qIndex}"]:checked`);
                userAnswers.push({
                    question: q.question,
                    correct_answer: q.correct_answer,
                    options: q.options,
                    user_answer: checkedRadio ? checkedRadio.value : null
                });
            });

            // 2. Call the grading API (Updated Error Handling)
            try {
                const response = await fetch(API_URLS.submit, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ quiz_data: userAnswers })
                });

                if (!response.ok) {
                    let errorText = `HTTP Error ${response.status}: ${response.statusText}.`;
                    
                    try {
                        const data = await response.json();
                        if (data.error) {
                            errorText = data.error;
                        }
                    } catch (e) {}

                    displayAlert(`Grading failed: ${errorText}`, 'error');
                    D.scoreButton.disabled = false; // Re-enable for another try
                    return;
                }

                // SUCCESS PATH
                const data = await response.json();
                const gradedData = data.grading_data;
                currentAnalysis.graded_quiz = gradedData;
                
                // 3. Render graded results
                renderQuiz(gradedData.questions, true); 
                
                D.quizScoreDisplay.innerHTML = `<span class="${gradedData.score >= (gradedData.total_questions / 2) ? 'text-green-400' : 'text-red-400'}">
                    Your Score: ${gradedData.score} / ${gradedData.total_questions}
                </span>`;
                D.quizScoreDisplay.classList.remove('hidden');

                // 4. Enable Export
                D.exportButton.disabled = false;
                D.scoreButton.disabled = true; 
                displayAlert("Quiz successfully scored!", 'success');

            } catch (e) {
                console.error("Fetch error during quiz submission:", e);
                displayAlert("A network error occurred while grading. Check the console for details.", 'error');
            } finally {
                stopLoading(D.scoreButton);
            }
        }
        
        /**
         * Generates and downloads the PDF report.
         */
        async function exportContent() {
            if (!currentAnalysis.graded_quiz) {
                displayAlert("Please score the quiz before exporting the report.", 'error');
                return;
            }

            startLoading(D.exportButton);
            
            try {
                const payload = {
                    video_title: currentAnalysis.video_title,
                    summary: currentAnalysis.summary,
                    quiz_data: currentAnalysis.graded_quiz,
                    action_plan: currentAnalysis.action_plan,
                };

                const response = await fetch(API_URLS.export, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Get the file name from the Content-Disposition header
                    const filenameMatch = response.headers.get('Content-Disposition').match(/filename="(.+)"/);
                    const filename = filenameMatch ? filenameMatch[1] : 'analysis_report.pdf';

                    // Create a blob from the response and trigger download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    displayAlert("PDF report downloaded successfully!", 'success');

                } else {
                    let errorText = `HTTP Error ${response.status}: ${response.statusText}.`;
                    
                    // Try to parse error from backend (Django JsonResponse)
                    try {
                        const data = await response.json();
                        if (data.error) {
                            errorText = data.error;
                        }
                    } catch (e) {
                        // If it's not JSON, just use the status text
                    }
                    
                    displayAlert(`Export failed: ${errorText}`, 'error');
                }

            } catch (e) {
                console.error("Fetch error during export:", e);
                displayAlert("A network error occurred while exporting. Check the console for details.", 'error');
            } finally {
                stopLoading(D.exportButton);
            }
        }
        
        /**
         * Utility to get CSRF token for Django POST requests.
         */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // --- 4. Initialization and Event Listeners ---
        
        // Initial setup based on input value (for deep linking)
        if (D.videoLinkInput.value) {
            const initialId = extractVideoId(D.videoLinkInput.value.trim());
            if (initialId) {
                loadVideoPlayer(initialId);
                D.analyzeButton.disabled = false;
            }
        }

        // 1. URL Input Listener: Enable/Disable Analyze button and load player
        D.videoLinkInput.addEventListener('input', () => {
            const url = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(url);
            const isValid = videoId !== null;
            
            // Re-enable/disable the analyze button
            D.analyzeButton.disabled = !isValid;
            
            // Reset and load player
            resetAnalysis(); 
            loadVideoPlayer(videoId);
        });

        // 2. Tab Button Listeners
        D.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 3. Main Action Button Listeners
        D.analyzeButton.addEventListener('click', analyzeVideo);
        D.scoreButton.addEventListener('click', submitQuiz); 
        D.exportButton.addEventListener('click', exportContent);
        
        // Initial Tab Activation
        switchTab('summary');
    });
</script>
{% endblock %}
