{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <style>
        /* Custom styles for the dark theme and responsive video player */
        :root {
            --color-background-dark: #1f2937; /* Gray-800 */
            --color-primary-blue: #3b82f6; /* Blue-500 */
            --color-text-light: #f3f4f6; /* Gray-100 */
        }
        .bg-background-dark { background-color: var(--color-background-dark); }
        .text-text-light { color: var(--color-text-light); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Aspect ratio container for responsive iframe */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Styling for the tab buttons */
        .tab-button.active {
            border-bottom: 3px solid var(--color-primary-blue);
            color: var(--color-primary-blue);
            font-weight: 600;
        }

        /* Markdown output styling */
        .markdown-content h1, .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--color-primary-blue);
        }
        .markdown-content p, .markdown-content ul, .markdown-content ol, .markdown-content li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            list-style-type: disc;
        }
        .markdown-content strong {
            color: #ffffff;
        }
        
    </style>
{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-8 bg-background-dark min-h-screen text-text-light font-sans">
    <h1 class="text-3xl md:text-4xl font-extrabold mb-6 text-center text-white">
        <i class="fas fa-brain text-blue-500 mr-2"></i> LearnFlow AI: Deep Video Analysis
    </h1>
    <p class="text-center text-gray-400 mb-8 max-w-2xl mx-auto">
        Paste a YouTube video link below to generate a detailed summary, a multiple-choice quiz, and a personalized action plan for learning.
    </p>

    <!-- Main Input & Action Section -->
    <div class="bg-gray-700 p-6 rounded-xl shadow-2xl mb-8">
        <div class="flex flex-col md:flex-row gap-4">
            <input type="url" id="videoLinkInput" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                   class="flex-grow p-3 rounded-lg bg-gray-800 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500"
                   value="{{ preloaded_video_url }}" required>
            <button id="analyzeButton"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed shadow-md"
                    disabled>
                <i class="fas fa-play-circle mr-2"></i> Analyze Video
            </button>
        </div>
        <div id="messageBox" class="mt-4 p-3 rounded-lg hidden transition-all duration-300"></div>
    </div>

    <!-- Layout: Video Player (Left) & Analysis Output (Right) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Video Player -->
        <div class="lg:col-span-1">
            <div id="videoPlayer" class="video-container bg-gray-800 flex items-center justify-center p-4">
                <p class="text-gray-400">Video player will load here.</p>
            </div>
            
            <!-- Quiz Submission and Export Buttons -->
            <div class="bg-gray-700 p-4 rounded-xl shadow-xl mt-4 space-y-3">
                <h3 class="text-xl font-semibold text-white mb-2">Quiz & Report</h3>
                <div id="quizScore" class="p-3 bg-gray-800 rounded-lg text-center text-white">
                    <p class="text-sm text-yellow-300">Submit your answers to see your score!</p>
                </div>
                <button id="scoreButton"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed shadow-md"
                        disabled>
                    <i class="fas fa-check-circle mr-2"></i> Submit Answers
                </button>
                <button id="exportButton"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed shadow-md"
                        disabled>
                    <i class="fas fa-file-pdf mr-2"></i> Export Report (PDF)
                </button>
            </div>
        </div>

        <!-- Right Column: Analysis Tabs -->
        <div class="lg:col-span-2">
            <div class="bg-gray-700 p-6 rounded-xl shadow-2xl">
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-600 mb-6">
                    <button data-tab="summary" class="tab-button px-4 py-2 text-gray-300 hover:text-blue-400 transition duration-150">
                        <i class="fas fa-clipboard-list mr-2"></i> Summary
                    </button>
                    <button data-tab="quiz" class="tab-button px-4 py-2 text-gray-300 hover:text-blue-400 transition duration-150">
                        <i class="fas fa-question-circle mr-2"></i> Quiz
                    </button>
                    <button data-tab="action_plan" class="tab-button px-4 py-2 text-gray-300 hover:text-blue-400 transition duration-150">
                        <i class="fas fa-map-marked-alt mr-2"></i> Action Plan
                    </button>
                </div>
                
                <!-- Tab Content Containers -->
                <div id="summaryOutput" class="tab-content active markdown-content min-h-[300px]">
                    <p class="text-gray-400">The detailed video summary will appear here once the video is processed.</p>
                </div>
                <div id="quizOutput" class="tab-content min-h-[300px] space-y-6">
                    <p class="text-gray-400">A multiple-choice quiz will be generated here.</p>
                </div>
                <div id="action_planOutput" class="tab-content markdown-content min-h-[300px]">
                    <p class="text-gray-400">Personalized next steps and resources will appear here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global state for analysis data and active video ID
    let currentAnalysis = null;
    let currentVideoId = null;
    let currentGradedQuiz = null;

    // Helper to extract the video ID from various YouTube URL formats
    function extractVideoId(url) {
        if (!url) return null;
        url = url.trim();
        
        // 1. Standard watch link: ?v=ID
        let match = url.match(/v=([^&]+)/);
        if (match && match[1].length === 11) return match[1];

        // 2. Shortened link: youtu.be/ID
        match = url.match(/youtu\.be\/([^?]+)/);
        if (match && match[1].length === 11) return match[1];

        // 3. Embed link: /embed/ID
        match = url.match(/\/embed\/([^?]+)/);
        if (match && match[1].length === 11) return match[1];

        // 4. If the input is already a bare ID (11 characters)
        if (url.length === 11 && /^[a-zA-Z0-9_-]+$/.test(url)) return url;

        return null;
    }

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Helper to render markdown content safely
    function renderMarkdown(markdown, element) {
        try {
            const html = marked.parse(markdown);
            element.innerHTML = DOMPurify.sanitize(html);
        } catch (e) {
            console.error("Markdown rendering failed:", e);
            element.innerHTML = `<p class="text-red-400">Error rendering content.</p>`;
        }
    }
    
    // Helper to display dynamic messages
    function displayMessage(type, message) {
        const box = document.getElementById('messageBox');
        box.classList.remove('hidden', 'bg-red-900', 'bg-yellow-900', 'bg-green-900');
        box.classList.add('p-3');
        box.innerHTML = `<p class="font-medium">${message}</p>`;

        if (type === 'error') {
            box.classList.add('bg-red-900', 'text-red-200');
        } else if (type === 'loading') {
            box.classList.add('bg-yellow-900', 'text-yellow-200');
        } else if (type === 'success') {
            box.classList.add('bg-green-900', 'text-green-200');
        }
    }

    // Helper to load YouTube player
    function loadVideoPlayer(videoId) {
        const playerDiv = document.getElementById('videoPlayer');
        if (videoId) {
            playerDiv.innerHTML = `
                <iframe 
                    width="100%" 
                    height="100%" 
                    src="https://www.youtube.com/embed/${videoId}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            `;
        } else {
            playerDiv.innerHTML = '<p class="text-gray-400">Video player will load here.</p>';
        }
    }

    // Helper to render the Quiz structure
    function renderQuiz(quizData, element) {
        if (!quizData || quizData.length === 0) {
            element.innerHTML = '<p class="text-gray-400">No quiz questions were generated.</p>';
            return;
        }

        let html = '';
        quizData.forEach((q, index) => {
            // Assign a unique ID for client-side tracking
            const questionId = `q${index + 1}`; 
            q.question_id = questionId; // Store it back in the data object

            html += `<div class="p-4 rounded-lg bg-gray-600 shadow-md">
                        <h4 class="text-lg font-semibold text-white mb-3">Q${index + 1}: ${DOMPurify.sanitize(q.question)}</h4>
                        <div class="space-y-2" data-question-id="${questionId}">`;
            
            Object.keys(q.options).forEach(key => {
                const optionText = DOMPurify.sanitize(q.options[key]);
                const radioId = `${questionId}-${key}`;
                
                html += `
                    <label for="${radioId}" class="flex items-center p-2 rounded-lg cursor-pointer transition duration-150 ease-in-out hover:bg-gray-500">
                        <input type="radio" id="${radioId}" name="${questionId}" value="${key}" class="form-radio text-blue-500 h-4 w-4 mr-3">
                        <span class="text-white">${key}. ${optionText}</span>
                    </label>
                `;
            });

            html += `</div>
                    </div>`;
        });
        element.innerHTML = html;
    }
    
    // Helper to handle tab switching
    function switchTab(tabName) {
        D.tabButtons.forEach(button => {
            button.classList.remove('active');
            if (button.dataset.tab === tabName) {
                button.classList.add('active');
            }
        });

        D.tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `${tabName}Output`) {
                content.classList.add('active');
            }
        });
    }

    // --- Core Functions ---

    // 1. Analyze Video Function (Main Action)
    async function analyzeVideo() {
        const videoUrl = D.videoLinkInput.value.trim();
        const videoId = extractVideoId(videoUrl);

        if (!videoId) {
            displayMessage("error", "Invalid YouTube URL provided.");
            return;
        }

        // Reset UI and show loading
        resetAnalysisOutputs();
        displayMessage("loading", `<i class="fas fa-sync-alt fa-spin mr-2"></i> Analyzing video and generating content with Gemini AI...`);
        D.analyzeButton.disabled = true;
        D.scoreButton.disabled = true; 
        D.exportButton.disabled = true;

        try {
            const response = await fetch('{% url "legalpages:api_analyze_video" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') 
                },
                body: JSON.stringify({ video_url: videoUrl })
            });

            const responseData = await response.json(); 

            if (!response.ok) {
                // This handles 400 (Bad URL) or 500 (Hard Transcript/AI Error)
                const errorMessage = responseData.error || `Server error: Status ${response.status}`;
                displayMessage("error", errorMessage);
                return;
            }

            // Success path (includes fallback analysis)
            const data = responseData.analysis_data;
            currentAnalysis = data;
            currentVideoId = videoId;
            
            // Set the analysis content
            renderMarkdown(data.summary, D.summaryOutput);
            renderQuiz(data.quiz, D.quizOutput);
            renderMarkdown(data.action_plan, D.action_planOutput);
            
            // Show success message and enable the next step
            displayMessage("success", "Analysis complete! Review the summary and take the quiz.");
            D.scoreButton.disabled = false; // Enable scoring button
            D.exportButton.disabled = true; // Disabled until quiz is scored
            D.quizScore.innerHTML = `<p class="text-sm text-yellow-300">Submit your answers to see your score!</p>`;
            switchTab('summary'); // Switch back to summary tab after analysis
            
        } catch (error) {
            console.error("Fetch Error:", error);
            displayMessage("error", `A network or unexpected error occurred: ${error.message}`);
        } finally {
            D.analyzeButton.disabled = (extractVideoId(D.videoLinkInput.value.trim()) === null);
        }
    }

    // 2. Submit Quiz Function
    async function submitQuiz() {
        if (!currentAnalysis || !currentAnalysis.quiz) {
            displayMessage("error", "Please analyze a video first.");
            return;
        }

        const userAnswers = {};
        let answeredCount = 0;
        
        // Collect user answers from radio inputs
        currentAnalysis.quiz.forEach((q) => {
            const questionId = q.question_id;
            const selectedOption = document.querySelector(`input[name="${questionId}"]:checked`);
            if (selectedOption) {
                userAnswers[questionId] = selectedOption.value;
                answeredCount++;
            }
        });

        if (answeredCount < currentAnalysis.quiz.length) {
            displayMessage("error", `Please answer all ${currentAnalysis.quiz.length} questions.`);
            return;
        }

        displayMessage("loading", `<i class="fas fa-sync-alt fa-spin mr-2"></i> Submitting and grading quiz...`);
        D.scoreButton.disabled = true;

        try {
            const response = await fetch('{% url "legalpages:api_submit_quiz" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ 
                    quiz: currentAnalysis.quiz, 
                    user_answers: userAnswers,
                    video_title: document.title // Use a generic title or fetch it if available
                })
            });

            const responseData = await response.json(); 

            if (!response.ok) {
                const errorMessage = responseData.error || `Server error during grading: Status ${response.status}`;
                displayMessage("error", errorMessage);
                return;
            }

            currentGradedQuiz = responseData.grading_data;

            // Display results
            renderGradedQuiz(currentGradedQuiz.graded_quiz, D.quizOutput);
            D.quizScore.innerHTML = `<p class="font-bold text-lg">${DOMPurify.sanitize(currentGradedQuiz.score_text)}</p>`;
            displayMessage("success", "Quiz graded! Check the Quiz tab for detailed feedback.");
            
            D.exportButton.disabled = false; // Enable export now that we have graded data
            switchTab('quiz'); // Switch to quiz tab to show results

        } catch (error) {
            console.error("Quiz Submit Error:", error);
            displayMessage("error", `A network or unexpected error occurred during grading: ${error.message}`);
        } finally {
            D.scoreButton.disabled = false;
        }
    }

    // 3. Render Graded Quiz Function
    function renderGradedQuiz(gradedQuizData, element) {
        let html = '';
        gradedQuizData.forEach((item, index) => {
            const isCorrect = item.is_correct;
            const bgColor = isCorrect ? 'bg-green-800' : 'bg-red-800';
            const icon = isCorrect ? '<i class="fas fa-check-circle text-green-300 mr-2"></i>' : '<i class="fas fa-times-circle text-red-300 mr-2"></i>';
            const borderColor = isCorrect ? 'border-green-400' : 'border-red-400';

            html += `<div class="p-4 rounded-lg ${bgColor} shadow-md border-l-4 ${borderColor}">
                        <h4 class="text-lg font-semibold text-white mb-2">${icon} Q${index + 1}: ${DOMPurify.sanitize(item.question)}</h4>
                        <p class="text-gray-200 mb-1">Your Answer: <strong>${DOMPurify.sanitize(item.user_answer)}</strong></p>
                        <p class="text-gray-200 mb-2">Correct Answer: <strong class="text-yellow-300">${DOMPurify.sanitize(item.correct_answer)}</strong></p>
                        <p class="text-sm italic text-gray-300 mt-2 border-t border-gray-600 pt-2">${DOMPurify.sanitize(item.feedback)}</p>
                    </div>`;
        });
        element.innerHTML = html;
    }


    // 4. Export Content Function
    async function exportContent() {
        if (!currentAnalysis || !currentGradedQuiz) {
            displayMessage("error", "Please analyze the video and submit the quiz before exporting the report.");
            return;
        }

        displayMessage("loading", `<i class="fas fa-file-download fa-spin mr-2"></i> Generating and downloading PDF report...`);
        D.exportButton.disabled = true;

        try {
            const response = await fetch('{% url "legalpages:api_export_content" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    video_title: `YouTube Video: ${currentVideoId}`, // Use the video ID as the title for the backend
                    summary: currentAnalysis.summary,
                    quiz_data: currentGradedQuiz,
                    action_plan: currentAnalysis.action_plan
                })
            });

            if (!response.ok) {
                 const errorText = await response.text();
                 try {
                    const errorJson = JSON.parse(errorText);
                    displayMessage("error", errorJson.error || "Failed to generate PDF due to server error.");
                 } catch {
                     displayMessage("error", "Failed to generate PDF. Check server logs.");
                 }
                return;
            }

            // Get blob from response
            const blob = await response.blob();
            
            // Create a link element to trigger the download
            const disposition = response.headers.get('Content-Disposition');
            let filename = 'LearnFlow_Report.pdf';
            if (disposition && disposition.indexOf('attachment') !== -1) {
                const filenameRegex = /filename=["']?([^"']*)["']?/;
                const matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                    filename = matches[1];
                }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            displayMessage("success", "PDF report downloaded successfully!");

        } catch (error) {
            console.error("Export Error:", error);
            displayMessage("error", `A network or unexpected error occurred during export: ${error.message}`);
        } finally {
            D.exportButton.disabled = false;
        }
    }


    // --- Initialization and DOM Cache ---

    const D = {};

    document.addEventListener('DOMContentLoaded', () => {
        // Cache DOM elements
        D.videoLinkInput = document.getElementById('videoLinkInput');
        D.analyzeButton = document.getElementById('analyzeButton');
        D.scoreButton = document.getElementById('scoreButton');
        D.exportButton = document.getElementById('exportButton');
        D.summaryOutput = document.getElementById('summaryOutput');
        D.quizOutput = document.getElementById('quizOutput');
        D.action_planOutput = document.getElementById('action_planOutput');
        D.quizScore = document.getElementById('quizScore');
        D.tabButtons = document.querySelectorAll('.tab-button');
        D.tabContents = document.querySelectorAll('.tab-content');

        // Initial check for preloaded video URL from Django context
        const initialVideoId = extractVideoId(D.videoLinkInput.value.trim());
        if (initialVideoId) {
            D.analyzeButton.disabled = false;
            loadVideoPlayer(initialVideoId);
        }

        // Function to reset all output areas
        function resetAnalysisOutputs() {
            currentAnalysis = null;
            currentGradedQuiz = null;
            D.summaryOutput.innerHTML = '<p class="text-gray-400">The detailed video summary will appear here once the video is processed.</p>';
            D.quizOutput.innerHTML = '<p class="text-gray-400">A multiple-choice quiz will be generated here.</p>';
            D.action_planOutput.innerHTML = '<p class="text-gray-400">Personalized next steps and resources will appear here.</p>';
            D.quizScore.innerHTML = `<p class="text-sm text-yellow-300">Submit your answers to see your score!</p>`;
        }

        // 1. URL Input Listener: Enable/Disable Analyze button
        D.videoLinkInput.addEventListener('input', () => {
            const isValid = extractVideoId(D.videoLinkInput.value.trim()) !== null;
            D.analyzeButton.disabled = !isValid;
            
            // Update the player on input change, but only if it's valid
            if (isValid) {
                 loadVideoPlayer(extractVideoId(D.videoLinkInput.value.trim()));
            } else {
                 loadVideoPlayer(null); // Clear player if invalid
            }
        });

        // 2. Tab Button Listeners
        D.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 3. Main Action Button Listeners
        D.analyzeButton.addEventListener('click', analyzeVideo);
        D.scoreButton.addEventListener('click', submitQuiz); 
        D.exportButton.addEventListener('click', exportContent);
        
        // Initial Tab Activation
        switchTab('summary');
    });
</script>

{% endblock %}
