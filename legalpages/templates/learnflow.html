{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // UPDATED COLORS for Blue-Black Theme
                        'primary-bg': '#0A1428', /* Deep Blue-Black - Main Background */
                        'secondary-bg': '#121C34', /* Darker Blue Card Background */
                        'card-bg': '#1E2B4B', /* Lighter Blue Card/Quiz Item Background */
                        
                        'accent-cyan': '#00DDEB', /* Vibrant Cyan for highlights (Kept same) */
                        'accent-blue': '#3b82f6', /* Standard Blue for buttons (Kept same) */
                        'text-light': '#C9D1D9', /* Light gray text (Kept same) */
                        'success-green': '#10B981', /* Tailwind Green */
                        'error-red': '#EF4444' /* Tailwind Red */
                    },
                    boxShadow: {
                        'glow-cyan': '0 0 10px 0 rgba(0, 221, 235, 0.5)',
                    }
                }
            }
        }
    </script>
{% endblock %}

{% block content %}
    <div class="min-h-screen bg-primary-bg text-text-light p-4 lg:p-10">
        <div class="max-w-7xl mx-auto">

            <header class="text-center mb-10">
                <h1 class="text-4xl lg:text-5xl font-extrabold text-accent-cyan tracking-tight">
                    LearnFlow AI: Video Analyzer
                </h1>
                <p class="mt-2 text-lg text-text-light opacity-70">
                    Paste a YouTube link to instantly generate a summary, quiz, and action plan.
                </p>
            </header>

            <div class="bg-secondary-bg p-6 rounded-xl shadow-2xl mb-8">
                <div class="flex flex-col lg:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="video-link-input" class="block text-sm font-medium text-text-light mb-1">YouTube Video Link</label>
                        <input type="text" id="video-link-input" 
                            class="w-full p-3 bg-card-bg border border-card-bg focus:border-accent-cyan rounded-lg text-text-light placeholder-gray-500 transition duration-300"
                            placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                            value="{{ video_id | default:'' | prepend:'https://www.youtube.com/watch?v=' }}">
                    </div>

                    <button id="analyze-button" 
                            class="w-full lg:w-48 p-3 bg-accent-blue hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic mr-2"></i> Analyze Video
                    </button>
                </div>
                
                <div id="player-container" class="mt-6 w-full aspect-video rounded-lg overflow-hidden bg-card-bg flex items-center justify-center">
                    <div id="youtube-player" class="w-full h-full">
                        <p id="player-placeholder" class="text-text-light opacity-50 p-10">
                            Paste a valid YouTube link above to load the video player.
                        </p>
                    </div>
                </div>
            </div>

            <div id="analysis-container" class="mt-10 hidden">
                <h2 id="video-title" class="text-3xl font-bold text-text-light mb-6 border-b border-secondary-bg pb-3">
                    [Video Title]
                </h2>
                
                <div id="warning-message" class="hidden bg-error-red/20 border border-error-red text-text-light p-3 rounded-lg mb-6 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-3 text-error-red"></i>
                    <span id="warning-text"></span>
                </div>

                <div class="flex border-b border-card-bg mb-6">
                    <button data-tab="summary" class="tab-button px-4 py-2 text-lg font-medium border-b-2 border-transparent hover:border-accent-cyan transition duration-300 active-tab-button">Summary</button>
                    <button data-tab="quiz" class="tab-button px-4 py-2 text-lg font-medium border-b-2 border-transparent hover:border-accent-cyan transition duration-300">Quiz</button>
                    <button data-tab="action_plan" class="tab-button px-4 py-2 text-lg font-medium border-b-2 border-transparent hover:border-accent-cyan transition duration-300">Action Plan</button>
                </div>

                <div class="flex flex-col lg:flex-row gap-6">
                    
                    <div class="lg:w-3/4 w-full bg-secondary-bg p-6 rounded-xl shadow-xl min-h-96">
                        <div id="summary-tab" class="tab-content prose prose-invert max-w-none text-text-light">
                            <p class="text-lg opacity-70">Analysis results will appear here after clicking 'Analyze Video'.</p>
                        </div>
                        
                        <div id="quiz-tab" class="tab-content hidden">
                            <form id="quiz-form">
                                </form>
                            <div id="quiz-feedback" class="mt-6 p-4 bg-card-bg rounded-lg hidden">
                                <h3 class="text-xl font-bold text-accent-cyan mb-2">Quiz Results</h3>
                                <div id="feedback-content" class="prose prose-invert max-w-none text-text-light"></div>
                            </div>
                        </div>

                        <div id="action_plan-tab" class="tab-content prose prose-invert max-w-none text-text-light hidden">
                            </div>
                    </div>

                    <div class="lg:w-1/4 w-full flex flex-col space-y-4">
                        <button id="score-button" 
                                class="p-3 bg-success-green hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <i class="fas fa-check-circle mr-2"></i> Score Quiz
                        </button>

                        <button id="export-button" 
                                class="p-3 bg-accent-cyan hover:bg-cyan-700 text-primary-bg font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <i class="fas fa-file-pdf mr-2"></i> Export Content (PDF)
                        </button>
                        
                        <div id="status-message" class="p-4 bg-card-bg text-text-light rounded-lg text-sm hidden">
                            <p id="status-text">Ready.</p>
                        </div>
                    </div>

                </div>
            </div>
            
            <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
                <div class="bg-error-red/10 border border-error-red p-6 rounded-xl max-w-md w-full shadow-2xl">
                    <h3 class="text-xl font-bold text-error-red mb-3 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> Error</h3>
                    <p id="error-modal-text" class="text-text-light"></p>
                    <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="mt-4 p-2 bg-error-red hover:bg-red-700 text-white font-bold rounded-lg w-full transition duration-300">Close</button>
                </div>
            </div>

        </div>
    </div>
{% endblock %}


{% block extra_js %}
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Use a single object to manage DOM elements for cleaner code
        const D = {
            videoLinkInput: document.getElementById('video-link-input'),
            analyzeButton: document.getElementById('analyze-button'),
            scoreButton: document.getElementById('score-button'),
            exportButton: document.getElementById('export-button'),
            analysisContainer: document.getElementById('analysis-container'),
            videoTitle: document.getElementById('video-title'),
            summaryTab: document.getElementById('summary-tab'),
            quizTab: document.getElementById('quiz-tab'),
            actionPlanTab: document.getElementById('action_plan-tab'),
            tabButtons: document.querySelectorAll('.tab-button'),
            quizForm: document.getElementById('quiz-form'),
            quizFeedback: document.getElementById('quiz-feedback'),
            feedbackContent: document.getElementById('feedback-content'),
            statusMessage: document.getElementById('status-message'),
            statusText: document.getElementById('status-text'),
            errorModal: document.getElementById('error-modal'),
            errorModalText: document.getElementById('error-modal-text'),
            warningMessage: document.getElementById('warning-message'),
            warningText: document.getElementById('warning-text'),
            playerContainer: document.getElementById('youtube-player'),
            playerPlaceholder: document.getElementById('player-placeholder'),
        };

        let player;
        let currentAnalysis = {
            video_title: '',
            summary: '',
            quiz: [],
            action_plan: '',
            graded_quiz: null, // Stores the graded quiz object
        };

        // --- 1. Utility Functions ---

        const showStatus = (text, isError = false) => {
            D.statusText.innerHTML = DOMPurify.sanitize(text);
            D.statusMessage.classList.remove('hidden');
            D.statusMessage.className = `p-4 rounded-lg text-sm ${isError ? 'bg-error-red/20 text-error-red' : 'bg-card-bg text-text-light'}`;
            if (isError) {
                showErrorModal(text);
            }
        };

        const showErrorModal = (message) => {
            D.errorModalText.textContent = message;
            D.errorModal.classList.remove('hidden');
        }

        const resetAnalysis = () => {
            currentAnalysis = { video_title: '', summary: '', quiz: [], action_plan: '', graded_quiz: null };
            D.videoTitle.textContent = '[Video Title]';
            D.summaryTab.innerHTML = '<p class="text-lg opacity-70">Analysis results will appear here after clicking \'Analyze Video\'.</p>';
            D.quizForm.innerHTML = '';
            D.quizFeedback.classList.add('hidden');
            D.actionPlanTab.innerHTML = '';
            D.analysisContainer.classList.add('hidden');
            D.scoreButton.disabled = true; // IMPORTANT: Disable Score button until new quiz is generated
            D.exportButton.disabled = true; // IMPORTANT: Disable Export button until quiz is scored
            D.warningMessage.classList.add('hidden');
            D.statusMessage.classList.add('hidden');
        };

        const extractVideoId = (url) => {
            let videoId = null;
            let match = url.match(/(?:youtu\.be\/|v=|embed\/|shorts\/)([^"&?\/\s]{11})/);
            if (match && match[1]) {
                videoId = match[1];
            } else {
                // Check for standard URL structure if not found (less common for embedding, but robust)
                match = url.match(/youtube\.com.*[?&]v=([^"&?\/\s]{11})/);
                if (match && match[1]) {
                    videoId = match[1];
                }
            }
            return videoId;
        };

        const switchTab = (tabName) => {
            D.tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('active-tab-button', 'border-accent-cyan');
                    button.classList.remove('border-transparent');
                } else {
                    button.classList.remove('active-tab-button', 'border-accent-cyan');
                    button.classList.add('border-transparent');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        };
        
        // Function to create a placeholder/container for the YouTube player
        const createPlayerContainer = () => {
            // Remove existing player element to prevent memory leaks/re-init issues
            while (D.playerContainer.firstChild) {
                D.playerContainer.removeChild(D.playerContainer.firstChild);
            }
            D.playerPlaceholder = document.createElement('p');
            D.playerPlaceholder.id = 'player-placeholder';
            D.playerPlaceholder.className = 'text-text-light opacity-50 p-10';
            D.playerPlaceholder.textContent = 'Paste a valid YouTube link above to load the video player.';
            
            const newPlayerDiv = document.createElement('div');
            newPlayerDiv.id = 'youtube-player-actual';
            D.playerContainer.appendChild(newPlayerDiv);
            return newPlayerDiv.id;
        };

        const loadVideoPlayer = (videoId) => {
            if (!videoId) {
                // If no video ID, clear the player area
                while (D.playerContainer.firstChild) {
                    D.playerContainer.removeChild(D.playerContainer.firstChild);
                }
                D.playerContainer.appendChild(D.playerPlaceholder);
                return;
            }

            const playerId = createPlayerContainer();
            D.playerPlaceholder.classList.add('hidden');

            if (typeof YT !== 'undefined' && YT.Player) {
                if (player) {
                    player.destroy(); // Destroy previous player instance if it exists
                }
                player = new YT.Player(playerId, {
                    videoId: videoId,
                    playerVars: {
                        'controls': 1,
                        'rel': 0, // Disable related videos
                        'modestbranding': 1, // Minimize YouTube logo
                    },
                    events: {
                        'onReady': (event) => {
                            event.target.setVolume(50); // Set volume to 50%
                            D.playerContainer.style.background = 'none'; // Clear background after load
                        }
                    }
                });
            }
        };

        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

        // --- 2. Content Rendering Functions ---

        const renderQuiz = (quizData) => {
            D.quizForm.innerHTML = '';
            quizData.forEach((q, index) => {
                const questionHtml = `
                    <div class="bg-card-bg p-5 rounded-xl mb-4 shadow-md">
                        <p class="text-lg font-semibold text-accent-cyan mb-3">Q${index + 1}: ${DOMPurify.sanitize(q.question)}</p>
                        <div class="space-y-2">
                            ${q.options.map((option, optIndex) => `
                                <label class="flex items-center p-3 bg-secondary-bg hover:bg-secondary-bg/80 rounded-lg cursor-pointer transition duration-150">
                                    <input type="radio" name="question_${index}" value="${DOMPurify.sanitize(option)}" class="h-4 w-4 text-accent-blue border-gray-300 focus:ring-accent-blue">
                                    <span class="ml-3 text-text-light">${DOMPurify.sanitize(option)}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                D.quizForm.insertAdjacentHTML('beforeend', questionHtml);
            });
            D.quizFeedback.classList.add('hidden'); // Hide feedback when rendering a fresh quiz
            D.scoreButton.disabled = false; // ENABLE SCORE QUIZ BUTTON
            D.exportButton.disabled = true; // Disable Export until score is submitted
        };
        
        const renderGradedQuiz = (gradedQuiz, feedback) => {
            const total = gradedQuiz.length;
            const correct = gradedQuiz.filter(q => q.is_correct).length;
            
            D.quizForm.innerHTML = '';
            
            gradedQuiz.forEach((q, index) => {
                const isCorrect = q.is_correct;
                const resultClass = isCorrect ? 'border-success-green bg-success-green/20' : 'border-error-red bg-error-red/20';
                const icon = isCorrect ? 'fa-check' : 'fa-times';
                
                const questionHtml = `
                    <div class="p-5 rounded-xl mb-4 border-2 ${resultClass} shadow-md">
                        <p class="text-lg font-semibold text-text-light mb-3 flex items-center">
                            <i class="fas ${icon} mr-3 ${isCorrect ? 'text-success-green' : 'text-error-red'}"></i>
                            Q${index + 1}: ${DOMPurify.sanitize(q.question)}
                        </p>
                        <div class="mt-2 space-y-1 text-sm">
                            <p class="text-text-light/80">
                                <strong>Your Answer:</strong> 
                                <span class="${isCorrect ? 'text-success-green' : 'text-error-red'}">${DOMPurify.sanitize(q.user_answer || 'N/A')}</span>
                            </p>
                            <p class="text-text-light/80">
                                <strong>Correct Answer:</strong> 
                                <span class="text-success-green">${DOMPurify.sanitize(q.correct_answer)}</span>
                            </p>
                        </div>
                    </div>
                `;
                D.quizForm.insertAdjacentHTML('beforeend', questionHtml);
            });
            
            // Display Feedback
            D.feedbackContent.innerHTML = marked.parse(DOMPurify.sanitize(feedback));
            D.quizFeedback.classList.remove('hidden');
            
            // Update score button
            D.scoreButton.textContent = `Score: ${correct} / ${total}`;
            D.scoreButton.disabled = true; // Disable scoring again once graded
            D.scoreButton.classList.remove('bg-success-green', 'hover:bg-green-700');
            D.scoreButton.classList.add('bg-card-bg');
            
            D.exportButton.disabled = false; // ENABLE EXPORT BUTTON
            
            // Switch to quiz tab to show results
            switchTab('quiz');
        };

        const renderAnalysis = (data) => {
            D.videoTitle.textContent = DOMPurify.sanitize(data.video_title);
            D.summaryTab.innerHTML = marked.parse(DOMPurify.sanitize(data.summary));
            D.actionPlanTab.innerHTML = marked.parse(DOMPurify.sanitize(data.action_plan));
            
            // Set global analysis data
            currentAnalysis.video_title = data.video_title;
            currentAnalysis.summary = data.summary;
            currentAnalysis.action_plan = data.action_plan;
            currentAnalysis.quiz = data.quiz;
            currentAnalysis.graded_quiz = null; // Reset graded quiz

            // Handle Quiz Rendering and Button Enabling
            if (data.quiz && data.quiz.length > 0) {
                renderQuiz(data.quiz);
            } else {
                D.scoreButton.disabled = true; // No quiz, keep score button disabled
            }
            
            // Handle Warning
            if (data.warning) {
                D.warningText.textContent = DOMPurify.sanitize(data.warning);
                D.warningMessage.classList.remove('hidden');
            } else {
                D.warningMessage.classList.add('hidden');
            }

            D.analysisContainer.classList.remove('hidden');
        };

        // --- 3. Main Action Functions ---

        const analyzeVideo = async () => {
            const videoUrl = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(videoUrl);
            
            if (!videoId) {
                showStatus('Please enter a valid YouTube video URL.', true);
                return;
            }
            
            // Lock button and show loading state
            D.analyzeButton.disabled = true;
            D.scoreButton.disabled = true;
            D.exportButton.disabled = true;
            const originalAnalyzeText = D.analyzeButton.innerHTML;
            D.analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Analyzing...';
            showStatus('Fetching transcript and generating analysis...');
            resetAnalysis(); // Clear previous results

            try {
                // Fetch the video title (assuming there's a title fetch function or player property available)
                // Since we don't have a direct backend endpoint for title only, we'll try to get it from the player
                let videoTitle = "YouTube Video Analysis";
                if (player && player.getVideoData) {
                    videoTitle = player.getVideoData().title || videoTitle;
                }
                
                const response = await fetch('/api/analyze_video/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ video_url: videoUrl, video_title: videoTitle }),
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    renderAnalysis(data);
                    showStatus('Analysis complete! Check the tabs for your content.', false);
                } else {
                    const errorMessage = data.error || 'Unknown error occurred during video analysis.';
                    showStatus(errorMessage, true);
                    resetAnalysis();
                }

            } catch (error) {
                console.error('Analysis API Error:', error);
                showStatus('A network or server error occurred. Please check the URL and try again.', true);
                resetAnalysis();
            } finally {
                // Always restore Analyze button state based on current input
                const url = D.videoLinkInput.value.trim();
                const isValid = extractVideoId(url) !== null;
                D.analyzeButton.disabled = !isValid;
                D.analyzeButton.innerHTML = originalAnalyzeText;
                D.scoreButton.classList.remove('bg-card-bg');
                D.scoreButton.classList.add('bg-success-green', 'hover:bg-green-700');
                D.scoreButton.textContent = 'Score Quiz';
            }
        };


        const submitQuiz = async () => {
            if (currentAnalysis.quiz.length === 0) {
                showStatus('No quiz data available to score.', true);
                return;
            }
            
            // Get user answers
            const userAnswers = {};
            currentAnalysis.quiz.forEach((q, index) => {
                const radio = D.quizForm.querySelector(`input[name="question_${index}"]:checked`);
                if (radio) {
                    userAnswers[index] = radio.value;
                }
            });

            // Check if all questions are answered (optional, but good UX)
            // if (Object.keys(userAnswers).length !== currentAnalysis.quiz.length) {
            //     showStatus('Please answer all questions before submitting.', true);
            //     return;
            // }

            // Lock button and show loading state
            D.scoreButton.disabled = true;
            const originalScoreText = D.scoreButton.innerHTML;
            D.scoreButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Grading...';
            showStatus('Submitting answers and grading quiz...');

            try {
                const response = await fetch('/api/submit_quiz/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ 
                        quiz: currentAnalysis.quiz, 
                        user_answers: userAnswers, 
                        video_title: currentAnalysis.video_title 
                    }),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const gradedQuiz = data.grading_data.graded_quiz;
                    const feedback = data.grading_data.feedback;
                    
                    currentAnalysis.graded_quiz = gradedQuiz; // Save graded quiz
                    renderGradedQuiz(gradedQuiz, feedback);
                    
                    showStatus('Quiz graded successfully! See your results below.', false);
                    D.exportButton.disabled = false; // **CRITICAL: Enable Export button here**

                } else {
                    const errorMessage = data.error || 'Unknown error occurred during quiz grading.';
                    showStatus(errorMessage, true);
                    D.scoreButton.disabled = false;
                }
                
            } catch (error) {
                console.error('Quiz API Error:', error);
                showStatus('A network or server error occurred during quiz grading.', true);
                D.scoreButton.disabled = false;

            } finally {
                // Restore button text (its disabled state is handled by success/failure logic)
                if (!D.scoreButton.disabled) {
                    D.scoreButton.innerHTML = originalScoreText;
                }
            }
        };


        const exportContent = async () => {
            if (!currentAnalysis.summary || !currentAnalysis.quiz || !currentAnalysis.graded_quiz) {
                showStatus('Analysis is incomplete or quiz is not scored.', true);
                return;
            }

            D.exportButton.disabled = true;
            const originalExportText = D.exportButton.innerHTML;
            D.exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating PDF...';
            showStatus('Generating PDF report...');

            try {
                const response = await fetch('/api/export_content/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ 
                        video_title: currentAnalysis.video_title, 
                        summary: currentAnalysis.summary,
                        action_plan: currentAnalysis.action_plan,
                        quiz_data: { graded_quiz: currentAnalysis.graded_quiz }
                    }),
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'LearnFlow_Report.pdf';
                    
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+?)"/i);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1];
                        }
                    }

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showStatus('PDF successfully downloaded.', false);

                } else {
                    const data = await response.json();
                    const errorMessage = data.error || 'Unknown error occurred during PDF export.';
                    showStatus(errorMessage, true);
                }

            } catch (error) {
                console.error('Export API Error:', error);
                showStatus('A network or server error occurred during export.', true);
            } finally {
                D.exportButton.disabled = false;
                D.exportButton.innerHTML = originalExportText;
            }
        };


        // --- 4. Initialization and Event Listeners ---
        
        // Function to handle the YouTube Iframe API ready state
        function onYouTubeIframeAPIReady() {
            // Initial setup based on input value (for deep linking)
            if (D.videoLinkInput.value) {
                const initialId = extractVideoId(D.videoLinkInput.value.trim());
                if (initialId) {
                    loadVideoPlayer(initialId);
                    D.analyzeButton.disabled = false;
                }
            }
        }
        window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady; // Make available globally

        // 1. URL Input Listener: Enable/Disable Analyze button and load player
        D.videoLinkInput.addEventListener('input', () => {
            const url = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(url);
            const isValid = videoId !== null;
            
            D.analyzeButton.disabled = !isValid;
            resetAnalysis(); 
            
            loadVideoPlayer(videoId);
        });

        // 2. Tab Button Listeners
        D.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 3. Main Action Button Listeners
        D.analyzeButton.addEventListener('click', analyzeVideo);
        D.scoreButton.addEventListener('click', submitQuiz); 
        D.exportButton.addEventListener('click', exportContent);
        
        // Initial Tab Activation
        switchTab('summary');
        
        // If the API was ready before the IframeReady function was set, call it now
        if (typeof YT !== 'undefined' && YT.Player && !player) {
            onYouTubeIframeAPIReady();
        }

    </script>
{% endblock %}