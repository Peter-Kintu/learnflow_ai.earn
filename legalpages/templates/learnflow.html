{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}


{% block content %}<main class="min-h-screen bg-background-dark text-text-light p-4 sm:p-6 lg:p-8 dark">
    <div class="max-w-7xl mx-auto">
        
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        
        <!-- Define JS variables for API paths using Django's {% url %} tag -->
        <script>
            // These variables MUST be defined before the main <script> block
            const ANALYZE_API_URL = "{% url 'legalpages:api_analyze_video' %}";
            const SUBMIT_QUIZ_API_URL = "{% url 'legalpages:api_submit_quiz' %}";
        </script>

        <header class="text-center py-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-light mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-blue to-blue-start">LearnFlow AI</span> Video Analysis
            </h1>
            <p class="text-md text-gray-400 max-w-2xl mx-auto">
                Paste a YouTube link below to generate an AI-powered summary, key takeaways, and a quiz.
            </p>
        </header>

        <!-- Input and Action Controls -->
        <div class="bg-surface-card p-6 rounded-xl shadow-2xl mb-8 border border-border-light">
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-end">
                <div class="flex-grow w-full">
                    <label for="video-link" class="block text-sm font-medium text-gray-300 mb-1">YouTube Video Link or ID</label>
                    <input type="url" id="video-link" name="video-link" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ" 
                           class="w-full px-4 py-2 rounded-lg bg-input-bg border border-input-border text-text-light focus:ring-primary-blue focus:border-primary-blue"
                           value="{{ preloaded_video_url|default:'' }}">
                </div>
                <button id="analyzeButton" disabled 
                        class="w-full sm:w-auto px-6 py-2 text-white font-semibold rounded-lg transition duration-200 
                               bg-primary-blue hover:bg-blue-600 disabled:bg-gray-600 disabled:cursor-not-allowed 
                               shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-primary-blue focus:ring-opacity-50">
                    <i class="fas fa-magic mr-2"></i> Analyze
                </button>
            </div>
            <div id="error-message" class="text-red-500 text-sm mt-3 hidden"></div>
        </div>
        
        <!-- Video Player and Content Tabs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Video Player (Col 1/3) -->
            <div class="lg:col-span-1 bg-surface-card p-4 rounded-xl shadow-2xl border border-border-light h-auto">
                <h2 class="text-xl font-bold text-text-light mb-3 border-b border-border-light pb-2">Video Preview</h2>
                <div id="video-player-container" class="aspect-w-16 aspect-h-9 w-full rounded-lg overflow-hidden bg-gray-900 shadow-inner">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        Enter a link to load player.
                    </div>
                </div>
            </div>

            <!-- Analysis Tabs (Col 2/3) -->
            <div class="lg:col-span-2 bg-surface-card rounded-xl shadow-2xl border border-border-light min-h-[500px]">
                
                <!-- Tab Headers -->
                <div class="flex border-b border-border-light p-2">
                    <button data-tab="summary" class="tab-button flex-1 text-center py-3 px-4 text-sm font-medium text-primary-blue border-b-2 border-primary-blue transition duration-150 ease-in-out hover:bg-input-bg focus:outline-none rounded-t-lg">
                        <i class="fas fa-book-open mr-1"></i> Summary & Takeaways
                    </button>
                    <button data-tab="quiz" class="tab-button flex-1 text-center py-3 px-4 text-sm font-medium text-gray-400 border-b-2 border-transparent transition duration-150 ease-in-out hover:bg-input-bg focus:outline-none rounded-t-lg">
                        <i class="fas fa-question-circle mr-1"></i> AI Quiz
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="p-5">
                    
                    <!-- Summary Tab Content -->
                    <div id="summary-tab" class="tab-content">
                        <div id="summary-content" class="text-gray-300 prose prose-invert max-w-none space-y-4">
                            <p class="text-center p-8 text-gray-500">Start by pasting a YouTube link and clicking 'Analyze' to generate the summary here.</p>
                        </div>
                    </div>
                    
                    <!-- Quiz Tab Content -->
                    <div id="quiz-tab" class="tab-content hidden">
                        <form id="quiz-form">
                            <div id="quiz-questions" class="space-y-6">
                                <p class="text-center p-8 text-gray-500">The multiple-choice quiz will appear here after analysis.</p>
                            </div>
                        </form>
                        
                        <!-- Quiz Action Buttons -->
                        <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4 mt-8 pt-4 border-t border-border-light">
                            <button id="scoreButton" disabled 
                                    class="w-full sm:w-auto px-6 py-2 text-white font-semibold rounded-lg transition duration-200 
                                           bg-success-green hover:bg-green-600 disabled:bg-gray-600 disabled:cursor-not-allowed 
                                           shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-success-green focus:ring-opacity-50">
                                <i class="fas fa-clipboard-check mr-2"></i> Submit & Score
                            </button>
                            <button id="exportButton" disabled 
                                    class="w-full sm:w-auto px-6 py-2 text-white font-semibold rounded-lg transition duration-200 
                                           bg-secondary-purple hover:bg-purple-600 disabled:bg-gray-600 disabled:cursor-not-allowed 
                                           shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-secondary-purple focus:ring-opacity-50">
                                <i class="fas fa-file-pdf mr-2"></i> Export Report
                            </button>
                        </div>

                        <!-- Score Display -->
                        <div id="score-display" class="text-center text-xl font-bold mt-6 p-4 rounded-lg bg-input-bg border border-border-light hidden">
                            Your Score: <span id="final-score" class="text-primary-blue">-- / --</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</main>

<script>
    // --- Global State Variables ---
    let videoId = '{{ video_id|default:'' }}';
    let analysisData = null; // Stores the successful JSON response from analyze_video_api
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // --- Utility Functions ---

    /**
     * Shows a flash message to the user (instead of alert/confirm).
     * @param {string} message The message to display.
     * @param {string} type 'success' or 'error'.
     */
    function showFlashMessage(message, type) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.className = `text-sm mt-3 p-3 rounded-lg ${type === 'error' ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'} block`;
        setTimeout(() => {
            errorDiv.textContent = '';
            errorDiv.className = 'text-red-500 text-sm mt-3 hidden';
        }, 5000);
    }
    
    /**
     * Determines the video ID from a URL or raw ID string.
     * @param {string} url_or_id 
     * @returns {string | null}
     */
    function extractYouTubeId(url_or_id) {
        let id = null;
        const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const matches = url_or_id.match(regex);
        if (matches) {
            id = matches[1];
        } else if (url_or_id.length === 11) {
            // Check if it's already a valid ID (11 chars, alphanumeric/dash/underscore)
            if (/^[a-zA-Z0-9_-]{11}$/.test(url_or_id)) {
                id = url_or_id;
            }
        }
        return id;
    }

    /**
     * Switches the active tab content.
     * @param {string} tabName 'summary' or 'quiz'
     */
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(button => {
            if (button.dataset.tab === tabName) {
                button.classList.replace('text-gray-400', 'text-primary-blue');
                button.classList.replace('border-transparent', 'border-primary-blue');
            } else {
                button.classList.replace('text-primary-blue', 'text-gray-400');
                button.classList.replace('border-primary-blue', 'border-transparent');
            }
        });
    }

    /**
     * Loads the YouTube player into the container.
     * @param {string} id YouTube video ID
     */
    function loadVideoPlayer(id) {
        const container = document.getElementById('video-player-container');
        if (!id) {
            container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Enter a link to load player.</div>';
            return;
        }
        
        const iframe = document.createElement('iframe');
        iframe.width = "100%";
        iframe.height = "100%";
        iframe.src = `https://www.youtube.com/embed/${id}`;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        iframe.className = "w-full h-full"; // Ensure iframe takes up container space

        // Use the aspect ratio container to manage responsiveness
        container.innerHTML = '';
        container.appendChild(iframe);
        videoId = id;
    }

    /**
     * Controls the state of all action buttons and indicators.
     * @param {boolean} isAnalyzing If true, shows loading state.
     * @param {boolean} analysisSuccessful If true, enables quiz/export buttons.
     */
    function setAnalysisState(isAnalyzing, analysisSuccessful) {
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        const videoLinkInput = document.getElementById('video-link');
        const summaryContent = document.getElementById('summary-content');

        if (isAnalyzing) {
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Analyzing...';
            scoreButton.disabled = true;
            exportButton.disabled = true;
            videoLinkInput.disabled = true;
            summaryContent.innerHTML = '<p class="text-center p-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Fetching transcript and consulting AI...</p>';
            document.getElementById('quiz-questions').innerHTML = '<p class="text-center p-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Waiting for analysis...</p>';
            document.getElementById('score-display').classList.add('hidden');
        } else {
            analyzeButton.disabled = videoLinkInput.value.trim().length === 0;
            analyzeButton.innerHTML = '<i class="fas fa-magic mr-2"></i> Analyze';
            videoLinkInput.disabled = false;
            
            if (analysisSuccessful) {
                scoreButton.disabled = false;
                exportButton.disabled = false; // Note: Export requires scoring first, logic handled in submitQuiz
            } else {
                scoreButton.disabled = true;
                exportButton.disabled = true;
            }
        }
    }


    // --- Rendering Functions ---
    
    /**
     * Renders the summary content using marked.js to convert Markdown to HTML.
     * @param {string} markdownText 
     */
    function renderSummary(markdownText) {
        const summaryDiv = document.getElementById('summary-content');
        if (!markdownText) {
            summaryDiv.innerHTML = '<p class="text-center p-8 text-red-400">Analysis failed or returned empty content.</p>';
            return;
        }

        // 1. Convert Markdown to HTML using marked
        let htmlContent = marked.parse(markdownText);
        
        // 2. Sanitize the HTML using DOMPurify
        const sanitizedHtml = DOMPurify.sanitize(htmlContent);

        // 3. Update the content
        summaryDiv.innerHTML = sanitizedHtml;
    }
    
    /**
     * Renders the quiz questions into the quiz tab.
     * @param {object} quizData The quiz data object.
     */
    function renderQuiz(quizData) {
        const questionsContainer = document.getElementById('quiz-questions');
        const questions = quizData.questions || [];
        
        if (questions.length === 0) {
            questionsContainer.innerHTML = '<p class="text-center p-8 text-red-400">AI failed to generate quiz questions.</p>';
            return;
        }
        
        let html = '';
        questions.forEach(q => {
            html += `
                <div class="bg-input-bg p-4 rounded-lg border border-border-light shadow-md">
                    <p class="font-semibold text-text-light mb-3">${q.id}. ${q.question}</p>
                    <div class="space-y-2">
            `;
            q.options.forEach((option, index) => {
                const optionId = `q${q.id}_opt${index}`;
                html += `
                    <label for="${optionId}" class="flex items-center p-3 rounded-md cursor-pointer hover:bg-gray-700 transition duration-150">
                        <input type="radio" id="${optionId}" name="question_${q.id}" value="${option}" 
                               class="text-primary-blue focus:ring-primary-blue h-4 w-4 border-gray-600 bg-gray-700" 
                               data-question-id="${q.id}">
                        <span class="ml-3 text-sm font-medium text-gray-300">${option}</span>
                    </label>
                `;
            });
            html += `
                    </div>
                </div>
            `;
        });
        
        questionsContainer.innerHTML = html;
        document.getElementById('scoreButton').disabled = false;
    }


    // --- Core Action Functions ---

    /**
     * Initiates the video analysis process.
     */
    async function analyzeVideo() {
        const videoLinkInput = document.getElementById('video-link');
        const url_or_id = videoLinkInput.value.trim();
        const extractedId = extractYouTubeId(url_or_id);
        
        if (!extractedId) {
            showFlashMessage("Please enter a valid YouTube URL or 11-character video ID.", 'error');
            return;
        }

        // Set global ID and update player
        videoId = extractedId;
        loadVideoPlayer(videoId);
        setAnalysisState(true, false); // Start loading state
        
        // Clear previous results
        renderSummary('');
        document.getElementById('quiz-questions').innerHTML = '<p class="text-center p-8 text-gray-500">Waiting for analysis...</p>';
        analysisData = null;

        try {
            const response = await fetch(ANALYZE_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ video_url_or_id: extractedId })
            });

            const result = await response.json();
            
            if (response.ok) {
                // Success
                analysisData = result;
                renderSummary(result.summary_result);
                renderQuiz(result.quiz_data);
                showFlashMessage("Analysis complete! Review the summary and take the quiz.", 'success');
                setAnalysisState(false, true); // Analysis succeeded
                // Ensure the main analyze button is re-enabled if input is present
                document.getElementById('analyzeButton').disabled = false; 

            } else {
                // API returned a controlled error (e.g., 400, 500)
                showFlashMessage(`Analysis Error: ${result.message}`, 'error');
                renderSummary('<p class="text-center p-8 text-red-400">Analysis failed: ' + result.message + '</p>');
                setAnalysisState(false, false); // Analysis failed
            }
        } catch (error) {
            console.error('Fetch error:', error);
            showFlashMessage("Analysis Error: A server error occurred. Please check the console for details.", 'error');
            renderSummary('<p class="text-center p-8 text-red-400">Analysis failed: Server error occurred.</p>');
            setAnalysisState(false, false); // Analysis failed
        }
    }
    
    /**
     * Submits the quiz for scoring and generates the PDF report.
     * @param {Event} event The click event.
     */
    async function submitQuiz(event) {
        if (!analysisData) {
            showFlashMessage("Please analyze a video first before submitting the quiz.", 'error');
            return;
        }
        
        const isExportAction = event.target.id === 'exportButton';
        const quizForm = document.getElementById('quiz-form');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');

        // 1. Extract user answers
        const userAnswers = {};
        let questionsAnswered = 0;
        
        analysisData.quiz_data.questions.forEach(q => {
            const answerElement = quizForm.querySelector(`input[name="question_${q.id}"]:checked`);
            if (answerElement) {
                userAnswers[q.id] = answerElement.value;
                questionsAnswered++;
            }
        });
        
        // Check if all questions are answered only if scoring (not just exporting the previous score)
        if (questionsAnswered < analysisData.quiz_data.questions.length) {
            if (!isExportAction) {
                showFlashMessage("Please answer all questions before submitting.", 'error');
                return;
            }
        }

        // Set button loading state
        scoreButton.disabled = true;
        exportButton.disabled = true;
        const originalScoreText = scoreButton.innerHTML;
        const originalExportText = exportButton.innerHTML;
        
        scoreButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Scoring...';
        exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Exporting...';


        try {
            const payload = {
                user_answers: userAnswers,
                quiz_data: analysisData.quiz_data,
                video_response_data: {
                    video_id: videoId,
                    video_title: analysisData.video_title,
                    summary_result: analysisData.summary_result
                }
            };

            const response = await fetch(SUBMIT_QUIZ_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            });

            if (response.ok && response.headers.get('Content-Type') === 'application/pdf') {
                // Success: PDF is returned
                
                // Extract score from custom header
                const scoreHeader = response.headers.get('X-Quiz-Score');
                if (scoreHeader) {
                    const [score, total] = scoreHeader.split('/');
                    document.getElementById('final-score').textContent = `${score} / ${total}`;
                    document.getElementById('score-display').classList.remove('hidden');
                    showFlashMessage(`Quiz submitted! Final Score: ${score} out of ${total}.`, 'success');
                } else {
                    showFlashMessage("Quiz submitted and PDF generated, but score could not be retrieved.", 'success');
                }
                
                // Trigger file download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = response.headers.get('Content-Disposition').split('filename=')[1].replace(/"/g, ''); // Extract filename
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);

            } else {
                // API returned an error (JSON response)
                const errorResult = await response.json();
                showFlashMessage(`Scoring/Export Error: ${errorResult.message}`, 'error');
            }

        } catch (error) {
            console.error('Submit/Export error:', error);
            showFlashMessage("Scoring/Export Error: A network or server error occurred.", 'error');

        } finally {
            // Restore button state
            scoreButton.disabled = false;
            exportButton.disabled = false;
            scoreButton.innerHTML = originalScoreText;
            exportButton.innerHTML = originalExportText;
        }
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const videoLinkInput = document.getElementById('video-link');
        const analyzeButton = document.getElementById('analyzeButton');
        const scoreButton = document.getElementById('scoreButton');
        const exportButton = document.getElementById('exportButton');
        
        switchTab('summary');

        // Tab button listeners
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 1. Enable/Disable Analyze button based on input
        if (videoLinkInput && analyzeButton) {
            videoLinkInput.addEventListener('input', () => {
                analyzeButton.disabled = videoLinkInput.value.trim().length === 0;
                // If the input changes, disable quiz buttons until re-analyzed
                setAnalysisState(false, false);
                analysisData = null; // Clear previous data
                loadVideoPlayer(extractYouTubeId(videoLinkInput.value.trim()));
            });
        }

        // 2. Attach click handlers to the main action buttons
        if (analyzeButton) analyzeButton.addEventListener('click', analyzeVideo);
        // Both buttons use the same logic, but the event target is checked inside submitQuiz
        if (scoreButton) scoreButton.addEventListener('click', submitQuiz); 
        if (exportButton) exportButton.addEventListener('click', submitQuiz); 
        
        
        // Initial state logic
        // Set all buttons to the non-analyzing, not-analyzed state.
        setAnalysisState(false, false); 
        
        // If a URL is preloaded, manually ensure the analyze button is enabled and load video.
        if (videoLinkInput && videoLinkInput.value.startsWith('http')) {
            const preloadedId = extractYouTubeId(videoLinkInput.value.trim());
            if (preloadedId) {
                if (analyzeButton) analyzeButton.disabled = false;
                loadVideoPlayer(preloadedId);
            }
        }
    });
</script>
{% endblock %}
