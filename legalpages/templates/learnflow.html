{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // UPDATED COLORS for Blue-Black Theme
                        'primary-bg': '#0A1428', /* Deep Blue-Black - Main Background */
                        'secondary-bg': '#121C34', /* Darker Blue Card Background */
                        'card-bg': '#1E2B4B', /* Lighter Blue Card/Quiz Item Background */
                        
                        'accent-cyan': '#00DDEB', /* Vibrant Cyan for highlights (Kept same) */
                        'accent-blue': '#3b82f6', /* Standard Blue for buttons (Kept same) */
                        'text-light': '#C9D1D9', /* Light gray text (Kept same) */
                        'success-green': '#34D399', /* Green 400 (Kept same) */
                        'error-red': '#F87171', /* Red 400 (Kept same) */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles for a clean, professional look */
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Custom Button Style with Subtle Gradient */
        .btn-primary {
            background-image: linear-gradient(to right, #00DDEB, #3b82f6);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(0, 221, 235, 0.2);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(0, 221, 235, 0.4);
        }
        .btn-primary:disabled {
            background-image: linear-gradient(to right, #4b5563, #6b7280); /* Grayed out gradient */
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Aspect ratio container for responsive iframe */
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            border-radius: 1rem; 
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Stronger shadow for depth */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Improved Prose Styling for Dark Mode */
        .prose-dark {
            color: #C9D1D9; /* Light gray */
            font-size: 1rem;
            line-height: 1.75;
        }
        .prose-dark h1, .prose-dark h2, .prose-dark h3 {
            color: #00DDEB; /* Cyan headers */
            border-bottom: 1px solid #21262D;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .prose-dark ol li::marker, .prose-dark ul li::marker {
            color: #3b82f6; /* Blue bullets/numbers */
        }
        .prose-dark a {
            color: #00DDEB;
            text-decoration: none;
        }
        .prose-dark p {
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-primary-bg text-text-light p-4 md:p-12 font-sans">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header & Branding -->
        <header class="mb-10 text-center">
             <h1 class="text-5xl font-extrabold tracking-tight" style="color: #00DDEB; text-shadow: 0 0 10px rgba(0, 221, 235, 0.4);">
                <i class="fas fa-brain mr-3"></i> LearnFlow AI
             </h1>
             <p class="text-lg text-gray-400 mt-2">Transforming YouTube into Personalized Learning Modules.</p>
        </header>
        
        <!-- Global Alert Box -->
        <div id="global-alert" role="alert" 
             class="hidden p-4 mb-8 rounded-xl font-medium border-l-4 shadow-xl transition-all duration-300 z-10 sticky top-4 max-w-2xl mx-auto">
        </div>
        
        <!-- Input and Control Area -->
        <div class="bg-secondary-bg p-8 rounded-2xl shadow-2xl mb-12 border border-gray-700/50">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                
                <!-- Video Link Input -->
                <input type="url" id="video-link-input" placeholder="Paste YouTube Video URL here..." 
                       class="flex-grow p-4 rounded-xl bg-primary-bg border border-gray-600 text-text-light placeholder-gray-500 
                              focus:ring-2 focus:ring-accent-cyan focus:border-accent-cyan shadow-inner text-lg transition duration-200" 
                       value="{{ initial_url|default:'' }}"
                >
                
                <!-- Analyze Button -->
                <button id="analyze-button" disabled 
                        class="w-full md:w-auto px-10 py-4 btn-primary text-white font-bold rounded-xl shadow-lg transition-all duration-300 text-lg">
                    <i class="fas fa-microscope mr-2"></i> Analyze
                </button>
            </div>
        </div>

        <!-- Main Content Layout (Video Player on Left, Analysis Tabs on Right) -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-10">
            
            <!-- Left Column: Video Player and Action Buttons (2/5 width) -->
            <div class="lg:col-span-2 space-y-8">
                <div class="video-container">
                    <div id="video-player">
                        <!-- YouTube iframe will be loaded here -->
                        <div class="flex flex-col items-center justify-center w-full h-full bg-secondary-bg absolute top-0 left-0 p-8">
                            <i class="fab fa-youtube text-6xl text-red-600 mb-4 opacity-70"></i>
                            <p class="text-gray-400 font-medium text-center text-lg">
                                Input a valid YouTube link above to load the player.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Score and Export Button Group -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="score-button" disabled
                            class="flex-grow px-4 py-4 bg-success-green hover:bg-green-500 text-secondary-bg font-bold rounded-xl shadow-lg transition duration-200 disabled:bg-gray-700 disabled:cursor-not-allowed">
                        <i class="fas fa-check-double mr-2"></i> Score Quiz
                    </button>
                    <button id="export-button" disabled
                            class="flex-grow px-4 py-4 bg-accent-blue hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg transition duration-200 disabled:bg-gray-700 disabled:cursor-not-allowed">
                        <i class="fas fa-file-export mr-2"></i> Export Report
                    </button>
                </div>
            </div>

            <!-- Right Column: Analysis Tabs (3/5 width) -->
            <div class="lg:col-span-3 bg-secondary-bg p-8 rounded-2xl shadow-2xl border border-gray-700/50">
                
                <!-- Tab Navigation (Pill Style) -->
                <div id="tab-buttons" class="flex p-1 bg-primary-bg rounded-xl mb-8 shadow-inner">
                    <button data-tab="summary" class="tab-button flex-1 py-3 text-base font-semibold rounded-lg text-gray-400 transition duration-150 flex items-center justify-center active-tab-class">
                        <i class="fas fa-list-alt mr-2"></i> Summary
                    </button>
                    <button data-tab="quiz" class="tab-button flex-1 py-3 text-base font-semibold rounded-lg text-gray-400 transition duration-150 flex items-center justify-center">
                        <i class="fas fa-question-circle mr-2"></i> Quiz
                    </button>
                    <button data-tab="action-plan" class="tab-button flex-1 py-3 text-base font-semibold rounded-lg text-gray-400 transition duration-150 flex items-center justify-center">
                        <i class="fas fa-rocket mr-2"></i> Action Plan
                    </button>
                </div>

                <!-- Tab Contents -->
                <div class="min-h-[500px]">
                    <!-- Summary Tab -->
                    <div id="summary-content" data-tab="summary" class="tab-content active">
                        <h2 class="text-3xl font-bold mb-4" style="color: #00DDEB;">Summary Overview</h2>
                        <div id="summary-output" class="prose prose-dark max-w-none">
                            <p class="text-gray-500 text-lg">Detailed analysis will be generated here after processing the video.</p>
                        </div>
                    </div>

                    <!-- Quiz Tab -->
                    <div id="quiz-content" data-tab="quiz" class="tab-content">
                        <h2 class="text-3xl font-bold mb-4" style="color: #00DDEB;">Knowledge Check</h2>
                        <div id="quiz-output" class="space-y-6">
                            <p class="text-gray-500 text-lg">A challenging quiz will appear here once the video is analyzed. Good luck!</p>
                        </div>
                        <div id="quiz-score-display" class="mt-8 text-2xl font-extrabold hidden p-6 rounded-xl bg-card-bg border border-gray-700 shadow-lg"></div>
                    </div>

                    <!-- Action Plan Tab -->
                    <div id="action-plan-content" data-tab="action-plan" class="tab-content">
                        <h2 class="text-3xl font-bold mb-4" style="color: #00DDEB;">Next Steps</h2>
                        <div id="action-plan-output" class="prose prose-dark max-w-none">
                            <p class="text-gray-500 text-lg">Personalized recommendations and next steps will guide your future learning.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DOM Elements (D) & State ---
        const D = {
            videoLinkInput: document.getElementById('video-link-input'),
            analyzeButton: document.getElementById('analyze-button'),
            scoreButton: document.getElementById('score-button'),
            exportButton: document.getElementById('export-button'),
            globalAlert: document.getElementById('global-alert'), 
            videoPlayer: document.getElementById('video-player'),
            tabButtons: document.querySelectorAll('.tab-button'),
            summaryOutput: document.getElementById('summary-output'),
            quizOutput: document.getElementById('quiz-output'),
            action_planOutput: document.getElementById('action-plan-output'),
            quizScoreDisplay: document.getElementById('quiz-score-display'),
        };

        let currentAnalysis = {
            video_title: '',
            summary: '',
            quiz: [], // The initial quiz data from the AI
            action_plan: '',
            graded_quiz: null, // The scored quiz data after submission
        };
        
        // Ensure this maps to your Django URL configuration in urls.py
        const API_URLS = {
            analyze: "{% url 'legalpages:api_analyze_video' %}",
            submit: "{% url 'legalpages:api_submit_quiz' %}",
            export: "{% url 'legalpages:api_export_content' %}",
        };

        // --- 2. Helper Functions ---
        
        /**
         * Displays a temporary alert message (success or error).
         * @param {string} message - The message content.
         * @param {string} type - 'error' (default) or 'success'.
         */
        function displayAlert(message, type = 'error') {
            // Reset classes
            D.globalAlert.className = 'p-4 mb-8 rounded-xl font-medium border-l-4 shadow-xl transition-all duration-300 z-10 sticky top-4 max-w-2xl mx-auto';
            
            if (type === 'error') {
                D.globalAlert.classList.add('bg-error-red/20', 'text-error-red', 'border-error-red');
                D.globalAlert.innerHTML = `<i class="fas fa-exclamation-triangle mr-3"></i> <span class="font-bold">Failure:</span> ${message}`;
            } else {
                D.globalAlert.classList.add('bg-success-green/20', 'text-success-green', 'border-success-green');
                D.globalAlert.innerHTML = `<i class="fas fa-check-circle mr-3"></i> <span class="font-bold">Success:</span> ${message}`;
            }
            D.globalAlert.classList.remove('hidden');

            // Auto-hide after 10 seconds
            setTimeout(() => D.globalAlert.classList.add('hidden'), 10000);
        }

        /**
         * Safely extracts the YouTube video ID from various URL formats.
         * @param {string} url - The YouTube URL.
         * @returns {string | null} The video ID or null if invalid.
         */
        function extractVideoId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            // YouTube IDs are 11 characters long
            return (match && match[2].length === 11) ? match[2] : null;
        }

        /**
         * Updates the video player iframe.
         * @param {string | null} videoId - The YouTube video ID.
         */
        function loadVideoPlayer(videoId) {
            if (videoId) {
                const iframe = `<iframe width="100%" height="100%" 
                                        src="https://www.youtube.com/embed/${videoId}" 
                                        frameborder="0" allow="accelerometer; autoplay; clipboard-write; 
                                        encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen></iframe>`;
                D.videoPlayer.innerHTML = iframe;
            } else {
                 D.videoPlayer.innerHTML = `
                    <div class="flex flex-col items-center justify-center w-full h-full bg-secondary-bg absolute top-0 left-0 p-8">
                        <i class="fab fa-youtube text-6xl text-red-600 mb-4 opacity-70"></i>
                        <p class="text-gray-400 font-medium text-center text-lg">Input a valid YouTube link above to load the player.</p>
                    </div>`;
            }
        }
        
        /**
         * Toggles the active tab display (using the new pill style).
         * @param {string} targetTab - The data-tab value of the tab to activate.
         */
        function switchTab(targetTab) {
            D.tabButtons.forEach(button => {
                const tabContent = document.getElementById(`${button.dataset.tab}-content`);
                if (button.dataset.tab === targetTab) {
                    // Active Pill Style
                    button.classList.add('bg-card-bg', 'text-accent-cyan', 'shadow-md');
                    button.classList.remove('text-gray-400');
                    tabContent.classList.add('active');
                } else {
                    // Inactive Pill Style
                    button.classList.remove('bg-card-bg', 'text-accent-cyan', 'shadow-md');
                    button.classList.add('text-gray-400');
                    tabContent.classList.remove('active');
                }
            });
        }
        
        /**
         * Clears all analysis output areas and resets state.
         */
        function resetAnalysis() {
            currentAnalysis = { video_title: '', summary: '', quiz: [], action_plan: '', graded_quiz: null };
            D.summaryOutput.innerHTML = '<p class="text-gray-500 text-lg">Detailed analysis will be generated here after processing the video.</p>';
            D.quizOutput.innerHTML = '<p class="text-gray-500 text-lg">A challenging quiz will appear here once the video is analyzed. Good luck!</p>';
            D.action_planOutput.innerHTML = '<p class="text-gray-500 text-lg">Personalized recommendations and next steps will guide your future learning.</p>';
            D.quizScoreDisplay.classList.add('hidden');
            D.scoreButton.disabled = true;
            D.exportButton.disabled = true;
        }

        /**
         * Renders the quiz based on the quiz data.
         */
        function renderQuiz(quizData, isGraded = false) {
            if (!quizData || quizData.length === 0) {
                D.quizOutput.innerHTML = '<p class="text-error-red font-medium text-lg">Quiz generation failed. Ensure the video has available English subtitles/captions.</p>';
                return;
            }

            let html = '';
            quizData.forEach((q, qIndex) => {
                const isCorrectlyAnswered = isGraded && q.user_answer === q.correct_answer;
                const questionBg = isGraded 
                                   ? (isCorrectlyAnswered ? 'bg-success-green/10 border-success-green/50' : 'bg-error-red/10 border-error-red/50') 
                                   : 'bg-card-bg border-gray-700';

                html += `<div class="p-6 rounded-xl border shadow-xl transition duration-300 ${questionBg}">`;
                html += `<p class="font-bold text-xl mb-4 text-text-light">Q${qIndex + 1}: ${DOMPurify.sanitize(q.question)}</p>`;
                
                const selectedAnswer = currentAnalysis.graded_quiz ? q.user_answer : null;

                q.options.forEach((option, oIndex) => {
                    const optionId = `q${qIndex}-o${oIndex}`;
                    
                    let inputClass = 'h-5 w-5 bg-primary-bg border-gray-600 checked:bg-accent-cyan checked:border-accent-cyan focus:ring-accent-cyan';
                    let labelClass = 'ml-3 text-lg transition duration-150';
                    let answerStatus = '';

                    if (isGraded) {
                        const isUserAnswer = (option === q.user_answer);
                        const isCorrect = (option === q.correct_answer);
                        
                        if (isCorrect) {
                            labelClass = 'ml-3 text-success-green font-semibold';
                            answerStatus = ' <i class="fas fa-check ml-1"></i> (Correct Answer)';
                        } else if (isUserAnswer) {
                            labelClass = 'ml-3 text-error-red font-semibold line-through';
                            answerStatus = ' <i class="fas fa-times ml-1"></i> (Your Answer)';
                        } else {
                             labelClass = 'ml-3 text-gray-400';
                        }
                    } else {
                        // Ungraded state
                        labelClass = 'ml-3 text-text-light hover:text-accent-cyan';
                    }

                    html += `<div class="flex items-center my-3">
                                <input id="${optionId}" 
                                       type="radio" 
                                       name="question-${qIndex}" 
                                       value="${DOMPurify.sanitize(option)}" 
                                       data-q-index="${qIndex}"
                                       ${option === selectedAnswer ? 'checked' : ''}
                                       ${isGraded ? 'disabled' : ''}
                                       class="${inputClass}">
                                <label for="${optionId}" class="${labelClass}">
                                    ${DOMPurify.sanitize(option)} ${answerStatus}
                                </label>
                            </div>`;
                });
                // Display the explanation if graded
                if (isGraded && q.explanation) {
                    html += `<div class="mt-4 p-4 text-sm rounded bg-primary-bg/50 text-gray-300 border-l-4 border-accent-cyan">
                        <span class="font-bold text-accent-cyan">Explanation:</span> ${DOMPurify.sanitize(q.explanation)}
                    </div>`;
                }
                html += `</div>`;
            });

            D.quizOutput.innerHTML = html;
        }

        /**
         * Shows the loading state and updates button text.
         */
        function startLoading(button, loadingText = 'Processing...') {
            button.disabled = true;
            button.originalText = button.innerHTML;
            button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ${loadingText}`;
        }

        /**
         * Stops the loading state.
         */
        function stopLoading(button) {
            if (button.originalText) {
                button.innerHTML = button.originalText;
                button.originalText = null;
            }
        }
        
        // --- 3. Main Logic Functions (With Enhanced Error Handling) ---

        /**
         * CORE FUNCTION: Fetches analysis data from the Django API.
         */
        async function analyzeVideo() {
            resetAnalysis(); 
            const videoUrl = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(videoUrl);
            const videoTitle = 'YouTube Video Analysis'; 

            if (!videoId) {
                displayAlert("Please enter a valid YouTube video URL.", 'error');
                D.analyzeButton.disabled = false;
                return;
            }
            
            startLoading(D.analyzeButton, 'Analyzing...');
            
            try {
                const response = await fetch(API_URLS.analyze, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ 
                        video_url: videoUrl,
                        video_title: videoTitle
                    })
                });

                if (!response.ok) {
                    let errorText = `HTTP Error ${response.status}: ${response.statusText}.`;
                    
                    try {
                        const data = await response.json();
                        if (data.error) {
                            errorText = data.error; 
                        }
                    } catch (e) {
                        console.error("Could not parse error JSON:", e);
                    }
                    
                    displayAlert(`Analysis failed: ${errorText}`, 'error');
                    return; 
                }

                // SUCCESS PATH
                const data = await response.json();
                
                currentAnalysis.summary = data.summary;
                currentAnalysis.quiz = data.quiz;
                currentAnalysis.action_plan = data.action_plan;
                currentAnalysis.video_title = data.video_title || videoTitle;

                // Render results
                D.summaryOutput.innerHTML = DOMPurify.sanitize(marked.parse(data.summary));
                D.action_planOutput.innerHTML = DOMPurify.sanitize(marked.parse(data.action_plan));
                renderQuiz(data.quiz, false); 

                if (data.quiz && data.quiz.length > 0) {
                    D.scoreButton.disabled = false;
                    switchTab('quiz');
                    displayAlert(`Video "${data.video_title || 'Untitled'}" analyzed successfully! Quiz ready.`, 'success');
                } else {
                    switchTab('summary');
                    displayAlert(`Summary generated successfully, but no quiz could be created (transcript likely unavailable).`, 'success');
                }

            } catch (e) {
                console.error("Fetch error during analysis:", e);
                displayAlert("A network or unexpected error occurred. Check your connection and console for details.", 'error');
            } finally {
                stopLoading(D.analyzeButton);
                D.analyzeButton.disabled = false; 
            }
        }
        
        /**
         * Submits the user's quiz answers for grading.
         */
        async function submitQuiz() {
            if (currentAnalysis.quiz.length === 0) {
                displayAlert("Cannot score: No quiz questions available.", 'error');
                return;
            }
            
            startLoading(D.scoreButton, 'Grading...');
            D.exportButton.disabled = true;

            // 1. Collect user answers
            const userAnswers = [];
            let allAnswered = true;
            currentAnalysis.quiz.forEach((q, qIndex) => {
                const checkedRadio = document.querySelector(`input[name="question-${qIndex}"]:checked`);
                const userAnswer = checkedRadio ? checkedRadio.value : null;
                
                if (!userAnswer) {
                    allAnswered = false;
                }
                
                // Collect the necessary data to send to the backend
                userAnswers.push({
                    question: q.question,
                    options: q.options,
                    user_answer: userAnswer
                });
            });
            
            if (!allAnswered) {
                stopLoading(D.scoreButton);
                D.scoreButton.disabled = false; 
                displayAlert("Please answer all questions before submitting the quiz.", 'error');
                return;
            }

            // 2. Call the grading API 
            try {
                const response = await fetch(API_URLS.submit, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ quiz_data: userAnswers })
                });

                if (!response.ok) {
                    let errorText = `HTTP Error ${response.status}: ${response.statusText}.`;
                    
                    try {
                        const data = await response.json();
                        if (data.error) {
                            errorText = data.error;
                        }
                    } catch (e) {
                        console.error("Could not parse error JSON:", e);
                    }

                    displayAlert(`Grading failed: ${errorText}`, 'error');
                    return;
                }

                // SUCCESS PATH
                const data = await response.json();
                const gradedData = data.grading_data;
                currentAnalysis.graded_quiz = gradedData;
                
                // 3. Render graded results
                renderQuiz(gradedData.questions, true); 
                
                const scoreColor = gradedData.score >= (gradedData.total_questions / 2) ? 'text-success-green' : 'text-error-red';
                const scoreText = `<i class="fas fa-trophy mr-2"></i> Score: <span class="${scoreColor} font-extrabold">${gradedData.score} / ${gradedData.total_questions}</span>`;
                
                D.quizScoreDisplay.innerHTML = scoreText;
                D.quizScoreDisplay.classList.remove('hidden');

                // 4. Enable Export and disable score
                D.exportButton.disabled = false;
                D.scoreButton.disabled = true; 
                displayAlert("Quiz successfully graded! Review your results and export the report.", 'success');

            } catch (e) {
                console.error("Fetch error during quiz submission:", e);
                displayAlert("A network error occurred while grading. Check the console for details.", 'error');
            } finally {
                stopLoading(D.scoreButton);
            }
        }
        
        /**
         * Generates and downloads the PDF report.
         */
        async function exportContent() {
            if (!currentAnalysis.graded_quiz) {
                displayAlert("Please score the quiz before exporting the report.", 'error');
                return;
            }

            startLoading(D.exportButton, 'Generating PDF...');
            
            try {
                const payload = {
                    video_title: currentAnalysis.video_title,
                    summary: currentAnalysis.summary,
                    quiz_data: currentAnalysis.graded_quiz,
                    action_plan: currentAnalysis.action_plan,
                };

                const response = await fetch(API_URLS.export, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filenameMatch = contentDisposition ? contentDisposition.match(/filename="(.+)"/) : null;
                    const filename = filenameMatch ? filenameMatch[1] : 'analysis_report.pdf';

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    displayAlert("PDF report downloaded successfully!", 'success');

                } else {
                    let errorText = `HTTP Error ${response.status}: ${response.statusText}.`;
                    
                    try {
                        const data = await response.json();
                        if (data.error) {
                            errorText = data.error;
                        }
                    } catch (e) {
                         console.error("Could not parse error JSON:", e);
                    }
                    
                    displayAlert(`Export failed: ${errorText}`, 'error');
                }

            } catch (e) {
                console.error("Fetch error during export:", e);
                displayAlert("A network error occurred while exporting. Check the console for details.", 'error');
            } finally {
                stopLoading(D.exportButton);
            }
        }
        
        /**
         * Utility to get CSRF token for Django POST requests.
         */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // --- 4. Initialization and Event Listeners ---
        
        // Initial setup based on input value (for deep linking)
        if (D.videoLinkInput.value) {
            const initialId = extractVideoId(D.videoLinkInput.value.trim());
            if (initialId) {
                loadVideoPlayer(initialId);
                D.analyzeButton.disabled = false;
            }
        }

        // 1. URL Input Listener: Enable/Disable Analyze button and load player
        D.videoLinkInput.addEventListener('input', () => {
            const url = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(url);
            const isValid = videoId !== null;
            
            D.analyzeButton.disabled = !isValid;
            resetAnalysis(); 
            
            loadVideoPlayer(videoId);
        });

        // 2. Tab Button Listeners
        D.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 3. Main Action Button Listeners
        D.analyzeButton.addEventListener('click', analyzeVideo);
        D.scoreButton.addEventListener('click', submitQuiz); 
        D.exportButton.addEventListener('click', exportContent);
        
        // Initial Tab Activation
        switchTab('summary');
    });
</script>
{% endblock %}
