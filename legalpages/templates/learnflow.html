{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for better font integration
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1a73e8',
                        'hover-blue': '#0c4fae',
                        'background-light': '#f4f7f9',
                        'error-red': '#d93025',
                        'blue-start': '#1e3a8a', 
                        'black-end': '#0f172a',  
                    },
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
{% endblock %}

{% block content %}
<div id="video-analysis-app" class="p-4 md:p-8 min-h-screen bg-background-light dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-extrabold text-primary-blue dark:text-white" id="mainTitle">LearnFlow AI</h1>
        <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-150 ease-in-out mt-2 sm:mt-0" title="Toggle dark mode">
            <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="moonIcon" class="w-6 h-6 text-gray-800 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </header> 

    <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
        <input type="text" id="videoLink" placeholder="Paste YouTube Video URL here (e.g., https://www.youtube.com/watch?v=...)" 
               class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-gray-700 dark:text-white transition duration-150 ease-in-out"
               value="{% if pre_selected_video_id %}https://www.youtube.com/watch?v={{ pre_selected_video_id }}{% endif %}">
        
        <button id="analyzeButton" 
                class="w-full md:w-auto px-6 py-3 text-white font-bold rounded-lg transition duration-150 ease-in-out bg-primary-blue hover:bg-hover-blue focus:outline-none focus:ring-4 focus:ring-primary-blue/50 disabled:opacity-50" 
                title="Start Analysis">
            <span id="analyzeButtonText">Analyze Video</span>
            <span id="loadingIndicator" class="hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></span>
        </button>
    </div>

    <div id="statusMessage" class="hidden p-4 mb-6 rounded-lg font-medium" role="alert"></div>

    <div id="analysisContent" class="hidden">
        
        <div id="videoPlayer" class="aspect-video mb-6 rounded-xl overflow-hidden shadow-2xl bg-black dark:bg-gray-900"></div>

        <div class="flex flex-col lg:flex-row gap-6">

            <div class="lg:w-2/3 space-y-6">
                
                <div class="flex border-b border-gray-200 dark:border-gray-700">
                    <button data-tab="summary" class="tab-button px-4 py-2 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none" aria-controls="tab-summary-content" aria-selected="true" id="summaryButton">Summary</button>
                    <button data-tab="questions" class="tab-button px-4 py-2 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none" aria-controls="tab-questions-content" aria-selected="false" id="questionsButton">Questions</button>
                    <button data-tab="transcript" class="tab-button px-4 py-2 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none" aria-controls="tab-transcript-content" aria-selected="false" id="transcriptButton">Transcript</button>
                </div>

                <div id="tabContent">
                    
                    <div id="tab-summary-content" class="tab-pane p-6 bg-white dark:bg-gray-800 rounded-b-xl shadow-md space-y-4 prose dark:prose-invert">
                        <h2 class="text-xl font-bold border-b pb-2 dark:border-gray-700" id="summaryTitle">Video Summary</h2>
                        <div id="summaryContent" class="text-gray-700 dark:text-gray-300">
                            <p id="summaryPlaceholder" class="italic text-gray-500 dark:text-gray-400">Analysis result will appear here...</p>
                        </div>
                    </div>

                    <div id="tab-questions-content" class="tab-pane hidden p-6 bg-white dark:bg-gray-800 rounded-b-xl shadow-md space-y-6">
                        <div class="flex justify-between items-center border-b pb-2 dark:border-gray-700">
                            <h2 class="text-xl font-bold" id="quizTitle">Knowledge Assessment (20+ Questions)</h2>
                            <button id="scoreButton" 
                                    class="px-4 py-2 text-white font-bold rounded-lg bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-600/50 disabled:opacity-50"
                                    disabled>
                                <span id="scoreButtonText">Submit & Get Report</span>
                            </button>
                        </div>
                        
                        <div id="quizContainer" class="space-y-8">
                            <p id="quizPlaceholder" class="italic text-gray-500 dark:text-gray-400">Questions will load here after analysis...</p>
                        </div>

                        <div id="quizResults" class="hidden mt-8 p-6 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-xl shadow-inner space-y-4">
                            <h3 class="text-2xl font-bold text-green-700 dark:text-green-300" id="quizResultsTitle">Your Results</h3>
                            <p id="finalScoreDisplay" class="text-lg font-semibold text-green-800 dark:text-green-200">Score: -/-</p>
                            <button id="exportButton" 
                                    class="px-4 py-2 text-white font-bold rounded-lg bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-600/50"
                                    title="Download PDF Report and Certificate">
                                <span id="exportButtonText">Download PDF Report & Certificate</span>
                            </button>
                        </div>
                    </div>

                    <div id="tab-transcript-content" class="tab-pane hidden p-6 bg-white dark:bg-gray-800 rounded-b-xl shadow-md space-y-4 prose dark:prose-invert">
                        <h2 class="text-xl font-bold border-b pb-2 dark:border-gray-700" id="transcriptTitle">Video Transcript</h2>
                        <div id="transcriptContent" class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                            <p id="transcriptPlaceholder" class="italic text-gray-500 dark:text-gray-400">Transcript will appear here...</p>
                        </div>
                    </div>

                </div>
            </div>

            <div class="lg:w-1/3 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg h-fit space-y-4">
                <h3 class="text-xl font-bold border-b pb-2 dark:border-gray-700">Additional Resources</h3>
                <p id="feedbackPromptText" class="text-sm">Found an issue or want to request a feature? Let us know.</p>
                <a href="#" id="feedbackLink" class="text-primary-blue hover:text-hover-blue font-semibold text-sm">Send Feedback</a>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global State ---
    let currentVideoId = null;
    let quizData = []; // Stores the full quiz structure with correct answers
    let quizSubmitted = false;
    const analyzeButton = document.getElementById('analyzeButton');
    const scoreButton = document.getElementById('scoreButton');
    const exportButton = document.getElementById('exportButton');
    const statusMessage = document.getElementById('statusMessage');

    // Internationalization (for text elements)
    const i18n = {
        // ... (Original i18n properties - kept for context)
        analyzeButtonText: "Analyze Video",
        loadingText: "Analyzing...",
        summaryTitle: "Video Summary",
        questionsTitle: "Knowledge Assessment (20+ Questions)",
        transcriptTitle: "Video Transcript",
        placeholderSummary: "Analysis result will appear here...",
        placeholderQuiz: "Questions will load here after analysis...",
        placeholderTranscript: "Transcript will appear here...",
        scoreButtonText: "Submit & Get Report",
        exportButtonText: "Download PDF Report & Certificate",
        quizResultsTitle: "Your Results",
        feedbackPrompt: "Found an issue or want to request a feature? Let us know.",
        feedbackLink: "Send Feedback",
        darkModeToggle: "Toggle dark mode"
    };

    // --- Core Functions ---

    function switchTab(tabName) {
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('text-primary-blue', 'dark:text-white', 'border-b-2', 'border-primary-blue');
            button.classList.add('text-gray-500', 'dark:text-gray-400');
        });

        document.getElementById(`tab-${tabName}-content`).classList.remove('hidden');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('text-primary-blue', 'dark:text-white', 'border-b-2', 'border-primary-blue');
        document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-500', 'dark:text-gray-400');
    }

    function showStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
        statusMessage.classList.add('dark:text-white');
        
        switch (type) {
            case 'error':
                statusMessage.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-300');
                break;
            case 'success':
                statusMessage.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-300');
                break;
            case 'info':
            default:
                statusMessage.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-300');
                break;
        }
    }
    
    function setButtonState(isLoading) {
        analyzeButton.disabled = isLoading;
        analyzeButton.querySelector('#loadingIndicator').classList.toggle('hidden', !isLoading);
        analyzeButton.querySelector('#analyzeButtonText').textContent = isLoading ? i18n.loadingText : i18n.analyzeButtonText;
    }

    // --- Rendering and Data Handling ---

    function renderVideoPlayer(videoId) {
        const iframe = document.createElement('iframe');
        iframe.setAttribute('width', '100%');
        iframe.setAttribute('height', '100%');
        iframe.setAttribute('src', `https://www.youtube.com/embed/${videoId}`);
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
        iframe.setAttribute('allowfullscreen', true);
        
        const player = document.getElementById('videoPlayer');
        player.innerHTML = '';
        player.appendChild(iframe);
    }
    
    // NEW FUNCTION: Renders both MCQ and Short Answer questions
    function renderQuestions(questions) {
        const container = document.getElementById('quizContainer');
        container.innerHTML = ''; // Clear previous content

        if (questions.length === 0) {
            container.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">No questions were generated for this video.</p>`;
            scoreButton.disabled = true;
            return;
        }

        questions.forEach((q, index) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 shadow-sm';
            questionElement.setAttribute('data-q-index', index);
            
            // Question Text
            const qText = document.createElement('p');
            qText.className = 'font-semibold text-lg mb-3';
            qText.innerHTML = `${index + 1}. ${DOMPurify.sanitize(q.question)}`;
            questionElement.appendChild(qText);

            if (q.type === 'MCQ') {
                // Render Multiple Choice Options (Radio Buttons)
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'space-y-2';

                q.options.forEach((option, optIndex) => {
                    const optionId = `q${index}-opt${optIndex}`;
                    const radioGroup = document.createElement('div');
                    radioGroup.className = 'flex items-center';

                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.id = optionId;
                    input.name = `q${index}`; // Group radio buttons by question index
                    input.value = optIndex; // Value is the index of the option
                    input.className = 'w-4 h-4 text-primary-blue bg-gray-100 border-gray-300 focus:ring-primary-blue dark:focus:ring-primary-blue dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600';
                    input.addEventListener('change', enableScoreButton); // Enable score button on first interaction

                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.className = 'ml-2 text-sm font-medium text-gray-900 dark:text-gray-300 cursor-pointer';
                    label.textContent = option;

                    radioGroup.appendChild(input);
                    radioGroup.appendChild(label);
                    optionsContainer.appendChild(radioGroup);
                });
                questionElement.appendChild(optionsContainer);
            } else if (q.type === 'ShortAnswer') {
                // Render Short Answer Input (Text Field)
                const input = document.createElement('input');
                input.type = 'text';
                input.name = `q${index}`;
                input.placeholder = 'Type your answer here...';
                input.className = 'mt-2 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-primary-blue focus:border-primary-blue transition duration-150';
                input.addEventListener('input', enableScoreButton); // Enable score button on input

                // We don't show the answer space, but the input is used to collect the answer
                questionElement.appendChild(input); 
            }

            container.appendChild(questionElement);
        });

        scoreButton.disabled = false; // Enable the button now that questions are rendered
        document.getElementById('quizResults').classList.add('hidden'); // Hide results on new load
        quizSubmitted = false;
    }

    function enableScoreButton() {
        scoreButton.disabled = false;
    }

    async function analyzeVideo() {
        // ... (Original video analysis logic - kept as before)
        const videoLink = document.getElementById('videoLink').value.trim();
        if (!videoLink) {
            showStatus("Please paste a valid YouTube video link.", 'error');
            return;
        }

        setButtonState(true);
        showStatus("Fetching transcript and generating 20+ mixed questions with AI...", 'info');
        
        try {
            const response = await fetch('/api/analyze_video/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CSRF token must be obtained and included in a real Django setup
                },
                body: JSON.stringify({ video_link: videoLink })
            });

            const data = await response.json();

            if (data.status === 'success') {
                showStatus("Analysis complete. Check the Summary and Questions tabs.", 'success');
                document.getElementById('analysisContent').classList.remove('hidden');
                
                // Set global state
                currentVideoId = data.video_id;
                quizData = data.questions; // Store the full data for submission later

                // Render content
                renderVideoPlayer(currentVideoId);
                document.getElementById('summaryContent').innerHTML = marked.parse(DOMPurify.sanitize(data.summary));
                document.getElementById('transcriptContent').textContent = data.transcript_text;
                
                // NEW: Render the mixed questions
                renderQuestions(quizData); 

                switchTab('summary');
            } else {
                showStatus(`Error: ${data.message}`, 'error');
            }
        } catch (error) {
            showStatus(`A network error occurred: ${error.message}`, 'error');
        } finally {
            setButtonState(false);
        }
    }
    
    // NEW FUNCTION: Collects user answers from the rendered quiz
    function collectUserAnswers() {
        const answers = {};
        quizData.forEach((q, index) => {
            const qName = `q${index}`;
            const qElement = document.querySelector(`[data-q-index="${index}"]`);
            
            if (q.type === 'MCQ') {
                // Find the checked radio button's value (which is the option index)
                const checkedRadio = qElement.querySelector(`input[name="${qName}"]:checked`);
                answers[index] = checkedRadio ? checkedRadio.value : '';
            } else if (q.type === 'ShortAnswer') {
                // Get the value from the text input
                const inputField = qElement.querySelector(`input[name="${qName}"]`);
                answers[index] = inputField ? inputField.value.trim() : '';
            }
        });
        return answers;
    }

    // NEW FUNCTION: Handles quiz submission and PDF download
    async function submitQuiz() {
        if (quizSubmitted) return;

        const userAnswers = collectUserAnswers();
        
        // Simple check to ensure at least one answer was provided before submission
        if (Object.values(userAnswers).every(ans => ans === '')) {
            showStatus("Please answer at least one question before submitting.", 'error');
            return;
        }
        
        // Show loading state for the score button
        scoreButton.disabled = true;
        scoreButton.textContent = 'Submitting...';

        try {
            const response = await fetch('/api/submit_quiz/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CSRF token must be obtained and included
                },
                body: JSON.stringify({
                    video_id: currentVideoId,
                    quiz_data: quizData,
                    user_answers: userAnswers
                })
            });

            // Check if the response is a JSON error or the PDF stream
            if (response.headers.get('content-type') === 'application/json') {
                 const data = await response.json();
                 showStatus(`Submission Error: ${data.message}`, 'error');
                 return;
            }

            // --- Handle successful PDF download (Response is a file stream) ---
            const finalScoreHeader = response.headers.get('X-Quiz-Score'); // Get score from header
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            
            // Trigger download
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = response.headers.get('Content-Disposition').split('filename=')[1].replace(/"/g, ''); // Use filename from Content-Disposition header
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Display results on the page
            document.getElementById('finalScoreDisplay').textContent = `Final Score: ${finalScoreHeader}`;
            document.getElementById('quizResults').classList.remove('hidden');
            showStatus("Quiz submitted and PDF report generated successfully!", 'success');
            
            quizSubmitted = true;
            scoreButton.textContent = 'Report Downloaded';
            scoreButton.disabled = true;

        } catch (error) {
            showStatus(`A network error occurred during submission: ${error.message}`, 'error');
            scoreButton.textContent = i18n.scoreButtonText;
            scoreButton.disabled = false;
        }
    }


    // --- Event Listeners and Initial Setup ---\

    document.addEventListener('DOMContentLoaded', () => {
        // ... (Original initial setup and dark mode logic)

        // Add event listeners for tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add the main event listeners
        document.getElementById('analyzeButton').addEventListener('click', analyzeVideo);
        // NEW: Submit Quiz handler
        document.getElementById('scoreButton').addEventListener('click', submitQuiz);
        // The export button is now redundant since submission triggers download, but keep it as a re-download trigger
        document.getElementById('exportButton').addEventListener('click', submitQuiz); 
        
        // Initial button states
        scoreButton.disabled = true;
        
        // If a pre-selected video ID exists (from URL routing), trigger analysis on load
        {% if pre_selected_video_id %}
            // Need a slight delay to ensure all JS/HTML elements are ready
            setTimeout(analyzeVideo, 100); 
        {% endif %}
    });

</script>
{% endblock %}