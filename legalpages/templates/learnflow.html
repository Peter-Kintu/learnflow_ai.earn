{% extends "base.html" %}
{% load static %}

{% block title %}Video Analysis - LearnFlow AI{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // UPDATED COLORS for Blue-Black Theme
                        'primary-bg': '#0A1428', /* Deep Blue-Black - Main Background */
                        'secondary-bg': '#121C34', /* Darker Blue Card Background */
                        'card-bg': '#1E2B4B', /* Lighter Blue Card/Quiz Item Background */
                        
                        'accent-cyan': '#00DDEB', /* Vibrant Cyan for highlights (Kept same) */
                        'accent-blue': '#3b82f6', /* Standard Blue for buttons (Kept same) */
                        'text-light': '#C9D1D9', /* Light gray text (Kept same) */
                        'success-green': '#10B981', /* Tailwind Green */
                        'error-red': '#EF4444' /* Tailwind Red */
                    },
                    boxShadow: {
                        'glow-cyan': '0 0 10px 0 rgba(0, 221, 235, 0.5)',
                    }
                }
            }
        }
    </script>
{% endblock %}

{% block content %}
    <div class="min-h-screen bg-primary-bg text-text-light p-4 lg:p-10">
        <div class="max-w-7xl mx-auto">

            <header class="text-center mb-10">
                <h1 class="text-4xl lg:text-5xl font-extrabold text-accent-cyan tracking-tight">
                    LearnFlow AI: Video Analyzer
                </h1>
                <p class="mt-2 text-lg text-text-light opacity-70">
                    Paste a YouTube link to instantly generate a summary, quiz, and action plan.
                </p>
            </header>

            <div class="bg-secondary-bg p-6 rounded-xl shadow-2xl mb-8">
                <div class="flex flex-col lg:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="video-link-input" class="block text-sm font-medium text-text-light mb-1">YouTube Video Link</label>
                        <input type="text" id="video-link-input" 
                            class="w-full p-3 bg-card-bg border border-card-bg focus:border-accent-cyan rounded-lg text-text-light placeholder-gray-500 transition duration-300"
                            placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                            value="{{ initial_url|default:'' }}">
                    </div>

                    <button id="analyze-button" 
                            class="w-full lg:w-48 p-3 bg-accent-blue hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic mr-2"></i> Analyze Video
                    </button>
                </div>
                
                <div id="player-container" class="mt-6 w-full aspect-video rounded-lg overflow-hidden bg-card-bg flex items-center justify-center">
                    <div id="youtube-player" class="w-full h-full">
                        <p id="player-placeholder" class="text-text-light opacity-50 p-10">
                            Paste a valid YouTube link above to load the video player.
                        </p>
                    </div>
                </div>
            </div>

            <div id="analysis-container" class="mt-10 hidden">
                <h2 id="video-title" class="text-3xl font-bold text-text-light mb-6 border-b border-secondary-bg pb-3">
                    [Video Title]
                </h2>
                
                <div id="warning-message" class="hidden bg-error-red/20 border border-error-red text-text-light p-3 rounded-lg mb-6 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-3 text-error-red"></i>
                    <span id="warning-text"></span>
                </div>

                <div class="flex border-b border-card-bg mb-6">
                    <button data-tab="summary" class="tab-button px-4 py-2 text-lg font-medium border-b-2 border-transparent hover:border-accent-cyan transition duration-300 active-tab-button">Summary</button>
                    <button data-tab="quiz" class="tab-button px-4 py-2 text-lg font-medium border-b-2 border-transparent hover:border-accent-cyan transition duration-300">Quiz</button>
                    <button data-tab="action_plan" class="tab-button px-4 py-2 text-lg font-medium border-b-2 border-transparent hover:border-accent-cyan transition duration-300">Action Plan</button>
                </div>

                <div class="flex flex-col lg:flex-row gap-6">
                    
                    <div class="lg:w-3/4 w-full bg-secondary-bg p-6 rounded-xl shadow-xl min-h-96">
                        <div id="summary-tab" class="tab-content prose prose-invert max-w-none text-text-light">
                            <p class="text-lg opacity-70">Analysis results will appear here after clicking 'Analyze Video'.</p>
                        </div>
                        
                        <div id="quiz-tab" class="tab-content hidden">
                            <form id="quiz-form">
                                </form>
                            <div id="quiz-feedback" class="mt-6 p-4 bg-card-bg rounded-lg hidden">
                                <h3 class="text-xl font-bold text-accent-cyan mb-2">Quiz Results</h3>
                                <div id="feedback-content" class="prose prose-invert max-w-none text-text-light"></div>
                            </div>
                        </div>

                        <div id="action_plan-tab" class="tab-content prose prose-invert max-w-none text-text-light hidden">
                            </div>
                    </div>

                    <div class="lg:w-1/4 w-full flex flex-col space-y-4">
                        <button id="score-button" 
                                class="p-3 bg-success-green hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <i class="fas fa-check-circle mr-2"></i> Score Quiz
                        </button>

                        <button id="export-button" 
                                class="p-3 bg-accent-cyan hover:bg-cyan-700 text-primary-bg font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <i class="fas fa-file-pdf mr-2"></i> Export Content (PDF)
                        </button>
                        
                        <div id="status-message" class="p-4 bg-card-bg text-text-light rounded-lg text-sm hidden">
                            <p id="status-text">Ready.</p>
                        </div>
                    </div>

                </div>
            </div>
            
            <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
                <div class="bg-error-red/10 border border-error-red p-6 rounded-xl max-w-md w-full shadow-2xl">
                    <h3 class="text-xl font-bold text-error-red mb-3 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> Error</h3>
                    <p id="error-modal-text" class="text-text-light"></p>
                    <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="mt-4 p-2 bg-error-red hover:bg-red-700 text-white font-bold rounded-lg w-full transition duration-300">Close</button>
                </div>
            </div>

        </div>
    </div>
{% endblock %}


{% block extra_js %}
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Use a single object to manage DOM elements for cleaner code
        const D = {
            videoLinkInput: document.getElementById('video-link-input'),
            analyzeButton: document.getElementById('analyze-button'),
            scoreButton: document.getElementById('score-button'),
            exportButton: document.getElementById('export-button'),
            analysisContainer: document.getElementById('analysis-container'),
            videoTitle: document.getElementById('video-title'),
            summaryTab: document.getElementById('summary-tab'),
            quizTab: document.getElementById('quiz-tab'),
            actionPlanTab: document.getElementById('action_plan-tab'),
            tabButtons: document.querySelectorAll('.tab-button'),
            quizForm: document.getElementById('quiz-form'),
            quizFeedback: document.getElementById('quiz-feedback'),
            feedbackContent: document.getElementById('feedback-content'),
            statusMessage: document.getElementById('status-message'),
            statusText: document.getElementById('status-text'),
            errorModal: document.getElementById('error-modal'),
            errorModalText: document.getElementById('error-modal-text'),
            warningMessage: document.getElementById('warning-message'),
            warningText: document.getElementById('warning-text'),
            playerContainer: document.getElementById('youtube-player'),
            playerPlaceholder: document.getElementById('player-placeholder'),
        };

        let player;
        let currentAnalysis = {
            video_title: '',
            summary: '',
            quiz: [],
            action_plan: '',
            graded_quiz: null, // Stores the graded quiz object
        };

        // --- 1. Utility Functions ---

        const showStatus = (text, isError = false) => {
            D.statusText.innerHTML = DOMPurify.sanitize(text);
            D.statusMessage.classList.remove('hidden');
            D.statusMessage.className = `p-4 rounded-lg text-sm ${isError ? 'bg-error-red/20 text-error-red' : 'bg-card-bg text-text-light'}`;
            if (isError) {
                showErrorModal(text);
            }
        };

        const showErrorModal = (message) => {
            D.errorModalText.textContent = message;
            D.errorModal.classList.remove('hidden');
        }

        const resetAnalysis = () => {
            currentAnalysis = { video_title: '', summary: '', quiz: [], action_plan: '', graded_quiz: null };
            D.videoTitle.textContent = '[Video Title]';
            D.summaryTab.innerHTML = '<p class="text-lg opacity-70">Analysis results will appear here after clicking \'Analyze Video\'.</p>';
            D.quizForm.innerHTML = '';
            D.quizFeedback.classList.add('hidden');
            D.actionPlanTab.innerHTML = '';
            D.analysisContainer.classList.add('hidden');
            D.scoreButton.disabled = true; // IMPORTANT: Disable Score button until new quiz is generated
            D.exportButton.disabled = true; // IMPORTANT: Disable Export button until quiz is scored
            D.warningMessage.classList.add('hidden');
            D.statusMessage.classList.add('hidden');
        };

        const extractVideoId = (url) => {
            let videoId = null;
            let match = url.match(/(?:youtu\.be\/|v=|embed\/|shorts\/)([^"&?\/\s]{11})/);
            if (match && match[1]) {
                videoId = match[1];
            } else {
                // Check for standard URL structure if not found (less common for embedding, but robust)
                match = url.match(/youtube\.com.*[?&]v=([^"&?\/\s]{11})/);
                if (match && match[1]) {
                    videoId = match[1];
                }
            }
            return videoId;
        };

        const switchTab = (tabName) => {
            D.tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('active-tab-button', 'border-accent-cyan');
                    button.classList.remove('border-transparent');
                } else {
                    button.classList.remove('active-tab-button', 'border-accent-cyan');
                    button.classList.add('border-transparent');
                }
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        };

        // Function to create a placeholder/container for the YouTube player
        const createPlayerContainer = () => {
            // Remove existing player element to prevent memory leaks/re-init issues
            while (D.playerContainer.firstChild) {
                D.playerContainer.removeChild(D.playerContainer.firstChild);
            }
            // Re-create the placeholder if needed (though it should be the player itself)
            const newPlayerDiv = document.createElement('div');
            newPlayerDiv.id = 'youtube-player-actual';
            newPlayerDiv.className = 'w-full h-full'; // Ensure it takes full space
            D.playerContainer.appendChild(newPlayerDiv);
            return newPlayerDiv.id;
        };


        const loadVideoPlayer = (videoId) => {
            if (!videoId) {
                // If no valid ID, remove player and show placeholder
                if (player) {
                    player.destroy();
                    player = null;
                }
                while (D.playerContainer.firstChild) { D.playerContainer.removeChild(D.playerContainer.firstChild); }
                D.playerContainer.appendChild(D.playerPlaceholder);
                return;
            }

            const playerElementId = createPlayerContainer();

            if (typeof YT !== 'undefined' && YT.Player) {
                // Destroy old player instance if it exists
                if (player) {
                    player.destroy();
                }

                player = new YT.Player(playerElementId, {
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'modestbranding': 1,
                        'rel': 0
                    },
                    events: {
                        'onReady': (event) => {
                            // Video ready, remove placeholder if still visible
                            if (D.playerPlaceholder.parentNode) {
                                D.playerPlaceholder.remove();
                            }
                        },
                        'onError': (event) => {
                            showErrorModal(`Youtubeer Error. Code: ${event.data}. The video may be unavailable, private, or restricted.`);
                        }
                    }
                });
            } else {
                // If the API isn't ready yet, the onYouTubeIframeAPIReady will handle it.
            }
        };

        const renderQuiz = (quizData) => {
            D.quizForm.innerHTML = ''; // Clear previous quiz
            D.scoreButton.disabled = false; // Enable score button
            D.quizFeedback.classList.add('hidden');
            
            quizData.forEach((q, index) => {
                const questionHtml = `
                    <div class="bg-card-bg p-4 rounded-lg shadow-md mb-4 border border-secondary-bg">
                        <p class="text-text-light font-semibold mb-3">
                            <span class="text-accent-cyan mr-2">${index + 1}.</span> ${q.question}
                        </p>
                        <div class="space-y-2">
                            ${q.options.map((option, oIndex) => `
                                <label class="flex items-center text-text-light cursor-pointer p-2 rounded-md hover:bg-primary-bg transition duration-200">
                                    <input type="radio" 
                                        name="question-${index}" 
                                        value="${DOMPurify.sanitize(option)}" 
                                        data-correct-answer="${DOMPurify.sanitize(q.correct_answer)}" 
                                        class="mr-3 text-accent-cyan bg-secondary-bg border-gray-600 focus:ring-accent-cyan"
                                        required>
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                D.quizForm.insertAdjacentHTML('beforeend', questionHtml);
            });
        };

        const renderAnalysis = (data) => {
            currentAnalysis = {
                ...currentAnalysis,
                video_title: data.video_title,
                summary: data.summary,
                quiz: data.quiz,
                action_plan: data.action_plan,
            };

            // 1. Title
            D.videoTitle.textContent = data.video_title;

            // 2. Summary (Render Markdown to HTML)
            D.summaryTab.innerHTML = DOMPurify.sanitize(marked.parse(data.summary));
            
            // 3. Quiz (Render form)
            renderQuiz(data.quiz);

            // 4. Action Plan (Render Markdown to HTML)
            D.actionPlanTab.innerHTML = DOMPurify.sanitize(marked.parse(data.action_plan));

            D.analysisContainer.classList.remove('hidden');
            switchTab('summary'); // Default to summary tab
            showStatus('Analysis complete. Please take the quiz.', false);
        };


        // --- 2. API Call Functions ---

        const analyzeVideo = async () => {
            const videoUrl = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(videoUrl);

            if (!videoId) {
                showErrorModal('Please enter a valid YouTube URL.');
                return;
            }

            // Simple check to get the title from the player object if available
            const videoTitle = player && player.getVideoData ? player.getVideoData().title : 'Analyzing Video...';

            resetAnalysis();
            D.analyzeButton.disabled = true;
            showStatus('Fetching transcript and analyzing video with Gemini AI. This may take up to 30 seconds...');

            try {
                const response = await fetch('api/analyze_video/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        video_url: videoUrl,
                        video_title: videoTitle // Send the title to the backend
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    renderAnalysis(data);
                } else {
                    showStatus(data.error || 'Failed to analyze video due to an unknown API error.', true);
                    resetAnalysis();
                }

            } catch (error) {
                console.error('Analyze Video Network Error:', error);
                showStatus('Network error while communicating with the server. Check your connection.', true);
                resetAnalysis();
            } finally {
                D.analyzeButton.disabled = false;
            }
        };

        const submitQuiz = async () => {
            const form = D.quizForm;
            const quizResults = [];
            let allAnswered = true;

            // Collect user answers
            currentAnalysis.quiz.forEach((q, index) => {
                const radios = form.elements[`question-${index}`];
                let userAnswer = 'N/A';
                
                if (radios) {
                    // radios can be an element or a NodeList, so check for `value` on a radio group
                    const checkedRadio = Array.from(radios).find(radio => radio.checked);
                    if (checkedRadio) {
                        userAnswer = checkedRadio.value;
                    } else {
                        allAnswered = false;
                    }
                }
                
                // Prepare data for the grading API
                quizResults.push({
                    question: q.question,
                    user_answer: userAnswer,
                    correct_answer: q.correct_answer // Send the correct answer for grading/comparison
                });
            });

            if (!allAnswered) {
                showStatus('Please answer all quiz questions before scoring.', true);
                return;
            }

            D.scoreButton.disabled = true;
            D.exportButton.disabled = true;
            showStatus('Grading quiz with Gemini AI...');

            try {
                const response = await fetch('api/submit_quiz/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        quiz_data: quizResults
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const gradedData = data.grading_data;
                    currentAnalysis.graded_quiz = gradedData;
                    
                    // Render feedback
                    let feedbackHtml = `
                        <p class="text-xl font-extrabold text-accent-cyan mb-4">
                            Your Score: ${gradedData.score} / ${gradedData.total_questions}
                        </p>
                    `;

                    gradedData.questions.forEach((q, index) => {
                        const status = q.is_correct ? 'CORRECT' : 'INCORRECT';
                        const color = q.is_correct ? 'text-success-green' : 'text-error-red';
                        
                        feedbackHtml += `
                            <div class="mb-4 p-3 rounded-lg ${q.is_correct ? 'bg-success-green/10' : 'bg-error-red/10'} border ${q.is_correct ? 'border-success-green' : 'border-error-red'}">
                                <p class="font-bold text-text-light">${index + 1}. ${q.question}</p>
                                <p class="mt-1">Your Answer: <span class="${color} font-semibold">${q.user_answer} (${status})</span></p>
                                ${!q.is_correct ? `<p class="mt-1">Correct Answer: <span class="text-success-green font-semibold">${q.correct_answer}</span></p>` : ''}
                            </div>
                        `;
                    });

                    D.feedbackContent.innerHTML = DOMPurify.sanitize(feedbackHtml);
                    D.quizFeedback.classList.remove('hidden');
                    D.exportButton.disabled = false; // Enable export after grading
                    showStatus('Quiz scored successfully. You can now export your report.', false);

                } else {
                    showStatus(data.error || 'Failed to grade quiz due to an unknown API error.', true);
                }

            } catch (error) {
                console.error('Submit Quiz Network Error:', error);
                showStatus('Network error while communicating with the server.', true);
            } finally {
                D.scoreButton.disabled = false;
            }
        };

        const exportContent = async () => {
            if (!currentAnalysis.graded_quiz) {
                showStatus('Please complete and score the quiz before exporting the report.', true);
                return;
            }

            D.exportButton.disabled = true;
            showStatus('Generating PDF report...');

            try {
                const response = await fetch('api/export_content/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        video_title: currentAnalysis.video_title,
                        summary: currentAnalysis.summary,
                        quiz_data: currentAnalysis.graded_quiz, // Send the graded data
                        action_plan: currentAnalysis.action_plan
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    // Extract filename from Content-Disposition header if possible, otherwise use a default
                    let filename = "learnflow_report.pdf";
                    const contentDisposition = response.headers.get('Content-Disposition');
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match && match[1]) {
                            filename = match[1];
                        }
                    }

                    // Create a link element, trigger download, and clean up
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showStatus('PDF successfully downloaded.', false);
                } else {
                    const errorText = await response.json().catch(() => ({error: 'Could not read server error message.'}));
                    showStatus(errorText.error || 'Failed to generate PDF.', true);
                }
            } catch (error) {
                console.error('Export Content Network Error:', error);
                showStatus('Network error during PDF export.', true);
            } finally {
                D.exportButton.disabled = false;
            }
        };


        // --- 3. CSRF Token Utility ---

        // Function to get CSRF token from cookies
        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // --- 4. Initialization and Event Listeners ---
        
        // Make sure the player logic runs after the YouTube Iframe API is loaded
        const onYouTubeIframeAPIReady = () => {
            // Initial setup based on input value (for deep linking)
            if (D.videoLinkInput.value) {
                const initialId = extractVideoId(D.videoLinkInput.value.trim());
                if (initialId) {
                    loadVideoPlayer(initialId);
                    D.analyzeButton.disabled = false;
                }
            }
        }
        window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady; // Make available globally

        // 1. URL Input Listener: Enable/Disable Analyze button and load player
        D.videoLinkInput.addEventListener('input', () => {
            const url = D.videoLinkInput.value.trim();
            const videoId = extractVideoId(url);
            const isValid = videoId !== null;
            
            D.analyzeButton.disabled = !isValid;
            resetAnalysis(); 
            
            loadVideoPlayer(videoId);
        });

        // 2. Tab Button Listeners
        D.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // 3. Main Action Button Listeners
        D.analyzeButton.addEventListener('click', analyzeVideo);
        D.scoreButton.addEventListener('click', submitQuiz); 
        D.exportButton.addEventListener('click', exportContent);
        
        // Initial Tab Activation
        switchTab('summary');
        
        // If the API was ready before the IframeReady function was set, call it now
        if (typeof YT !== 'undefined' && YT.Player && !player) {
            onYouTubeIframeAPIReady();
        }

    </script>
{% endblock %}