{% extends "base.html" %}
{% load static %}

{% block title %}Math Tug-of-War - Nakintu AI{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="bg-slate-800 p-4 rounded-t-2xl border-x border-t border-indigo-600/30 flex flex-wrap justify-center items-center gap-3">
        <button class="mode-btn active bg-indigo-600 px-3 py-1 rounded-lg text-sm font-bold transition-all" onclick="setMode('+', this)">Add</button>
        <button class="mode-btn bg-slate-700 px-3 py-1 rounded-lg text-sm font-bold transition-all" onclick="setMode('-', this)">Sub</button>
        <button class="mode-btn bg-slate-700 px-3 py-1 rounded-lg text-sm font-bold transition-all" onclick="setMode('*', this)">Mult</button>
        <button class="mode-btn bg-slate-700 px-3 py-1 rounded-lg text-sm font-bold transition-all" onclick="setMode('/', this)">Div</button>
        <button id="ai-toggle" class="bg-purple-600 hover:bg-purple-500 px-3 py-1 rounded-lg text-sm font-bold transition-colors" onclick="toggleAI()">AI: OFF</button>
    </div>

    <div id="stage" class="relative h-[30vh] bg-emerald-500 border-x border-indigo-600/30 overflow-hidden flex items-center justify-center shadow-inner">
        <div class="absolute left-1/2 w-2 h-full bg-black/20 -translate-x-1/2"></div>
        <div id="tug-container" class="absolute flex items-center justify-center w-[150%] transition-transform duration-300">
            <div id="team1" class="text-6xl md:text-8xl select-none transition-transform">ðŸ‘¦ðŸ‘¦</div>
            <div class="h-3 w-[40vw] bg-amber-900 border-2 border-amber-950 mx-2"></div>
            <div id="team2" class="text-6xl md:text-8xl select-none transition-transform">ðŸ‘§ðŸ‘§</div>
        </div>
        
        <div id="win-overlay" class="absolute inset-0 bg-slate-900/95 z-50 hidden flex-col items-center justify-center text-center p-6">
            <h2 id="win-text" class="text-4xl md:text-6xl font-black text-yellow-400 mb-6 drop-shadow-lg">WINNER!</h2>
            <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold text-xl shadow-lg transform hover:scale-105 transition-all" onclick="resetGame()">REMATCH</button>
        </div>
    </div>

    <div class="bg-slate-800 p-6 rounded-b-2xl border border-indigo-600/30 flex flex-col md:flex-row gap-6">
        <div class="flex-1 bg-slate-900/50 p-4 rounded-xl border border-blue-500/30 flex flex-col items-center">
            <input type="text" id="p1-name" value="{{ user.username|default:'Player 1' }}" class="bg-transparent text-blue-400 text-center font-bold mb-2 border-b border-blue-500/20 focus:outline-none">
            <div class="w-full bg-black h-2 rounded-full mb-4 overflow-hidden">
                <div id="p1-fill" class="h-full bg-blue-500 transition-all duration-100" style="width: 100%;"></div>
            </div>
            <div id="q1" class="text-5xl font-black mb-4">?</div>
            <input type="number" id="ans1" oninput="autoCheck(1)" class="w-32 bg-black text-yellow-400 text-4xl text-center p-2 rounded-lg border-2 border-blue-500 focus:border-yellow-400 outline-none" inputmode="numeric" placeholder="?">
        </div>

        <div class="flex-1 bg-slate-900/50 p-4 rounded-xl border border-red-500/30 flex flex-col items-center">
            <input type="text" id="p2-name" value="Guest" class="bg-transparent text-red-400 text-center font-bold mb-2 border-b border-red-500/20 focus:outline-none">
            <div class="w-full bg-black h-2 rounded-full mb-4 overflow-hidden">
                <div id="p2-fill" class="h-full bg-red-500 transition-all duration-100" style="width: 100%;"></div>
            </div>
            <div id="q2" class="text-5xl font-black mb-4">?</div>
            <input type="number" id="ans2" oninput="autoCheck(2)" class="w-32 bg-black text-yellow-400 text-4xl text-center p-2 rounded-lg border-2 border-red-500 focus:border-yellow-400 outline-none" inputmode="numeric" placeholder="?">
        </div>
    </div>
</div>

<style>
    .pull-L { transform: scale(1.3) rotate(-20deg) translateX(-15px); }
    .pull-R { transform: scale(1.3) rotate(20deg) translateX(15px); }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let pos = 0;
    let p1Time = 100, p2Time = 100;
    let isAI = false;
    let currentMode = '+';
    let audioCtx = null;
    let qs = [null, {}, {}];

    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

    function playSound(freq, type, duration) {
        if(!audioCtx) return;
        let osc = audioCtx.createOscillator();
        let gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function toggleAI() {
        isAI = !isAI;
        const btn = document.getElementById('ai-toggle');
        btn.innerText = isAI ? "AI: ON" : "AI: OFF";
        btn.classList.toggle('bg-green-600', isAI);
        btn.classList.toggle('bg-purple-600', !isAI);
        document.getElementById('p2-name').value = isAI ? "Nakintu AI" : "Guest";
        document.getElementById('ans2').disabled = isAI;
        document.getElementById('ans2').value = '';
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.className = 'mode-btn bg-slate-700 px-3 py-1 rounded-lg text-sm font-bold transition-all');
        btn.className = 'mode-btn active bg-indigo-600 px-3 py-1 rounded-lg text-sm font-bold transition-all';
        newQ(1); newQ(2);
    }

    function generate(mode) {
        let m = mode;
        let a, b, ans;
        if (m === '+') { a = Math.floor(Math.random()*20)+1; b = Math.floor(Math.random()*20)+1; ans = a+b; }
        else if (m === '-') { a = Math.floor(Math.random()*20)+10; b = Math.floor(Math.random()*10)+1; ans = a-b; }
        else if (m === '*') { a = Math.floor(Math.random()*10)+1; b = Math.floor(Math.random()*10)+1; ans = a*b; }
        else { b = Math.floor(Math.random()*9)+1; ans = Math.floor(Math.random()*10)+1; a = b*ans; }
        return { txt: `${a}${m==='*'?'Ã—':m==='/'?'Ã·':m}${b}`, ans: ans };
    }

    function newQ(p) {
        qs[p] = generate(currentMode);
        document.getElementById('q' + p).innerText = qs[p].txt;
    }

    // AUTOMATIC SUBMISSION LOGIC
    function autoCheck(p) {
        initAudio();
        let input = document.getElementById('ans' + p);
        let val = input.value;

        // Only check if value length is equal or greater than answer length 
        // (to prevent checking "1" if the answer is "10")
        if (val.length >= qs[p].ans.toString().length) {
            if (parseInt(val) === qs[p].ans) {
                // Correct
                pull(p, 50); 
                p === 1 ? p1Time = 100 : p2Time = 100;
                playSound(523, 'sine', 0.15);
                input.value = ''; 
                newQ(p);
            } else {
                // Wrong - only trigger sound and clear if length is matched
                // This prevents buzzing while the user is still typing a multi-digit number
                if (val.length >= qs[p].ans.toString().length) {
                    playSound(150, 'sawtooth', 0.3);
                    input.value = ''; 
                }
            }
        }
    }

    function pull(p, dist) {
        pos += (p === 1 ? -dist : dist);
        const kid = document.getElementById('team' + p);
        kid.classList.add(p === 1 ? 'pull-L' : 'pull-R');
        setTimeout(() => kid.classList.remove('pull-L', 'pull-R'), 400);
        updateRope();
    }

    function updateRope() {
        document.getElementById('tug-container').style.transform = `translateX(${pos}px)`;
        if (Math.abs(pos) > window.innerWidth * 0.4) win();
    }

    function win() {
        const winner = pos < 0 ? document.getElementById('p1-name').value : document.getElementById('p2-name').value;
        document.getElementById('win-text').innerText = winner.toUpperCase() + " WINS!";
        document.getElementById('win-overlay').classList.remove('hidden');
        document.getElementById('win-overlay').classList.add('flex');
        playSound(600, 'square', 0.5);
    }

    function resetGame() {
        pos = 0; p1Time = 100; p2Time = 100;
        document.getElementById('win-overlay').classList.add('hidden');
        updateRope(); newQ(1); newQ(2);
        document.getElementById('ans1').value = '';
        document.getElementById('ans2').value = '';
    }

    setInterval(() => {
        if(document.getElementById('win-overlay').classList.contains('hidden')) {
            p1Time -= 0.5; p2Time -= 0.5;
            if (isAI && Math.random() < 0.02) { pull(2, 40); newQ(2); p2Time = 100; }
            if (p1Time <= 0) { pos += 15; p1Time = 100; updateRope(); }
            if (p2Time <= 0) { pos -= 15; p2Time = 100; updateRope(); }
            document.getElementById('p1-fill').style.width = p1Time + "%";
            document.getElementById('p2-fill').style.width = p2Time + "%";
        }
    }, 100);

    newQ(1); newQ(2);
</script>
{% endblock %}