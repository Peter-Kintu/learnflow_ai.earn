{% extends "base.html" %}

{% block title %}Attempt Quiz: {{ quiz.title }} - Nakintu AI{% endblock %}

{% block extra_head %}
    <meta name="description" content="Attempt the quiz '{{ quiz.title }}' to test your knowledge. Subject: {{ quiz.subject }}. {{ quiz.description }}">
    <link rel="canonical" href="{{ request.build_absolute_uri }}">
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-8 bg-slate-800 rounded-2xl shadow-lg mt-10">
    <h2 class="text-3xl font-bold text-gray-200 mb-2">{{ quiz.title }}</h2>
    <p class="text-gray-400 mb-4">{{ quiz.description }}</p>

    <div class="flex items-center justify-between bg-slate-700 p-4 rounded-xl shadow-inner mb-6">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-timer text-indigo-400 mr-2">
                <path d="M10 2h4"/>
                <path d="M12 14v-4"/>
                <circle cx="12" cy="14" r="8"/>
            </svg>
            <span class="text-gray-400 font-medium">Time Remaining:</span>
        </div>
        <div id="countdown-timer" class="text-2xl font-bold text-indigo-400">
            30:00
        </div>
    </div>
    
    <form method="post" id="quiz-form" class="space-y-6">
        {% csrf_token %}
        {% for question in quiz.questions.all %}
        <div class="question-block bg-slate-700 p-6 rounded-xl shadow-inner border border-slate-600">
            <h3 class="text-xl font-semibold text-gray-200 mb-4 flex items-center">
                <span class="text-indigo-400 mr-2">{{ forloop.counter }}.</span>
                {# FIX: Use 'question.text' to display the question text #}
                {{ question.text }}
            </h3>
            <div class="space-y-3">
                
                {# ADDED: Conditional logic to display appropriate input based on question type #}
                {% if question.question_type == 'MC' %}
                    {# Multiple Choice Questions #}
                    {% for choice in question.choices.all %}
                    <label class="flex items-center text-gray-300 cursor-pointer hover:bg-slate-600/50 p-3 rounded-lg transition-colors">
                        {# FIX: Use 'choice.id' as the value, as expected by views.py #}
                        <input type="radio" name="question_{{ question.id }}" value="{{ choice.id }}" required 
                               class="form-radio h-5 w-5 text-indigo-500 bg-slate-800 border-gray-600 focus:ring-indigo-500">
                        {# FIX: Use 'choice.text' to display the choice text #}
                        <span class="ml-3 text-lg">{{ choice.text }}</span>
                    </label>
                    {% endfor %}
                
                {% elif question.question_type == 'SA' %}
                    {# Short Answer Questions #}
                    <textarea name="question_{{ question.id }}" rows="4" required 
                              class="w-full p-3 bg-slate-800 text-gray-200 rounded-lg border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="Type your answer here..."></textarea>
                
                {% else %}
                    <p class="text-red-400">Error: Unknown question type.</p>
                {% endif %}

            </div>
        </div>
        {% endfor %}
        
        <button type="submit" id="submit-button" class="w-full mt-8 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-bold text-lg flex items-center justify-center shadow-lg">
            <span class="mr-2">âœ…</span>
            Submit Quiz
        </button>
        <p id="timer-warning" class="text-sm text-center mt-4 hidden"></p>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // --- Timer Logic ---
    // Get the quiz time limit from a Django context variable (assuming it's passed)
    // Placeholder time in seconds (e.g., 30 minutes * 60 seconds)
    const TIME_LIMIT_SECONDS = 1800; // 30 minutes

    let timeLeft = TIME_LIMIT_SECONDS;
    const timerDisplay = document.getElementById('countdown-timer');
    const submitButton = document.getElementById('submit-button');
    const quizForm = document.getElementById('quiz-form');
    const timerWarning = document.getElementById('timer-warning');

    // Initial display
    timerDisplay.textContent = formatTime(timeLeft);

    // Start the timer
    const timerInterval = setInterval(updateTimer, 1000);

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateTimer() {
        timeLeft--;
        timerDisplay.textContent = formatTime(timeLeft);

        if (timeLeft <= 60 && !timerDisplay.classList.contains('text-red-500')) {
            timerDisplay.classList.remove('text-indigo-400');
            timerDisplay.classList.add('text-red-500');
            timerWarning.textContent = 'Hurry! Only 60 seconds remaining.';
            timerWarning.classList.remove('hidden');
            timerWarning.classList.add('text-red-400');
        }

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerDisplay.textContent = 'Time\'s up!';
            submitButton.textContent = 'Time Expired';
            submitButton.disabled = true;
            submitButton.classList.add('bg-gray-500', 'cursor-not-allowed', 'hover:bg-gray-500');
            submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            timerWarning.textContent = 'Your answers have been automatically submitted.';
            timerWarning.classList.remove('text-red-400');
            timerWarning.classList.add('text-green-400');
            quizForm.submit();
        }
    }

    // Prevents submitting by pressing enter
    quizForm.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
        }
    });

    // Handle manual form submission to clear interval
    quizForm.addEventListener('submit', function() {
        clearInterval(timerInterval);
    });
</script>
{% endblock %}
