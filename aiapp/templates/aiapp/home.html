{% extends "base.html" %}

{% block title %}Home - LearnFlow AI{% endblock %}

{% block content %}
<style>
  /* A simple loader for the search state */
  .loader {
    border-top-color: #4f46e5;
    -webkit-animation: spinner 1s linear infinite;
    animation: spinner 1s linear infinite;
  }
  @-webkit-keyframes spinner {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
  }
  @keyframes spinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<div class="max-w-5xl mx-auto p-10 mt-12 bg-gradient-to-br from-slate-800 via-slate-700 to-slate-900 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-slate-600 transition-all duration-300">

  <h1 class="text-5xl font-extrabold text-white mb-4 tracking-tight animate-fade-in">
    Welcome, {{ user.username }} üëã
  </h1>
  <p class="text-gray-300 text-lg mb-8 font-light">
    You‚Äôve joined a movement where educators and learners rise together‚Äîone joyful click at a time.
  </p>

  <div class="mb-10 text-left">
    <h2 class="text-2xl font-semibold text-white mb-3">üîç Quick Knowledge Lookup</h2>
    <div class="flex gap-4 items-center">
      <input type="text" id="wikiSearch" placeholder="Search Wikipedia..." class="flex-1 px-4 py-3 rounded-xl bg-slate-900 text-white border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
      <button onclick="searchWikipedia()" class="px-5 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-semibold shadow-md">Search</button>
    </div>
    <div id="wikiResult" class="mt-6 text-gray-300"></div>
  </div>

  <div class="mb-10 text-left">
    <h2 class="text-2xl font-semibold text-white mb-3">üí¨ Ask LearnFlow</h2>
    <div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 shadow-inner">
      <div id="chatLog" class="h-48 overflow-y-auto text-gray-300 mb-4 px-2 py-1 bg-slate-800 rounded-lg border border-slate-600"></div>
      <div class="flex gap-4">
        <input type="text" id="chatInput" placeholder="Type your question..." class="flex-1 px-4 py-3 rounded-xl bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200">
        <button onclick="sendChat()" class="px-5 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors font-semibold shadow-md">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
  async function searchWikipedia() {
    const query = document.getElementById('wikiSearch').value.trim();
    const resultDiv = document.getElementById('wikiResult');

    if (!query) {
      resultDiv.innerHTML = "<span class='text-yellow-400'>Please enter a topic to search.</span>";
      return;
    }

    resultDiv.innerHTML = `<div class='flex items-center space-x-2'><span>Searching Wikipedia...</span><div class='loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6'></div></div>`;

    try {
      const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
      
      if (!response.ok) {
        // If the direct query fails, it's likely a typo or no direct match.
        // We'll fall back to searching for suggestions.
        throw new Error("No direct match found.");
      }
      
      const data = await response.json();

      if (data.type === "disambiguation") {
        // Handle disambiguation pages by showing the user the original page.
        resultDiv.innerHTML = `
          <h3 class="text-lg font-bold mb-2 text-white">${data.title}</h3>
          <p class="text-gray-300">This term has multiple meanings. Try a more specific search or explore the full list.</p>
          <a href="${data.content_urls.desktop.page}" target="_blank" class="text-indigo-400 underline mt-2 inline-block">Explore options on Wikipedia</a>
        `;
      } else if (data.extract) {
        // Display a successful summary.
        resultDiv.innerHTML = `
          <h3 class="text-lg font-bold mb-2 text-white">${data.title}</h3>
          <p class="text-gray-300">${data.extract}</p>
          <a href="${data.content_urls.desktop.page}" target="_blank" class="text-indigo-400 underline mt-2 inline-block">Read more on Wikipedia</a>
        `;
      } else {
        // Fallback for pages with no summary text.
        resultDiv.innerHTML = `<span class='text-red-400'>No summary available for this topic, but you can read the full article below.</span> <a href="${data.content_urls.desktop.page}" target="_blank" class="text-indigo-400 underline mt-2 inline-block">Read full article</a>`;
      }

    } catch (error) {
      // This is our intelligent fallback for typos or no results.
      try {
        const fallbackResponse = await fetch(`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=5&format=json&origin=*`);
        const suggestions = await fallbackResponse.json();
        const titles = suggestions[1];
        const urls = suggestions[3];

        if (titles.length > 0) {
          let suggestionList = '<p class="text-gray-300">Did you mean?</p><ul class="list-disc list-inside mt-2 space-y-1">';
          titles.forEach((title, index) => {
            suggestionList += `<li><a href="${urls[index]}" target="_blank" class="text-indigo-400 hover:underline">${title}</a></li>`;
          });
          suggestionList += '</ul>';
          resultDiv.innerHTML = suggestionList;
        } else {
          // No suggestions either, a true topic not found.
          resultDiv.innerHTML = "<span class='text-red-400'>Topic not found. Please try a different term.</span>";
        }
      } catch (fallbackError) {
        // General error if both methods fail.
        resultDiv.innerHTML = "<span class='text-red-400'>An unexpected error occurred. Please try again later.</span>";
      }
    }
  }

  function sendChat() {
    const input = document.getElementById('chatInput');
    const log = document.getElementById('chatLog');
    const userMessage = input.value.trim();
    if (!userMessage) return;

    log.innerHTML += `<div><strong class="text-green-400">You:</strong> ${userMessage}</div>`;

    const botResponse = getBotResponse(userMessage);
    setTimeout(() => {
      log.innerHTML += `<div><strong class="text-indigo-400">LearnFlow Bot:</strong> ${botResponse}</div>`;
      log.scrollTop = log.scrollHeight;
    }, 600);

    input.value = '';
  }

  function getBotResponse(message) {
    if (message.toLowerCase().includes("upload")) return "To upload content, visit your dashboard and click 'Add Resource'.";
    if (message.toLowerCase().includes("verify")) return "Teacher verification is handled securely‚Äîcheck your profile settings.";
    return "Thanks for your question! Our team is working to make LearnFlow AI even better.";
  }
</script>
{% endblock %}