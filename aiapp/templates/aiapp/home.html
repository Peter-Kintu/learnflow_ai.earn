{% extends "base.html" %}

{% block title %}Home - LearnFlow AI{% endblock %}

{% block content %}
<style>
    /* Base styling and animations for the entire page */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    
    body {
        font-family: 'Inter', sans-serif;
        background: #100f1c; /* A very deep, dark blue-purple */
        color: #e2e8f0; /* Light gray for readability */
        overflow: hidden; /* Hide scrollbars for the particles */
    }

    /* Particle animation background */
    .particle-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }

    .particle {
        position: absolute;
        background: #4A3E90;
        border-radius: 50%;
        opacity: 0;
        animation: floatUp 15s infinite ease-in-out;
    }

    @keyframes floatUp {
        0% { transform: translateY(100vh) scale(0); opacity: 0; }
        25% { opacity: 0.5; }
        50% { opacity: 1; }
        75% { opacity: 0.5; }
        100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }

    /* Spinning loader for pending responses */
    .loader {
        border-top-color: #5d5dff;
        animation: spinner 1s linear infinite;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 28px;
        height: 28px;
    }

    @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* General hover effect for buttons */
    .button-hover-effect {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .button-hover-effect:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    /* Fade-in animation for initial content load */
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fade-in-up 0.8s ease-out forwards;
    }

    /* Custom chat bubble styling */
    .chat-bubble {
        max-width: 85%;
        padding: 1rem 1.25rem;
        border-radius: 1.5rem;
        word-wrap: break-word;
        line-height: 1.6;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        animation: fade-in-up 0.5s ease-out;
    }

    .user-bubble {
        background-color: #2c2957; /* Deep purple */
        color: #e2e8f0;
        border-bottom-right-radius: 0.5rem;
        margin-left: auto;
    }

    .ai-bubble {
        background-color: #212536; /* Very dark gray */
        color: #a7f3d0; /* Soft green */
        border-bottom-left-radius: 0.5rem;
        margin-right: auto;
    }
</style>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Particle animation background container -->
<div id="particle-bg" class="particle-bg"></div>

<!-- Main container for the entire page content -->
<div class="max-w-4xl mx-auto p-6 sm:p-12 mt-6 sm:mt-16 rounded-3xl sm:rounded-4xl transform transition-all duration-500 relative z-10">

    <!-- Hero Section -->
    <div class="text-center p-8 sm:p-12 rounded-3xl animate-fade-in-up mb-8">
        <h1 class="text-4xl sm:text-6xl font-extrabold text-white mb-2 sm:mb-4 tracking-tighter">
            Welcome, {{ user.username }} <span class="wave-emoji inline-block">ðŸ‘‹</span>
        </h1>
        <p class="text-md sm:text-xl text-gray-400 mb-8 font-light">
            Youâ€™ve joined a movement where educators and learners rise togetherâ€”one joyful click at a time.
        </p>
    </div>

    <!-- Main Chatbot Card -->
    <div class="bg-gray-800 bg-opacity-80 backdrop-blur-md p-4 sm:p-8 rounded-3xl border border-gray-700 shadow-2xl animate-fade-in-up">
        
        <!-- Chatbot Section Header -->
        <h2 class="text-xl sm:text-3xl font-semibold text-indigo-400 mb-4 flex items-center gap-3">
            <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.549a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.549A9.863 9.863 0 0112 10a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.549A9.863 9.863 0 0112 4c4.97 0 9 3.582 9 8z" />
            </svg>
            Ask LearnFlow AI
        </h2>

        <!-- Chat Log with improved styling -->
        <div id="chatLog" class="h-96 overflow-y-auto text-gray-300 mb-4 p-4 bg-gray-900 rounded-xl border border-gray-700 transition-all duration-300 flex flex-col gap-4"></div>

        <!-- Input and Buttons -->
        <div class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="chatInput" placeholder="Ask LearnFlow AI..." class="flex-1 px-4 py-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-300">
            <button onclick="sendChat()" class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-semibold shadow-md button-hover-effect">Send</button>
            <button onclick="clearChat()" class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors font-semibold shadow-md button-hover-effect">Clear</button>
        </div>
    </div>

</div>

<script>
    const chatInput = document.getElementById('chatInput');
    const chatLog = document.getElementById('chatLog');
    
    // API endpoint using your AWS EC2 public IP
    const API_BASE_URL = "http://13.60.117.13:8000";

    // Load chat history from localStorage on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Create particle background
        const particleBg = document.getElementById('particle-bg');
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const size = Math.random() * 10 + 5;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animationDelay = `${Math.random() * 15}s`;
            particle.style.animationDuration = `${Math.random() * 10 + 15}s`;
            particleBg.appendChild(particle);
        }

        // Load chat history from localStorage
        const storedChat = localStorage.getItem('chatHistory');
        if (storedChat) {
            chatLog.innerHTML = storedChat;
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    });

    // Save chat history to localStorage whenever it changes
    function saveChatHistory() {
        localStorage.setItem('chatHistory', chatLog.innerHTML);
    }
    
    // Function to clear the chat log and localStorage
    function clearChat() {
        chatLog.innerHTML = '';
        localStorage.removeItem('chatHistory');
    }

    // Allow sending message with 'Enter' key
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendChat();
    });

    async function sendChat() {
        const query = chatInput.value.trim();
        if (!query) return;

        // Display user message as a chat bubble
        const userMsgDiv = document.createElement('div');
        userMsgDiv.className = "flex justify-end";
        userMsgDiv.innerHTML = `<div class="user-bubble chat-bubble">${query}</div>`;
        chatLog.appendChild(userMsgDiv);
        chatInput.value = '';
        saveChatHistory();
        
        const loaderDiv = document.createElement('div');
        loaderDiv.id = 'loader';
        loaderDiv.className = 'loader my-4';
        chatLog.appendChild(loaderDiv);
        chatLog.scrollTop = chatLog.scrollHeight;

        try {
            // Step 1: Send the query and get a task_id
            const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query })
            });
            const chatData = await chatResponse.json();
            const taskId = chatData.task_id;

            // Step 2: Poll the task endpoint until the answer is ready
            const pollInterval = setInterval(async () => {
                const taskResponse = await fetch(`${API_BASE_URL}/api/task/${taskId}`);
                const taskData = await taskResponse.json();
                
                // Check if the task is complete
                if (taskData.answer !== "Your question is still being processed. Please check back soon.") {
                    clearInterval(pollInterval); // Stop polling
                    
                    // Remove the loader
                    const loader = document.getElementById('loader');
                    if (loader) loader.remove();
                    
                    // Display the final answer
                    const aiMsgDiv = document.createElement('div');
                    aiMsgDiv.className = "flex justify-start";
                    chatLog.appendChild(aiMsgDiv);

                    const aiBubble = document.createElement('div');
                    aiBubble.className = "ai-bubble chat-bubble";
                    aiMsgDiv.appendChild(aiBubble);

                    const fullText = taskData.answer;
                    let i = 0;
                    const typingInterval = setInterval(() => {
                        if (i < fullText.length) {
                            aiBubble.innerHTML += fullText.charAt(i);
                            chatLog.scrollTop = chatLog.scrollHeight;
                            i++;
                        } else {
                            clearInterval(typingInterval);
                            saveChatHistory();
                        }
                    }, 25);
                }
            }, 1000); // Poll every 1 second
            
        } catch (error) {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.remove();
            }
            const errorMsgDiv = document.createElement('div');
            errorMsgDiv.innerHTML = `<div class='py-2 text-red-400 text-center'>Error fetching answer. Please try again.</div>`;
            chatLog.appendChild(errorMsgDiv);
            saveChatHistory();
        }

        chatLog.scrollTop = chatLog.scrollHeight;
    }
</script>
{% endblock %}
