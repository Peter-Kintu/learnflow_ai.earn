{% extends "base.html" %}

{% block title %}Available Quizzes{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto p-8 bg-slate-800 rounded-2xl shadow-lg w-full mt-10 relative">

<h2 class="text-3xl font-bold text-gray-200 mb-2 text-center">Available Quizzes</h2>
<p class="text-center text-gray-400 mb-8">
    Select a quiz to begin your practice or assessment.
</p>

<div class="flex justify-center mb-8">
    <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-9564790727166506"
          data-ad-slot="1234567890"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

<div class="bg-slate-700 p-6 rounded-xl shadow-inner mb-10">
  <h3 class="text-xl font-semibold text-gray-200 mb-4 text-center">Generate a Quiz with LearnFlow AI</h3>
  <div class="flex flex-col md:flex-row items-center gap-4">
    <input type="text" id="aiTopicInput" placeholder="Enter a topic (e.g. Photosynthesis)" class="flex-1 px-4 py-2 rounded-lg bg-slate-800 text-gray-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
    <button onclick="generateQuiz()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-semibold">Generate</button>
  </div>
  <p id="aiStatus" class="text-sm text-gray-400 mt-4 text-center"></p>
</div>

<div id="aiQuizOutput" class="hidden bg-slate-700 p-6 rounded-xl shadow-inner mb-10">
  <h4 class="text-lg font-semibold text-indigo-400 mb-4">LearnFlow AI-Generated Quiz</h4>
  <div id="quizContent" class="space-y-4 text-gray-300"></div>
</div>

{% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="p-4 rounded-xl text-center {% if message.tags %} bg-{{ message.tags }}-600/50 text-{{ message.tags }}-200 {% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
{% endif %}

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% if quizzes %}
        {% for quiz in quizzes %}
            <a href="{% url 'aiapp:quiz_detail' quiz.id %}" class="block bg-slate-700 p-6 rounded-xl shadow-inner hover:bg-slate-600 transition-colors duration-200 group">
                <h3 class="text-xl font-semibold text-gray-200 mb-2 group-hover:text-indigo-400 transition-colors">{{ quiz.title }}</h3>
                <p class="text-gray-400 text-sm mb-4 line-clamp-2">{{ quiz.description }}</p>
                
                <div class="flex items-center text-xs text-gray-500">
                    {% if quiz.teacher %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user mr-1"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <span>Created by {{ quiz.teacher.get_full_name|default:quiz.teacher.username }}</span>
                    {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-x mr-1"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" x2="22" y1="17" y2="22"/><line x1="22" x2="17" y1="17" y2="22"/></svg>
                        <span class="text-red-400">Creator unknown</span>
                    {% endif %}

                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days ml-4 mr-1"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                    <span>{{ quiz.created_at|date:"F j, Y" }}</span>
                </div>
            </a>
        {% endfor %}
    {% else %}
        <div class="text-center md:col-span-2 p-8 bg-slate-700 rounded-xl shadow-inner">
            <p class="text-gray-400 text-lg">No quizzes are currently available.</p>
            {% if user.is_authenticated and user.is_staff %}
                <p class="text-gray-500 mt-2">As a teacher, you can create one now!</p>
                <a href="{% url 'aiapp:create_quiz' %}" class="inline-block mt-4 px-6 py-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors shadow-lg font-semibold">
                    Create a Quiz
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

</div>

<script>
const GEMINI_API_KEY = "AIzaSyAPPxFduurg61JsZTq5w9GI9HQPKHWheKo"; // Replace with your actual Gemini API key

function speakText(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "en-US";
    utterance.rate = 0.95;
    speechSynthesis.speak(utterance);
}

async function generateQuiz() {
    const topic = document.getElementById("aiTopicInput").value.trim();
    const status = document.getElementById("aiStatus");
    const output = document.getElementById("aiQuizOutput");
    const content = document.getElementById("quizContent");

    if (!topic) {
        status.textContent = "Please enter a topic.";
        return;
    }

    status.textContent = "LearnFlow AI is preparing your quiz...";
    output.classList.add("hidden");
    content.innerHTML = "";

    try {
        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + GEMINI_API_KEY, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `You are LearnFlow AI. Create a 5-question multiple choice quiz on the topic: ${topic}. Include options and correct answers.` }] }]
            })
        });

        const data = await response.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "No quiz generated.";
        const questions = text.split("\n\n");

        questions.forEach(q => {
            const block = document.createElement("div");
            block.className = "bg-slate-800 p-4 rounded-lg border border-slate-600 mb-4";
            block.innerHTML = `
                <pre class="whitespace-pre-wrap text-sm mb-2">${q}</pre>
                <button onclick="speakText(\`${q.replace(/`/g, "\\`")}\`)" class="mt-2 px-4 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">ðŸ”Š Read Aloud</button>
                `;

            content.appendChild(block);
        });

        output.classList.remove("hidden");
    } catch (error) {
        status.textContent = "Error generating quiz.";
        console.error(error);
    }
}
</script>

{% endblock %}