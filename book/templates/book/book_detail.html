{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto p-8 bg-slate-800 rounded-2xl shadow-lg mt-10">

    <!-- Feedback Messages -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="px-4 py-3 rounded-lg shadow-md text-white bg-green-600 animate-pulse">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="flex flex-col md:flex-row items-start md:space-x-8">
        <!-- Book Cover Section -->
        <div class="flex-shrink-0 mb-6 md:mb-0">
            <img src="{{ book.cover_image_url|default:'/static/images/default_cover.png' }}"
                 alt="{{ book.title }} Cover"
                 class="w-64 h-auto rounded-lg shadow-xl">
        </div>

        <!-- Book Details Section -->
        <div class="flex-grow">
            <h2 class="text-4xl font-bold text-gray-200 mb-2">{{ book.title }}</h2>
            <div class="flex items-center text-sm text-gray-400 mb-4 space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                     stroke-linejoin="round" class="lucide lucide-user">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Uploaded by {{ book.uploaded_by.get_full_name|default:book.uploaded_by.username }}</span>
            </div>

            <p class="text-gray-400 mb-6">{{ book.description }}</p>

            <div class="flex items-center mb-6">
                <span class="text-indigo-400 text-3xl font-extrabold mr-4">UGX {{ book.price }}</span>
                {% if has_paid %}
                    <a href="{% url 'book:download_book' book.id %}"
                       class="px-6 py-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-transform transform hover:scale-105 shadow-lg font-semibold">
                        ðŸ“˜ Read Book
                    </a>
                {% else %}
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" name="confirm_payment"
                                class="px-6 py-3 bg-green-600 text-white rounded-full hover:bg-green-700 transition-transform transform hover:scale-105 shadow-lg font-semibold animate-bounce">
                            I Have Paid â€“ Unlock Book
                        </button>
                    </form>

                    <!-- Custom Airtel QR Code -->
                    <div class="mt-6 border border-slate-600 p-4 rounded-xl bg-slate-700 shadow-md text-center">
                        <p class="text-gray-300 font-semibold mb-2">ðŸ“² Scan to pay via Airtel Money:</p>
                        <img src="{% static 'images/aitel.png' %}" alt="Airtel Money QR Code" class="mx-auto w-48 h-auto rounded-lg shadow-lg">
                        <p class="text-sm text-gray-400 mt-2">
                            This payment will unlock <span class="font-semibold text-white">{{ book.title }}</span> for you.
                        </p>
                        <p class="text-green-400 font-semibold mt-2 animate-pulse">
                            ðŸ“± Confirm via <a href="https://wa.me/256789746493" target="_blank" class="underline">WhatsApp</a>
                        </p>
                    </div>
                {% endif %}
            </div>

            {% if not has_paid %}
            <div class="text-sm text-gray-400 mt-4 space-y-2">
                <p>To access this book, you can:</p>
                <ul class="list-disc list-inside text-gray-300">
                    <li>Scan the QR code above and pay via Airtel Money</li>
                    <li>Or <a href="{% url 'book:pay_with_card' book.id %}" class="text-indigo-400 underline">pay with Visa card</a> instantly</li>
                </ul>
            </div>
            {% else %}
            <div class="mt-4 text-sm text-green-400 font-semibold">
                âœ… Payment confirmed. Enjoy your reading journey!
            </div>

            <!-- QR Code for Access -->
            {% with book.transaction_set.filter(user=request.user, verified=True).last as tx %}
                {% if tx %}
                <div class="mt-6">
                    <p class="text-gray-300 mb-2">ðŸ“² Scan to access your book:</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://learnflow-ai.com/book/access/{{ tx.access_code }}"
                         alt="QR Code for Book Access" class="rounded shadow-md">
                    <p class="text-xs text-gray-400 mt-2">
                        Access Code: <span class="font-semibold text-green-400">{{ tx.access_code }}</span>
                    </p>
                    <p class="text-sm text-gray-400 mt-2">
                        Or <a href="{% url 'book:download_book' book.id %}" class="underline text-indigo-400">click here to download</a>.
                    </p>
                </div>
                {% endif %}
            {% endwith %}

            <!-- Floating Toast -->
            {% if tx %}
            <div class="fixed bottom-6 right-6 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-bounce">
                ðŸŽ‰ Book unlocked! <a href="https://wa.me/?text=I%20just%20unlocked%20{{ book.title }}%20on%20EduVerse!%20My%20access%20code%20is%20{{ tx.access_code }}" target="_blank" class="underline">Share your achievement</a>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}