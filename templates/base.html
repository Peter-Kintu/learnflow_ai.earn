{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
   
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}LearnFlow AI{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "What is LearnFlow AI?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "LearnFlow AI is a multilingual educational platform offering quizzes, books, and videos for African educators and students."
        }
      }]
    }
    </script>
    
    </head>
<body>
    
    <div class="min-h-screen bg-slate-900 text-gray-200">
        <main class="container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                {% if user.is_authenticated %}
                    <div id="ad-unit-container" 
                         onclick="trackAdClick()"
                         class="my-6 p-2 bg-slate-700/50 rounded-lg shadow-inner border border-indigo-600/50 text-center cursor-pointer transition-all duration-300 hover:bg-slate-700 w-fit mx-auto">
                        <h3 class="text-xs font-semibold text-gray-400 mb-1">Click this Ad to Earn Points</h3>
                        
                        <div class="flex justify-center">
                            <div class="w-[468px] h-[60px] max-w-full overflow-hidden bg-gray-800 rounded-sm">
                                <script type="text/javascript">
                                    atOptions = {
                                        'key' : '7f6534d747d7fc18ada93341f5afacd2',
                                        'format' : 'iframe',
                                        'height' : 60,
                                        'width' : 468,
                                        'params' : {}
                                    };
                                </script>
                                <script type="text/javascript" src="//www.highperformanceformat.com/7f6534d747d7fc18ada93341f5afacd2/invoke.js"></script>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% block content %}
                {% endblock %}
            </div>
        </main>
    </div>

    <div id="point-notification" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-xl hidden z-[1000] transition-transform duration-300">
        +<span id="points-gained">100</span> Points!
    </div>

    <script>
        // Helper function to get the CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                // ... (CSRF function logic remains)
            }
            return cookieValue;
        }

        // Function to show point notification
        function showPointNotification(points) {
            // ... (Notification function logic remains)
        }

        // This function executes when the Ad unit container is clicked.
        function trackAdClick() {
            const adContainer = document.getElementById('ad-unit-container');
            // Check if the ad was already clicked (to prevent spamming the server)
            if (adContainer && adContainer.dataset.clicked) {
                return; // Do nothing if already clicked
            }

            // Mark the ad as clicked
            if (adContainer) {
                adContainer.dataset.clicked = 'true';
                // Visually indicate the click (e.g., dim the ad and disable pointer events)
                adContainer.classList.add('opacity-50', 'pointer-events-none'); 
            }

            // Get the CSRF token
            const csrftoken = getCookie('csrftoken');
            
            // 1. Send an AJAX POST request to the Django endpoint
            fetch("{% url 'user:track_ad_click' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({}) // Send empty JSON body
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Points awarded:', data.points);
                    // Show a notification to the user with the new points
                    showPointNotification(data.points - (data.points - 100)); // Assumes 100 points per click based on previous view logic
                } else {
                    console.error('Failed to track ad click:', data.message);
                }
            })
            .catch(error => {
                console.error('Error tracking ad click:', error);
            })
            .finally(() => {
                // Remove the clicked state and restore appearance after a delay (e.g., 5 seconds)
                setTimeout(() => {
                    if (adContainer) {
                        delete adContainer.dataset.clicked;
                        adContainer.classList.remove('opacity-50', 'pointer-events-none');
                    }
                }, 5000); 
            });
        }
    </script>
    
    </body>
</html>