{% load static %}

<div class="flex flex-col items-center gap-4 mb-10" role="complementary" aria-label="Advertisement">

    <a href="https://galeindelicatedrove.com/xa0dwpgpev?key=69191c2b5ac00672ced97515583f6477"
       id="ad-button"
       target="_blank" 
       rel="nofollow"
       onclick="trackAdClick();"
       class="inline-block px-8 py-4 bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-full hover:from-red-700 hover:to-pink-700 transition-all shadow-2xl font-black text-xl tracking-wider uppercase transform hover:scale-105">
        üéÅ Click to Unlock Access & Earn Points
    </a>

    <div id="ad-feedback-container" class="mt-2 text-center">
        <p class="text-sm text-gray-400">Click the button above to support us and earn points!</p>
    </div>

    <div class="flex justify-center mb-8 mt-6">
        <div class="w-[468px] h-[60px] border border-slate-700 rounded-lg overflow-hidden shadow-md">
            <script type="text/javascript">
                atOptions = {
                    'key' : '7f6534d747d7fc18ada93341f5afacd2',
                    'format' : 'iframe',
                    'height' : 60,
                    'width' : 468,
                    'params' : {}
                };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/7f6534d747d7fc18ada93341f5afacd2/invoke.js"></script>
        </div>
    </div>
    
    <script>
        // Helper function to get the CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // This function executes when the button is clicked.
        function trackAdClick() {
            // Get the CSRF token
            const csrftoken = getCookie('csrftoken');
            const feedbackContainer = document.getElementById('ad-feedback-container');

            // Set temporary feedback while waiting for the response
            feedbackContainer.innerHTML = `<p class="text-sm text-yellow-400 animate-pulse">Processing your points...</p>`;

            // 1. Send an AJAX POST request to the Django endpoint
            fetch("{% url 'user:track_ad_click' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({}) // Send an empty body
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Server error response:', response.status);
                    throw new Error('Server returned an error.');
                }
                return response.json();
            })
            .then(data => {
                // 2. Point update successful - provide feedback to the user
                if (data.success) {
                    const pointsGained = 100; // Value from your views.py
                    
                    // Display success message
                    feedbackContainer.innerHTML = `<p class="text-lg text-green-400 font-bold animate-pulse">üéâ Success! You earned ${pointsGained} points. Total: ${data.points}</p>`;
                } else {
                    console.error('Failed to award points:', data.message);
                    feedbackContainer.innerHTML = `<p class="text-sm text-red-400">Error: Could not award points. ${data.message}</p>`;
                }
            })
            .catch(error => {
                console.error('Error tracking ad click:', error);
                feedbackContainer.innerHTML = `<p class="text-sm text-red-400">A network error occurred. Please try again!</p>`;
            });
        }
    </script>
    
    <div class="requires-ad-click w-full mt-6 p-4 bg-slate-700 rounded-xl shadow-inner text-center text-gray-300">
      <p class="text-lg font-semibold">üîí This feature is locked</p>
      <p class="text-sm text-gray-400 mt-2">Please click the offer above to unlock access to this service.</p>
    </div>
</div>