{% load static %}

<div id="point-notification" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-xl hidden z-[1000] transition-transform duration-300">
    +<span id="points-gained">1</span> Points! </div>

{% if messages %}
    <div class="mb-4 max-w-4xl mx-auto">
        {% for message in messages %}
            <div class="p-3 mb-2 rounded-md font-medium text-sm bg-indigo-800 text-indigo-300">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="flex flex-col items-center gap-4 mb-10" role="complementary" aria-label="Advertisement">

    {% if user.is_authenticated %}
        <div id="ad-unit-container" 
             onclick="trackAdClick()"
             class="my-6 p-2 bg-slate-700/50 rounded-lg shadow-inner border border-indigo-600/50 text-center cursor-pointer transition-all duration-300 hover:bg-slate-700 w-fit mx-auto">
            <h3 class="text-xs font-semibold text-gray-400 mb-1">Click this Ad to Earn Points</h3>
            
            <div class="flex justify-center">
                <div class="w-[468px] h-[60px] max-w-full overflow-hidden bg-gray-800 rounded-sm">
                    <script type="text/javascript">
                        atOptions = {
                            'key' : '7f6534d747d7fc18ada93341f5afacd2',
                            'format' : 'iframe',
                            'height' : 60,
                            'width' : 468,
                            'params' : {},
                            'container' : 'ad-unit-container'
                        };
                    </script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/7f6534d747d7fc18ada93341f5afacd2/invoke.js"></script>
                </div>
            </div>
            <p class="text-xs text-indigo-400 mt-2">Clicking this ad rewards your account. Thank you for supporting us!</p>
        </div>
    {% endif %}

    <input type="hidden" id="csrf-token-input" value="{{ csrf_token }}">


    <a href="https://galeindelicatedrove.com/xa0dwpgpev?key=69191c2b5ac00672ced97515583f6477"
       id="ad-button"
       target="_blank" 
       rel="nofollow"
       onclick="trackAdClick();"
       class="w-full sm:w-fit inline-block px-6 py-3 sm:px-8 sm:py-4 
              bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-full 
              hover:from-red-700 hover:to-pink-700 transition-all shadow-2xl 
              font-black text-base sm:text-xl tracking-wider uppercase 
              transform hover:scale-105 text-center">
        üéÅ Click to Unlock Access & Earn Points
    </a>

    <div id="ad-feedback-container" class="mt-2 text-center">
        <p class="text-sm text-gray-400">Click the button above to support us and earn points!</p>
    </div>

    <script>
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to show the points notification
        function showPointNotification(points) {
            const notification = document.getElementById('point-notification');
            const pointsGainedSpan = document.getElementById('points-gained');

            if (notification && pointsGainedSpan) {
                pointsGainedSpan.textContent = points;
                notification.classList.remove('hidden');
                
                // Hide after 3 seconds
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 3000);
            }
        }

        function trackAdClick() {
            // Prevent multiple clicks immediately after the first one
            const adButton = document.getElementById('ad-button');
            const adContainer = document.getElementById('ad-unit-container'); 

            if (adContainer && adContainer.dataset.clicked) {
                console.log("Ad click already tracked recently. Ignoring.");
                return; // Stop if already clicked recently
            }

            // Visually disable the ad button/container to prevent double counting
            if (adContainer) {
                adContainer.dataset.clicked = 'true';
                adContainer.classList.add('opacity-50', 'pointer-events-none');
            }
            if (adButton) {
                 adButton.classList.add('opacity-50', 'pointer-events-none');
            }

            // ‚≠ê FIX: Attempt to get token from the hidden input first (most reliable)
            const tokenInput = document.getElementById('csrf-token-input');
            let csrftoken = tokenInput ? tokenInput.value : null;

            // Fallback to cookie retrieval if the hidden input fails
            if (!csrftoken) {
                csrftoken = getCookie('csrftoken');
            }

            // ‚≠ê Set points gained to 1 to match backend logic
            const pointsGained = 1; 

            // ‚≠ê CRITICAL FIX: Check if the token is present before fetch.
            if (!csrftoken) {
                console.error('CSRF token is missing. The POST request will fail. Reverting state.');
                // Revert visual changes immediately if token is missing
                if (adContainer) {
                    delete adContainer.dataset.clicked;
                    adContainer.classList.remove('opacity-50', 'pointer-events-none');
                }
                if (adButton) {
                    adButton.classList.remove('opacity-50', 'pointer-events-none');
                }
                return; // Stop the function
            }

            // Send an AJAX POST request to the Django endpoint
            fetch("{% url 'user:track_ad_click' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken, // Use the retrieved token
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    // This will catch the 403 Forbidden error from Django
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Points awarded:', data.points);
                    // Show a notification to the user with the points gained
                    showPointNotification(pointsGained); 
                } else {
                    console.error('Failed to track ad click:', data.message);
                }
            })
            .catch(error => {
                console.error('Error tracking ad click:', error);
            })
            .finally(() => {
                // Restore appearance after a delay (regardless of success/failure)
                setTimeout(() => {
                    if (adContainer) {
                        delete adContainer.dataset.clicked;
                        adContainer.classList.remove('opacity-50', 'pointer-events-none');
                    }
                    if (adButton) {
                        adButton.classList.remove('opacity-50', 'pointer-events-none');
                    }
                }, 5000); 
            });
        }
    </script>
    
    <div class="requires-ad-click w-full mt-6 p-4 bg-slate-700 rounded-xl shadow-inner text-center text-gray-300">
      <p class="text-lg font-semibold">üîí This feature is locked</p>
      <p class="text-sm text-gray-400 mt-2">Please click the offer button above to unlock this feature and earn points!</p>
    </div>

</div>